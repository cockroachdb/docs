---
title: What&#39;s New in v1.1.3
toc: false
summary: Additions and changes in CockroachDB version v1.1.3
---

## Nov 27, 2017

Get future release notes emailed to you:

<div class="hubspot-install-form install-form-1 clearfix">
    <script>
        hbspt.forms.create({
            css: '',
            cssClass: 'install-form',
            portalId: '1753393',
            formId: '39686297-81d2-45e7-a73f-55a596a8d5ff',
            formInstanceId: 1,
            target: '.install-form-1'
        });
    </script>
</div>

### Downloads

<div id="os-tabs" class="clearfix">
    <a href="https://binaries.cockroachdb.com/cockroach-v1.1.3.darwin-10.9-amd64.tgz"><button id="mac" data-eventcategory="mac-binary-release-notes">Mac</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v1.1.3.linux-amd64.tgz"><button id="linux" data-eventcategory="linux-binary-release-notes">Linux</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v1.1.3.windows-6.2-amd64.zip"><button id="windows" data-eventcategory="windows-binary-release-notes">Windows</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v1.1.3.src.tgz"><button id="source" data-eventcategory="source-release-notes">Source</button></a>
</div>

### Raw changelog

[github list](https://github.com/cockroachdb/cockroach/compare/v1.1.2...0629bcd)

commit 8cfd996fcaf633acd96c087048b7e942c90542a8
Author: marc <marc@cockroachlabs.com>
Date:   Tue Nov 21 09:01:56 2017 -0500

    metrics: write vars to temporary buffer.
    
    Fixes #20186.
    
    We have seen cases of requests hanging (see #20118) while trying to
    write the contents of `/_status/vars`. Since this was done while holding
    the lock, all further requests failed.
    
    This workaround allows a single connection to hang without blocking
    future requests. It does nothing to detect/fix hangs and will actually
    hide such issues by not causing a goroutine/filedescriptor blowup.

commit 3095785465bf3bd6ae95660e95793fe619acfb68
Author: Matt Jibson <matt.jibson@gmail.com>
Date:   Mon Nov 20 15:01:31 2017 -0500

    sqlccl: correctly mutate table descriptors during resumed RESTORE
    
    If a RESTORE was resumed after a pause or node failure, it would
    attempt to regenerate the sql descriptors it was using. However it did
    this in a way that was different than the first invocation that didn't
    use the same resume codepath. This mutation was to remove the FK on
    indexes if the user requested it. Move the mutation to a downstream
    place so both invocation paths will mutate index descriptors in the
    same way.
    
    Release note: correctly resume RESTORE jobs that skip foreign keys.

commit 8da9f78b0dd9150249c5646805ccd504aad11c34
Author: Andrei Matei <andrei@cockroachlabs.com>
Date:   Mon Nov 20 12:03:34 2017 -0500

    sql: support SHOW TRACE FOR SELECT ... AS OF SYSTEM TIME
    
    Release note: SHOW TRACE FOR SELECT ... AS OF SYSTEM TIME is now
    supported.
    
    Before this patch, the Executor wasn't recognizing the AS OF SYSTEM TIME
    and so the SELECT was failing with a planning error.

commit a591b6b2c28edcae5b916c9c61903d6139e2e7be
Author: Andrei Matei <andrei@cockroachlabs.com>
Date:   Mon Nov 20 15:31:53 2017 -0500

    sql: fix handling of errors on Flush
    
    Release note: Fix a possible crash due to statements finishing execution
    after the client connection has been closed.
    
    The Executor Flush()es results to the client on occasions. Before this
    patch, if the flush failed (because the client conn had died) we'd
    always try to roll back the kv txn. If there was no kv txn (e.g. because
    it was a COMMIT that we were flushing), the server would panic. This
    patch makes the rollback conditional on the state.
    
    Fixes #20007

commit a69d60a2cbc786e6aaafaff8140591d09627ab99
Author: Nathan VanBenschoten <nvanbenschoten@gmail.com>
Date:   Mon Nov 20 00:36:06 2017 -0500

    sql: fix PARTITION BY multiple columns with window functions
    
    Fixes #20143.
    
    This has been broken since 278e2e7. Instead of adding to the
    `partitionIdxs` slice, we were replacing it for each new partitioning
    column.

commit 10abdb7492c83fd696fba71e87cb14863f54a4b9
Author: Nathan VanBenschoten <nvanbenschoten@gmail.com>
Date:   Mon Nov 20 00:33:09 2017 -0500

    sql: re-enable and add new Window function tests
    
    Some commented out tests claimed to depend on #12482, but they work
    without it thanks to recent improvements to `addOrReuseRenders`.
    
    This commit also adds a window function test with an ORDER BY clause
    over multiple columns.

commit 8a54de0242b0966b15cb361b7f73dc6cc19b6a66
Author: Nikhil Benesch <nikhil.benesch@gmail.com>
Date:   Fri Nov 17 16:30:39 2017 -0500

    build: more robust checking for clean workspaces
    
    The inverted conditional in the previous version of the check for a
    clean workspace meant that if `git status --porcelain` failed (e.g., due
    to a corrupted Git repository), the workspace was assumed to be clean.
    This allowed a commit that forgot to update a generated file to sneak
    onto a release branch.
    
    Replace the conditional with one that is both more understandable and
    robust against `git status` failures.
    
    Fixes #19639.

commit 868bacbaa974e63fa438d8e279740c67913e6649
Author: Tobias Schottdorf <tobias.schottdorf@gmail.com>
Date:   Thu Nov 16 13:32:24 2017 -0500

    storage: report stringified RocksDB error code
    
    We are now seeing first error reports that have a RocksDB-originating error at their root,
    so next it would be nice to see what classes of errors we see. We hope to see "IO error"
    a lot, as that usually means out of disk.
    
    See https://github.com/facebook/rocksdb/blob/master/include/rocksdb/status.h for a list
    of status code messages that we can expect to see.
    
    Release note: none

commit 3a29f60e81fbd1378445439970897eeaee70ba53
Author: Tobias Schottdorf <tobias.schottdorf@gmail.com>
Date:   Wed Oct 25 14:53:46 2017 -0400

    cherrypick-1.1: storage: do not GC large transactions
    
    Cherry-pick of #19538.
    
    Release notes (temporary workaround): avoid overloading the system during
    cleanup of large transactions.
    
    cc @cockroachdb/release

commit 3c1edd11a3e99acf4818330b71f184dcb418bebb
Author: Vivek Menezes <vivek@cockroachlabs.com>
Date:   Sun Nov 12 22:27:57 2017 -0500

    sqlbase: fix encoding of index value when using unspecified columns
    
    prior to this fix we would treat an unspecified column as a NULL value
    when encoding a column for an index key, but not when encoding it in the
    index as the value part of the key:value index pair.
    
    For the storing case, we would pick up the first specified value
    for the unspecified value and encode it in the index creating a
    completely broken index!
    
    For the composite encoding case it would crash. See #20000
    
    fixes #20000

commit efc8acee1d6e295bcd29b752d911c93959f90e6d
Author: Radu Berinde <radu@cockroachlabs.com>
Date:   Tue Nov 14 10:02:41 2017 -0500

    sql: fix span generation with IN
    
    Issue #20035 exposes a bug in span generation. We have an IN with three values
    and we only see one span.
    
    The root cause is that we are appending to the same slices for each IN value,
    which means that if the slice has some extra capacity, we overwrite the previous
    value. The result is that we get multiple spans that are identical (which get
    merged later into a single span).
    
    Fixes #20035.
    
    Release Note: Fixed a bug leading to incorrect results for queries with IN
    constraints (in some cases).

commit 930cbeb7554bea8d4acebc2ca911fd10048354ac
Author: Tobias Schottdorf <tobias.schottdorf@gmail.com>
Date:   Tue Nov 7 12:28:15 2017 -0500

    log: simplify crash report anonymization
    
    We had an optimization in place that allowed `panic(err)` to report the
    type of `err` instead of reporting a wrapper error. This optimization
    incurred too much complexity to be worth it and is removed in this commit.

commit 9fe332a94c8c259aae8ec38ef85337d1bb8de15f
Author: Justin Jaffray <justin@cockroachlabs.com>
Date:   Mon Nov 6 09:43:57 2017 -0500

    cherry-pick 1.1: sql: fix panic with IN expressions and subqueries
    
    Fixes #19770.
    
    Previously, an IN expression with a subquery on the RHS was not
    type-checked for if the column value matched the LHS, which would lead
    to a panic in some cases.
    
    This commit introduces a check in the case of an IN expression that the
    type matches.
    
    There is already such a check for explicit tuples, but these cannot be
    folded into the same check, as the typechecking of the tuple case has
    some specialized logic for inferring its types.

commit d3d7661fb40b8c799ab57cfc040c941967393430
Author: Radu Berinde <radu@cockroachlabs.com>
Date:   Tue Nov 7 10:47:30 2017 -0500

    sql: fix KV TRACE crash with COUNT(*)
    
    Also adding a test.
    
    Fixes #19846.

commit e66c9b3a01b19e9d819d9e9fcef66588ce33c491
Author: Tobias Schottdorf <tobias.schottdorf@gmail.com>
Date:   Fri Nov 3 22:37:59 2017 -0400

    log: extract file:line from most opaque errors in reports
    
    This makes previously completely opaque errors such as `errors.Errorf("%s",
    "foo")` much more useful by redacting them to their file:line. In particular,
    most `errors.Wrap` chains should essentially emit a piecemeal stack trace.
    
    Note that this only works for the `pkg/errors` package, but we use that in most
    places (as a drop-in for the `errors` package).

commit 64e778e1eecb0c25c4710b711e1cf7b207564bbe
Author: Tobias Schottdorf <tobias.schottdorf@gmail.com>
Date:   Fri Nov 3 13:32:48 2017 -0400

    log: better error reporting
    
    The previous code tended to lose the type when it mattered most, for example in
    `errors.Wrap(unknownSentinelErr, "something")`, the output would have only an
    empty string for the unknown sentinel error. This will now print its type
    instead (which could still be useless, but it's better than nothing).

commit a76379ec68d5de744dc6b51349f5f77331b77c20
Author: Raphael 'kena' Poss <knz@cockroachlabs.com>
Date:   Sat Nov 4 12:55:28 2017 +0100

    sql/parser: fix the grouping of a = ANY/SOME/ALL b <postfixop>
    
    Prior to this patch, an expression of the form `a = ANY b <postfix>`,
    for example `1 = ANY 2::INT` would be parsed as `(a = ANY b)
    <postfix>` (`((1) = ANY (2))::INT`), not the required `a = ANY (b
    <postfix>)` (`(1) = ANY ((2)::INT)`).
    
    This is incorrect on its face, and peeking at the pg grammar indeed
    different from what pg does: the right operand of an ANY/SOME/ALL
    comparisons must be an `a_expr`, not a `d_expr`.

commit c62358a89ab4ae07ca53999a1ccc292a70ce1fe8
Author: Raphael 'kena' Poss <knz@cockroachlabs.com>
Date:   Sat Nov 4 12:48:20 2017 +0100

    sql/parser: new TestParseTree that checks operator grouping

commit b72dfaa5214992230a4b406cd884555cbf6a264d
Author: Raphael 'kena' Poss <knz@cockroachlabs.com>
Date:   Mon Nov 6 14:07:06 2017 +0100

    sql: ensure that DELETE on the fast path is still a valid data source
    
    Prior to this patch, the DELETE statement without WHERE and RETURNING
    would use the "fast path", that is, all the work being done in Start().
    
    The code for this would however violate the `planNode` interface
    contract: after the fast path is taken, the code would panic if the
    `Next()` method is called. `planNode` specifies that `Next()` is
    always callable after `Start()`, although perhaps it has nothing to
    do.

commit efee17a859051b0c65e4d2ed4b43f84827c3af54
Author: Andrei Matei <andrei@cockroachlabs.com>
Date:   Fri Nov 3 16:56:06 2017 -0400

    distsqlrun: fix a double close of the merge joiner output
    
    This patch fixes a bug that caused us to call ProducerDone() twice on
    the output of a mergeJoiner in case outputting a matched row encountered
    an error or a closed consumer. This was a panic.

commit 82f43f6f02cfce106ed0af61e450708348a0ce1e
Author: Ben Darnell <ben@cockroachlabs.com>
Date:   Thu Nov 2 14:59:42 2017 -0400

    build: Move issue-posting script from TC config to repo
    
    This is cleaned up from the previous version and modified to work
    for any project, not just merge-to-master.

commit de26aa0bed195805bf289e78fdda243de44d151a
Author: Jordan Lewis <jordanthelewis@gmail.com>
Date:   Wed Oct 25 12:16:58 2017 -0400

    sql: pre-evaluate arguments to set
    
    Run Eval() on all arguments passed to Set before beginning the Set plan.
    This is necessary because the implementations of all of the different
    variable setters don't get passed the proper EvalContext, and therefore
    won't be able to properly resolve Placeholders once they become leaf
    values.
    
    This wouldn't be necessary if the Set implementations were able to get
    the correct EvalContext, but doing that properly would require a larger
    refactor.

commit 8880fd056e439f225960cacbf1023d676ce001a1
Author: Radu Berinde <radu@cockroachlabs.com>
Date:   Tue Oct 31 10:15:07 2017 -0400

    sql: prefer hard limit
    
    We are seeing a case where we have a soft limit coming from above a limit node,
    and a sort node underneath, something along the lines of:
      SELECT DISTINCT (<some query> ORDER BY x LIMIT 100) ORDER BY x LIMIT 25
    
    We are using the soft limit because it's smaller, but this makes the sort node
    store all the rows in memory. The hard limit avoids this.
    
    Switch to preferring the hard limit.
    
    Fixes #19677.
    
    Release Note: Improved memory usage for certain queries that use limits at
    multiple levels.

commit 3be3530565d7f85d9ac0a58fc8f122cf5b57ea57
Author: Matt Jibson <matt.jibson@gmail.com>
Date:   Mon Oct 30 16:46:59 2017 -0400

    cherrypick-1.1: sqlccl: cleanup failed or canceled RESTORE data
    
    Previously, if a RESTORE failed or was manually canceled, any data
    it had committed would have been orphaned, and forever taken up
    space. Since there was no table descriptor, nothing would have been
    able to see or delete it.
    
    Add optional callbacks in jobs code to allow for specific jobs
    to implement an onFail method. Add the job's client.Txn to the
    update method and this onFail callback to allow for a job to be
    transactionally failed and cleaned up.
    
    Release note: Cleanup partially restored data when a RESTORE fails
    or is canceled.
    
    This PR is from #19578 but with all of the settings passing removed,
    since 1.1 doesn't have any cluster settings for backup/restore.
    
    Fixes #19398
    Fixes #17123

commit 0f49ae0a7394c6858025709be09f54937131e0b1
Author: Tobias Schottdorf <tobias.schottdorf@gmail.com>
Date:   Mon Oct 30 13:02:14 2017 -0400

    ui: regenerate embedded.go

commit 498e1035ecc11b59f145728334dd84f4ef6455c5
Author: Tobias Schottdorf <tobias.schottdorf@gmail.com>
Date:   Sun Oct 29 11:46:05 2017 -0400

    ui: exclude decommissioned nodes from staggered version warning
    
    Fixes #15534.
