---
title: v21.1
toc: true
summary: Additions and changes in v21.1 releases
toc_not_nested: true
---

## v21.1.9

- For a comprehensive summary of features in v21.1, see the [v21.1 GA release notes](#v21-1-0).
- To upgrade to v21.1, see [Upgrade to CockroachDB v21.1](../v21.1/upgrade-cockroach-version.html).

Get future release notes emailed to you:

{% include marketo.html %}

### Downloads

<div id="os-tabs" class="filters clearfix">
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.9.linux-amd64.tgz"><button id="linux" class="filter-button" data-scope="linux" data-eventcategory="linux-binary-release-notes">Linux</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.9.darwin-10.9-amd64.tgz"><button id="mac" class="filter-button" data-scope="mac" data-eventcategory="mac-binary-release-notes">Mac</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.9.windows-6.2-amd64.zip"><button id="windows" class="filter-button" data-scope="windows" data-eventcategory="windows-binary-release-notes">Windows</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.9.src.tgz"><button id="source" class="filter-button" data-scope="source" data-eventcategory="source-release-notes">Source</button></a>
</div>

<section class="filter-content" data-scope="windows">
{% include windows_warning.md %}
</section>

### Docker image

{% include copy-clipboard.html %}
~~~shell
$ docker pull cockroachdb/cockroach:v21.1.9
~~~

### SQL language changes

- Added the [`bulkio.backup.proxy_file_writes.enabled`](../v21.1/cluster-settings.html) cluster setting to opt-in to writing backup files outside the KV storage layer. [#69250][#69250]
- You can now alter the owner of the `crdb_internal_region` type which is created by initiating a [multi-region database](../v21.1/multiregion-overview.html). [#69759][#69759]

### Operational changes

- A new cluster setting, [`sql.mutations.max_row_size.log`](../v21.1/cluster-settings.html), was added, which controls large row logging. Whenever a row larger than this size is written (or a single column family if multiple column families are in use) a `LargeRow` event is logged to the `SQL_PERF` channel (or a `LargeRowInternal` event is logged to `SQL_INTERNAL_PERF` if the row was added by an internal query). This could occur for `INSERT`, `UPSERT`, `UPDATE`, `CREATE TABLE AS`, `CREATE INDEX`, `ALTER TABLE`, `ALTER INDEX`, `IMPORT`, or `RESTORE` statements. `SELECT`, `DELETE`, `TRUNCATE`, and `DROP` are not affected by this setting. This setting is disabled by default. [#69946][#69946]
- A new cluster setting, [`sql.mutations.max_row_size.err`](../v21.1/cluster-settings.html), was added, which limits the size of rows written to the database (or individual column families, if multiple column families are in use). Statements trying to write a row larger than this will fail with a code 54000 (`program_limit_exceeded`) error. Internal queries writing a row larger than this will not fail, but will log a `LargeRowInternal` event to the `SQL_INTERNAL_PERF` channel. This limit is enforced for `INSERT`, `UPSERT`, and `UPDATE` statements. `CREATE TABLE AS`, `CREATE INDEX`, `ALTER TABLE`, `ALTER INDEX`, `IMPORT`, and `RESTORE` will not fail with an error, but will log `LargeRowInternal` events to the `SQL_INTERNAL_PERF` channel. `SELECT`, `DELETE`, `TRUNCATE`, and `DROP` are not affected by this limit. Note that existing rows violating the limit *cannot* be updated, unless the update shrinks the size of the row below the limit, but *can* be selected, deleted, altered, backed-up, and restored. For this reason we recommend using the accompanying setting `sql.mutations.max_row_size.log` in conjunction with `SELECT pg_column_size()` queries to detect and fix any existing large rows before lowering `sql.mutations.max_row_size.err`. This setting is disabled by default. [#69946][#69946]
- New variables `sql.mutations.max_row_size.{log|err}` were renamed to `sql.guardrails.max_row_size_{log|err}` for consistency with other variables and metrics. [#69946][#69946]
- Added four new metrics: `sql.guardrails.max_row_size_log.count`, `sql.guardrails.max_row_size_log.count.internal`, `sql.guardrails.max_row_size_err.count`, and `sql.guardrails.max_row_size_err.count.internal`. These metrics are incremented whenever a large row violates the corresponding `sql.guardrails.max_row_size_{log|err}` limit. [#69946][#69946]

### DB Console changes

- A CES survey link component was added to support being able to get client feedback. [#68517][#68517]

### Bug fixes

- Fixed a bug where running [`IMPORT PGDUMP`](../v21.1/migrate-from-postgres.html) with a UDT would result in a null pointer exception. This change makes it fail gracefully. [#69249][#69249]
- Fixed a bug where the `schedules.backup.succeeded` and `schedules.backup.failed` metrics would sometimes not be updated. [#69256][#69256]
- The correct format code will now be returned when using [`COPY FROM .. BINARY`](../v21.1/copy-from.html). [#69278][#69278]
- Fixed a bug where [`COPY FROM ... BINARY`](../v21.1/copy-from.html) would return an error if the input data was split across different messages. [#69278][#69278]
- Fixed a bug where [`COPY FROM ... CSV`](../v21.1/copy-from.html) would require each `CopyData` message to be split at the boundary of a record. The `COPY` protocol allows messages to be split at arbitrary points. [#69278][#69278]
- Fixed a bug where [`COPY FROM ... CSV`](../v21.1/copy-from.html) did not correctly handle octal byte escape sequences such as `\011` when using a [`BYTES` column](../v21.1/bytes.html). [#69278][#69278]
- Fixed an oversight in the data generator for TPC-H which was causing a smaller number of distinct values to be generated for p_type and p_container in the part table than the spec calls for. [#68710][#68710]
- Fixed a bug that was introduced in [v21.1.5](v21.1.5.html), which prevented [nodes from being decommissioned](../v21.1/remove-nodes.html) in a cluster if the cluster had multiple nodes intermittently miss their liveness heartbeat. [#68552][#68552]
- Fixed a bug introduced in v21.1 where CockroachDB could return an internal error when performing streaming aggregation in some edge cases. [#69181][#69181]
- Fixed a bug that created non-partial unique constraints when a user attempted to create a partial unique constraint in [`ALTER TABLE` statements](../v21.1/alter-table.html). [#68745][#68745]
- Fixed a bug where a [`DROP VIEW ... CASCADE`](../v21.1/drop-view.html) could incorrectly result in "table ...is already being dropped" errors. [#68618][#68618]
- Fixed a bug introduced in v21.1 where the output of [`SHOW CREATE TABLE`](../v21.1/show-create.html) on tables with [hash-sharded indexes](../v21.1/hash-sharded-indexes.html) was not round-trippable. Executing the output would not create an identical table. This has been fixed by showing `CHECK` constraints that are automatically created for these indexes in the output of `SHOW CREATE TABLE`. [#69695][#69695]
- Fixed internal or "invalid cast" error in some cases involving cascading [updates](../v21.1/update.html). [#69180][#69180]
- Fixed a bug with cardinality estimation in the [optimizer](../v21.1/cost-based-optimizer.html) that was introduced in v21.1.0. This bug could cause inaccurate row count estimates in queries involving tables with a large number of null values. As a result, it was possible that the optimizer could choose a suboptimal plan. [#69125][#69125]
- Fixed a bug introduced in v20.2 that caused internal errors with set operations, like [`UNION`](../v21.1/selection-queries.html#union-combine-two-queries), and columns with tuple types that contained constant `NULL` values. [#69271][#69271]
- Added backwards compatibility between v21.1.x cluster versions and the [v21.1.8 cluster version](v21.1.8.html). [#69894][#69894]
- Fixed a bug where table stats collection issued via [`EXPLAIN ANALYZE`](../v21.1/explain-analyze.html) statements or via [`CREATE STATISTICS`](../v21.1/create-statistics.html) statements without specifying the [`AS OF SYSTEM TIME`](../v21.1/as-of-system-time.html) option could run into `flow: memory budget exceeded`. [#69588][#69588]
- Fixed a bug where an internal error or a crash could occur when some [`crdb_internal` built-in functions](../v21.1/functions-and-operators.html) took string-like type arguments (e.g. `name`). [#69993][#69993]
- Fixed all broken links to the documentation from the DB Console. [#70117][#70117]
- Previously, when using [`ALTER PRIMARY KEY`](../v21.1/alter-primary-key.html) on a [`REGIONAL BY ROW`](../v21.1/multiregion-overview.html) table, the copied unique index from the old primary key would not have the correct [zone configurations](../v21.1/configure-zone.html) applied. This bug is now fixed. Users who have encountered this bug should re-create the index. [#69681][#69681]

### Performance improvements

- Lookup joins on [partial indexes](../v21.1/partial-indexes.html) with [virtual computed columns](../v21.1/computed-columns.html) are not considered by the [optimizer](../v21.1/cost-based-optimizer.html), resulting in more efficient query plans in some cases. [#69110][#69110]
- Updated the [optimizer](../v21.1/cost-based-optimizer.html) cost model so that, all else being equal, the optimizer prefers plans in which [`LIMIT`](../v21.1/limit-offset.html) operators are pushed as far down the tree as possible. This can reduce the number of rows that need to be processed by higher operators in the plan tree, improving performance.[#69977][#69977]

### Contributors

This release includes 40 merged PRs by 19 authors.

[#68509]: https://github.com/cockroachdb/cockroach/pull/68509
[#68517]: https://github.com/cockroachdb/cockroach/pull/68517
[#68552]: https://github.com/cockroachdb/cockroach/pull/68552
[#68618]: https://github.com/cockroachdb/cockroach/pull/68618
[#68710]: https://github.com/cockroachdb/cockroach/pull/68710
[#68745]: https://github.com/cockroachdb/cockroach/pull/68745
[#69110]: https://github.com/cockroachdb/cockroach/pull/69110
[#69125]: https://github.com/cockroachdb/cockroach/pull/69125
[#69180]: https://github.com/cockroachdb/cockroach/pull/69180
[#69181]: https://github.com/cockroachdb/cockroach/pull/69181
[#69249]: https://github.com/cockroachdb/cockroach/pull/69249
[#69250]: https://github.com/cockroachdb/cockroach/pull/69250
[#69256]: https://github.com/cockroachdb/cockroach/pull/69256
[#69271]: https://github.com/cockroachdb/cockroach/pull/69271
[#69278]: https://github.com/cockroachdb/cockroach/pull/69278
[#69305]: https://github.com/cockroachdb/cockroach/pull/69305
[#69588]: https://github.com/cockroachdb/cockroach/pull/69588
[#69695]: https://github.com/cockroachdb/cockroach/pull/69695
[#69759]: https://github.com/cockroachdb/cockroach/pull/69759
[#69894]: https://github.com/cockroachdb/cockroach/pull/69894
[#69946]: https://github.com/cockroachdb/cockroach/pull/69946
[#69977]: https://github.com/cockroachdb/cockroach/pull/69977
[#69993]: https://github.com/cockroachdb/cockroach/pull/69993
[#70117]: https://github.com/cockroachdb/cockroach/pull/70117
[#69681]: https://github.com/cockroachdb/cockroach/pull/69681

## v21.1.8

{{site.data.alerts.callout_danger}}
This patch release has been withdrawn due to [this technical advisory](../advisories/a69874.html). All the changes listed as part of this release will be in the next release. Do not upgrade to this release.
{{site.data.alerts.end}}

- For a comprehensive summary of features in v21.1, see the [v21.1 GA release notes](#v21-1-0).
- To upgrade to v21.1, see [Upgrade to CockroachDB v21.1](../v21.1/upgrade-cockroach-version.html).

Get future release notes emailed to you:

{% include marketo.html %}

### Downloads and Docker image

{{site.data.alerts.callout_danger}}
This release was withdrawn, and we've removed the links to the downloads and Docker image.
{{site.data.alerts.end}}

### Security updates

- The [node status retrieval endpoints over HTTP](../v21.1/monitoring-and-alerting.html) (`/_status/nodes`, `/_status/nodes/<N>`, and the DB Console `/#/reports/nodes`) have been updated to require the [`admin`](../v21.1/authorization.html#admin-role) role from the requesting user. This ensures that operational details such as network addresses and command-line flags do not leak to unprivileged users. [#67068][#67068] {% comment %}doc{% endcomment %}

### General changes

- A recent release removed parts of some queries from the [debugging traces](../v21.1/show-trace.html) of those queries. This information (i.e. the execution of some low-level RPCs) has been re-included in the traces. [#68923][#68923] {% comment %}doc{% endcomment %}

### Enterprise edition changes

- The `kafka_sink_config` [changefeed option](../v21.1/create-changefeed.html) can now include `RequiredAcks`. [#69015][#69015] {% comment %}doc{% endcomment %}
- Added a new per-node [changefeed](../v21.1/stream-data-out-of-cockroachdb-using-changefeeds.html) configuration [`changefeed.node_sink_throttle_config`](../v21.1/cluster-settings.html) that can be used to throttle the rate of emission from the memory buffer thus making it possible to limit the emission rate from changefeeds. [#68628][#68628] {% comment %}doc{% endcomment %}

### SQL language changes

- Added a new [`EXPLAIN` flag](../v21.1/explain.html), `MEMO`, to be used with [`EXPLAIN (OPT)`](../v21.1/explain.html#opt-option). When the `MEMO` flag is passed, a representation of the optimizer memo will be printed along with the best plan. The `MEMO` flag can be used in combination with other flags such as `CATALOG` and `VERBOSE`. For example, `EXPLAIN (OPT, MEMO, VERBOSE)` will print the memo along with verbose output for the best plan. [#67778][#67775] {% comment %}doc{% endcomment %}
- Some queries with [lookup joins](../v21.1/joins.html#lookup-joins) and/or top K sorts are now more likely to be executed in a "local" manner with the [`distsql=auto`](../v21.1/set-vars.html#parameters) session variable when the newly introduced `sql.distsql.prefer_local_execution.enabled` [cluster setting](../v21.1/cluster-settings.html) is set to `true` (`false` is the default). [#68613][#68613] {% comment %}doc{% endcomment %}

### Operational changes

- Introduced the `bulkio.index_backfill.checkpoint_interval` [cluster setting](../v21.1/cluster-settings.html) to control the rate at which backfills checkpoint their progress. Useful for controlling the backfill rate on large tables. [#68287][#68287] {% comment %}doc{% endcomment %}

### Command-line changes

- [`cockroach debug zip`](../v21.1/cockroach-debug-zip.html) no longer retrieves database and table details into separate files. The schema information is collected by means of `system.descriptors` and `crdb_internal.create_statements`. [#68984][#68984] {% comment %}doc{% endcomment %}

### DB Console changes

- Added a new column picker on the [Statements](../v21.2/ui-statements-page.html) and [Statements Details pages](../v21.1/ui-statements-page.html#statement-details-page) to select which columns to display in the statements table. Includes a new database column option for database name information, which is hidden by default on the [Statements page](../v21.2/ui-statements-page.html). [#68294][#68294] {% comment %}doc{% endcomment %}
- Fixed the [Transactions page](../v21.2/ui-transactions-page.html) to show the correct value for implicit transactions. [#68294][#68294]
- [Statements Details](../v21.1/ui-statements-page.html#statement-details-page), [Statements](../v21.2/ui-statements-page.html), and [Transactions pages](../v21.2/ui-transactions-page.html) now display information about the node and region on which a statement was executed. [#68317][#68317] {% comment %}doc{% endcomment %}
- Fixed tooltips behavior on the [Sessions](../v21.2/ui-sessions-page.html), [Statements](../v21.2/ui-statements-page.html), and [Transactions pages](../v21.2/ui-transactions-page.html). [#68474][#68474] {% comment %}doc{% endcomment %}

### Bug fixes

- Fixed missing [foreign key](../v21.1/foreign-key.html) checks in some cases when there are multiple checks and the inserted data contains a `NULL` for one of the checks. [#68520][#68520]
- Fixed a bug where using [`ST_segmentize`](../v21.1/functions-and-operators.html#spatial-functions) on coordinates that are infinite would error with a crash. [#67848][#67848]
- Fixed the [`COPY CSV`](../v21.1/copy-from.html) command so that it handles multiple records separated by newline characters. [#68623][#68623] {% comment %}doc{% endcomment %}
- Fixed a bug that caused incorrect query results when querying tables with multiple [column families](../v21.1/column-families.html) and unique secondary [indexes](../v21.1/indexes.html). The bug only occurred if 1) [vectorized execution](../v21.1/vectorized-execution.html) was enabled for the query, 2) the query scanned a [unique secondary index](../v21.1/indexes.html) that contained columns from more than one column family, and 3) the rows fetched by the query contained `NULL` values for some of the indexed columns. This bug was present since version v20.1. [#68238][#68239]
- Fixed a crash in the `/debug/closedts-{sender,receiver}` [advanced debug pages](../v21.1/ui-debug-pages.html) if the last message of the closed timestamp side transport buffer was removed before rendering. [#68669][#68669]
- Fixed an issue where terminating a CockroachDB process early in its startup routine might cause it to fail to start again, falsely reporting write-ahead log corruption. [#68897][#68897]
- Fixed a regression in the [optimizer's cost model](../v21.1/cost-based-optimizer.html) that could cause it to choose sub-optimal plans when choosing between two non-unique index scans with different numbers of columns per index. [#68991][#68991]
- Fixed a bug where CockroachDB could incorrectly evaluate [`LIKE` expressions](../v21.1/scalar-expressions.html#string-pattern-matching) when the pattern contained the escape characters `\` if the expressions were executed via the [vectorized execution engine](../v21.1/vectorized-execution.html). [#68353][#68353]
- File logs now respect the [`max-group-size`](../v21.1/configure-logs.html) configuration parameter again. This parameter had incorrectly become ignored in v21.1, resulting in arbitrarily large log directories. [#69007][#69007]
- Fixed a bug in [`EXPORT`](../v21.1/export.html) where concurrent exports could overwrite each other. [#68392][#68392]

### Performance improvements

- Jobs no longer hold exclusive locks during the duration of their checkpointing transactions which could result in long wait times when trying to run [`SHOW JOBS`](../v21.1/show-jobs.html). [#68244][#68244] {% comment %}doc{% endcomment %}
- [Lookup joins](../v21.1/joins.html#lookup-joins) on indexes with virtual columns are now considered by the optimizer. This should result in more efficient queries in many cases. Most notably, post-query uniqueness checks for unique indexes on virtual columns in [`REGIONAL BY ROW` tables](../v21.1/regional-tables.html#regional-by-row-tables) can now use the unique index rather than perform a full-table scan. [#68423][#68423] {% comment %}doc{% endcomment %}

### Contributors

This release includes 40 merged PRs by 26 authors.

[#67068]: https://github.com/cockroachdb/cockroach/pull/67068
[#67746]: https://github.com/cockroachdb/cockroach/pull/67746
[#67775]: https://github.com/cockroachdb/cockroach/pull/67775
[#67848]: https://github.com/cockroachdb/cockroach/pull/67848
[#67883]: https://github.com/cockroachdb/cockroach/pull/67883
[#68239]: https://github.com/cockroachdb/cockroach/pull/68239
[#68244]: https://github.com/cockroachdb/cockroach/pull/68244
[#68287]: https://github.com/cockroachdb/cockroach/pull/68287
[#68294]: https://github.com/cockroachdb/cockroach/pull/68294
[#68317]: https://github.com/cockroachdb/cockroach/pull/68317
[#68353]: https://github.com/cockroachdb/cockroach/pull/68353
[#68392]: https://github.com/cockroachdb/cockroach/pull/68392
[#68423]: https://github.com/cockroachdb/cockroach/pull/68423
[#68474]: https://github.com/cockroachdb/cockroach/pull/68474
[#68510]: https://github.com/cockroachdb/cockroach/pull/68510
[#68520]: https://github.com/cockroachdb/cockroach/pull/68520
[#68613]: https://github.com/cockroachdb/cockroach/pull/68613
[#68623]: https://github.com/cockroachdb/cockroach/pull/68623
[#68628]: https://github.com/cockroachdb/cockroach/pull/68628
[#68669]: https://github.com/cockroachdb/cockroach/pull/68669
[#68897]: https://github.com/cockroachdb/cockroach/pull/68897
[#68923]: https://github.com/cockroachdb/cockroach/pull/68923
[#68984]: https://github.com/cockroachdb/cockroach/pull/68984
[#68991]: https://github.com/cockroachdb/cockroach/pull/68991
[#69007]: https://github.com/cockroachdb/cockroach/pull/69007
[#69015]: https://github.com/cockroachdb/cockroach/pull/69015

## v21.1.7

This page lists additions and changes in v21.1.7 since v21.1.6.

- For a comprehensive summary of features in v21.1, see the [v21.1 GA release notes](#v21-1-0).
- To upgrade to v21.1, see [Upgrade to CockroachDB v21.1](../v21.1/upgrade-cockroach-version.html).

Get future release notes emailed to you:

{% include marketo.html %}

### Downloads

<div id="os-tabs" class="filters clearfix">
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.7.linux-amd64.tgz"><button id="linux" class="filter-button" data-scope="linux" data-eventcategory="linux-binary-release-notes">Linux</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.7.darwin-10.9-amd64.tgz"><button id="mac" class="filter-button" data-scope="mac" data-eventcategory="mac-binary-release-notes">Mac</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.7.windows-6.2-amd64.zip"><button id="windows" class="filter-button" data-scope="windows" data-eventcategory="windows-binary-release-notes">Windows</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.7.src.tgz"><button id="source" class="filter-button" data-scope="source" data-eventcategory="source-release-notes">Source</button></a>
</div>

<section class="filter-content" data-scope="windows">
{% include windows_warning.md %}
</section>

### Docker image

{% include_cached copy-clipboard.html %}
~~~shell
$ docker pull cockroachdb/cockroach:v21.1.7
~~~

### Security updates

- The `--cert-principal-map` flag passed to [`cockroach` commands](../v21.1/cockroach-commands.html) now allows the certificate principal name to contain colons. [#67810][#67810] {% comment %}doc{% endcomment %}

### General changes

- Added a new [cluster setting](../v21.1/cluster-settings.html) (`kv.transaction.reject_over_max_intents_budget`) that controls the behavior of CockroachDB when a transaction exceeds the locks-tracking memory budget set by the `kv.transaction.max_intents_bytes` cluster setting. If `kv.transaction.reject_over_max_intents_budget` is set to `true`, CockroachDB rejects the query that would push its transaction over the memory budget with an error (error code 53400 - "configuration limit exceeded"). Transactions that don't track their locks precisely are potentially destabilizing for the cluster since cleaning up locks can take up considerable resources. Transactions that change many rows have the potential to run into this memory budget issue. [#67967][#67967] {% comment %}doc{% endcomment %}

### SQL language changes

- The remote [DistSQL](../v21.1/architecture/sql-layer.html#distsql) flows are now eagerly canceled if they were queued up and the query was canceled. [#66331][#66331]
- Added a new cluster setting (`changefeed.slow_span_log_threshold`) that allows setting a cluster-wide default for slow span logging. [#68106][#68106] {% comment %}doc{% endcomment %}
- Added a new [session variable](../v21.1/set-vars.html) (`enable_copying_partitioning_when_deinterleaving_table`) which will change the behavior of [`ALTER PRIMARY KEY`](../v21.1/alter-primary-key.html) when performing a change which retains the same primary key but removes an [`INTERLEAVE INTO` clause](../v21.1/interleave-in-parent.html). When this variable is set to `true` and an `ALTER PRIMARY KEY` is run that only removes an `INTERLEAVE INTO` clause, the [partitioning](../v21.1/partitioning.html) and [zone configuration](../v21.1/configure-zone.html) which applied to the root of the interleave will not be applied to the new primary index. The default value for `enable_copying_partitioning_when_deinterleaving_table` is equal to the value set for the new cluster setting `sql.defaults.copy_partitioning_when_deinterleaving_table.enabled`. [#68114][#68114] {% comment %}doc{% endcomment %}

### Operational changes

- [Histogram metrics](../v21.1/cost-based-optimizer.html#control-histogram-collection) now store the total number of observations over time. [#68106][#68106] {% comment %}doc{% endcomment %}

### DB Console changes

- Fixed a bug causing the Summary Panel on the [Overview Dashboard](../v21.1/ui-overview-dashboard.html) to flicker. [#67365][#67365]
- Fixed a bug preventing a redirect to the originally-requested DB Console page after user login. [#67858][#67858]
- User can now see time series metrics for disk spilling on the [Advanced Debug page](../v21.1/ui-debug-pages.html). [#68112][#68112] {% comment %}doc{% endcomment %}
- Fixed color mismatch of node status badge on the [Cluster Overview page](../v21.1/ui-cluster-overview-page.html). [#68056][#68056]
- Chart titles on the [Replication Dashboard](../v21.1/ui-replication-dashboard.html) were previously falsely labeled as "per Store" but were in fact "per Node". This bug is now fixed. [#67847][#67847] {% comment %}doc{% endcomment %}

### Bug fixes

- Fixed a bug causing the `ST_GeneratePoints` [built-in function](../v21.1/functions-and-operators.html) to return a garbage value or an error if an empty geometry or negative nPoints input is given. [#67580][#67580]
- Fixed a bug where [`DROP DATABASE`](../v21.1/drop-database.html) could return errors if the database contained [temporary views](../v21.1/views.html#temporary-views) in use in an another session. [#67172][#67172]
- Fixed a [storage-level](../v21.1/architecture/storage-layer.html) bug where Pebble would occasionally create excessively large SSTables, causing poor compaction performance and high read-amplification. This was especially likely after a manual offline compaction. [#67610][#67610]
- [Correlated subqueries](../v21.1/subqueries.html#correlated-subqueries) that couldn't be decorrelated and that have their own subqueries are now executed correctly when supported. Note that it is an edge case of an edge case, so it's unlikely that users have hit this bug (it was found by the randomized testing). [#67570][#67570]
- Fixed very rare, unexpected "index out of bounds" error from the [vectorized engine](../v21.1/vectorized-execution.html) when evaluating a `CASE` operator. [#67779][#67779]
- Catching up [Raft](../v21.1/architecture/replication-layer.html#raft) followers on the Raft log is now more efficient in the presence of many large Raft log entries. This helps avoid situations where Raft leaders struggle to retain leadership while catching up their followers. [#67127][#67127]
- Fixed a bug that allowed rows to be inserted into a table with a [`CHECK` constraint](../v21.1/check.html) that always evaluated to `false` (e.g., `CHECK (false)`). This bug was present since version 21.1.0. [#67341][#67341]
- Fixed a bug causing [changefeeds](../v21.1/changefeed-for.html) to sometimes get stuck. [#67968][#67968]
- Previously, CockroachDB nodes would crash whenever the cluster setting `sql.trace.txn.enable_threshold` was changed to a non-zero value. The bug was introduced in 21.1.0. [#68027][#68027]
- Fixed a deadlock that could occur when many replicas were rapidly queued for removal. [#65859][#65859]
- Fixed two bugs which affected [geospatial queries](../v21.1/spatial-features.html) with the `st_distance` function. The first bug caused errors for filters of the form `st_distance(g1, g2, use_spheroid) = 0`. The second could cause incorrect results in some cases; it incorrectly transformed filters of the form `st_distance(g1, g2) = 0` when `g1` and `g2` were geographies to `st_instersects(g1, g2)`. This is not a valid transformation because `st_distance` makes spheroid-based calculations by default while `st_intersects` only makes sphere-based calculations. [#67392][#67392]
- Fixed a bug causing a prepared statement to incorrectly reuse the query plan of a different prepared statement that had similar, but not identical type hints. [#67688][#67688]
- Fixed an issue with statistics estimation in the optimizer that could cause it to over-estimate the number of rows for some expressions and thus choose a sub-optimal plan. This issue could happen when multi-column statistics were used in combination with histograms, the query contained a predicate on two or more columns where the columns were highly correlated, and the selected values were very common according to the histograms. [#67998][#67998]
- Previously, CockroachDB could encounter an internal error or crash when performing a cast of [`NULL`](../v21.1/null-handling.html) [`JSON`](../v21.1/jsonb.html) value to [Geography or Geometry types](../v21.1/spatial-data.html). Now this is fixed. [#67902][#67902]
- [`INSERT`](../v21.1/insert.html) and [`UPDATE`](../v21.1/update.html) statements which operate on larger rows can now be split into batches using the `sql.mutations.mutation_batch_byte_size` setting. [#67958][#67958]
- A rare bug that could result in a crash while creating a [debug.zip file](../v21.1/cockroach-debug-zip.html) has been fixed. The bug was only possible to hit if a debug.zip file was captured during a period of rapid lease movement. [#67728][#67728]
- Previously the [`GRANT`](../v21.1/grant.html) and [`REVOKE`](../v21.1/revoke.html) commands would incorrectly handle role names. CockroachDB treats role names as case-insensitive, but these commands were incorrectly handling the names. Now, `GRANT` and `REVOKE` normalize the names and are case-insensitive. [#67901][#67901] {% comment %}doc{% endcomment %}

### Performance improvements

- [Vectorized flows](../v21.1/vectorized-execution.html) can use less memory when sending and receiving data to the network. [#67609][#67609]
- Range merges are no longer considered if a range has seen significant load over the previous 5 minutes, instead of being considered as long as a range had low load over the previous second. This change improves stability, as load-based splits will no longer rapidly disappear during transient throughput dips. [#65362][#65362]
- A new cluster setting `sql.defaults.optimizer_improve_disjunction_selectivity.enabled` enables more accurate selectivity estimation of query filters with `OR` expressions. This improves query plans in some cases. This cluster setting is disabled by default. [#67730][#67730] {% comment %}doc{% endcomment %}

### Contributors

This release includes 47 merged PRs by 26 authors.

[#65362]: https://github.com/cockroachdb/cockroach/pull/65362
[#65859]: https://github.com/cockroachdb/cockroach/pull/65859
[#66331]: https://github.com/cockroachdb/cockroach/pull/66331
[#67127]: https://github.com/cockroachdb/cockroach/pull/67127
[#67172]: https://github.com/cockroachdb/cockroach/pull/67172
[#67341]: https://github.com/cockroachdb/cockroach/pull/67341
[#67365]: https://github.com/cockroachdb/cockroach/pull/67365
[#67392]: https://github.com/cockroachdb/cockroach/pull/67392
[#67570]: https://github.com/cockroachdb/cockroach/pull/67570
[#67580]: https://github.com/cockroachdb/cockroach/pull/67580
[#67609]: https://github.com/cockroachdb/cockroach/pull/67609
[#67610]: https://github.com/cockroachdb/cockroach/pull/67610
[#67688]: https://github.com/cockroachdb/cockroach/pull/67688
[#67728]: https://github.com/cockroachdb/cockroach/pull/67728
[#67730]: https://github.com/cockroachdb/cockroach/pull/67730
[#67779]: https://github.com/cockroachdb/cockroach/pull/67779
[#67810]: https://github.com/cockroachdb/cockroach/pull/67810
[#67847]: https://github.com/cockroachdb/cockroach/pull/67847
[#67858]: https://github.com/cockroachdb/cockroach/pull/67858
[#67901]: https://github.com/cockroachdb/cockroach/pull/67901
[#67902]: https://github.com/cockroachdb/cockroach/pull/67902
[#67958]: https://github.com/cockroachdb/cockroach/pull/67958
[#67967]: https://github.com/cockroachdb/cockroach/pull/67967
[#67968]: https://github.com/cockroachdb/cockroach/pull/67968
[#67998]: https://github.com/cockroachdb/cockroach/pull/67998
[#68027]: https://github.com/cockroachdb/cockroach/pull/68027
[#68056]: https://github.com/cockroachdb/cockroach/pull/68056
[#68106]: https://github.com/cockroachdb/cockroach/pull/68106
[#68112]: https://github.com/cockroachdb/cockroach/pull/68112
[#68114]: https://github.com/cockroachdb/cockroach/pull/68114

## v21.1.6

Get future release notes emailed to you:

{% include marketo.html %}

### Downloads

<div id="os-tabs" class="filters clearfix">
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.6.linux-amd64.tgz"><button id="linux" class="filter-button" data-scope="linux" data-eventcategory="linux-binary-release-notes">Linux</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.6.darwin-10.9-amd64.tgz"><button id="mac" class="filter-button" data-scope="mac" data-eventcategory="mac-binary-release-notes">Mac</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.6.windows-6.2-amd64.zip"><button id="windows" class="filter-button" data-scope="windows" data-eventcategory="windows-binary-release-notes">Windows</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.6.src.tgz"><button id="source" class="filter-button" data-scope="source" data-eventcategory="source-release-notes">Source</button></a>
</div>

<section class="filter-content" data-scope="windows">
{% include windows_warning.md %}
</section>

### Docker image

{% include copy-clipboard.html %}
~~~shell
$ docker pull cockroachdb/cockroach:v21.1.6
~~~

### General changes

- Switched the `release-21.1` branch to point to a fork of the Google Cloud SDK at version 0.45.1 with an [upstream bug fix](https://github.com/googleapis/google-cloud-go/pull/4226). [#66808][#66808]

### Enterprise edition changes

- Improved the internal buffering of [changefeeds](../v21.1/stream-data-out-of-cockroachdb-using-changefeeds.html) to be robust to bursts in traffic which exceed the throughput to the sink. [#67205][#67205]
- [Incremental backups](../v21.1/take-full-and-incremental-backups.html#incremental-backups) to a cloud storage location that already contains large existing backups now find their derived destination without listing as many remote files. [#67286][#67286]

### Operational changes

- Added logs for important events during the server draining/shutdown process: (1) log when the server closes an existing connection while draining, (2) log when the server rejects a new connection while draining, and (3) log when the server cancels in-flight queries after waiting for the [`server.shutdown.query_wait`](../v21.1/cluster-settings.html) duration to elapse while draining. [#66874][#66874] {% comment %}doc{% endcomment %}

### DB Console changes

- Fixed a bug preventing the [Custom Chart debug page](../v21.1/ui-custom-chart-debug-page.html) from loading on initial. [#66897][#66897]
- Added a drag-to-select timescale feature to the [Custom Chart debug page](../v21.1/ui-custom-chart-debug-page.html). [#66594][#66594] {% comment %}doc{% endcomment %}

### Bug fixes

- CockroachDB now allows a node with lease preferences to drain gracefully. [#66712][#66712]
- Fixed a panic that could occur in the [optimizer](../v21.1/cost-based-optimizer.html) when executing a prepared plan with placeholders. This could happen when one of the tables used by the query had computed columns or a partial index. [#66833][#66833]
- Fixed a bug that caused graceful drain to call `time.sleep` multiple times, which cut into time needed for range lease transfers. [#66851][#66851]
- Reduced CPU usage of idle `cockroach` processes. [#66894][#66894]
- Fixed an error that backup would produce in some [full backups with revision history](../v21.1/take-backups-with-revision-history-and-restore-from-a-point-in-time.html). Previously, some full backups would erroneously produce an error in the form of `batch timestamp <some_timestamp> must be after replica GC threshold <some_other_timestamp>`. [#66904][#66904]
- CockroachDB now avoids interacting with [decommissioned nodes](../v21.1/remove-nodes.html#how-it-works) during DistSQL planning and consistency checking. [#66950][#66950]
- [Changefeeds](../v21.1/stream-data-out-of-cockroachdb-using-changefeeds.html) no longer interact poorly with large, abandoned transactions. Previously, this combination could result in a cascade of work during transaction cleanup that could starve out foreground traffic. [#66813][#66813]
- [Changefeeds](../v21.1/stream-data-out-of-cockroachdb-using-changefeeds.html) now properly invalidate cached range descriptors and retry when encountering [decommissioned nodes](../v21.1/remove-nodes.html#how-it-works). [#67013][#67013]
- Fixed a bug where [metrics pages](../v21.1/ui-overview-dashboard.html) would lose their scroll position on chart data updates. [#67089][#67089]
- Fixed a bug which caused internal errors when running an [`IMPORT TABLE`](../v21.1/import.html) statement with a virtual computed column to import a CSV file. This bug has been present since virtual computed columns were introduced in v21.1.0. [#67043][#67043]
- Previously, the CLI would attribute some of the time spent running schema changes to network latency. This has now been fixed. Additionally, verbose timings in the CLI now also show time spent running schema changes in a separate bucket. [#65719][#65719]
- Fixed a statement buffer memory leak when using suspended portals. [#67372][#67372]
- [Changefeeds](../v21.1/stream-data-out-of-cockroachdb-using-changefeeds.html) on tables with array columns now support Avro. [#67433][#67433]
- Avro encoding now supports collated string types. [#67433][#67433]
- [`ENUM`](../v21.1/enum.html) columns can now be encoded in Avro [changefeeds](../v21.1/stream-data-out-of-cockroachdb-using-changefeeds.html) [#67433][#67433]
- Avro [changefeeds](../v21.1/stream-data-out-of-cockroachdb-using-changefeeds.html) now support `BIT` and `VARBIT` columns. [#67433][#67433]
- [`INTERVAL`](../v21.1/interval.html) columns are now supported in Avro [changefeeds](../v21.1/stream-data-out-of-cockroachdb-using-changefeeds.html). [#67433][#67433]

### Performance improvements

- CockroachDB now continues to generate histograms when table statistics collection reaches memory limits, instead of disabling histogram generation. [#67057][#67057] {% comment %}doc{% endcomment %}
- The [optimizer](../v21.1/cost-based-optimizer.html) now prefers performing a reverse scan over a forward scan + sort if the reverse scan eliminates the need for a sort and the plans are otherwise equivalent. Ihis was previously the case in most cases, but some edge cases with a small number of rows have been fixed. [#67388][#67388]
- When choosing between index scans that are estimated to have the same number of rows, the [optimizer](../v21.1/cost-based-optimizer.html) now prefers indexes for which it has higher certainty about the maximum number of rows over indexes for which there is more uncertainty in the estimated row count. This helps to avoid choosing suboptimal plans for small tables or if the statistics are stale. [#67388][#67388]

### Contributors

This release includes 47 merged PRs by 34 authors.
We would like to thank the following contributors from the CockroachDB community:

- joesankey (first-time contributor)

[#65719]: https://github.com/cockroachdb/cockroach/pull/65719
[#66594]: https://github.com/cockroachdb/cockroach/pull/66594
[#66712]: https://github.com/cockroachdb/cockroach/pull/66712
[#66808]: https://github.com/cockroachdb/cockroach/pull/66808
[#66813]: https://github.com/cockroachdb/cockroach/pull/66813
[#66833]: https://github.com/cockroachdb/cockroach/pull/66833
[#66851]: https://github.com/cockroachdb/cockroach/pull/66851
[#66874]: https://github.com/cockroachdb/cockroach/pull/66874
[#66894]: https://github.com/cockroachdb/cockroach/pull/66894
[#66897]: https://github.com/cockroachdb/cockroach/pull/66897
[#66904]: https://github.com/cockroachdb/cockroach/pull/66904
[#66950]: https://github.com/cockroachdb/cockroach/pull/66950
[#67013]: https://github.com/cockroachdb/cockroach/pull/67013
[#67043]: https://github.com/cockroachdb/cockroach/pull/67043
[#67057]: https://github.com/cockroachdb/cockroach/pull/67057
[#67089]: https://github.com/cockroachdb/cockroach/pull/67089
[#67205]: https://github.com/cockroachdb/cockroach/pull/67205
[#67286]: https://github.com/cockroachdb/cockroach/pull/67286
[#67356]: https://github.com/cockroachdb/cockroach/pull/67356
[#67372]: https://github.com/cockroachdb/cockroach/pull/67372
[#67388]: https://github.com/cockroachdb/cockroach/pull/67388
[#67433]: https://github.com/cockroachdb/cockroach/pull/67433

## v21.1.5

{{site.data.alerts.callout_danger}}
We recommend upgrading from [v21.1.4](v21.1.4.html) to this bugfix release as soon as possible.
{{site.data.alerts.end}}

Get future release notes emailed to you:

{% include marketo.html %}

### Downloads

<div id="os-tabs" class="filters clearfix">
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.5.linux-amd64.tgz"><button id="linux" class="filter-button" data-scope="linux" data-eventcategory="linux-binary-release-notes">Linux</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.5.darwin-10.9-amd64.tgz"><button id="mac" class="filter-button" data-scope="mac" data-eventcategory="mac-binary-release-notes">Mac</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.5.windows-6.2-amd64.zip"><button id="windows" class="filter-button" data-scope="windows" data-eventcategory="windows-binary-release-notes">Windows</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.5.src.tgz"><button id="source" class="filter-button" data-scope="source" data-eventcategory="source-release-notes">Source</button></a>
</div>

<section class="filter-content" data-scope="windows">
{% include windows_warning.md %}
</section>

### Docker image

{% include copy-clipboard.html %}
~~~shell
$ docker pull cockroachdb/cockroach:v21.1.5
~~~

### Bug fixes

- Fixed a panic that could occur in the [optimizer](../v21.1/cost-based-optimizer.html) when executing a prepared plan with placeholders. This could happen when one of the tables used by the query had [computed columns](../v21.1/computed-columns.html) or a [partial index](../v21.1/partial-indexes.html). [#66883][#66883]

[#66883]: https://github.com/cockroachdb/cockroach/pull/66833

## v21.1.4

{{site.data.alerts.callout_danger}}
We recommend upgrading from this release to the [v21.1.5](v21.1.5.html) bugfix release as soon as possible.
{{site.data.alerts.end}}

Get future release notes emailed to you:

{% include marketo.html %}

### Downloads

<div id="os-tabs" class="filters clearfix">
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.4.linux-amd64.tgz"><button id="linux" class="filter-button" data-scope="linux" data-eventcategory="linux-binary-release-notes">Linux</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.4.darwin-10.9-amd64.tgz"><button id="mac" class="filter-button" data-scope="mac" data-eventcategory="mac-binary-release-notes">Mac</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.4.windows-6.2-amd64.zip"><button id="windows" class="filter-button" data-scope="windows" data-eventcategory="windows-binary-release-notes">Windows</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.4.src.tgz"><button id="source" class="filter-button" data-scope="source" data-eventcategory="source-release-notes">Source</button></a>
</div>

<section class="filter-content" data-scope="windows">
{% include windows_warning.md %}
</section>

### Docker image

{% include copy-clipboard.html %}
~~~shell
$ docker pull cockroachdb/cockroach:v21.1.4
~~~

### Security updates

- Previously, all the [logging](../v21.1/logging-overview.html) output to files or network sinks was disabled temporarily while an operator was using the `/debug/logspy` HTTP API, resulting in lost entries and a breach of auditability guarantees. This behavior has been corrected. [#66328][#66328]
- CockroachDB now configures a maximum number of concurrent password verifications in the server process, across UI and SQL clients. This limit reduces the risk of DoS attacks or accidents due to misbehaving clients. By default, the maximum amount of concurrency is ~12% of the number of allocated CPU cores (as per `GOMAXPROCS`), with a minimum of 1 core. This default can be overridden using the environment variable `COCKROACH_MAX_BCRYPT_CONCURRENCY`. [#66367][#66367] {% comment %}doc{% endcomment %}

### SQL language changes

- Implemented the `ST_HasArc` [builtin function](../v21.1/functions-and-operators.html#spatial-functions). This adds better out-of-the-box support for [GeoServer](../v21.1/geoserver.html). [#66531][#66531] {% comment %}doc{% endcomment %}
- Added a new internal [cluster setting](../v21.1/cluster-settings.html), `jobs.cancel_update_limit`, for controlling how many [jobs](../v21.1/show-jobs.html) are cleaned up concurrently after query cancellation. [#66488][#66488] {% comment %}doc{% endcomment %}

### Command-line changes

- The [SQL shell](../v21.1/cockroach-sql.html) now formats times with time zones so that the minutes and seconds offsets are only shown if they are non-zero. Also, infinite floating point values are now formatted as `Infinity` rather than `Inf`. [#66130][#66130] {% comment %}doc{% endcomment %}
- When [log entries](../v21.1/logging-overview.html) are written to disk, the first few header lines written at the start of every new file now report the configured [logging format](../v21.1/log-formats.html). [#66328][#66328] {% comment %}doc{% endcomment %}

### API endpoint changes

- The `/debug/logspy` HTTP API has changed. The endpoint now returns JSON data by default. If the previous format is desired, the user can pass the query argument `&flatten=1` to the `logspy` URL to obtain the previous flat text format (`crdb-v1`) instead. [#66328][#66328] This change is motivated as follows: {% comment %}doc{% endcomment %}
    - The previous format, `crdb-v1`, cannot be parsed reliably.
    - Using JSON entries guarantees that the text of each entry all fits on a single line of output (newline characters inside the messages are escaped). This makes filtering easier and more reliable.
    - Using JSON enables the user to apply `jq` on the output, for example via `curl -s .../debug/logspy | jq ...`.
- The `/debug/logspy` API no longer enables maximum logging verbosity automatically. To change the verbosity, use the new `/debug/vmodule` endpoint or pass the `&vmodule=` query parameter to the `/debug/logspy` endpoint. [#66328][#66328] For example, suppose you wish to run a 20s logspy session: {% comment %}doc{% endcomment %}
    - Before: `curl 'https://.../debug/logspy?duration=20s&...'`.
    - Now: `curl 'https://.../debug/logspy?duration=20s&vmodule=...'` OR `curl 'https://.../debug/vmodule?duration=22s&vmodule=...'   curl 'https://.../debug/logspy?duration=20s'`.
    - As for the regular `vmodule` command-line flag, the maximum verbosity across all the source code can be selected with the pattern `*=4`.
    - Note: at most one in-flight HTTP API request is allowed to modify the `vmodule` parameter. This maintains the invariant that the configuration restored at the end of each request is the same as when the request started.
- The new `/debug/vmodule` API makes it possible for an operator to configure the logging verbosity in a similar way as the SQL [builtin function](../v21.1/functions-and-operators.html) `crdb_internal.set_vmodule()`, or to query the current configuration as in `crdb_internal.get_vmodule()`. Additionally, any configuration change performed via this API can be automatically reverted after a configurable delay. [#66328][#66328] The API forms are: {% comment %}doc{% endcomment %}
    - `/debug/vmodule`: Retrieve the current configuration
    - `/debug/vmodule?set=[vmodule config]&duration=[duration]`: Change the configuration to `[vmodule config]` . The previous configuration at the time the `/debug/vmodule` request started is restored after `[duration]`. This duration, if not specified, defaults to twice the default duration of a `logspy` request (currently, the `logspy`   default duration is 5s, so the `vmodule` default duration is 10s). If the duration is zero or negative, the previous configuration is never restored.

### DB Console changes

- Fixed an issue with displaying more than 100 hours of remaining time on the [Jobs page](../v21.1/ui-jobs-page.html). [#66596][#66596]

### Bug fixes

- Minute timezone offsets are only displayed in the wire protocol if they are non-zero for `TimestampTZ` and `TimeTZ` values. Previously, they would always display. [#66130][#66130]
- Fixed a bug where binary `TimeTZ` values were not being decoded correctly when being sent as a parameter in the wire protocol. [#66130][#66130]
- CockroachDB's [SQL shell](../v21.1/cockroach-sql.html) now properly displays results of common array types, for example: arrays of floats, or arrays of strings. [#66130][#66130]
- Fixed a bug where the `--log='file-defaults: {format: crdb-v1}'` flag was not being handled properly. This bug existed since v21.1.0. [#66328][#66328]
- Fixed a bug where log entries could be lost while the `/debug/logspy` HTTP API was being used. This bug had existed since CockroachDB v1.1. [#66328][#66328]
- The binary encoding of decimals will no longer have negative `dscale` values. This was preventing [Npgsql](https://www.npgsql.org) from being able to read some binary decimals from CockroachDB. [#66532][#66532]
- A bug has been fixed which prevented the [optimizer](../v21.1/cost-based-optimizer.html) from producing plans with [partial indexes](../v21.1/partial-indexes.html) when executing some prepared statements that contained placeholders, stable functions, or casts. This bug was present since partial indexes were added in v20.2.0. [#66634][#66634]
- Fixed a bug which could have prevented [backups](../v21.1/backup.html) from being successfully [restored](../v21.1/restore.html). [#66616][#66616]
- Fixed a bug where CockroachDB could crash when executing [`EXPLAIN (VEC)`](../v21.1/explain.html#vec-option) on some mutations. The bug is present only in the v21.1.1-v21.1.3 releases. [#66573][#66573]
- Fixed a bug where CockroachDB could encounter an internal error when computing [window functions](../v21.1/window-functions.html) with `ROWS` mode of window framing if the offsets were very large for the `OFFSET FOLLOWING` boundary type. [#66446][#66446]
- Fixed a bug where using [`ADD COLUMN UNIQUE`](../v21.1/add-column.html) on [`REGIONAL BY ROW` tables](../v21.1/set-locality.html#regional-by-row) did not correctly add the [zone configs](../v21.1/configure-replication-zones.html) for the newly created column index. [#66696][#66696]
- Fixed a bug where reading from Google Cloud Storage was not using the resuming reader, as a result of which some retriable errors were not being treated as such, and the read would fail. [#66190][#66190]
- Fixed a deadlock during [backups](../v21.1/backup.html) and [imports](../v21.1/import.html). [#66773][#66773]
- Fixed incorrect accounting for statement/transaction sampled [execution statistics](../v21.1/explain-analyze.html). [#66790][#66790]
- Fixed a bug causing [transactions](../v21.1/transactions.html) to be spuriously aborted in rare circumstances. [#66567][#66567]

### DB Console

- Fixed a CSS width calculation which was causing the multibar to not be visible in the [DB Console](../v21.1/ui-overview.html). [#66739][#66739]

### Contributors

This release includes 28 merged PRs by 22 authors.

[#66130]: https://github.com/cockroachdb/cockroach/pull/66130
[#66190]: https://github.com/cockroachdb/cockroach/pull/66190
[#66328]: https://github.com/cockroachdb/cockroach/pull/66328
[#66367]: https://github.com/cockroachdb/cockroach/pull/66367
[#66446]: https://github.com/cockroachdb/cockroach/pull/66446
[#66473]: https://github.com/cockroachdb/cockroach/pull/66473
[#66488]: https://github.com/cockroachdb/cockroach/pull/66488
[#66531]: https://github.com/cockroachdb/cockroach/pull/66531
[#66532]: https://github.com/cockroachdb/cockroach/pull/66532
[#66567]: https://github.com/cockroachdb/cockroach/pull/66567
[#66573]: https://github.com/cockroachdb/cockroach/pull/66573
[#66596]: https://github.com/cockroachdb/cockroach/pull/66596
[#66616]: https://github.com/cockroachdb/cockroach/pull/66616
[#66634]: https://github.com/cockroachdb/cockroach/pull/66634
[#66696]: https://github.com/cockroachdb/cockroach/pull/66696
[#66739]: https://github.com/cockroachdb/cockroach/pull/66739
[#66773]: https://github.com/cockroachdb/cockroach/pull/66773
[#66790]: https://github.com/cockroachdb/cockroach/pull/66790

## v21.1.3

This page lists additions and changes in v21.1.3 since v21.1.2.

- For a comprehensive summary of features in v21.1, see the [v21.1 GA release notes](#v21-1-0).
- To upgrade to v21.1, see [Upgrade to CockroachDB v21.1](../v21.1/upgrade-cockroach-version.html).

Get future release notes emailed to you:

{% include marketo.html %}

### Downloads

<div id="os-tabs" class="filters clearfix">
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.3.linux-amd64.tgz"><button id="linux" class="filter-button" data-scope="linux" data-eventcategory="linux-binary-release-notes">Linux</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.3.darwin-10.9-amd64.tgz"><button id="mac" class="filter-button" data-scope="mac" data-eventcategory="mac-binary-release-notes">Mac</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.3.windows-6.2-amd64.zip"><button id="windows" class="filter-button" data-scope="windows" data-eventcategory="windows-binary-release-notes">Windows</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.3.src.tgz"><button id="source" class="filter-button" data-scope="source" data-eventcategory="source-release-notes">Source</button></a>
</div>

<section class="filter-content" data-scope="windows">
{% include windows_warning.md %}
</section>

### Docker image

{% include copy-clipboard.html %}
~~~shell
$ docker pull cockroachdb/cockroach:v21.1.3
~~~

### Security updates

- Syntax errors in the host-based authentication (HBA) configuration in cluster setting `server.host_based_authentication.configuration` are now logged on the [OPS channel](../v21.1/logging.html). [#66128][#66128] {% comment %}doc{% endcomment %}
- The `User` and `ApplicationName` fields of structured events pertaining to SQL queries are now marked as non-sensitive when they contain certain values (`root`/`node` for `User` and values starting with `$` for application names). [#66443][#66443] {% comment %}doc{% endcomment %}

### Enterprise edition changes

- Changefeeds with custom Kafka client configurations (using the `kafka_sink_config` object) that could lead to long delays in flushing messages will now produce an error. [#66265][#66265] {% comment %}doc{% endcomment %}
- The `kafka_sink_config` object now supports a `version` configuration item to specify Kafka server versions. This is likely only necessary for old (Kafka 0.11/Confluent 3.3 or earlier) Kafka servers. Additionally, settings not specified in `kafka_sink_config` now retain their default values. [#66314][#66314] {% comment %}doc{% endcomment %}

### SQL language changes

- [`TRUNCATE`](../v21.1/truncate.html) is now less disruptive on tables with a large amount of concurrent traffic. [#65940][#65940] {% comment %}doc{% endcomment %}
- Creating `STORED` or `VIRTUAL` [computed columns](../v21.1/computed-columns.html) with expressions that reference [foreign key](../v21.1/foreign-key.html) columns is now allowed. [#66168][#66168] {% comment %}doc{% endcomment %}
- The new function [`crdb_internal.get_vmodule`](../v21.1/functions-and-operators.html#system-info-functions) returns the current `vmodule` configuration on the node processing the request. [#63545][#63545] {% comment %}doc{% endcomment %}
- The description string for the `random()` function now clarifies that there are at most 53 bits of randomness available; that is, the function is unsuitable to generate 64-bit random integer values. This behavior is similar to that of PostgreSQL. [#66128][#66128] {% comment %}doc{% endcomment %}
- [`EXPLAIN ANALYZE`](../v21.1/explain-analyze.html) now displays information about the regions on which a statement was executed. [#66368][#66368] {% comment %}doc{% endcomment %}

### Operational changes

- Added a configurable limit to the number of intents collected by a `scan` before aborting, to prevent out-of-memory errors. The setting `storage.mvcc.max_intents_per_error` replaces `storage.sst_export.max_intents_per_error` and covers both `scan` and `export` commands. [#65923][#65923] {% comment %}doc{% endcomment %}
- [`BACKUP`](../v21.1/backup.html) now puts backup data files in a `data` sub-directory of the `BACKUP` path instead of directly in the backup path. [#66161][#66161] {% comment %}doc{% endcomment %}

### Command-line changes

- The informational messages printed out when [`cockroach demo`](../v21.1/cockroach-demo.html) starts have been updated to clarify that certain information is only needed when accessing the demo cluster from another tool. [#66129][#66129] {% comment %}doc{% endcomment %}
- [`cockroach demo`](../v21.1/cockroach-demo.html) and [`cockroach sql`](../v21.1/cockroach-sql.html) are now able to run client-side commands via the `-e` command-line flag. This makes it possible to use commands like `\dt` or `\hf` from a shell script. [#66326][#66326] {% comment %}doc{% endcomment %}

### DB Console changes

- Users can now reset SQL stats from the [DB Console](../v21.1/ui-overview.html). [#65916][#65916] {% comment %}doc{% endcomment %}
- Removed shading on line graphs, improving legibility when viewing more than a few series on the same plot. [#66032][#66032] {% comment %}doc{% endcomment %}
- Drag-to-zoom on metrics graphs now supports time ranges under 10 minutes. [#66032][#66032] {% comment %}doc{% endcomment %}
- In some cases, the Execution Stats page would show a very high Overhead latency for a statement. This could happen due to multiple statements being parsed together or due to statement execution being retried. To avoid this, we no longer consider the time between when parsing ends and execution begins when determining service latency. [#66108][#66108] {% comment %}doc{% endcomment %}
- Improved the style of the password input field for Safari. [#66134][#66134]
- The metrics chart under Overview was renamed from `SQL Queries` to `SQL Statements` to match the naming used under SQL Metrics. [#66364][#66364] {% comment %}doc{% endcomment %}

### Bug fixes

- Fixed a bug which prevented adding columns to tables which contain data and use `NOT NULL` virtual columns [#65973][#65973]
- Fixed a bug in the DB Console where graphs for clusters with decommissioned nodes could show an empty series and data could be incorrectly attributed to the wrong nodes. [#66032][#66032]
- Fixed a bug where queries on `REGIONAL BY ROW` tables could fail in the brief window in which a DROP REGION operation is in progress. [#65984][#65984]
- Fixed a bug where a schema's privilege descriptor could be corrupted upon executing `ALTER DATABASE ... CONVERT TO SCHEMA`, where privileges invalid on a schema were copied from the database, rendering the schema unusable. [#65993][#65993]
- Fixed the error classification for duplicate index names where the later index was a `UNIQUE` index. [#64000][#64000]
- Fixed the error classification for `ALTER TABLE ... ADD CONSTRAINT ... UNIQUE` with the same name as an existing index. [#64000][#64000]
- Fixed a bug that made it less likely for range merges to succeed on clusters using multiple stores per node is now fixed. [#65889][#65889]
- Improved `TRUNCATE` operations to prevent contention issues. [#65940][#65940]
- Improved garbage collection of stale replicas by proactively checking certain replicas that have lost contact with other voting replicas. [#65186][#65186]
- Fixed a bug in `SHOW RANGES` which misattributed localities to nodes when using multiple stores. [#66037][#66037]
- Queries run through the `EXECUTE` statement can now generate statement diagnostic bundles as expected. [#66098][#66098]
- Previously, an `INSERT` causing a foreign key violation could result in an internal error in rare cases. The bug only affected the error response; any affected `INSERT`s (which would have been foreign-key violations) did not succeed. This bug, present since v21.1.0, has been fixed. [#66300][#66300]
- `BACKUP` and other operations can now reuse a previously created S3 client session when operating on the same bucket, which can avoid `NoCredentialProviders` errors on EC2 when interating with large incremental backups. [#66259][#66259]
- The command exit status of `cockroach demo` and `cockroach sql` is now properly set to non-zero (error) after an error is encountered in a client-side command. Additionally, `cockroach sql` and `cockroach demo` now properly stop upon encountering an invalid configuration with `--set`, instead of starting to execute SQL statements after the invalid configuration. [#66326][#66326]
- Improved the availability of the jobs table for reads in large, global clusters by running background tasks at low priority. [#66344][#66344]
- Backups no longer risk the possibility of blocking conflicting writes while being rate limited by the `kv.bulk_io_write.concurrent_export_requests` concurrency limit. [#66408][#66408]
- The `soundex` and `st_difference` [builtin functions](../v21.1/functions-and-operators.html#built-in-functions) for fuzzy string matching now correctly handle `NULL` values. [#66302][#66302]

### Performance improvements

- Fixed an issue in the optimizer that prevented spatial predicates of the form `(column && value) = true` from being index-accelerated. These queries can now use a [spatial index](../v21.1/spatial-indexes.html) if one is available. [#65986][#65986]
- The optimizer is now more efficient when planning queries on tables that have many columns and indexes. [#66304][#66304]
- The `COCKROACHDB_REGISTRY` file is no longer rewritten whenever a new unencrypted file is created. [#66423][#66423] {% comment %}doc{% endcomment %}
- After improvements, queries use up to 1MB less system memory per scan, [lookup join, index join, zigzag join, or inverted join](../v21.1/joins.html) in their query plans. This will result in improved memory performance for workloads with concurrent OLAP-style queries. [#66145][#66145]
- Made improvements to prevent intra-query leaks during disk spilling that could cause the database to run out of memory, especially on tables with wide rows. [#66145][#66145]

### Contributors

This release includes 64 merged PRs by 35 authors.


[#63545]: https://github.com/cockroachdb/cockroach/pull/63545
[#64000]: https://github.com/cockroachdb/cockroach/pull/64000
[#65186]: https://github.com/cockroachdb/cockroach/pull/65186
[#65889]: https://github.com/cockroachdb/cockroach/pull/65889
[#65916]: https://github.com/cockroachdb/cockroach/pull/65916
[#65923]: https://github.com/cockroachdb/cockroach/pull/65923
[#65940]: https://github.com/cockroachdb/cockroach/pull/65940
[#65973]: https://github.com/cockroachdb/cockroach/pull/65973
[#65984]: https://github.com/cockroachdb/cockroach/pull/65984
[#65986]: https://github.com/cockroachdb/cockroach/pull/65986
[#65993]: https://github.com/cockroachdb/cockroach/pull/65993
[#66022]: https://github.com/cockroachdb/cockroach/pull/66022
[#66032]: https://github.com/cockroachdb/cockroach/pull/66032
[#66037]: https://github.com/cockroachdb/cockroach/pull/66037
[#66098]: https://github.com/cockroachdb/cockroach/pull/66098
[#66108]: https://github.com/cockroachdb/cockroach/pull/66108
[#66128]: https://github.com/cockroachdb/cockroach/pull/66128
[#66129]: https://github.com/cockroachdb/cockroach/pull/66129
[#66134]: https://github.com/cockroachdb/cockroach/pull/66134
[#66145]: https://github.com/cockroachdb/cockroach/pull/66145
[#66161]: https://github.com/cockroachdb/cockroach/pull/66161
[#66168]: https://github.com/cockroachdb/cockroach/pull/66168
[#66259]: https://github.com/cockroachdb/cockroach/pull/66259
[#66265]: https://github.com/cockroachdb/cockroach/pull/66265
[#66300]: https://github.com/cockroachdb/cockroach/pull/66300
[#66302]: https://github.com/cockroachdb/cockroach/pull/66302
[#66304]: https://github.com/cockroachdb/cockroach/pull/66304
[#66314]: https://github.com/cockroachdb/cockroach/pull/66314
[#66326]: https://github.com/cockroachdb/cockroach/pull/66326
[#66344]: https://github.com/cockroachdb/cockroach/pull/66344
[#66364]: https://github.com/cockroachdb/cockroach/pull/66364
[#66368]: https://github.com/cockroachdb/cockroach/pull/66368
[#66408]: https://github.com/cockroachdb/cockroach/pull/66408
[#66423]: https://github.com/cockroachdb/cockroach/pull/66423
[#66443]: https://github.com/cockroachdb/cockroach/pull/66443
[#66453]: https://github.com/cockroachdb/cockroach/pull/66453
[#66508]: https://github.com/cockroachdb/cockroach/pull/66508

## v21.1.2

- For a comprehensive summary of features in v21.1, see the [v21.1 GA release notes](#v21-1-0).
- To upgrade to v21.1, see [Upgrade to CockroachDB v21.1](../v21.1/upgrade-cockroach-version.html).

Get future release notes emailed to you:

{% include marketo.html %}

### Downloads

<div id="os-tabs" class="filters clearfix">
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.2.linux-amd64.tgz"><button id="linux" class="filter-button" data-scope="linux" data-eventcategory="linux-binary-release-notes">Linux</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.2.darwin-10.9-amd64.tgz"><button id="mac" class="filter-button" data-scope="mac" data-eventcategory="mac-binary-release-notes">Mac</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.2.windows-6.2-amd64.zip"><button id="windows" class="filter-button" data-scope="windows" data-eventcategory="windows-binary-release-notes">Windows</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.2.src.tgz"><button id="source" class="filter-button" data-scope="source" data-eventcategory="source-release-notes">Source</button></a>
</div>

<section class="filter-content" data-scope="windows">
{% include windows_warning.md %}
</section>

### Docker image

{% include copy-clipboard.html %}
~~~shell
$ docker pull cockroachdb/cockroach:v21.1.2
~~~

### General changes

- Added [multi-region workloads](../v21.1/multi-region-overview.html) for `cockroach demo movr --geo-partitioned-replicas`. Setting `--multi-region` enables for multi-region workloads, and setting `--survive` allows for surviving `AZ` or `REGION` failures. Setting `--infer-crdb-region-column` also infers the `crdb_region` for `REGIONAL BY ROW` tables. [#65642][#65642] {% comment %}doc{% endcomment %}
- [Changefeeds](../v21.1/create-changefeed.html) now better handle slow or unavailable sinks by treating "memory exceeded" errors as retryable. [#65387][#65387] {% comment %}doc{% endcomment %}

### SQL language changes

- Added the `crdb_internal.lost_descriptors_with_data` [function](../v21.1/functions-and-operators.html) to show descriptors that have no entries but data left behind. [#65462][#65462] {% comment %}doc{% endcomment %}
- Added the `crdb_internal.force_delete_table_data` [function](../v21.1/functions-and-operators.html) which allows table data to be cleaned up only using a descriptor ID for cases of table descriptor corruption. [#65462][#65462] {% comment %}doc{% endcomment %}
- The statement type ("tag") is now also included alongside the full text of the SQL query in the various structured log entries produced when query execution is being [logged](../v21.1/logging-overview.html). [#65554][#65554] {% comment %}doc{% endcomment %}
- CockroachDB now returns a SQL Notice if a [`CREATE TABLE IF NOT EXISTS`](../v21.1/create-table.html) command is used to create a `TABLE` and the `TABLE` already exists. [#65636][#65636] {% comment %}doc{% endcomment %}
- The `SHOW FULL TABLE SCANS` statement was added to CockroachDB. [#65671][#65671] {% comment %}doc{% endcomment %}
- CockroachDB now returns a SQL Notice if a [`CREATE TYPE IF NOT EXISTS`](../v21.1/create-type.html) command is used to create a type and the type already exists. [#65635][#65635] {% comment %}doc{% endcomment %}
- Added a `chunk_size` option to [`EXPORT INTO CSV`](../v21.1/export.html) to control the target CSV file size. [#65388][#65388] {% comment %}doc{% endcomment %}
- SQL stats can now be cleared using the `crdb_internal.reset_sql_stats()` function. [#65674][#65674] {% comment %}doc{% endcomment %}
- CockroachDB now supports [`ALTER DATABASE ... ADD REGION IF NOT EXISTS ...`](../v21.1/add-region.html) which does not cause an error when adding a region that is already in the database. [#65752][#65752] {% comment %}doc{% endcomment %}
- CockroachDB now outputs a clearer error message when running [`ALTER DATABASE ... ADD REGION ...`](../v21.1/add-region.html) if the region is an undefined region. Previously, the error message for not having a region defined on a database resulted in an error about enums. [#65752][#65752] {% comment %}doc{% endcomment %}
- Added the [`ALTER DATABASE ... DROP REGION IF EXISTS ...`](../v21.1/drop-region.html) statement syntax, which does not error if dropping a region that is not defined on the database. [#65752][#65752] {% comment %}doc{% endcomment %}
- Fixed a bug where transitioning from locality `REGIONAL BY ROW` to `GLOBAL` or `REGIONAL BY TABLE` could mistakenly remove a zone configuration on an index which has no multi-region fields set. [#65833][#65833] {% comment %}doc{% endcomment %}
- CockroachDB now only blocks a [zone configuration DISCARD](../v21.1/configure-zone.html) on a multi-region table, index, or partition if the multi-region abstractions created the zone configuration. [#65834][#65834] {% comment %}doc{% endcomment %}

### Operational changes

- [Range metrics](../v21.1/ui-replication-dashboard.html) are now gathered from the leaseholder (if live) rather than the first available range replica. This avoids scenarios where a stale replica may yield incorrect metrics, in particular over/underreplication markers. [#64590][#64590] {% comment %}doc{% endcomment %}

### DB Console changes

- Fixed [Jobs page](../v21.1/ui-jobs-page.html) crash while using pagination and improved its performance. [#65723][#65723]
- Fixed a typo on the Network tooltip on the [Statements page](../v21.1/ui-statements-page.html). [#65605][#65605]
- Fixed a missing node ID in the rejoin [event message](../v21.1/ui-runtime-dashboard.html#events-panel) [#65806][#65806]
- Sorts on tables now pick up the correct value from the URL. [#65605][#65605]

### Bug fixes

- Fixed a bug where a certain percentage of cases in which a node could have served a [follower read](../v21.1/follower-reads.html) were not handled correctly, resulting in the node routing the request to another nearby node for no reason. [#65471][#65471]
- The [`has_database_privilege`](../v21.1/functions-and-operators.html) function now correctly will check privileges on databases that are not the current database being used by the session. [#65534][#65534]
- Fixed a bug where CockroachDB would previously crash when attempting to create a table using [`CREATE TABLE ... AS`](../v21.1/create-table-as.html) syntax where the `AS` clause selects from `crdb_internal.node_statement_statistics`, `crdb_internal.node_transaction_statistics`, or `crdb_internal.node_txn_stats` virtual tables. [#65542][#65542]
- Fixed a bug which allowed [index definitions](../v21.1/indexes.html) with redundant columns, which led to unnecessary storage usage. This bug can notably manifest itself with [`ALTER TABLE`](../v21.1/alter-table.html) statements which alter the primary index on a partitioned table. This bug has been present for a long time in theory, but in practice would only appear in CockroachDB since version 21.1.0. [#65482][#65482]
- Fixed a bug where binary [`TIMETZ`](../v21.1/time.html) values were not being decoded correctly when being sent as a parameter in the wire protocol. [#65341][#65341]
- Fixed a race condition during transaction cleanup that could leave old transaction records behind until [MVCC garbage collection](../v21.1/architecture/storage-layer.html#mvcc). [#65383][#65383]
- Improved [transaction cleanup](../v21.1/architecture/transaction-layer.html) for disconnected clients, to reduce intent buildup. [#65383][#65383]
- Added the ability to change the `COMMENT` on a column after using [`ALTER TYPE`](../v21.1/alter-type.html) on that column. [#65698][#65698]
- [Scheduled backup](../v21.1/create-schedule-for-backup.html) with [interleaved tables](../v21.1/interleave-in-parent.html) can now be created with the `include_deprecated_interleaves` option. [#65731][#65731]
- Fixed a bug where `ST_Node` on a [`LINESTRING`](../v21.1/linestring.html) with the same repeated points results in an error. [#65700][#65700]
- Calling [`get_bit` or `set_bit`](../v21.1/functions-and-operators.html) on a byte array argument now goes to the correct index of the underlying bit string, in order to match the behavior of Postgres. [#65786][#65786]
- Fixed a bug where [`ALTER DATABASE ... CONVERT TO SCHEMA`](../v21.1/convert-to-schema.html) could potentially leave the schema with invalid privileges thus causing the privilege descriptor to be invalid. [#65810][#65810]
- CockroachDB now renders the `CACHE` clause for [sequences](../v21.1/create-sequence.html) which use a cache. [#65805][#65805]
- Fixed a bug that could cause a node to crash in rare cases if a [`BACKUP`](../v21.1/backup.html) writing to Google Cloud Storage failed. [#65802][#65802]
- Fixed a bug introduced in 21.1 where [cluster restores](../v21.1/restore.html) would report inaccurate progress, showing 100% progress erroneously. [#65803][#65803]
- Fixed a crash when performing a cluster [`BACKUP`](../v21.1/backup.html) with revision history of a cluster upgraded from 20.1 to 20.2 to 21.1 which contains tables that were truncated by 20.1. [#65860][#65860]
- Fixed a bug that caused incorrect results for queries where [`CHAR` and `VARCHAR`](../v21.1/string.html#related-types) columns are filtered by constant string values. The bug was present since version v21.1.0. [#66101][#66101]

### Performance improvements

- The [optimizer](../v21.1/cost-based-optimizer.html) can now avoid full table scans for queries with a [`LIMIT`](../v21.1/limit-offset.html) and [`ORDER BY`](../v21.1/order-by.html) clause in some additional cases where the `ORDER BY` columns are not a prefix of an index. [#65392][#65392]
- The [optimizer](../v21.1/cost-based-optimizer.html) now generates query plans that scan indexes on virtual collated string columns, regardless of the casing or formatting of the collated locale in the query. [#65531][#65531]
- CockroachDB now reduces the number of round-trips required to call `pg_table_is_visible` in the context of [`pg_catalog` queries](../v21.1/pg-catalog.html). [#65807][#65807]

### Contributors

This release includes 58 merged PRs by 34 authors.
We would like to thank the following contributors from the CockroachDB community:

- Max Neverov
- Rupesh Harode

[#64590]: https://github.com/cockroachdb/cockroach/pull/64590
[#65341]: https://github.com/cockroachdb/cockroach/pull/65341
[#65383]: https://github.com/cockroachdb/cockroach/pull/65383
[#65387]: https://github.com/cockroachdb/cockroach/pull/65387
[#65388]: https://github.com/cockroachdb/cockroach/pull/65388
[#65392]: https://github.com/cockroachdb/cockroach/pull/65392
[#65462]: https://github.com/cockroachdb/cockroach/pull/65462
[#65471]: https://github.com/cockroachdb/cockroach/pull/65471
[#65482]: https://github.com/cockroachdb/cockroach/pull/65482
[#65531]: https://github.com/cockroachdb/cockroach/pull/65531
[#65534]: https://github.com/cockroachdb/cockroach/pull/65534
[#65542]: https://github.com/cockroachdb/cockroach/pull/65542
[#65554]: https://github.com/cockroachdb/cockroach/pull/65554
[#65605]: https://github.com/cockroachdb/cockroach/pull/65605
[#65635]: https://github.com/cockroachdb/cockroach/pull/65635
[#65636]: https://github.com/cockroachdb/cockroach/pull/65636
[#65642]: https://github.com/cockroachdb/cockroach/pull/65642
[#65671]: https://github.com/cockroachdb/cockroach/pull/65671
[#65674]: https://github.com/cockroachdb/cockroach/pull/65674
[#65698]: https://github.com/cockroachdb/cockroach/pull/65698
[#65700]: https://github.com/cockroachdb/cockroach/pull/65700
[#65723]: https://github.com/cockroachdb/cockroach/pull/65723
[#65731]: https://github.com/cockroachdb/cockroach/pull/65731
[#65752]: https://github.com/cockroachdb/cockroach/pull/65752
[#65786]: https://github.com/cockroachdb/cockroach/pull/65786
[#65802]: https://github.com/cockroachdb/cockroach/pull/65802
[#65803]: https://github.com/cockroachdb/cockroach/pull/65803
[#65805]: https://github.com/cockroachdb/cockroach/pull/65805
[#65806]: https://github.com/cockroachdb/cockroach/pull/65806
[#65807]: https://github.com/cockroachdb/cockroach/pull/65807
[#65810]: https://github.com/cockroachdb/cockroach/pull/65810
[#65833]: https://github.com/cockroachdb/cockroach/pull/65833
[#65834]: https://github.com/cockroachdb/cockroach/pull/65834
[#65860]: https://github.com/cockroachdb/cockroach/pull/65860
[#66101]: https://github.com/cockroachdb/cockroach/pull/66101

## v21.1.1

- For a comprehensive summary of features in v21.1, see the [v21.1 GA release notes](#v21-1-0).
- To upgrade to v21.1, see [Upgrade to CockroachDB v21.1](../v21.1/upgrade-cockroach-version.html).

Get future release notes emailed to you:

{% include marketo.html %}


### Downloads

<div id="os-tabs" class="filters clearfix">
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.1.linux-amd64.tgz"><button id="linux" class="filter-button" data-scope="linux" data-eventcategory="linux-binary-release-notes">Linux</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.1.darwin-10.9-amd64.tgz"><button id="mac" class="filter-button" data-scope="mac" data-eventcategory="mac-binary-release-notes">Mac</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.1.windows-6.2-amd64.zip"><button id="windows" class="filter-button" data-scope="windows" data-eventcategory="windows-binary-release-notes">Windows</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.1.src.tgz"><button id="source" class="filter-button" data-scope="source" data-eventcategory="source-release-notes">Source</button></a>
</div>

<section class="filter-content" data-scope="windows">
{% include windows_warning.md %}
</section>

### Docker image

{% include copy-clipboard.html %}
~~~shell
$ docker pull cockroachdb/cockroach:v21.1.1
~~~


### General changes

- Disabled read-triggered compactions to avoid instances where the [storage engine](../v21.1/architecture/storage-layer.html) would compact excessively. [#65345][#65345]

### SQL language changes

- Fixed [Julian date](https://en.wikipedia.org/wiki/Julian_day) parsing logic for wrong formats. [#63540][#63540]
- The error payload returned to the client when a [`DATE`](../v21.1/date.html)/[`TIME`](../v21.1/time.html) conversion fails now contains more details about the difference between the values provided and the values that are expected. [#63540][#63540] {% comment %}doc{% endcomment %}
- Introduced `ALTER TABLE ... ALTER COLUMN SET [VISIBLE|NOT VISIBLE]`, which marks columns as visible/not visible. [#63881][#63881] {% comment %}doc{% endcomment %}
- When using [`ALTER TABLE ... LOCALITY REGIONAL BY ROW`](../v21.1/set-locality.html), we would previously verify uniqueness of the new table, which was an unnecessary operation. This verification has been removed, improving the performance of updating localities to or from `REGIONAL BY ROW`. [#63880][#63880] {% comment %}doc{% endcomment %}
- Improved cancellation behavior for [DistSQL](../v21.1/architecture/sql-layer.html) flows. [#65047][#65047] {% comment %}doc{% endcomment %}
- [`ST_EstimatedExtent`](../v21.1/functions-and-operators.html#spatial-functions) now always returns `NULL`. This allows [GeoServer](http://geoserver.org/) to make progress in certain cases, and is a valid default return value for the function. [#65098][#65098] {% comment %}doc{% endcomment %}
- Implemented `ST_Envelope` for [`Box2D`](../v21.1/spatial-glossary.html#data-types). [#65098][#65098] {% comment %}doc{% endcomment %}
- Implemented a subset of variants for `ST_AsTWKB`, which encodes a geometry into a [`TWKB`](https://github.com/TWKB/Specification/blob/master/twkb.md) format. This allows the use of [GeoServer](https://docs.geoserver.org/latest/en/user/) with CRDB if the user selects "PreserveTopology" for their "Method used to simplify geometries" option on the "Store" page. [#65098][#65098] {% comment %}doc{% endcomment %}
- Implemented `ST_Simplify` with [`preserveCollapsed`](https://postgis.net/docs/ST_Simplify.html) support. This unblocks the use of GeoServer with the default settings. [#65098][#65098] {% comment %}doc{% endcomment %}
- [Lookup joins](../v21.1/joins.html) on indexes with [computed columns](../v21.1/computed-columns.html) which are also either constrained by [`CHECK`](../v21.1/check.html) constraints or use an [`ENUM`](../v21.1/enum.html) data type may now choose a more optimal plan. [#65361][#65361] {% comment %}doc{% endcomment %}
- Floating point infinity values are now formatted as `Infinity` (or `-Infinity` if negative). This is for compatibility with PostgresSQL. [#65334][#65334] {% comment %}doc{% endcomment %}
- [`INSERT INTO ... ON CONFLICT ... DO UPDATE SET`](../v21.1/insert.html) statements without predicates now acquire locks using the `FOR UPDATE` locking mode during their initial row scan, which improves performance for contended workloads. This behavior is configurable using the `enable_implicit_select_for_update` [session variable](../v21.1/set-vars.html) and the `sql.defaults.implicit_select_for_update.enabled` [cluster setting](../v21.1/cluster-settings.html). [#65363][#65363] {% comment %}doc{% endcomment %}
- [`ST_GeomFromGeoJSON(string)`](../v21.1/functions-and-operators.html#spatial-functions) is now marked as the preferred overload, meaning it will resolve correctly in more contexts. [#65442][#65442] {% comment %}doc{% endcomment %}

### Operational changes

- [Replica garbage collection](../v21.1/architecture/storage-layer.html#garbage-collection) now checks replicas against the range descriptor every 12 hours (down from 10 days) to see if they should be removed. Replicas that fail to notice they have been removed from a range will therefore linger for at most 12 hours rather than 10 days. [#64589][#64589]

### Command-line changes

- The `--help` text for [`--log`](../v21.1/configure-logs.html) now references the fact that the flag accepts YAML syntax and also points to the `cockroach debug check-log-config` command. [#64948][#64948]
- The new parameter `--log-config-file` simplifies the process of loading the logging configuration from a YAML file. Instead of passing the content of the file via the `--log` flag (e.g., `--log=$(cat file.yaml)`), it is now possible to pass the path to the file using `--log-config-file=file.yaml`. <br>**Note:** Each occurrence of `--log` and `--log-config-file` on the command line overrides the configuration set from previous occurrences. [#64948][#64948] {% comment %}doc{% endcomment %}
- The prefixes displayed before connection URLs when [`cockroach demo`](../v21.1/cockroach-demo.html) starts up have been updated to better align with the output of [`cockroach start`](../v21.1/cockroach-start.html). [#63535][#63535] {% comment %}doc{% endcomment %}
- The flag `--empty` for `cockroach demo` has been renamed to `--no-example-database`. `--empty` is still recognized but is marked as deprecated. Additionally, the user can now set the environment variable `COCKROACH_NO_EXAMPLE_DATABASE` to obtain this behavior automatically in every new demo session. [#63535][#63535] {% comment %}doc{% endcomment %}
- CockroachDB no longer supports the `\demo add` and `\demo shutdown` commands for `cockroach demo` in `--global` configurations. [#63535][#63535] {% comment %}doc{% endcomment %}
- Added a note when starting up a `--global` demo cluster that the `--global` configuration is experimental. [#63535][#63535] {% comment %}doc{% endcomment %}
- The SQL shell (`cockroach demo`, [`cockroach sql`](../v21.1/cockroach-sql.html)) now attempts to better format values that are akin to time/date values, as well as floating-point numbers. [#63541][#63541] {% comment %}doc{% endcomment %}
- [`cockroach debug zip`](../v21.1/cockroach-debug-zip.html) now attempts to pull data from multiple nodes concurrently, up to 15 nodes at a time. This change is meant to accelerate the data collection when a cluster contains multiple nodes. This behavior can be changed with the new command-line flag `--concurrency`. [#64705][#64705] {% comment %}doc{% endcomment %}
- The format of the informational messages printed by `cockroach debug zip` , when concurrent execution is enabled. [#64705][#64705] {% comment %}doc{% endcomment %}
- The new command `cockroach debug list-files` show the list of files that can be retrieved via the `cockroach debug zip` command. It supports the `--nodes` and `--exclude-nodes` parameters in the same way as `cockroach debug zip`. [#64705][#64705] {% comment %}doc{% endcomment %}
- It is now possible to fine-tune which files get retrieved from the server nodes by the `cockroach debug zip` command, using the new flag `--include-files` and `--exclude-files`. These flags take glob patterns that are applied to the file names server-side. For example, to include only log files, use `--include-files='*.log'`.  The command `cockroach debug list-files` also accepts these flags and can thus be used to experiment with the new flags before running the `cockroach debug zip` command. [#64705][#64705] {% comment %}doc{% endcomment %}
- The `cockroach debug zip` command now retrieves only the log files, goroutine dumps and heap profiles pertaining to the last 48 hours prior to the command invocation.  This behavior is supported entirely client-side, which means that it is not necessary to upgrade the server nodes to put these newly-configurable limits in place.  The other data items retrieved by `cockroach debug zip` are not affected by this time limit.  This behavior can be customized by the two new flags `--files-from` and `--files-until`. Both are optional. See the command-line help text for details.  The two new flags are also supported by `cockroach debug list-files`. It is advised to experiment with `list-files` prior to issuing a `debug zip` command that may retrieve a large amount of data. [#64705][#64705] {% comment %}doc{% endcomment %}

### DB Console changes

- A [new metric](../v21.1/ui-overview.html) for the average number of runnable goroutines per CPU is now present in the runtime graphs. [#64750][#64750] {% comment %}doc{% endcomment %}
- The Console now uses a new library for line graphs that renders metrics more efficiently. Customers with large clusters can now load and interact with metrics much faster than before. [#64479][#64479]
- Placed a legend under charts on [metrics page](../v21.1/ui-overview-dashboard.html), if more than 10 series are being displayed [#64479][#64479] {% comment %}doc{% endcomment %}

### Bug fixes

- Fixed a bug in the artificial latencies introduced by the `--global` flag to [`cockroach demo`](../v21.1/cockroach-demo.html). [#63535][#63535]
- Fixed a bug where multiple concurrent invocations of [`cockroach debug zip`](../v21.1/cockroach-debug-zip.html) could yield cluster instability. This bug had been present since CockroachDB v20.1. [#64083][#64083]
- When a [`STRING`](../v21.1/string.html) value is converted to [`TIME`](../v21.1/time.html)/[`DATE`](../v21.1/date.html)/[`TIMESTAMP`](../v21.1/timestamp.html), and the `STRING` value contains invalid entries, the error messages reported now more clearly report which fields are missing or undesired. [#63540][#63540]
- Fixed a bug where view expressions created using an [`ARRAY`](../v21.1/array.html) [`ENUM`](../v21.1/enum.html) without a name for the column could cause failures when dropping unrelated `ENUM` values. [#64272][#64272]
- Fixed a bug causing an internal error in rare circumstances when executing queries via the [vectorized engine](../v21.1/vectorized-execution.html) that operate on columns of [`BOOL`](../v21.1/bool.html), [`BYTES`](../v21.1/bytes.html), [`INT`](../v21.1/int.html), and [`FLOAT`](../v21.1/float.html) types that have a mix of [`NULL`](../v21.1/null-handling.html) and non-`NULL` values. [#62915][#62915]
- Fixed a bug causing CockroachDB to either return an error or crash when comparing an infinite `DATE` coming from a subquery against a `TIMESTAMP`. [#64074][#64074]
- CockroachDB now should crash less often due to out-of-memory conditions caused by the [subqueries](../v21.1/subqueries.html) returning multiple rows of large size. [#64727][#64727]
- Previously, the [session trace](../v21.1/show-trace.html) could contain entries that corresponded to the previous trace (i.e., `SET TRACING=ON` didn't properly reset the trace). Now this is fixed. [#64945][#64945]
- Previously, CockroachDB could incorrectly cast [integers](../v21.1/int.html) of larger widths to integers of smaller widths (e.g., `INT8` to `INT2`) when the former was out of range for the latter. Now this is fixed. [#65035][#65035]
- Fixed a race condition where read-write requests during replica removal (e.g., during range merges or rebalancing) could be evaluated on the removed replica. [#64598][#64598]
- [`BACKUP`](../v21.1/backup.html) no longer resolves intents one-by-one. This eliminates the need to run a high-priority query to cleanup intents to unblock `BACKUP` in the case of intent buildup. [#64881][#64881]
- Fixed an internal error that could occur during planning when a query used the output of an [`UPDATE`](../v21.1/update.html)'s `RETURNING` clause, and one or more of the columns in the `RETURNING` clause were from a table specified in the `FROM` clause of the `UPDATE` (i.e., not from the table being updated). [#62960][#62960]
- Fixed an index-out-of-range error that could occur when `crdb_internal_mvcc_timestamp` was selected as part of a [`view`](../v21.1/views.html). It is now possible to select `crdb_internal_mvcc_timestamp` as part of a view as long as it is aliased with a different name. [#63632][#63632]
- Fixed a bug in the application of environment variables to populate defaults for certain [command-line flags](../v21.1/cockroach-commands.html), for example `COCKROACH_URL` for `--url`, has been fixed. [#63539][#63539]
- Fixed a stack overflow that can happen in some corner cases involving [partial indexes](../v21.1/partial-indexes.html) with predicates containing `(x IS NOT NULL)`. [#64738][#64738]
- Providing a constant value as an [`ORDER BY`](../v21.1/order-by.html) value in an ordered-set [aggregate](../v21.1/functions-and-operators.html#aggregate-functions), such as `percentile_dist` or `percentile_cont`, no longer returns an error. This bug has been present since order-set aggregates were added in version 20.2. [#64902][#64902]
- Queries that reference tables with [`GEOMETRY` or `GEOGRAPHY`](../v21.1/spatial-glossary.html#data-types) [inverted indexes](../v21.1/inverted-indexes.html) and that call [geospatial functions](../v21.1/functions-and-operators.html#spatial-functions) with constant [`NULL`](../v21.1/null-handling.html) values cast to a type, like `NULL::GEOMETRY` or `NULL::FLOAT8`, no longer error. This bug was present since 20.2. [#63003][#63003]
- Fixed a bug causing CockroachDB to incorrectly calculate the latency from the remote nodes when the latency info was shown on the [`EXPLAIN ANALYZE (DISTSQL)`](../v21.1/explain-analyze.html) diagrams. [#63089][#63089]
- Fixed a bug causing the [`ZONECONFIG` privilege](../v21.1/authorization.html#privileges) on tables and databases to be incorrectly interpreted as `USAGE`, which could corrupt a table and/or database because `USAGE` is an invalid privilege for tables and databases. [#65160][#65160]
- Fixed a bug which could cause a panic when running an `EXECUTE` of a previously-prepared statement with a `REGCLASS` or `REGTYPE` parameter or a [user-defined type](../v21.1/enum.html) argument after running [`BEGIN AS OF SYSTEM TIME`](../v21.1/as-of-system-time.html) with an invalid timestamp. [#65150][#65150]
- Fixed a bug which could cause a panic when issuing a query referencing a [user-defined type](../v21.1/enum.html) as a placeholder. [#65150][#65150]
- Fixed a bug introduced in 20.2 that caused rows to be incorrectly de-duplicated from a scan with a non-unique index. [#65284][#65284]
- Fixed a bug where interval math on a [`TIMESTAMPTZ`](../v21.1/timestamp.html) value on a DST boundary would incorrectly add or subtract an extra hour. [#65095][#65095]
- Fixed a bug where `date_trunc` on a [`TIME`](../v21.1/time.html) value on a DST boundary could switch timezones and produce the incorrect result. [#65095][#65095]
- Improved memory utilization under some write-heavy workloads, added better logging to [storage engine](../v21.1/architecture/storage-layer.html) to surface compaction type, and persisted previously-missing Pebble options in `OPTIONS` file. [#65308][#65308]
- Fixed a bug causing `revision_history` cluster [backups](../v21.1/backup.html) to not include dropped databases. This means that, previously, dropped databases could not be restored from backups that were taken after the database was dropped. [#65314][#65314]
- Fixed a bug causing [`SHOW CREATE TABLE`](../v21.1/show-create.html) output to not display the [zone configurations](../v21.1/configure-zone.html) of a table or index if there were no partitions, even if there were zone configurations on the index or table. [#65176][#65176]
- Previously, concatenating a non-[`STRING`](../v21.1/string.html) value with a `STRING` value would not use the normal `STRING` representation of the non-`STRING` value. Now it does, so `true || 'string'` returns `truestring` instead of `tstring`. [#65331][#65331]
- Large [`SELECT FOR UPDATE`](../v21.1/selection-queries.html) scans will no longer prevent the memory associated with their entire result set from being reclaimed by the Go garbage collector for the lifetime of the locks that they acquire. [#65359][#65359]
- Fixed a rare race that could lead to a 3-second stall before a [Raft leader](../v21.1/architecture/replication-layer.html) was elected on a Range immediately after it was split off from its left-hand neighbor. [#65356][#65356]
- Fixed a bug where `SHOW CREATE TABLE` would show the zone configurations of a table of the same name from a different schema. [#65368][#65368]
- [`BACKUP`](../v21.1/backup.html), [`RESTORE`](../v21.1/restore.html), and [`IMPORT`](../v21.1/import.html) are now more resilient to node failures and will retry automatically. [#65391][#65391]
- Previously, replica rebalancing could sometimes rebalance to stores on dead nodes. This bug is now fixed. [#65428][#65428]

### Performance improvements

- The optimizer now always prefers to plan a [locality-optimized](../v21.1/multiregion-overview.html) scan over a regular scan when possible. This may enable the execution engine to avoid communicating with remote nodes, thus reducing query latency. [#65088][#65088]
- The optimizer will now try to plan anti lookup joins using "locality-optimized search". This optimization applies for anti lookup joins into [`REGIONAL BY ROW`](../v21.1/multiregion-overview.html#regional-by-row-tables) tables (i.e., the right side of the join is a `REGIONAL BY ROW` table), and if enabled, it means that the execution engine will first search locally for matching rows before searching remote nodes. If a matching row is found in a local node, remote nodes will not be searched. This optimization may improve the performance of [foreign key](../v21.1/foreign-key.html) checks when rows are inserted or updated in a table that references a foreign key in a `REGIONAL BY ROW` table. [#63118][#63118]
- Certain queries containing `<tuple> IN (<subquery>)` conditions now run faster. [#63866][#63866]
- Improved intent cleanup performance for aborted transactions. [#64588][#64588]
- Adjusted the estimated cost of locality-optimized anti joins in the optimizer so that they are always chosen over non-locality-optimized anti joins when possible. This makes it more likely that queries involving anti joins (such as inserts with foreign key checks) can avoid visiting remote regions. This results in lower latency. [#65131][#65131]
- The optimizer can now avoid full table scans for queries with a `LIMIT` and [`ORDER BY`](../v21.1/order-by.html) clause, where the `ORDER BY` columns form a prefix on an index in a `REGIONAL BY ROW` table (excluding the hidden `crdb_region` column). Instead of a full table scan, at most `LIMIT` rows are scanned per region. [#65287][#65287]

### Contributors

This release includes 100 merged PRs by 33 authors.
We would like to thank the following contributors from the CockroachDB community:

- Kumar Akshay
- Mohammad Aziz (first-time contributor)
- kurokochin (first-time contributor)

[#62915]: https://github.com/cockroachdb/cockroach/pull/62915
[#62960]: https://github.com/cockroachdb/cockroach/pull/62960
[#63003]: https://github.com/cockroachdb/cockroach/pull/63003
[#63089]: https://github.com/cockroachdb/cockroach/pull/63089
[#63118]: https://github.com/cockroachdb/cockroach/pull/63118
[#63535]: https://github.com/cockroachdb/cockroach/pull/63535
[#63539]: https://github.com/cockroachdb/cockroach/pull/63539
[#63540]: https://github.com/cockroachdb/cockroach/pull/63540
[#63541]: https://github.com/cockroachdb/cockroach/pull/63541
[#63632]: https://github.com/cockroachdb/cockroach/pull/63632
[#63866]: https://github.com/cockroachdb/cockroach/pull/63866
[#63880]: https://github.com/cockroachdb/cockroach/pull/63880
[#63881]: https://github.com/cockroachdb/cockroach/pull/63881
[#64074]: https://github.com/cockroachdb/cockroach/pull/64074
[#64083]: https://github.com/cockroachdb/cockroach/pull/64083
[#64272]: https://github.com/cockroachdb/cockroach/pull/64272
[#64479]: https://github.com/cockroachdb/cockroach/pull/64479
[#64588]: https://github.com/cockroachdb/cockroach/pull/64588
[#64589]: https://github.com/cockroachdb/cockroach/pull/64589
[#64598]: https://github.com/cockroachdb/cockroach/pull/64598
[#64705]: https://github.com/cockroachdb/cockroach/pull/64705
[#64727]: https://github.com/cockroachdb/cockroach/pull/64727
[#64738]: https://github.com/cockroachdb/cockroach/pull/64738
[#64750]: https://github.com/cockroachdb/cockroach/pull/64750
[#64881]: https://github.com/cockroachdb/cockroach/pull/64881
[#64902]: https://github.com/cockroachdb/cockroach/pull/64902
[#64945]: https://github.com/cockroachdb/cockroach/pull/64945
[#64948]: https://github.com/cockroachdb/cockroach/pull/64948
[#65035]: https://github.com/cockroachdb/cockroach/pull/65035
[#65047]: https://github.com/cockroachdb/cockroach/pull/65047
[#65088]: https://github.com/cockroachdb/cockroach/pull/65088
[#65095]: https://github.com/cockroachdb/cockroach/pull/65095
[#65098]: https://github.com/cockroachdb/cockroach/pull/65098
[#65131]: https://github.com/cockroachdb/cockroach/pull/65131
[#65150]: https://github.com/cockroachdb/cockroach/pull/65150
[#65160]: https://github.com/cockroachdb/cockroach/pull/65160
[#65176]: https://github.com/cockroachdb/cockroach/pull/65176
[#65284]: https://github.com/cockroachdb/cockroach/pull/65284
[#65287]: https://github.com/cockroachdb/cockroach/pull/65287
[#65308]: https://github.com/cockroachdb/cockroach/pull/65308
[#65314]: https://github.com/cockroachdb/cockroach/pull/65314
[#65331]: https://github.com/cockroachdb/cockroach/pull/65331
[#65334]: https://github.com/cockroachdb/cockroach/pull/65334
[#65345]: https://github.com/cockroachdb/cockroach/pull/65345
[#65356]: https://github.com/cockroachdb/cockroach/pull/65356
[#65357]: https://github.com/cockroachdb/cockroach/pull/65357
[#65358]: https://github.com/cockroachdb/cockroach/pull/65358
[#65359]: https://github.com/cockroachdb/cockroach/pull/65359
[#65361]: https://github.com/cockroachdb/cockroach/pull/65361
[#65363]: https://github.com/cockroachdb/cockroach/pull/65363
[#65368]: https://github.com/cockroachdb/cockroach/pull/65368
[#65391]: https://github.com/cockroachdb/cockroach/pull/65391
[#65428]: https://github.com/cockroachdb/cockroach/pull/65428
[#65442]: https://github.com/cockroachdb/cockroach/pull/65442

## v21.1.0

With the release of CockroachDB v21.1, we've made a variety of flexibility, performance, and compatibility improvements. Check out a [summary of the most significant user-facing changes](#feature-summary) and then [upgrade to CockroachDB v21.1](../v21.1/upgrade-cockroach-version.html).

To learn more:

- Read the [v21.1 blog post](https://www.cockroachlabs.com/blog/cockroachdb-21-1-release).
- Join us on May 19 for a [livestream on why multi-region applications](https://www.cockroachlabs.com/webinars/the-cockroach-hour-multi-region/) matter and how our Product and Engineering teams partnered to make them simple in v21.1.

### Downloads

<div id="os-tabs" class="filters clearfix">
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.0.linux-amd64.tgz"><button id="linux" class="filter-button" data-scope="linux" data-eventcategory="linux-binary-release-notes">Linux</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.0.darwin-10.9-amd64.tgz"><button id="mac" class="filter-button" data-scope="mac" data-eventcategory="mac-binary-release-notes">Mac</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.0.windows-6.2-amd64.zip"><button id="windows" class="filter-button" data-scope="windows" data-eventcategory="windows-binary-release-notes">Windows</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.0.src.tgz"><button id="source" class="filter-button" data-scope="source" data-eventcategory="source-release-notes">Source</button></a>
</div>

<section class="filter-content" data-scope="windows">
{% include windows_warning.md %}
</section>

### Docker image

{% include copy-clipboard.html %}
~~~ shell
$ docker pull cockroachdb/cockroach:v21.1.0
~~~

### CockroachCloud

- <a href="https://cockroachlabs.cloud/signup?referralId=docs_crdb_release_notes" rel="noopener" target="_blank">Get a free v21.1 cluster on CockroachCloud</a>.
- Learn about recent updates to CockroachCloud in the [CockroachCloud Release Notes](index-cockroachcloud.html).

### Feature summary

This section summarizes the most significant user-facing changes in v21.1.0. For a complete list of features and changes, including bug fixes and performance improvements, see the [release notes](index.html#testing-releases) for previous testing releases. You can also search for [what's new in v21.1 in our docs](../search.html?query=%22New%20in%20v21.1%22&page=2).

{{site.data.alerts.callout_info}}
"Core" features are freely available in the core version and do not require an enterprise license. "Enterprise" features require an [enterprise license](https://www.cockroachlabs.com/get-cockroachdb/). [CockroachCloud clusters](https://cockroachlabs.cloud/) include all enterprise features. You can also use [`cockroach demo`](../v21.1/cockroach-demo.html) to test enterprise features in a local, temporary cluster.
{{site.data.alerts.end}}

- [SQL](#sql)
- [Recovery and I/O](#recovery-and-i-o)
- [Database Operations](#database-operations)
- [Backward-incompatible changes](#backward-incompatible-changes)
- [Deprecations](#deprecations)
- [Known limitations](#known-limitations)
- [Education](#education)

<style>
    table td:first-child {
        min-width: 100px !important;
    }
    table td:nth-child(2) {
        min-width: 200px !important;
    }
</style>

#### SQL

Version | Feature | Description
--------|---------|------------
Enterprise | **Multi-Region Improvements** | It is now much easier to leverage CockroachDB's low-latency and resilient multi-region capabilities. For an introduction to the high-level concepts, see the [Multi-Region Overview](../v21.1/multiregion-overview.html). For further details and links to related SQL statements, see [Choosing a Multi-Region Configuration](../v21.1/choosing-a-multi-region-configuration.html), [When to Use ZONE vs. REGION Survival Goals](../v21.1/when-to-use-zone-vs-region-survival-goals.html), and [When to Use REGIONAL vs. GLOBAL Tables](../v21.1/when-to-use-regional-vs-global-tables.html). For a demonstration of these capabilities using a local cluster, see the [Multi-Region Tutorial](../v21.1/demo-low-latency-multi-region-deployment.html). Finally, for details about related architectural enhancements, see [Non-Voting Replicas](../v21.1/architecture/replication-layer.html#non-voting-replicas) and [Non-Blocking Transactions](../v21.1/architecture/transaction-layer.html#non-blocking-transactions).
Enterprise | **Automatic Follower Reads for Read-Only Transactions** | You can now force all read-only transactions in a session to use [follower reads](../v21.1/follower-reads.html) by setting the new [`default_transaction_use_follow_reads` session variable](../v21.1/show-vars.html#supported-variables) to `on`.
Core | **Query Observability Improvements** | [`EXPLAIN`](../v21.1/explain.html) and [`EXPLAIN ANALYZE`](../v21.1/explain-analyze.html) responses have been unified and extended with additional details, including automatic statistics-backed row estimates for `EXPLAIN`, and maximum memory usage, network usage, nodes used per operator, and rows used per operator for `EXPLAIN ANALYZE`. `EXPLAIN ANALYZE` now outputs a text-based statement plan tree by default, showing statistics about the statement processors at each phase of the statement.<br><br>The [Transactions Page](../v21.1/ui-transactions-page.html) and [Statements Page](../v21.1/ui-statements-page.html) of the DB Console also include such details as well the mean average time statements were in contention with other transactions within a specified time interval. The [SQL Dashboard](../v21.1/ui-sql-dashboard.html) has been expanded with additional graphs for latency, contention, memory, and network traffic. The [SQL Tuning with `EXPLAIN`](../v21.1/sql-tuning-with-explain.html) tutorial and [Optimize Statement Performance](../v21.1/make-queries-fast.html) guidance have been updated to leverage these improvements.
Core | **Inverted Joins** | CockroachDB now supports [inverted joins](../v21.1/joins.html#inverted-joins), which force the optimizer to use an inverted index on the right side of the join. Inverted joins can only be used with `INNER` and `LEFT` joins.
Core | **Partial Inverted Indexes** | You can now create a [partial inverted index](../v21.1//inverted-indexes.html#partial-inverted-indexes) on a subset of `JSON`, `ARRAY`, or geospatial container column data.
Core | **Virtual Computed Columns** | You can now create [virtual computed columns](../v21.1/computed-columns.html), which are not stored on disk and are recomputed as the column data in the expression changes.
Core | **Dropping Values in User-Defined Types** | It's now possible to [drop values in user-defined types](../v21.1/alter-type.html#drop-a-value-in-a-user-defined-type).
Core | **Sequence Caching** | You can now create a sequence with the [`CACHE`](../v21.1/create-sequence.html#cache-sequence-values-in-memory) keyword to have the sequence cache its values in memory.  
Core | **Changing Sequence & View Ownership** | You can use the new `OWNER TO` parameter to change the owner of a [sequence](../v21.1/alter-sequence.html) or [view](../v21.1/alter-view.html).  
Core | **Show `CREATE` Statements for the Current Database** | You can now use [`SHOW CREATE ALL TABLES`](../v21.1/show-create.html#show-the-statements-needed-to-recreate-all-tables-views-and-sequences-in-the-current-database) to return the `CREATE` statements for all of the tables, views, and sequences in the current database.
Core | **Storage of Z/M Coordinates for Spatial Objects** | You can now store a third dimension coordinate (`Z`), a measure coordinate (`M`), or both (`ZM`) with [spatial objects](../v21.1/spatial-features.html#spatial-objects). Note, however, that CockroachDB's [spatial indexing](../v21.1/spatial-indexes.html) is still based on the 2D coordinate system. This means that the Z/M dimension is not index accelerated when using spatial predicates, and some spatial functions ignore the Z/M dimension, with transformations discarding the Z/M value.
Core | **Third-Party Tool Support** | [Spatial libraries for Hibernate, ActiveRecord, and Django](../v21.1/spatial-data.html#orm-compatibility) are now fully compatible with CockroachDB's spatial features. The [DataGrip IDE](../v21.1/third-party-database-tools.html#integrated-development-environments-ides) and [Liquibase schema migration tool](../v21.1/third-party-database-tools.html#schema-migration-tools) are also now supported.
Core | **Connection Pooling Guidance** | Creating the appropriate size pool of connections is critical to gaining maximum performance in an application. For guidance on sizing, validating, and using connection pools with CockroachDB, as well as examples for Java and Go applications, see [Use Connection Pools](../v21.1/connection-pooling.html).
Core | **PostgreSQL 13 Compatibility** | CockroachDB is now wire-compatible with PostgreSQL 13. For more information, see [PostgreSQL Compatibility](../v21.1/postgresql-compatibility.html).

#### Recovery and I/O

Version | Feature | Description
--------|---------|------------
Enterprise | **Changefeed Topic Naming Improvements** | New [`CHANGEFEED` options](../v21.1/create-changefeed.html#options) give you more control over topic naming: The `full_table_name` option lets you use a fully-qualified table name in topics, subjects, schemas, and record output instead of the default table name, and can prevent unintended behavior when the same table name is present in multiple databases. The `avro_schema_prefix` option lets you use a fully-qualified schema name for a table instead of the default table name, and makes it possible for multiple databases or clusters to share the same schema registry when the same table name is present in multiple databases.
Core | **Running Jobs Asynchronously** | You can use the new `DETACHED` option to run [`BACKUP`](../v21.1/backup.html#options), [`RESTORE`](../v21.1/restore.html#options), and [`IMPORT`](../v21.1/import.html#import-options) jobs asynchronously and receive a job ID immediately rather than waiting for the job to finish. This option enables you to run such jobs within transactions.
Core | **Import from Local Dump File** | The new [`cockroach import`](../v21.1/cockroach-import.html) command imports a database or table from a local `PGDUMP` or `MYSQLDUMP` file into a running cluster. This is useful for quick imports of 15MB or smaller. For larger imports, use the [`IMPORT`](../v21.1/import.html) statement.
Core | **Additional Import Options** | New [`IMPORT` options](../v21.1/import.html#import-options) give you more control over the import process's behavior: The `row_limit` option limits the number of rows to import, which is useful for finding errors quickly before executing a more time- and resource-consuming import; the `ignore_unsupported_statements` option ignores SQL statements in `PGDUMP` files that are unsupported by CockroachDB; and the `log_ignored_statements` option logs unsupported statements to cloud storage or userfile storage when `ignore_unsupported_statements` is enabled.
Core | **Re-validating Indexes During `RESTORE`** | Incremental backups created by v20.2.2 and prior v20.2.x releases or v20.1.4 and prior v20.1.x releases may include incomplete data for indexes that were in the process of being created. Therefore, when incremental backups taken by these versions are restored by v21.1.0, any indexes created during those incremental backups will be re-validated by [`RESTORE`](../v21.1/restore.html#restore-from-incremental-backups).

#### Database Operations

Version | Feature | Description
--------|---------|------------
Core | **Logging Improvements** | Log events are now organized into [logging channels](../v21.1/logging-overview.html) that address different [use cases](../v21.1/logging-use-cases.html). Logging channels can be freely mapped to log sinks and routed to destinations outside CockroachDB (including external log collectors). All logging aspects, including message format (e.g., JSON), are now [configurable](../v21.1/configure-logs.html) via YAML.
Core | **Cluster API v2.0** | This [new API](../v21.1/cluster-api.html) for monitoring clusters and nodes builds on prior endpoints, offering a consistent REST interface that's easier to use with your choice of tooling. The API offers a streamlined authentication process and developer-friendly [reference documentation](../api/cluster/v2.html).
Core | **OpenShift-certified<br>Kubernetes Operator** | You can now [deploy CockroachDB on the Red Hat OpenShift platform](../v21.1/deploy-cockroachdb-with-kubernetes-openshift.html) using the latest OpenShift-certified Kubernetes Operator.  
Core | **Auto TLS Certificate Setup** | Using the new [`cockroach connect` command](../v21.1/auto-tls.html), you can now let CockroachDB handle the creation and distribution among nodes of a cluster's CA (certificate authority) and node certificates. Note that this feature is an alpha release with core functionality that may not meet your requirements.
Core | **Built-in Timezone Library** | The CockroachDB binary now includes a copy of the [`tzdata` library](../v21.1/recommended-production-settings.html#dependencies), which is required by certain features that use time zone data. If CockroachDB cannot find the `tzdata` library externally, it will now use this built-in copy.  

#### Backward-incompatible changes

Before [upgrading to CockroachDB v21.1](../v21.1/upgrade-cockroach-version.html), be sure to review the following backward-incompatible changes and adjust your deployment as necessary.

- Rows containing empty arrays in [`ARRAY`](../v21.1/array.html) columns are now contained in [inverted indexes](../v21.1/inverted-indexes.html). This change is backward-incompatible because prior versions of CockroachDB will not be able to recognize and decode keys for empty arrays. Note that rows containing `NULL` values in an indexed column will still not be included in inverted indexes.
- Concatenation between a non-null argument and a null argument is now typed as string concatenation, whereas it was previously typed as array concatenation. This means that the result of `NULL || 1` will now be `NULL` instead of `{1}`. To preserve the old behavior, the null argument can be casted to an explicit type.
- The payload fields for certain event types in `system.eventlog` have been changed and/or renamed. Note that the payloads in `system.eventlog` were undocumented, so no guarantee was made about cross-version compatibility to this point. The list of changes includes (but is not limited to):
  - `TargetID` has been renamed to `NodeID` for `node_join`.
  - `TargetID` has been renamed to `TargetNodeID` for `node_decommissioning` / `node_decommissioned` / `node_recommissioned`.
  - `NewDatabaseName` has been renamed to `NewDatabaseParent` for `convert_to_schema`.
  - `grant_privilege` and `revoke_privilege` have been removed; they are replaced by `change_database_privilege`, `change_schema_privilege`, `change_type_privilege`, and `change_table_privilege`. Each event only reports a change for one user/role, so the `Grantees` field was renamed to `Grantee`.
  - Each `drop_role` event now pertains to a single [user/role](../v21.1/authorization.html#sql-users).
- The connection and authentication logging enabled by the [cluster settings](../v21.1/cluster-settings.html) `server.auth_log.sql_connections.enabled` and `server.auth_log.sql_sessions.enabled` was previously using a text format which was hard to parse and integrate with external monitoring tools. This has been changed to use the standard notable event mechanism, with standardized payloads. The output format is now structured; see the [reference documentation](../v21.1/eventlog.html) for details about the supported event types and payloads.
- The format for SQL audit, execution, and query logs has changed from a crude space-delimited format to JSON. To opt out of this new behavior and restore the pre-v21.1 logging format, you can set the [cluster setting](../v21.1/cluster-settings.html) `sql.log.unstructured_entries.enabled` to `true`.
- The [`cockroach debug ballast`](../v21.1/cockroach-debug-ballast.html) command now refuses to overwrite the target ballast file if it already exists. This change is intended to prevent mistaken uses of the `ballast` command by operators. Scripts that integrate `cockroach debug ballast` can consider adding a `rm` command.
- Removed the `kv.atomic_replication_changes.enabled` [cluster setting](../v21.1/cluster-settings.html). All replication changes on a range now use joint-consensus.
- Currently, [changefeeds](../v21.1/stream-data-out-of-cockroachdb-using-changefeeds.html) connected to [Kafka versions < v1.0](https://docs.confluent.io/platform/current/installation/versions-interoperability.html) are not supported in CockroachDB v21.1.

#### Deprecations

- The CLI flags `--log-dir`, `--log-file-max-size`, `--log-file-verbosity`, and `--log-group-max-size` are deprecated. Logging configuration can now be specified via the `--log` parameter. See the [Logging](../v21.1/logging-overview.html) documentation for details.
- The client-side command `\show` for the [SQL shell](../v21.1/cockroach-sql.html#commands) is deprecated in favor of the new command `\p`. This prints the contents of the query buffer entered so far.
- Currently, Google Cloud Storage (GCS) connections default to the `cloudstorage.gs.default.key` [cluster setting](../v21.1/cluster-settings.html). This default behavior will no longer be supported in v21.2. If you are relying on this default behavior, we recommend adjusting your queries and scripts to now specify the `AUTH` parameter you want to use. Similarly, if you are using the `cloudstorage.gs.default.key` cluster setting to authorize your GCS connection, we recommend switching to use `AUTH=specified` or `AUTH=implicit`. `AUTH=specified` will be the default behavior in v21.2 and beyond.

#### Known limitations

For information about new and unresolved limitations in CockroachDB v21.1, with suggested workarounds where applicable, see [Known Limitations](../v21.1/known-limitations.html).

#### Education

Area | Topic | Description
-----|-------|------------
Cockroach University | **New Intro Courses** | [Introduction to Distributed SQL and CockroachDB](https://university.cockroachlabs.com/course/introduction-to-distributed-sql-and-cockroachdb) teaches you the core concepts behind distributed SQL databases and describes how CockroachDB fits into this landscape. [Practical First Steps with CockroachDB](https://university.cockroachlabs.com/course/practical-first-steps) is a hands-on sequel that gives you the tools to get started with CockroachDB.
Cockroach University | **New Java Course** | [Fundamentals of CockroachDB for Java Developers](https://university.cockroachlabs.com/course/javadevs1) walks you through building a full-stack vehicle-sharing app in Java using the popular Spring Data JPA framework with Spring Boot and a <a href="https://cockroachlabs.cloud/signup?referralId=docs_crdb_release_notes" rel="noopener" target="_blank">CockroachCloud Free</a> cluster as the backend.
Cockroach University | **New Query Performance Course** | [CockroachDB Query Performance for Developers](https://university.cockroachlabs.com/course/perfbasics) teaches you key CockroachDB features and skills to improve application performance and functionality, such as analyzing a query execution plan, using indexes to avoid expensive full table scans, improving sorting performance, and efficiently querying fields in JSON records.
Docs | **Quickstart** | Documented the simplest way to [get started with CockroachDB](../cockroachcloud/quickstart.html) for testing and app development by using <a href="https://cockroachlabs.cloud/signup?referralId=docs_crdb_release_notes" rel="noopener" target="_blank">CockroachCloud Free</a>.
Docs | **Developer Guidance** | Published more comprehensive, task-oriented [guidance for developers](../v21.1/developer-guide-overview.html) building applications on CockroachDB, including connecting to a cluster, designing a database schema, reading and writing data, optimizing query performance, and debugging applications.
Docs | **Connection Pooling** | Added guidance on [planning, configuring, and using connection pools](../v21.1/connection-pooling.html) with CockroachDB, as well as examples for Java and Go applications.
Docs | **Sample Apps on <br>CockroachCloud Free** | Updated various Java, Python, Node.js, Ruby, and Go [sample app tutorials](../v21.1/hello-world-example-apps.html) to offer <a href="https://cockroachlabs.cloud/signup?referralId=docs_crdb_release_notes" rel="noopener" target="_blank">CockroachCloud Free</a> as the backend.
Docs | **Licensing FAQs** | Updated the [Licensing FAQ](../v21.1/licensing-faqs.html) to explain our licensing types, how features align to licenses, how to perform basic tasks around licenses (e.g., obtain, set, verify, monitor, renew), and other common questions.
Docs | **Product Limits** | Added [object sizing and scaling considerations](../v21.1/schema-design-overview.html#object-size-and-scaling-considerations), including specific hard limits imposed by CockroachDB and practical limits based on our performance testing and observations.
Docs | **System Catalogs** | Documented important [internal system catalogs](../v21.1/system-catalogs.html) that provide non-stored data to client applications.

## v21.1.0-rc.2

Get future release notes emailed to you:

{% include marketo.html %}

### Downloads

<div id="os-tabs" class="filters clearfix">
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.0-rc.2.linux-amd64.tgz"><button id="linux" class="filter-button" data-scope="linux" data-eventcategory="linux-binary-release-notes">Linux</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.0-rc.2.darwin-10.9-amd64.tgz"><button id="mac" class="filter-button" data-scope="mac" data-eventcategory="mac-binary-release-notes">Mac</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.0-rc.2.windows-6.2-amd64.zip"><button id="windows" class="filter-button" data-scope="windows" data-eventcategory="windows-binary-release-notes">Windows</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.0-rc.2.src.tgz"><button id="source" class="filter-button" data-scope="source" data-eventcategory="source-release-notes">Source</button></a>
</div>

<section class="filter-content" data-scope="windows">
{% include windows_warning.md %}
</section>

### Docker image

{% include copy-clipboard.html %}
~~~shell
$ docker pull cockroachdb/cockroach-unstable:v21.1.0-rc.2
~~~

### Enterprise edition changes

- [Changefeeds](../v21.1/stream-data-out-of-cockroachdb-using-changefeeds.html) now reliably fail when [`IMPORT INTO`](../v21.1/import-into.html) is run against a targeted table, as change data capture is [not supported](../v21.1/known-limitations.html#change-data-capture) for this action. [#64372][#64372]

### Bug fixes

- Fixed a correctness bug, which caused partitioned index scans to omit rows where the value of the first index column was `NULL`. This bug was present since v19.2.0. [#64046][#64046]
- [`IMPORT`](../v21.1/import.html) and [`RESTORE`](../v21.1/restore.html) jobs that were in progress during a cluster backup will now be canceled when that cluster backup is restored. This fixes a bug where these restored jobs may have assumed to make progress that was not captured in the backup. [#64352][#64352]
- Fixed a race condition where read-only requests during replica removal (for example, during range merges or rebalancing) could be evaluated on the removed replica, returning an empty result. [#64370][#64370]
- Fixed a bug where encryption-at-rest metadata was not synced and could become corrupted during a hard reset. [#64473][#64473]

### Contributors

This release includes 5 merged PRs by 6 authors.

[#64046]: https://github.com/cockroachdb/cockroach/pull/64046
[#64352]: https://github.com/cockroachdb/cockroach/pull/64352
[#64370]: https://github.com/cockroachdb/cockroach/pull/64370
[#64372]: https://github.com/cockroachdb/cockroach/pull/64372
[#64473]: https://github.com/cockroachdb/cockroach/pull/64473

## v21.1.0-rc.1

Get future release notes emailed to you:

{% include marketo.html %}

### Downloads

<div id="os-tabs" class="filters clearfix">
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.0-rc.1.linux-amd64.tgz"><button id="linux" class="filter-button" data-scope="linux" data-eventcategory="linux-binary-release-notes">Linux</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.0-rc.1.darwin-10.9-amd64.tgz"><button id="mac" class="filter-button" data-scope="mac" data-eventcategory="mac-binary-release-notes">Mac</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.0-rc.1.windows-6.2-amd64.zip"><button id="windows" class="filter-button" data-scope="windows" data-eventcategory="windows-binary-release-notes">Windows</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.0-rc.1.src.tgz"><button id="source" class="filter-button" data-scope="source" data-eventcategory="source-release-notes">Source</button></a>
</div>

<section class="filter-content" data-scope="windows">
{% include windows_warning.md %}
</section>

### Docker image

{% include copy-clipboard.html %}
~~~shell
$ docker pull cockroachdb/cockroach-unstable:v21.1.0-rc.1
~~~

### SQL language changes

- CockroachDB no longer allows [`ADD REGION`](../v21.1/add-region.html) or `DROP REGION` statements if a [`REGIONAL BY ROW`](../v21.1/multiregion-overview.html) table has index changes underway, or if a table is transitioning to or from `REGIONAL BY ROW`. [#64255][#64255] {% comment %}doc{% endcomment %}
- CockroachDB now prevents index modification on `REGIONAL BY ROW` tables and locality to or from `REGIONAL BY ROW` changes while an `ADD REGION` or `DROP REGION` statement is being executed. [#64255][#64255] {% comment %}doc{% endcomment %}

### Bug fixes

- Fixed a scenario in which a rapid sequence of [range splits](../v21.1/architecture/distribution-layer.html#range-splits) could trigger a storm of [Raft snapshots](../v21.1/architecture/replication-layer.html#snapshots). This would be accompanied by log messages of the form "would have dropped incoming MsgApp, but allowing due to ..." and tended to occur as part of [`RESTORE`](../v21.1/restore.html)/[`IMPORT`](../v21.1/import.html) operations. [#64202][#64202]
- Read-write contention on [`GLOBAL` tables](../v21.1/multiregion-overview.html) no longer has a potential to thrash without making progress. [#64215][#64215]
- Previously, if a [`DROP INDEX`](../v21.1/drop-index.html) failed during a `REGIONAL BY ROW` transition, the index could have been re-inserted back into the `REGIONAL BY ROW` table but would be invalid if it was [hash-sharded](../v21.1/hash-sharded-indexes.html) or [partitioned](../v21.1/multiregion-overview.html). This bug is now fixed. [#64255][#64255]
- Fixed a rare bug present in [v21.1 beta versions](index.html#testing-releases) that could cause rapid range splits and merges on a `GLOBAL` table to lead to a stuck leaseholder replica. The situation is no longer possible. [#64304][#64304]
- Fixed a bug in previous v21.1 beta versions that allowed the store rebalancer to spuriously down-replicate a range during normal operation. [#64303][#64303]
- CockroachDB now prevents some out-of-memory conditions caused by [schema change](../v21.1/online-schema-changes.html) validations concurrent with other high-memory-use queries. [#64307][#64307]
- Fixed a bug present since [v21.1.0-alpha.1](v21.1.0-alpha.1.html) that could cause cascading [`DELETE`](../v21.1/delete.html)s with [subqueries](../v21.1/subqueries.html) to error. [#64278][#64278]
- Fixed a bug that caused store information to be incorrectly redacted from the [CockroachDB logs](../v21.1/logging-overview.html), when logging was configured with redaction. [#64338][#64338]
- Previously, the remote flows of execution in the [vectorized engine](../v21.1/vectorized-execution.html) could take a long time to shut down if a node participating in the plan died. This bug is now fixed. [#64219][#64219]

### Contributors

This release includes 14 merged PRs by 14 authors.

[#64202]: https://github.com/cockroachdb/cockroach/pull/64202
[#64215]: https://github.com/cockroachdb/cockroach/pull/64215
[#64219]: https://github.com/cockroachdb/cockroach/pull/64219
[#64255]: https://github.com/cockroachdb/cockroach/pull/64255
[#64278]: https://github.com/cockroachdb/cockroach/pull/64278
[#64303]: https://github.com/cockroachdb/cockroach/pull/64303
[#64304]: https://github.com/cockroachdb/cockroach/pull/64304
[#64307]: https://github.com/cockroachdb/cockroach/pull/64307
[#64338]: https://github.com/cockroachdb/cockroach/pull/64338

## v21.1.0-beta.5

Get future release notes emailed to you:

{% include marketo.html %}

### Downloads

<div id="os-tabs" class="filters clearfix">
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.0-beta.5.linux-amd64.tgz"><button id="linux" class="filter-button" data-scope="linux" data-eventcategory="linux-binary-release-notes">Linux</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.0-beta.5.darwin-10.9-amd64.tgz"><button id="mac" class="filter-button" data-scope="mac" data-eventcategory="mac-binary-release-notes">Mac</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.0-beta.5.windows-6.2-amd64.zip"><button id="windows" class="filter-button" data-scope="windows" data-eventcategory="windows-binary-release-notes">Windows</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.0-beta.5.src.tgz"><button id="source" class="filter-button" data-scope="source" data-eventcategory="source-release-notes"></button></a>
</div>

<section class="filter-content" data-scope="windows">
{% include windows_warning.md %}
</section>

### Docker image

{% include copy-clipboard.html %}
~~~shell
$ docker pull cockroachdb/cockroach-unstable:v21.1.0-beta.5
~~~

### Backward-incompatible changes

- The internal representation of the `voter_constraints` [zone configuration](../v21.1/configure-replication-zones.html) attribute (new in v21.1) has been altered in a way that is partially incompatible with the representation used by previous v21.1 betas (and the alphas that include this attribute). This means that users who directly set the `voter_constraints` attribute to an empty list will lose those constraints and will have to reset them. [#63674][#63674] {% comment %}doc{% endcomment %}

### General changes

- Upgraded the CockroachDB binary to Go 1.15.10. [#63865][#63865] {% comment %}doc{% endcomment %}

### Enterprise edition changes

- [Changefeeds](../v21.1/create-changefeed.html) will now fail on any [regional by row table](../v21.1/multiregion-overview.html#regional-by-row-tables) with an error, `CHANGEFEED cannot target REGIONAL BY ROW tables: <table_name>.` This is to prevent unexpected behavior in changefeeds until they offer full support for this type of table. [#63542][#63542] {% comment %}doc{% endcomment %}

### SQL language changes

- [`RESTORE`](../v21.1/restore.html) now re-validates restored indexes if they were restored from an [incremental backup](../v21.1/take-full-and-incremental-backups.html#incremental-backups) that was taken while the index was being created. [#63320][#63320] {% comment %}doc{% endcomment %}
- The `sql.distsql.temp_storage.workmem` [cluster setting](../v21.1/cluster-settings.html) is now marked as public and is included in the documentation. It determines how much RAM a single operation of a single query can use before it must spill to temporary storage. Note the operations that do not support the disk spilling will ignore this setting and are subject only to the [`--max-sql-memory`](../v21.1/cockroach-start.html#flags) startup argument. [#63997][#63997] {% comment %}doc{% endcomment %}
- SQL executor data validation queries spawned by a schema change or a [`RESTORE`](../v21.1/restore.html) will now use [vectorized](../v21.1/vectorized-execution.html) query execution and [DistSQL](../v21.1/architecture/sql-layer.html#distsql) optimization if these are enabled in the cluster settings `sql.defaults.distsql` and `sql.defaults.vectorized`, respectively. This may improve the speed of these queries. [#64004][#64004] {% comment %}doc{% endcomment %}

### Bug fixes

- Allow the leases of offline descriptors to be cached, preventing issues with lease acquisitions during bulk operations (backup and restore operations). [#63558][#63558]
- Fixed bugs where [`TRUNCATE`](../v21.1/truncate.html) concurrent with index construction and other schema changes could result in corruption. [#63143][#63143]
- Fixed a panic condition which could occur in cases after a [`RESTORE`](../v21.1/restore.html) of a table with [user-defined types](../v21.1/enum.html). [#63549][#63549]
- CockroachDB now prevents a panic condition and offers a graceful error when [spatial function](../v21.1/functions-and-operators.html#spatial-functions) `ST_Segmentize` attempts to generate an extremely large number of points on a [`GEOGRAPHY`](../v21.1/spatial-glossary.html#geography). [#63758][#63758]
- Previously, running the `ST_Simplify` [spatial function](../v21.1/functions-and-operators.html#spatial-functions) on a non-numeric value would cause the node to crash. This is now resolved. [#63797][#63797]
- CockroachDB now uses the existing primary key to validate indexes built for [`ALTER PRIMARY KEY`](../v21.1/alter-primary-key.html) changes. [#63609][#63609]
- Fixed occasional stalls and excessive CPU usage under macOS Big Sur when building CockroachDB with Go 1.14 or newer. [#63789][#63789]
- Fixed a bug where [crdb_internal.validate_multi_region_zone_configs()](https://github.com/cockroachdb/cockroach/blob/master/docs/generated/sql/functions.md#multi-region-functions) would fail during a [`REGIONAL BY ROW`](../v21.1/set-locality.html) locality transition. [#63834][#63834]
- Fixed an internal error that could occur when executing queries using an [inverted index](../v21.1/inverted-indexes.html). The error was an index out of range error, and could occur in rare cases when a filter or join predicate contained at least two JSON, Array, Geometry or Geography expressions that were combined with `AND`. This has now been fixed. [#63811][#63811]
- Fixed a bug leading to crashes with the error message `writing below closed ts`. [#63861][#63861]
- Previously, if a user altered a table to [`REGIONAL BY ROW`](../v21.1/set-locality.html) when a region was being dropped, and the drop failed and had to be rolled back, it could have resulted in the [regional by row table](../v21.1/multiregion-overview.html#regional-by-row-tables) missing a partition for this region. This is now fixed. [#63793][#63793]
- Prevent an internal error `use of enum metadata before hydration as an enum` when querying or showing ranges from tables with user-defined types as their `PRIMARY KEY`. [#63878][#63878]
- Fixed a theoretical issue in index backfills that could result in stale entries that would likely fail validation. [#64044][#64044]
- CockroachDB now correctly accounts for used memory when closing compressed files. [#63917][#63917]

### Performance improvements

- CockroachDB now limits a series of heap allocations when serving read-only queries. [#63972][#63972]
- CockroachDB now limits the amount of memory that can be used in internal buffers for Kafka and cloud sinks. [#63611][#63611]

### Contributors

This release includes 48 merged PRs by 23 authors.
We would like to thank the following contributors from the CockroachDB community:

- Miguel Novelo (first-time contributor)
- Rupesh Harode (first-time contributor)

[#63143]: https://github.com/cockroachdb/cockroach/pull/63143
[#63320]: https://github.com/cockroachdb/cockroach/pull/63320
[#63542]: https://github.com/cockroachdb/cockroach/pull/63542
[#63549]: https://github.com/cockroachdb/cockroach/pull/63549
[#63558]: https://github.com/cockroachdb/cockroach/pull/63558
[#63609]: https://github.com/cockroachdb/cockroach/pull/63609
[#63611]: https://github.com/cockroachdb/cockroach/pull/63611
[#63674]: https://github.com/cockroachdb/cockroach/pull/63674
[#63758]: https://github.com/cockroachdb/cockroach/pull/63758
[#63768]: https://github.com/cockroachdb/cockroach/pull/63768
[#63789]: https://github.com/cockroachdb/cockroach/pull/63789
[#63793]: https://github.com/cockroachdb/cockroach/pull/63793
[#63797]: https://github.com/cockroachdb/cockroach/pull/63797
[#63811]: https://github.com/cockroachdb/cockroach/pull/63811
[#63834]: https://github.com/cockroachdb/cockroach/pull/63834
[#63861]: https://github.com/cockroachdb/cockroach/pull/63861
[#63865]: https://github.com/cockroachdb/cockroach/pull/63865
[#63878]: https://github.com/cockroachdb/cockroach/pull/63878
[#63917]: https://github.com/cockroachdb/cockroach/pull/63917
[#63949]: https://github.com/cockroachdb/cockroach/pull/63949
[#63972]: https://github.com/cockroachdb/cockroach/pull/63972
[#63997]: https://github.com/cockroachdb/cockroach/pull/63997

## v21.1.0-beta.4

Get future release notes emailed to you:

{% include marketo.html %}

### Downloads

<div id="os-tabs" class="filters clearfix">
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.0-beta.4.linux-amd64.tgz"><button id="linux" class="filter-button" data-scope="linux" data-eventcategory="linux-binary-release-notes">Linux</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.0-beta.4.darwin-10.9-amd64.tgz"><button id="mac" class="filter-button" data-scope="mac" data-eventcategory="mac-binary-release-notes">Mac</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.0-beta.4.windows-6.2-amd64.zip"><button id="windows" class="filter-button" data-scope="windows" data-eventcategory="windows-binary-release-notes">Windows</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.0-beta.4.src.tgz"><button id="source" class="filter-button" data-scope="source" data-eventcategory="source-release-notes"></a>
</div>

<section class="filter-content" data-scope="windows">
{% include windows_warning.md %}
</section>

{% include v21.1/misc/beta-release-warning.md %}

### Docker image

{% include copy-clipboard.html %}
~~~shell
$ docker pull cockroachdb/cockroach-unstable:v21.1.0-beta.4
~~~

### General changes

- Removed experimental feature `UNIQUE WITHOUT INDEX` from the documentation. [#63499][#63499] {% comment %}doc{% endcomment %}

### SQL language changes

- The [`pg_get_partkeydef` builtin function](../v21.1/functions-and-operators.html) is now implemented by always returning `NULL`. [#63149][#63149] {% comment %}doc{% endcomment %}
- CockroachDB now collects execution stats for all statements when seen for the first time. To disable this behavior, set the [`sql.txn_stats.sample_rate` cluster setting](../v21.1/cluster-settings.html) to 0, which will disable all execution stats collection. [#63325][#63325] {% comment %}doc{% endcomment %}
- CockroachDB will now block the ability to set the initial `PRIMARY REGION` of a database if any [multi-region](../v21.1/multiregion-overview.html) fields on any zone configs in the database have been set. [#63354][#63354] {% comment %}doc{% endcomment %}
- CockroachDB now introduces a `pgcode` when attempting to [`DROP REGION`](../v21.1/multiregion-overview.html) when the region being dropped is the `PRIMARY REGION`. [#63354][#63354] {% comment %}doc{% endcomment %}
- Replaced the word "tuple" with its more user-friendly synonym "row" in [vectorized stats outputs](../v21.1/vectorized-execution.html). [#62956][#62956] {% comment %}doc{% endcomment %}
- Changed [`BACKUP`](../v21.1/take-full-and-incremental-backups.html) of [interleaved tables](../v21.1/interleave-in-parent.html) to require the `include_deprecated_interleaves` option as interleaved table backups will not be able to be restored in future versions of CockroachDB. [#63501][#63501] {% comment %}doc{% endcomment %}

### Operational changes

- `RESTORE` now cannot [restore](../v21.1/take-full-and-incremental-backups.html) `BACKUP`s made by newer versions of CockroachDB. [#62398][#62398] {% comment %}doc{% endcomment %}

### DB Console changes

The following statements now render correctly as events in the [DB Console](../v21.1/ui-overview.html) [#63141][#63141]:
- [`ALTER DATABASE ADD REGION`](../v21.1/add-region.html)
- [`ALTER DATABASE SET PRIMARY REGION`](../v21.1/set-locality.html)
- [`ALTER DATABASE ... SURVIVE ... FAILURE`](../v21.1/survive-failure.html)
- [`ALTER DATABASE DROP REGION`](../v21.1/)
- [`CREATE TYPE`](../v21.1/create-type.html)
- [`ALTER TYPE`](../v21.1/alter-type.html)
- [`DROP TYPE`](../v21.1/drop-type.html)

### Bug fixes

- Fixed a bug present in earlier 21.1 versions where [`BACKUP`s](../v21.1/take-full-and-incremental-backups.html) would produce an error when they should be able to backup the underlying data. [#63095][#63095]
- [Dropping a foreign key](../v21.1/drop-constraint.html) that was added in the same transaction no longer triggers an internal error. This bug has been present since at least version 20.1. [#62879][#62879]
- Fixed a bug where an `ALTER TABLE ... ADD COLUMN ... UNIQUE` statement would cause an error if the table had a [`PARTITION ALL BY` or `REGIONAL BY ROW`](../v21.1/multiregion-overview.html) definition. [#63189][#63189]
- Fixed a bug in earlier 21.1 versions where `CREATE TABLE LIKE` would copy a [`VIRTUAL` column](../v21.1/computed-columns.html) from the source table as a `STORED` column in the destination table. [#63172][#63172]
- CockroachDB now returns an error when trying to perform a [backup](../v21.1/take-full-and-incremental-backups.html) of a cluster that was taken on another tenant. [#63223][#63223]
- Fixed a bug where index backfill data may have been missed by [`BACKUP`](../v21.1/take-full-and-incremental-backups.html) in incremental backups. [#63221][#63221]
- Fixed a bug where [`REGIONAL BY ROW` zone configs](../v21.1/multiregion-overview.html) were dropped before `REGIONAL BY ROW` changes are finalized. This caused a bug when the `REGIONAL BY ROW` transformation fail. [#63274][#63274]
- Fixed a case where implicitly partitioned columns (e.g., from [`REGIONAL BY ROW` tables](../v21.1/multiregion-overview.html) and hash-sharded indexes) previously showed as `implicit = false` when using `SHOW INDEXES` or querying `information_schema.pg_indexes`. [#63275][#63275]
- Fixed an error that could occur when performing an [`UPSERT`](../v21.1/upsert.html) on a [`REGIONAL BY ROW` table](../v21.1/multiregion-overview.html) with no secondary indexes or foreign keys. The error, 'missing "crdb_region" primary key column', has now been fixed. [#63257][#63257]
- Fixed a bug where tables that were created by CockroachDB 19.x or older that included foreign key constraints and were [backed up](../v21.1/take-full-and-incremental-backups.html) with the `revision_history` option would be malformed when restored by a CockroachDB 20.x cluster if the `RESTORE` used the `AS OF SYSTEM TIME` option. [#63267][#63267]
- Fixed a bug in [user-defined schemas](../v21.1/schema-design-schema.html) where the dropping of any schema would prevent creation of schemas with the name of the database and would corrupt already existing schemas of that name. [#63395][#63395]
- Fixed a bug in previous CockroachDB 21.1 releases where CockroachDB would sometimes return the output in an incorrect order if a query containing hash-aggregation was executed via the [vectorized execution engine](../v21.1/vectorized-execution.html) and spilled to temporary storage. [#63408][#63408]
- Fixed a bug where [incremental cluster backups](../v21.1/take-full-and-incremental-backups.html) may have missed data written to tables while they were `OFFLINE`. In practice this could have occurred if a [`RESTORE`](../v21.1/restore.html) or [`IMPORT`](../v21.1/import.html) was running across incremental backups. [#63304][#63304]
- CockroachDB now includes more anonymized data from SQL statements in telemetry updates and crash reports. [#63482][#63482]
- Fixed a rare issue that caused replica divergence. If this occurred the divergence was reported by the [replica consistency checker](../v21.1/architecture/replication-layer.html), typically within 24 hours of occurrence, and caused the nodes to terminate. [#63473][#63473]

### Performance improvements

- Improved performance of reverting [`IMPORT INTO`](../v21.1/import-into.html) jobs that `IMPORT INTO` empty tables. [#63220][#63220]

### Miscellaneous improvements

- Made the Kafka library used in [changefeeds](../v21.1/stream-data-out-of-cockroachdb-using-changefeeds.html) configurable using the `kafka_sink_config` option to enable latency versus throughput configurations. [#63361][#63361]
- Connected the [changefeed](../v21.1/stream-data-out-of-cockroachdb-using-changefeeds.html) memory monitor to the parent SQL monitor to ensure that changefeeds do not try to use more memory than is available to the SQL server. [#63409][#63409]

### Contributors

This release includes 50 merged PRs by 20 authors.

[#62398]: https://github.com/cockroachdb/cockroach/pull/62398
[#62879]: https://github.com/cockroachdb/cockroach/pull/62879
[#62956]: https://github.com/cockroachdb/cockroach/pull/62956
[#62968]: https://github.com/cockroachdb/cockroach/pull/62968
[#62971]: https://github.com/cockroachdb/cockroach/pull/62971
[#63095]: https://github.com/cockroachdb/cockroach/pull/63095
[#63141]: https://github.com/cockroachdb/cockroach/pull/63141
[#63149]: https://github.com/cockroachdb/cockroach/pull/63149
[#63172]: https://github.com/cockroachdb/cockroach/pull/63172
[#63189]: https://github.com/cockroachdb/cockroach/pull/63189
[#63220]: https://github.com/cockroachdb/cockroach/pull/63220
[#63221]: https://github.com/cockroachdb/cockroach/pull/63221
[#63223]: https://github.com/cockroachdb/cockroach/pull/63223
[#63257]: https://github.com/cockroachdb/cockroach/pull/63257
[#63267]: https://github.com/cockroachdb/cockroach/pull/63267
[#63274]: https://github.com/cockroachdb/cockroach/pull/63274
[#63275]: https://github.com/cockroachdb/cockroach/pull/63275
[#63304]: https://github.com/cockroachdb/cockroach/pull/63304
[#63325]: https://github.com/cockroachdb/cockroach/pull/63325
[#63354]: https://github.com/cockroachdb/cockroach/pull/63354
[#63361]: https://github.com/cockroachdb/cockroach/pull/63361
[#63395]: https://github.com/cockroachdb/cockroach/pull/63395
[#63402]: https://github.com/cockroachdb/cockroach/pull/63402
[#63403]: https://github.com/cockroachdb/cockroach/pull/63403
[#63408]: https://github.com/cockroachdb/cockroach/pull/63408
[#63409]: https://github.com/cockroachdb/cockroach/pull/63409
[#63473]: https://github.com/cockroachdb/cockroach/pull/63473
[#63482]: https://github.com/cockroachdb/cockroach/pull/63482
[#63499]: https://github.com/cockroachdb/cockroach/pull/63499
[#63501]: https://github.com/cockroachdb/cockroach/pull/63501

## v21.1.0-beta.3

Get future release notes emailed to you:

{% include marketo.html %}

### Downloads

<div id="os-tabs" class="filters clearfix">
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.0-beta.3.linux-amd64.tgz"><button id="linux" class="filter-button" data-scope="linux" data-eventcategory="linux-binary-release-notes">Linux</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.0-beta.3.darwin-10.9-amd64.tgz"><button id="mac" class="filter-button" data-scope="mac" data-eventcategory="mac-binary-release-notes">Mac</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.0-beta.3.windows-6.2-amd64.zip"><button id="windows" class="filter-button" data-scope="windows" data-eventcategory="windows-binary-release-notes">Windows</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.0-beta.3.src.tgz"><button id="source" class="filter-button" data-scope="source" data-eventcategory="source-release-notes"></a>
</div>

<section class="filter-content" data-scope="windows">
{% include windows_warning.md %}
</section>

{% include v21.1/misc/beta-release-warning.md %}

### Docker image

{% include copy-clipboard.html %}
~~~shell
$ docker pull cockroachdb/cockroach-unstable:v21.1.0-beta.3
~~~

### Enterprise edition changes

- The `WITH avro_schema_prefix` option for Avro [changefeeds](../v21.1/create-changefeed.html) now sets `schema.namespace` [#61734][#61734] {% comment %}doc{% endcomment %}
- CockroachDB now fails fast when [Change Data Capture](../v21.1/stream-data-out-of-cockroachdb-using-changefeeds.html) writes are blocked. [#62756][#62756] {% comment %}doc{% endcomment %}

### SQL language changes

#### Multi-region SQL changes

- Users can now use a multi-region [`ALTER DATABASE`](../v21.1/alter-database.html) command if:

    - The user is an [`admin`](../v21.1/authorization.html#admin-role) user
    - The user is the owner of the database.
    - The user has [`CREATE`](../v21.1/authorization.html#privileges) privileges on the database. [#62528][#62528] {% comment %}doc{% endcomment %}
- Availability zones are now ordered when using the `SHOW REGIONS` set of commands. [#62619][#62619] {% comment %}doc{% endcomment %}

#### General SQL changes

- Added the `stub_catalog_tables` [session variable](../v21.1/set-vars.html), which is enabled by default. If disabled, querying an unimplemented [`pg_catalog`](../v21.1/pg-catalog.html) table will result in an error, as is the case in v20.2 and earlier. Otherwise, the query will simply return no rows. [#62621][#62621] {% comment %}doc{% endcomment %}

### DB Console changes

-  The [**Statements** page](../v21.1/ui-statements-page.html) now shows internal statements when the *all* filter option is selected. [#62677][#62677] {% comment %}doc{% endcomment %}

### Bug fixes

- Fixed a bug that in rare circumstances could cause an implicitly committed (`STAGING`) transaction to be uncommitted if any unresolved intents were removed by a range clear (e.g., when cleaning up a dropped table). This bug fix is only effective with separated intents, which are disabled by default. [#62376][#62376]
- Added a `DuplicateObject` error code for when a user attempts to `ADD REGION` to a database where the region already exists. [#62491][#62491]
- Fixed an internal error that could occur during planning for queries involving tables with many columns and at least one [inverted index](../v21.1/inverted-indexes.html). The error, "estimated distinct count must be non-zero", was caused by an invalid pointer access in the cardinality estimation code. This has now been fixed. [#62545][#62545]
- Writing files to `userfile` would sometimes result in an error claiming that the `userfile` table already exists. This is now fixed. [#62544][#62544]
- When adding/dropping regions from a multi-region database, the user must now have privileges on all regional-by-row tables as these are implicitly re-partitioned under the hood. [#62612][#62612]
- Fixed an internal error caused by comparing collation names that had different upper/lower case characters. [#62637][#62637]
- Fixed a bug whereby [`ENUM`](../v21.1/enum.html) types which have large numbers of values would cause unexpected errors when attempting to read from tables with columns using that `ENUM` type. [#62210][#62210]
- Fixed a bug introduced in earlier v21.1 alpha releases which could cause panics when [dropping indexes](../v21.1/drop-index.html) on tables partitioned by [user-defined types](../v21.1/enum.html). [#62725][#62725]
- Fixed a bug from earlier v21.1 alpha releases whereby dropping an index on a table partitioned by a user-defined type and then [dropping the table](../v21.1/drop-table.html) and then [dropping the type](../v21.1/drop-type.html) before the GC TTL for the index has expired could result in a crash. [#62725][#62725]

### Performance improvements

- Improved the performance of the [vectorized engine](../v21.1/vectorized-execution.html) when scanning fewer than 1024 rows at a time. [#62365][#62365]
- Improved logic in determining the configuration for data to avoid expensive work when there are a large number of [user-defined schemas](../v21.1/create-schema.html). [#62577][#62577]
- Addressed a performance regression from a past change regarding read-triggered compactions. [#62676][#62676]

### Contributors

This release includes 37 merged PRs by 23 authors.

[#61734]: https://github.com/cockroachdb/cockroach/pull/61734
[#62210]: https://github.com/cockroachdb/cockroach/pull/62210
[#62365]: https://github.com/cockroachdb/cockroach/pull/62365
[#62376]: https://github.com/cockroachdb/cockroach/pull/62376
[#62491]: https://github.com/cockroachdb/cockroach/pull/62491
[#62528]: https://github.com/cockroachdb/cockroach/pull/62528
[#62544]: https://github.com/cockroachdb/cockroach/pull/62544
[#62545]: https://github.com/cockroachdb/cockroach/pull/62545
[#62577]: https://github.com/cockroachdb/cockroach/pull/62577
[#62606]: https://github.com/cockroachdb/cockroach/pull/62606
[#62612]: https://github.com/cockroachdb/cockroach/pull/62612
[#62619]: https://github.com/cockroachdb/cockroach/pull/62619
[#62621]: https://github.com/cockroachdb/cockroach/pull/62621
[#62637]: https://github.com/cockroachdb/cockroach/pull/62637
[#62676]: https://github.com/cockroachdb/cockroach/pull/62676
[#62677]: https://github.com/cockroachdb/cockroach/pull/62677
[#62725]: https://github.com/cockroachdb/cockroach/pull/62725
[#62733]: https://github.com/cockroachdb/cockroach/pull/62733
[#62756]: https://github.com/cockroachdb/cockroach/pull/62756

## v21.1.0-beta.2

Get future release notes emailed to you:

{% include marketo.html %}

### Downloads

<div id="os-tabs" class="filters clearfix">
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.0-beta.2.linux-amd64.tgz"><button id="linux" class="filter-button" data-scope="linux" data-eventcategory="linux-binary-release-notes">Linux</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.0-beta.2.darwin-10.9-amd64.tgz"><button id="mac" class="filter-button" data-scope="mac" data-eventcategory="mac-binary-release-notes">Mac</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.0-beta.2.windows-6.2-amd64.zip"><button id="windows" class="filter-button" data-scope="windows" data-eventcategory="windows-binary-release-notes">Windows</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.0-beta.2.src.tgz"><button id="source" class="filter-button" data-scope="source" data-eventcategory="source-release-notes"></a>
</div>

<section class="filter-content" data-scope="windows">
{% include windows_warning.md %}
</section>

{% include v21.1/misc/beta-release-warning.md %}

### Docker image

{% include copy-clipboard.html %}
~~~shell
$ docker pull cockroachdb/cockroach-unstable:v21.1.0-beta.2
~~~

### SQL language changes

#### Multi-region changes

- Added validation that prevents users from updating the [zone configurations](../v21.1/configure-replication-zones.html) of [multi-region tables](../v21.1/multiregion-overview.html) without first setting the `override_multi_region_zone_config` [session variable](../v21.1/set-vars.html). [#62119][#62119]
- Discarding a zone configuration from a multi-region enabled entity is blocked behind the `override_multi_region_zone_config` [session variable](../v21.1/set-vars.html). [#62159][#62159]
- Reverted the change that added the `FORCE` keyword in [#61499][#61499] in favor of the `override_multi_region_zone_config` session variable.  [#62119][#62119]
- Setting non-[multi-region](../v21.1/multiregion-overview.html) controlled fields on [zone configs](../v21.1/configure-replication-zones.html) before `ALTER DATABASE ... SET PRIMARY REGION` will now be preserved and have the same value after the `SET PRIMARY REGION` command is issued. [#62162][#62162]
- [Materialized views](../v21.1/views.html#materialized-views) in multi-region databases will now have a [`GLOBAL` table locality](../v21.1/set-locality.html#set-the-table-locality-to-global). [#62194][#62194]
- [Materialized views](../v21.1/views.html#materialized-views) which are in a database before the first [`ADD REGION`](../v21.1/add-region.html) will become [`GLOBAL`](../v21.1/set-locality.html#set-the-table-locality-to-global) on `ADD REGION`, in line with the behavior of `CREATE MATERIALIZED VIEW` on a [multi-region](../v21.1/multiregion-overview.html) database. [#62194][#62194]
- `ALTER DATABASE .. SET PRIMARY REGION` now requires both `CREATE` and `ZONECONFIG` privilege on all objects inside the database when [adding the first region to the database](../v21.1/add-region.html#examples). The same behavior applies for dropping the last region using `ALTER DATABASE ... DROP REGION`. [#62450][#62450]
- Removed the experimental multi-region locality syntaxes. [#62114][#62114]

#### General changes

- CockroachDB now stores information about contention on non-SQL keys. [#62041][#62041]
- Statement [diagnostics bundles](../v21.1/explain-analyze.html#debug-option) now contain output of `EXPLAIN (VEC)` and `EXPLAIN (VEC, VERBOSE)` commands for the statements. [#62049][#62049]
- Sampled execution stats are now available through [`crdb_internal.node_{statement,transaction}_statistics`](../v21.1/crdb-internal.html). [#62089][#62089]
- Increased the default value for the `sql.txn_stats.sample_rate` [cluster setting](../v21.1/cluster-settings.html) from 0 to 0.1. This means that from now on every statement has 10% probability of being sampled for the purposes of execution statistics. Note that no other criteria for sampling (such as query latency) are currently being utilized to decide whether to sample a statement or not. [#61815][#61815]
- Added the following [cluster settings](../v21.1/cluster-settings.html): `sql.defaults.statement_timeout`, which controls the default value for the `statement_timeout` [session setting](../v21.1/set-vars.html); `sql.defaults.idle_in_transaction_session_timeout`, which controls the default value for the `idle_in_transaction_session_timeout` timeout setting; `sql.defaults.idle_in_session_timeout`, which already existed, but is now a public cluster setting. [#62182][#62182]
- [`EXPLAIN`](../v21.1/explain.html) and [`EXPLAIN ANALYZE`](../v21.1/explain-analyze.html) now show how long ago [table statistics](../v21.1/cost-based-optimizer.html#table-statistics) were collected. [#61945][#61945]

### Command-line changes

- Changed the formatting of namespace validation failures in `cockroach debug doctor` output. [#62245][#62245]

### Bug fixes

- Fixed a bug where the `target` column of `crdb_internal.zones` would show names without properly accounting for user-defined schemas. [#62022][#62022]
- Added validation that prevents regions being dropped on [multi-region databases](../v21.1/multiregion-overview.html) when there are <= 3 regions left on the database. [#62162][#62162]
- Fixed a bug where [zone configurations](../v21.1/configure-replication-zones.html) were not being correctly dropped on the final `DROP REGION` of a multi-region database. [#62162][#62162]
- Fixed a bug where [`VIEW`s](../v21.1/views.html) and [`SEQUENCE`s](../v21.1/create-sequence.html) were not being allowed in multi-region databases. They will now default to the [`REGIONAL BY TABLE`](../v21.1/set-locality.html#set-the-table-locality-to-regional-by-table) locality. [#62176][#62176]
- Fixed a bug where the `pg_type_is_visible` builtin function did not correctly handle user-defined types. [#62225][#62225]
- Fixed a bug where casting an `OID` to a `regtype` did not work for user-defined types. [#62225][#62225]
- A Raft leader who loses quorum will now relinquish its range lease and remove the replica if the range is recreated elsewhere, e.g., via `Node.ResetQuorum()`. [#62103][#62103]
- Fixed a bug where `ClearRange` could leave behind stray write intents when separated intents were enabled, which could cause subsequent storage errors. [#62104][#62104]
- [`ALTER TABLE`](../v21.1/alter-table.html), [`ALTER VIEW`](../v21.1/alter-view.html), and [`ALTER SEQUENCE`](../v21.1/alter-sequence.html) can no longer be used to incorrectly create cross-DB references. [#62341][#62341]
- Disallowed adding columns of type `OIDVECTOR` or `INT2VECTOR` to a table in [`ALTER TABLE ... ADD COLUMN`](../v21.1/add-column.html) statements. These types are not allowed in user-created tables via [`CREATE TABLE`](../v21.1/create-table.html) and were previously erroneously allowed in `ALTER TABLE ... ADD COLUMN`. [#62180][#62180]
- CockroachDB now logs all unsupported `pgdump` statements across smaller log files that can be found in the subdirectory `import<jobID>/(unsupported_schema_stmts|unsupported_data_stmts)/<filenum>.log` [#62263][#62263]
- Fixed a bug where a [constraint](../v21.1/constraints.html) like `NOT NULL` or `CHECK` on a column made irrelevant by a [`DROP CONSTRAINT`](../v21.1/drop-constraint.html) statement in a later concurrent transaction would lead to errors / incorrect behaviour. [#62249][#62249]
- Fixed an internal error that could occur when [`REGIONAL BY ROW`](../v21.1/set-locality.html) tables were joined with other tables using a lookup or inverted join. The internal error was `"we expect that limited UNION ALL queries are only planned locally"`. [#62383][#62383]
- Fixed a bug where using `DROP REGION` on the last region of a multi-region database would not delete the global [zone configurations](../v21.1/configure-replication-zones.html) for [`GLOBAL` tables](../v21.1/set-locality.html#set-the-table-locality-to-global). [#62220][#62220]
- Fixed a bug where duplicate [`IMPORT`](../v21.1/import.html) job records may have been created, or `IMPORT` statements may have failed, when the actual job succeeded. [#62396][#62396]
- Fixed a bug where CockroachDB could collect execution statistics prematurely, which would result in incorrect stats (e.g., when running [`EXPLAIN ANALYZE`](../v21.1/explain-analyze.html)). [#62384][#62384]
- Fixed a bug where setting the `kv.closed_timestamp.target_duration` to 0 did not disable routing requests to [follower replicas](../v21.1/follower-reads.html). [#62439][#62439]
- Fixed a bug where a failed [restore from a backup](../v21.1/restore.html) including [user defined types](../v21.1/create-type.html) would require manual cleanup. [#62454][#62454]

### Contributors

This release includes 61 merged PRs by 21 authors.
We would like to thank the following contributors from the CockroachDB community:

- Tharun

[#61499]: https://github.com/cockroachdb/cockroach/pull/61499
[#61815]: https://github.com/cockroachdb/cockroach/pull/61815
[#61945]: https://github.com/cockroachdb/cockroach/pull/61945
[#62022]: https://github.com/cockroachdb/cockroach/pull/62022
[#62041]: https://github.com/cockroachdb/cockroach/pull/62041
[#62049]: https://github.com/cockroachdb/cockroach/pull/62049
[#62089]: https://github.com/cockroachdb/cockroach/pull/62089
[#62103]: https://github.com/cockroachdb/cockroach/pull/62103
[#62104]: https://github.com/cockroachdb/cockroach/pull/62104
[#62114]: https://github.com/cockroachdb/cockroach/pull/62114
[#62119]: https://github.com/cockroachdb/cockroach/pull/62119
[#62159]: https://github.com/cockroachdb/cockroach/pull/62159
[#62162]: https://github.com/cockroachdb/cockroach/pull/62162
[#62176]: https://github.com/cockroachdb/cockroach/pull/62176
[#62180]: https://github.com/cockroachdb/cockroach/pull/62180
[#62182]: https://github.com/cockroachdb/cockroach/pull/62182
[#62194]: https://github.com/cockroachdb/cockroach/pull/62194
[#62220]: https://github.com/cockroachdb/cockroach/pull/62220
[#62225]: https://github.com/cockroachdb/cockroach/pull/62225
[#62245]: https://github.com/cockroachdb/cockroach/pull/62245
[#62249]: https://github.com/cockroachdb/cockroach/pull/62249
[#62263]: https://github.com/cockroachdb/cockroach/pull/62263
[#62341]: https://github.com/cockroachdb/cockroach/pull/62341
[#62383]: https://github.com/cockroachdb/cockroach/pull/62383
[#62384]: https://github.com/cockroachdb/cockroach/pull/62384
[#62396]: https://github.com/cockroachdb/cockroach/pull/62396
[#62409]: https://github.com/cockroachdb/cockroach/pull/62409
[#62412]: https://github.com/cockroachdb/cockroach/pull/62412
[#62439]: https://github.com/cockroachdb/cockroach/pull/62439
[#62450]: https://github.com/cockroachdb/cockroach/pull/62450
[#62454]: https://github.com/cockroachdb/cockroach/pull/62454

## v21.1.0-beta.1

Get future release notes emailed to you:

{% include marketo.html %}

### Downloads

<div id="os-tabs" class="clearfix">
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.0-beta.1.darwin-10.9-amd64.tgz"><button id="mac" data-eventcategory="mac-binary-release-notes">Mac</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.0-beta.1.linux-amd64.tgz"><button id="linux" data-eventcategory="linux-binary-release-notes">Linux</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.0-beta.1.windows-6.2-amd64.zip"><button id="windows" data-eventcategory="windows-binary-release-notes">Windows</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.0-beta.1.src.tgz"><button id="source" data-eventcategory="source-release-notes">Source</button></a>
</div>

{% include v21.1/misc/beta-release-warning.md %}

### Docker image

{% include copy-clipboard.html %}
~~~shell
$ docker pull cockroachdb/cockroach-unstable:v21.1.0-beta.1
~~~

### Backward-incompatible changes

- The [`cockroach debug ballast`](../v21.1/cockroach-debug-ballast.html) command now refuses to overwrite the target ballast file if it already exists. This change is intended to prevent mistaken uses of the `ballast` command by operators. Scripts that integrate `cockroach debug ballast` can consider adding a `rm` command. [#59995][#59995] {% comment %}doc{% endcomment %}
- Removed the `kv.atomic_replication_changes.enabled` [cluster setting](../v21.1/cluster-settings.html). All replication changes on a range now use joint-consensus. [#61170][#61170] {% comment %}doc{% endcomment %}

### Security updates

- It is now possible to log SQL statements executed by admin users. This logging is enabled via the `sql.log.admin_audit.enabled` [cluster setting](../v21.1/cluster-settings.html). When set, events of type `admin_query` are logged to the `SENSITIVE_ACCESS` channel. [#60708][#60708] {% comment %}doc{% endcomment %}

### General changes

- Updated the AWS SDK used to interface with AWS services such as S3 (for backup, restore, and import) and KMS (for backup/restore). [#59709][#59709] {% comment %}doc{% endcomment %}
- [`SHOW TRACE FOR SESSION`](../v21.1/show-trace.html) previously included CockroachDB internal traces for async threads kicked off as part of user operations. This trace data is no longer captured. [#59815][#59815] {% comment %}doc{% endcomment %}
- Crash reports that are sent to Cockroach Labs no longer redact the names of built-in virtual tables from the `crdb_internal`, `information_schema`, and `pg_catalog` schemas. [#60799][#60799]
- Raised the default limit on the maximum number of spans that can be protected by the `protectedts` subsystem. This limit can be configured using the `kv.protectedts.max_spans` [cluster setting](../v21.1/cluster-settings.html). [#61018][#61018] {% comment %}doc{% endcomment %}

### Enterprise edition changes

- Added the `bulkio.stream_ingestion.minimum_flush_interval` [cluster setting](../v21.1/cluster-settings.html), which allows the user to control how often the stream ingestion job will flush. Note that the job may still flush more often if the in-memory buffers are filled. [#60160][#60160] {% comment %}doc{% endcomment %}
- CockroachDB now supports [primary key](../v21.1/primary-key.html) changes in [`CREATE CHANGEFEED`](../v21.1/create-changefeed.html). [#58422][#58422] {% comment %}doc{% endcomment %}
- [Multi-region database](../v21.1/multi-region-database.html) creations are now permitted as long as the cluster has a CockroachDB subscription. [#61041][#61041] {% comment %}doc{% endcomment %}
- `ALTER DATABASE ... ADD REGION` now requires an enterprise license.[#61169][#61169] {% comment %}doc{% endcomment %}

### SQL language changes

- Added a virtual table, `crdb_internal.node_inflight_trace_spans`, which exposes span ID, parent span ID, trace ID, start time, duration, and operation of node-local inflight spans. [#59492][#59492] {% comment %}doc{% endcomment %}
- Added `WITH avro_schema_prefix` option to Avro [changefeeds](../v21.1/create-changefeed.html) to prevent collisions in a shared schema registry [#59710][#59710] {% comment %}doc{% endcomment %}
- CockroachDB now allows implicitly partitioned indexes to be referenced by foreign keys using the non-implicit columns. [#59692][#59692] {% comment %}doc{% endcomment %}
- The [`SHOW ZONE CONFIGURATION`](../v21.1/show-zone-configurations.html) statement has been changed to use `FROM` instead of `FOR`. [#59410][#59410] {% comment %}doc{% endcomment %}
- It is now possible to use the `NOT VISIBLE` qualifier for new column definitions in [`CREATE TABLE`](../v21.1/create-table.html). This causes the column to become "hidden". Hidden columns are not considered when using `*` in `SELECT` clauses. Note that CockroachDB already supported hidden columns (e.g., `rowid`, which is added automatically when a table definition has no `PRIMARY KEY` constraint). This change adds the opportunity for end-users to define their own hidden columns. It is intended for use in combination with other features related to geo-partitioning introduced in v21.1, which offer more control about how geo-partitioning keys get exposed to client ORMs and other automated tools that inspect the SQL schema. [#58923][#58923] {% comment %}doc{% endcomment %}
- Added the `goroutine_id` column to the `crdb_internal.node_inflight_trace_spans` virtual table that represents the goroutine ID associated with a particular span. [#59717][#59717] {% comment %}doc{% endcomment %}
- Updated [`SHOW BACKUP ... WITH PRIVILEGES`](../v21.1/show-backup.html) to display ownership information of objects in the backup. [#59732][#59732] {% comment %}doc{% endcomment %}
- The [`ALTER TYPE ... DROP VALUE ...`](../v21.1/alter-type.html) statement has been added to drop values from an [`ENUM`](../v21.1/enum.html) type. The statement drops the provided value if it isn't used as a value in any table's row. The use of this syntax is gated behind the `sql_safe_updates` [session variable](../v21.1/set-vars.html), as it is susceptible to the value being used in a table expression (such as a computed column). [#58688][#58688] {% comment %}doc{% endcomment %}
- Added support for `COPY CSV`. [#59790][#59790] {% comment %}doc{% endcomment %}
- CockroachDB now supports specifying `NULL` and `DELIMITER` in `COPY`. [#59790][#59790] {% comment %}doc{% endcomment %}
- [`ALTER TABLE ... SET LOCALITY`](../v21.1/alter-table.html) adds the ability to change the locality of a `GLOBAL` or `REGIONAL BY TABLE` table to `REGIONAL BY ROW`, provided an existing column of the appropriate type already exists. [#59624][#59624] {% comment %}doc{% endcomment %}
- Overload sequence operators now accept a regclass. [#59396][#59396]
- `crdb_internal.invalid_objects` now includes invalid type descriptors. [#59978][#59978] {% comment %}doc{% endcomment %}
- Added the `finished` column to the virtual table `crdb_internal.node_inflight_trace_spans`, which represents whether each span has finished or not. [#59856][#59856] {% comment %}doc{% endcomment %}
- Partitioned [inverted indexes](../v21.1/inverted-indexes.html) are now supported. [#59858][#59858] {% comment %}doc{% endcomment %}
- Hidden columns (created by using `NOT VISIBLE` or implicitly created via hash sharded indexes, a lack of a primary key definition, or by using `REGIONAL BY ROW`) will now display with `NOT VISIBLE` annotations on [`SHOW CREATE TABLE`](../v21.1/show-create.html). [#59828][#59828] {% comment %}doc{% endcomment %}
- `REGIONAL BY ROW` tables that have an implicitly created `crdb_region` table will now mark the given column as hidden so it does not display in `SELECT *` statements. [#59831][#59831] {% comment %}doc{% endcomment %}
- CockroachDB now recognizes the `options` URL parameter. The `options` parameter specifies session variables to set at connection start. This is treated the same as defined in the [PostgreSQL docs](https://www.postgresql.org/docs/13/libpq-connect.html#LIBPQ-PARAMKEYWORDS). [#59621][#59621] {% comment %}doc{% endcomment %}
- Implemented the ability to `ALTER TABLE SET LOCALITY` to `REGIONAL BY ROW` without specifying `AS` for `GLOBAL` and `REGIONAL BY TABLE` tables. [#59824][#59824] {% comment %}doc{% endcomment %}
- Added the `sql.show_tables.estimated_row_count.enabled` [cluster setting](../v21.1/cluster-settings.html), which defaults to `true`. If `false`, `estimated_row_count` will not display on `SHOW TABLES` which improves performance. [#60282][#60282] {% comment %}doc{% endcomment %}
- [`ALTER DATABASE ... DROP REGION`](../v21.1/alter-database.html) is now implemented. [#59989][#59989] {% comment %}doc{% endcomment %}
- When a connection is established, CockroachDB will now return a placeholder `BackendKeyData` message in the response. This is for compatibility with some tools, but using `BackendKeyData` to cancel a query will still have no effect (which is the same as before). [#60281][#60281] {% comment %}doc{% endcomment %}
- To match the behavior of `PRIMARY KEY` creations setting, all relevant fields to `NOT NULL`, all `PARTITION BY` / R`EGIONAL BY ROW` columns will now have their fields set to `NOT NULL` at [`CREATE TABLE`](../v21.1/create-table.html) time. [#60379][#60379] {% comment %}doc{% endcomment %}
- [`ALTER DATABASE ... DROP REGION`](../v21.1/alter-database.html) now allows for dropping the primary region. [#60437][#60437] {% comment %}doc{% endcomment %}
- Added support for [restore](../v21.1/restore.html) of multi-region databases. [#60257][#60257] {% comment %}doc{% endcomment %}
- Implemented functionality to [`ALTER TABLE SET LOCALITY`](../v21.1/alter-table.html) from `REGIONAL BY ROW` to `REGIONAL BY TABLE` or `GLOBAL`. [#60311][#60311] {% comment %}doc{% endcomment %}
- Materialized views now require ownership or admin privilege to refresh. [#60448][#60448] {% comment %}doc{% endcomment %}
- `CONNECT` can be granted to / revoked from users at the database level (e.g., `GRANT CONNECT ON DATABASE db TO user;`). `CONNECT` allows users to view all objects in a database in `information_schema` and `pg_catalog`. Previously, only users could only see an object in `information_schema` / `pg_catalog` if they had any privilege (e.g., `SELECT`) on the object.  Added a warning when using `USE DATABASE` that notifies the user that they do not have `CONNECT` privilege on the database and will need `CONNECT` privilege to use databases in a future release. [#59676][#59676] {% comment %}doc{% endcomment %}
- Add the builtin `crdb_internal.show_create_all_tables`, which takes in a database name (`STRING`) and returns a flat log of all the [`CREATE TABLE`](../v21.1/create-table.html) statements in the database followed by `ALTER` statements to add constraints. The output can be used to recreate a database. This builtin was added to replace old dump logic. [#60154][#60154] {% comment %}doc{% endcomment %}
- Implemented `default_to_database_primary_region`, which will return the region passed in if the region is defined on the database, falling back to the primary key if not. [#59836][#59836] {% comment %}doc{% endcomment %}
- The default expression for `REGIONAL BY ROW` tables is now `default_to_database_primary_region(gateway_region())`, allowing users to add to `REGIONAL BY ROW` tables from any region. This would previously error if the gateway's region was not defined on the database. [#59836][#59836] {% comment %}doc{% endcomment %}
- [`EXPLAIN`](../v21.1/explain.html) now shows the estimated percentage of the table that is scanned. [#60467][#60467] {% comment %}doc{% endcomment %}
- Multi-region tables will have their zone configs regenerated during database [restore](../v21.1/restore.html). [#60519][#60519] {% comment %}doc{% endcomment %}
- CockroachDB now supports the `DETACHED` option when running [`IMPORT`](../v21.1/import.html). The detached import will return `jobID` and the user can later use [`SHOW JOB`](../v21.1/show-jobs.html) to check the result of the detached import. This allows users to run `IMPORT` under explicit transactions with `DETACHED` option specified. [#60442][#60442] {% comment %}doc{% endcomment %}
- Casting JSON numeric scalars to numeric types now works as expected. [#41367][#41367] {% comment %}doc{% endcomment %}
- Most batches of data flowing through the vectorized execution engine will now be limited in size by `sql.distsql.temp_storage.workmem` (64MiB by default), which should improve the stability of CockroachDB clusters. [#59851][#59851] {% comment %}doc{% endcomment %}
- Implemented the ability to [`ALTER TABLE LOCALITY REGIONAL BY ROW`](../v21.1/alter-table.html) from other `REGIONAL BY ROW` variants. [#60497][#60497] {% comment %}doc{% endcomment %}
- Setting of [zone configs](../v21.1/configure-replication-zones.html) for non-physical tables is now forbidden. [#60592][#60592] {% comment %}doc{% endcomment %}
- Added telemetry to track usage of `pg_catalog` and `information_schema` tables [#60511][#60511]
- [`SHOW JOBS`](../v21.1/show-jobs.html) now displays a meaningful value in the `running_status` column for GC jobs which are actually performing garbage collection, as opposed to waiting on a timer. [#59220][#59220] {% comment %}doc{% endcomment %}
- Added the [`SHOW CREATE ALL TABLES`](../v21.1/show-create.html) statement, which allows the user to get the statements (`CREATE`/`ALTER`) to recreate a the current database. The command returns a flat log of the create statements followed by the alter statements for adding the constraints. The commands are ordered topologically such that dependencies appear before it's references. `ALTER` statements follow create statements to guarantee that the objects are all added before adding constraints. This command is added to replace old dump logic. [#60539][#60539] {% comment %}doc{% endcomment %}
- Added the `schema_name` and `table_i`d columns to the `crdb_internal.ranges` and `crdb_internal.ranges_no_leases` virtual tables. [#59865][#59865] {% comment %}doc{% endcomment %}
- Using the `CACHE` sequence option no longer results in an "unimplemented" error. The `CACHE` option is now fully implemented and will allow nodes to cache sequence numbers. A cache size of 1 means that there is no cache, and cache sizes of less than 1 are not valid. [#56954][#56954] {% comment %}doc{% endcomment %}
- The `serial_normalization` [session variable](../v21.1/set-vars.html) can now be set to the value `sql_sequence_cached`. If this value is set, the `sql.defaults.serial_sequences_cache_size` [cluster setting](../v21.1/cluster-settings.html) can be used to control the number of values to cache in a user's session with a default of 256. When the cache is empty, the the underlying sequence will only be incremented once to populate it. Using `sql_sequence_cached` will result in better performance than `sql_sequence` because the former will perform fewer distributed calls to increment sequences. However, cached sequences may result in large gaps between serial sequence numbers if a session terminates before using all the values in its cache. [#56954][#56954] {% comment %}doc{% endcomment %}
- CockroachDB can now encode and decode [sequence](../v21.1/create-sequence.html) regclasses. [#59864][#59864]
- CockroachDB now allows renaming of [sequences](../v21.1/create-sequence.html) referenced by ID and conversion of sequences referenced by name to ID. [#59864][#59864] {% comment %}doc{% endcomment %}
- [`EXPLAIN ANALYZE`](../v21.1/explain-analyze.html) now shows more top-level query statistics. [#60641][#60641] {% comment %}doc{% endcomment %}
- Added `payloads_for_span` builtin that takes in a span ID and returns its paylods in `JSONB` format. If the span is not found, or if the span does not have any payloads, the builtin returns an empty JSON object. [#60616][#60616] {% comment %}doc{% endcomment %}
- Added a new [`IMPORT PGDUMP`](../v21.1/import.html) option, `ignore_unsupported`, to skip over all the unsupported `PGDUMP` stmts. The collection of these statements will be appropriately documented. [#57827][#57827] {% comment %}doc{% endcomment %}
- Users will now need to specify `ignore_unsupported` to ignore all unsupported import stmts during an [`IMPORT PGDUMP`](../v21.1/import.html). [#57827][#57827] {% comment %}doc{% endcomment %}
- Added a new [`IMPORT PGDUMP`](../v21.1/import.html) option, `ignored_stmt_log`, which allows users to specify where they would like to log stmts that have been skipped during an import, by virtue of being unsupported. [#57827][#57827] {% comment %}doc{% endcomment %}
- CockroachDB now supports `VIRTUAL` [computed columns](../v21.1/computed-columns.html) (as opposed to `STORED`). These are computed columns that are not stored in the primary index and are recomputed as necessary. [#60748][#60748] {% comment %}doc{% endcomment %}
- [`EXPLAIN ANALYZE`](../v21.1/explain-analyze.html) now includes the nodes which were involved in the execution of each operator in the tree. [#60550][#60550] {% comment %}doc{% endcomment %}
- Added missing tables and columns at `pg_catalog`. [#60758][#60758] {% comment %}doc{% endcomment %}
- Added a new [session setting](../v21.1/set-vars.html) `locality_optimized_partitioned_index_scan` and corresponding [cluster default setting](../v21.1/cluster-settings.html) `sql.defaults.locality_optimized_partitioned_index_scan.enabled`. Both are currently disabled by default, and are currently unused. In the future, these settings will be used to enable or disable locality optimized search. If enabled, the optimizer will try to search locally for rows in `REGIONAL BY ROW` tables before searching remote nodes. [#60771][#60771] {% comment %}doc{% endcomment %}
- Added the new `parse_timestamp` function, which can be used to parse absolute timestamp strings in computed column expressions or partial index predicates. [#60772][#60772] {% comment %}doc{% endcomment %}
- CockroachDB now supports storing spatial type objects with `Z` and `M` dimensions (e.g., `POINTZ`, `LINESTRINGM`). [#60832][#60832] {% comment %}doc{% endcomment %}
- [`ALTER DATABASE ... ADD REGION`](../v21.1/alter-database.html) now re-partitions `REGIONAL BY ROW` tables and updates the [zone configs](../v21.1/configure-replication-zones.html) on the newly created partitions as well. [#60596][#60596] {% comment %}doc{% endcomment %}
- Updated the `crdb_internal.payloads_for_span` builtin to return a table instead of a `JSONB` array. Each row of the table represents one payload for the given span. It has columns for `payload_type` and `payload_jsonb`. [#60784][#60784] {% comment %}doc{% endcomment %}
- [`ALTER DATABASE ... DROP REGION ...`](../v21.1/alter-database.html) now re-partitions `REGIONAL BY ROW` tables to remove the partition for the removed region and removes the [zone configuration](../v21.1/configure-replication-zones.html) for the partition as well. [#60938][#60938] {% comment %}doc{% endcomment %}
- Added the experimental `experimental_enable_stream_replication` [session setting](../v21.1/set-vars.html) and `sql.defaults.experimental_stream_replication.enabled` [cluster setting](../v21.1/cluster-settings.html) to enable cluster streaming. [#60826][#60826] {% comment %}doc{% endcomment %}
- Introduced a new `is_multi_region` column to c`rdb_internal.create_statements`, which informs whether the database of the object is a multi-region database. [#60761][#60761] {% comment %}doc{% endcomment %}
- Introduced the new `crdb_internal.filter_multiregion_fields_from_zone_config_sql` builtin, which removes multi-region fields from a [`CONFIGURE ZONE`](../v21.1/configure-zone.html) statement. [#60761][#60761] {% comment %}doc{% endcomment %}
- Added new virtual tables `crdb_internal.cluster_contention_events` and `crdb_internal.node_contention_events`, which expose cluster-wide and gateway-only, respectively, contention information. In order to access them, the user needs to be either an admin or have `VIEWACTIVITY` grant. [#60713][#60713] {% comment %}doc{% endcomment %}
- The structured payloads used for SQL audit and execution logs now include a transaction counter since the beginning of the session. Statements issued inside the same SQL [transaction](../v21.1/transactions.html) will thus be logged with the same counter value, thus enabling per-transactions grouping during log analysis. Separate sessions use independent counters. [#41929][#41929] {% comment %}doc{% endcomment %}
- The geometry builtins `ST_MakePoint` and `ST_MakePointM` have been implemented and provide a mechanism for easily creating new points. [#61105][#61105] {% comment %}doc{% endcomment %}
- Added the `payloads_for_trace()` builtin so that all payloads attached to all spans for a given trace ID will be displayed, utilizing the `crdb_internal.payloads_for_span()` builtin under the hood. All payloads for long-running spans are also added to debug.zip in the `crdb_internal.node_inflight_trace_spans` table dump. [#60922][#60922] {% comment %}doc{% endcomment %}
- [`IMPORT PGDUMP`](../v21.1/import.html) can now import dump files with non-public schemas. [#57183][#57183] {% comment %}doc{% endcomment %}
- Added the `sql.optimizer.uniqueness_checks_for_gen_random_uuid.enabled` [cluster setting](../v21.1/cluster-settings.html), which controls creation of uniqueness checks for [`UUID`](../v21.1/uuid.html) columns set to `gen_random_uuid()`. When enabled, uniqueness checks will be added for the `UUID` column if it has a unique constraint that cannot be enforced by an index. When disabled, no uniqueness checks are planned for these columns, and uniqueness is assumed due to the near-zero collision probability of `gen_random_uuid()`. [#61132][#61132] {% comment %}doc{% endcomment %}
- The `pg_catalog.pg_class` table now has a `relpartbound` column. This is only for compatibility, and the column value is always `NULL`. [#61162][#61162] {% comment %}doc{% endcomment %}
- Cluster [backup](../v21.1/backup.html) now [restores](../v21.1/restore.html) the zone configurations first. This means that there should be less range-relocation during and after cluster restores. [#60461][#60461] {% comment %}doc{% endcomment %}
- Fixed `information_schema.columns.udt_schema` for `ENUM` or user-defined types. [#61139][#61139] {% comment %}doc{% endcomment %}
- The geography builtin `ST_Affine` now supports 3D transformations. [#61286][#61286] {% comment %}doc{% endcomment %}
- The `ST_Z`, `ST_M`, and `ST_Zmflag` builtins are now available for use. [#61032][#61032] {% comment %}doc{% endcomment %}
- Geometry builtins for forcing geometries into non-2D layouts are now available. [#61297][#61297] {% comment %}doc{% endcomment %}
- `ST_Buffer` now requires at least 1 quadrant segment. [#61315][#61315] {% comment %}doc{% endcomment %}
- `ST_RotateX` function is now available. [#61326][#61326] {% comment %}doc{% endcomment %}
- [`EXPLAIN`](../v21.1/explain.html) now shows estimated row counts for all operators even without `VERBOSE` (except when we do not have statistics for the tables). [#61344][#61344] {% comment %}doc{% endcomment %}
- Updated the error message returned in case of a [unique constraint](../v21.1/unique.html) violation to hide the names and values for implicit partitioning columns and hash sharded index columns. [#61362][#61362]
- Fixed `information_schema.columns.is_identity` to display the correct value. [#61348][#61348]
- `ST_RotateY` and `ST_RotateZ` are now available. [#61387][#61387] {% comment %}doc{% endcomment %}
- CockroachDB now prevents `densifyFracs < 1e-6` for `ST_FrechetDistance` and `ST_HausdorffDistance` to protect panics and out-of-memory errors. [#61427][#61427]
- CockroachDB now disallows `GRANT/REVOKE` operations on system tables. [#61410][#61410] {% comment %}doc{% endcomment %}
- `ST_Snap` is now available. [#61523][#61523] {% comment %}doc{% endcomment %}
- Updates to certain fields in the zone configurations are blocked for multi-region enabled databases. This block can be overridden through the use of the `FORCE` keyword on the blocked statement. [#61499][#61499] {% comment %}doc{% endcomment %}
- The `ST_AddMeasure` function is now available for use. [#61514][#61514] {% comment %}doc{% endcomment %}
- Added a new builtin that sets the verbosity of all spans in a given trace. Syntax: `crdb_internal.set_trace_verbose($traceID,$verbosityAsBool)`. [#61353][#61353] {% comment %}doc{% endcomment %}
- `Pg_index.indkey` now includes attributes. [#61494][#61494] {% comment %}doc{% endcomment %}
- [`SHOW CREATE ALL TABLES`](../v21.1/show-create.html) is updated to be more memory efficient, however this should still not be run on a database with an excessive number of tables. Users should not run this on a database with more than 10000 tables (arbitrary but tested number). [#61127][#61127] {% comment %}doc{% endcomment %}
- Set the default [cluster setting](../v21.1/cluster-settings.html) for `sql.defaults.locality_optimized_partitioned_index_scan.enabled` to `true`, which is the default for the [session setting](../v21.1/set-vars.html) `locality_optimized_partitioned_index_scan`. When this session setting is enabled, the optimizer will plan queries to use "locality optimized search" when possible, which instructs the execution engine to search for keys in local nodes before searching remote nodes. If a key is found in a local node, the execution engine may be able to avoid visiting the remote nodes altogether. [#61601][#61601] {% comment %}doc{% endcomment %}
- [`ALTER TYPE ... DROP VALUE`](../v21.1/alter-type.html) is gated behind a feature flag. The [session setting](../v21.1/set-vars.html) is called `enable_drop_enum_value` and the corresponding [cluster setting](../v21.1/cluster-settings.html) is called `sql.defaults.drop_enum_value.enabled`. [#61723][#61723] {% comment %}doc{% endcomment %}
- `TYPE SCHEMA CHANGE` jobs which include a `DROP VALUE` in them are now cancellable. All other jobs remain non-cancellable. [#61733][#61733] {% comment %}doc{% endcomment %}
- A statement contention timeseries is now displayed in the SQL metrics overview dashboard. [#61844][#61844] {% comment %}doc{% endcomment %}
- The `ST_SnapToGrid` function can now be used to snap `Z` and `M` dimensions. [#61826][#61826] {% comment %}doc{% endcomment %}
- Added `json_extract_path_text` and `jsonb_extract_path_text` builtins. [#61813][#61813] {% comment %}doc{% endcomment %}
- Removed `pg_catalog` tables that were mistakenly added, notably all tables that end in `_index` that are not `pg_catalog.pg_classes` and all statistics collector tables that are not `pg_stat_activity`. [#61876][#61876]
- The `replicas` column of `crdb_internal.ranges{_no_leases}` now includes both voting and non-voting replicas and `crdb_internal.ranges{_no_leases}` include two new columns: `voting_replicas` and `non_voting_replicas`, which work as labeled. [#61962][#61962] {% comment %}doc{% endcomment %}

### Operational changes

- Added the `storage.transaction.separated_intents.enabled` [cluster setting](../v21.1/cluster-settings.html), which enables separated intents by default. [#59829][#59829] {% comment %}doc{% endcomment %}

### Command-line changes

- It is now possible to redirect logging to [Fluentd](https://www.fluentd.org)-compatible network collectors. See the reference sink documentation for details.This is an alpha-quality feature. Note that Fluent-enabled configuration only provide minimal event buffering, and log entries are dropped if the logging server becomes unavailable or network errors are encountered. This is a known limitation and will be likely improved in a later version. [#57170][#57170] {% comment %}doc{% endcomment %}
- The SQL shell ([`cockroach sql`](../v21.1/cockroach-sql.html) / [`cockroach demo`](../v21.1/cockroach-demo.html)) now supports a flag `--embedded`, for use with playground-style web applications. [#59750][#59750] {% comment %}doc{% endcomment %}
- [`cockroach userfile get`](../v21.1/cockroach-userfile-get.html) can now be used to fetch files from a cluster. [#60490][#60490] {% comment %}doc{% endcomment %}
- Added the `ignore-unsupported-statements`, `log-ignored-statements` and `row-limit` flags to the [`cockroach import`](../v21.1/cockroach-import.html) command. [#60923][#60923] {% comment %}doc{% endcomment %}
- The doctor tool can now report multiple descriptor validation failures per descriptor. [#60775][#60775]
- The new `cockroach connect` command now recognizes `--single-node` to prepare a TLS configuration suitable for a subsequent `start-single-node` command. Additionally, the command checks that either `--single-node` is specified, or both `--init-token` and `--num-expected-peers`. [#60854][#60854] {% comment %}doc{% endcomment %}
- Optimized handling of multi-line SQL strings to avoid unwanted extra server roundtrips. [#61207][#61207]
- Added back support for [`cockroach dump --dump-mode=schema`](../v21.1/cockroach-dump.html). This command calls [`SHOW CREATE ALL TABLES`](../v21.1/show-create.html) and returns the output. This gives users a migration path to use in v21.1 while switching over to `SHOW CREATE ALL TABLES` for v21.2. When executing this, the user is warned that the command is being removed in v21.2 and they should use `SHOW CREATE ALL TABLES` instead. [#61871][#61871] {% comment %}doc{% endcomment %}

### API endpoint changes

- Added the following new HTTP API endpoints:

    - `/api/v2/nodes/`: Lists all nodes in the cluster
    - `/api/v2/nodes/<node_id>/ranges`: Lists all ranges on the specified node
    - `/api/v2/ranges/hot/`: Lists hot ranges in the cluster
    - `/api/v2/ranges/<range_id>/`: Describes range in more detail
    - `/api/v2/health/`: Returns an HTTP 200 response if node is healthy. [#60952][#60952]

### DB Console changes

- Manually enqueue range in a replica GC queue now properly respects the `SkipShouldQueue` option. This can be useful to force a GC of a specific Range. [#60619][#60619] {% comment %}doc{% endcomment %}
- Added a filter for full scans to the [**Statements** page](../v21.1/ui-statements-page.html). [#60670][#60670] {% comment %}doc{% endcomment %}
- The **Range Report** page on the DB Console will now also show each of the replica's types. [#61113][#61113] {% comment %}doc{% endcomment %}
- The **Transaction Type** column was removed from [**Statements** page](../v21.1/ui-statements-page.html). The sort order in **Statement** / **Transaction Table** views is now by execution count. The sort order in **Transaction Details** view is by latency. Column titles in statements and transactions tables now say "{Statement,Transaction} Time" instead of "Latency". The **Contention** column added to the **Statements** / **Transactions** pages. **Max Scratch Disk Usage** added to **Statements** and **Transaction Details** pages. [#61177][#61177] {% comment %}doc{% endcomment %}
- Added a full-table scan checkbox. [#61676][#61676] {% comment %}doc{% endcomment %}

### Bug fixes

- Fixed a bug in the DB Console affecting status badges in Nodes list on **Cluster Overview** page. [#59636][#59636]
- Fixes a bug where backups would fail with an error when trying to read a backup that was written. [#59730][#59730]
- Fixes a bug where some import failures would cause tables to stay `OFFLINE`, when they should have been brought back to `PUBLIC`. [#59723][#59723]
- Fixed a bug that caused errors when joining two tables when one of the tables had a computed column. This bug was present since version v21.1.0-alpha.2 and not present in any production releases. [#59741][#59741]
- Statistics are now correctly generated for columns in multi-column inverted indexes and columns referenced in partial inverted index predicates. [#59687][#59687]
- Fixed a timestamp overflow bug that would overflow timestamps after the year 2038 by updating the Avro SDK used by changefeeds. [#59745][#59745]
- Fixed a very rare chance of inconsistent follower reads. [#59502][#59502]
- Previously if `RELEASE SAVEPOINT cockroach_restart` was followed by `ROLLBACK`, the `sql.txn.rollback.count` metric would be incremented. This was incorrect, since the transaction had already committed. Now that metric is not incremented in this case. [#59781][#59781]
- CockroachDB now explicitly verify descriptors are sequences. [#60159][#60159]
- The final result of the `cockroach debug doctor` invocation during `cockroach debug zip` is now properly included inside the generated zip file. [#60529][#60529]
- Fixed a bug in the optimizer statistics code that could cause an unconstrained partial index scan to be preferred over a constrained scan of the same index. [#60516][#60516]
- Fixed a deficiency in the replication layer that could result in ranges becoming unavailable for prolonged periods of time (hours) when a write burst occurred under system overload. While unavailable, the range status page for the affected range would show a last index much larger than the committed index and no movement in these indexes on a quorum of the replicas. Note that this should be distinguished from the case in which enough replicas are offline to constitute a loss of quorum, where the replication layer can not make progress due to the loss of quorum itself. [#60581][#60581]
- Previously, retryable errors in the cleanup phase of the type schema changer wouldn't be retried automatically in the background. This is now fixed. [#60495][#60495]
- v20.2 introduced an ability to rebalance replicas between multiple stores on the same node. This change fixed a problem with that feature, where occasionally an intra-node rebalance would fail and a range would get stuck permanently under replicated. [#60546][#60546]
- Fixed a bug that would cause the value of the optional `into_db` parameter to `RESTORE` to be included in anonymized crash reports. [#60624][#60624]
- Fixed a bug that caused errors for some queries on tables with `GEOMETRY` or `GEOGRAPHY` inverted indexes with filters containing shapes with zero area. [#60598][#60598]
- CockroachDB previously didn't account for some RAM used when disk-spilling operations (like sorts and hash joins) were using the temporary storage in the vectorized execution engine. This could result in OOM crashes, especially when the rows are large in size. This has been fixed. [#60593][#60593]
- Fixed a bug where `ST_Node` would panic if passed in `MULTILINESTRING EMPTY`. [#60691][#60691]
- Fixed a bug that could result in crashes during tracing when using the `trace.debug.enable` cluster setting. [#60725][#60725]
- Fixed execution errors for some queries that use set operations (`UNION` / `EXCEPT` / `INTERSECT`) where a column has types of different widths on the two sides (e.g., `INT4` vs. `INT8`). [#60560][#60560]
- CockroachDB now avoids creating batches that exceed the raft command limit (64MB) when reverting ranges that contain very large keys. [#59716][#59716]
- Fixed a bug whereby high-latency global clusters could sometimes fall behind checkpointing resolved timestamps. [#60807][#60807]
- Added check privileges before changing table/database owner. [#60800][#60800]
- Fixed an internal error caused in some cases involving JSON objects and arrays in a `VALUES` clause. [#60767][#60767]
- Previously `DROP TYPE IF EXISTS` with one existent, and another non-existent type would cause an unhandled error. This is now fixed. [#60822][#60822]
- Fixed bug that could report that a protected timestamp limit was exceeded when the limit was disabled, if an error were to occur while protecting a record. [#60913][#60913]
- CockroachDB previously could encounter an internal error when performing `UNION` operation when the first input resulted only in NULL values and consequent inputs produce tuples, and this is now fixed. Only v21.1 alpha versions are affected. [#60827][#60827]
- Fixed a bug in `crdb_internal.unsafe_upsert_namespace_entry` related to tables and types in user-defined schemas. [#60510][#60510]
- Integers inside of tuples were not being encoded properly when using the binary format for retrieving data. This is now fixed, and the proper integer width is reported. [#61013][#61013]
- Blank-padded chars (e.g., `CHAR(3)`) were not being encoded correctly when returning results to the client. Now they correctly include blank-padding when appropriate. [#61013][#61013]
- Collated strings were not encoded with the proper type OID when sending results to the client if the OID was for the `char` type. This is now fixed. [#61013][#61013]
- Fixed a very rare, possible impossible in practice, bug where a range merge that applied through a Raft snapshot on the left-hand side range's leaseholder could allow that leaseholder to serve writes that invalidated reads from before the merge on the right-hand side.  Release justification: bug fix [#60521][#60521]
- The `SHOW CREATE` output of a partitioned partial index now lists the `PARTITION BY` and `WHERE` clauses in the order accepted by the parser. [#60590][#60590]
- The `SHOW CREATE` output of a partial interleaved index now lists the `INTERLEAVED` and `WHERE` clauses in the order accepted by the parser. [#60590][#60590]
- Fix a bug where cluster restore would sometimes (very rarely) fail after retrying. [#60458][#60458]
- Previously, comparing a negative integer to an OID would fail to compare correctly because the integer was not converted to an unsigned representation first. this is now fixed for both comparisons and casts.[#61148][#61148]
- Previously, CockroachDB could not decode arrays of user-defined types when sent to the server in the binary format. Now it can. [#61165][#61165]
- `crdb_internal.jobs` virtual table is now populated in a paginated fashion, thus, alleviating memory related concerns when previously we could encounter OOM crash. [#60693][#60693]
- The `SHOW TABLES FROM database` command would always show a NULL `estimated_row_count` if inspecting a database that was not the current database. This is now fixed. [#61191][#61191]
- Fixed a bug where schema changes on databases and schemas could return a `relation [<id>] does not exist` if they failed or were canceled and entered the reverting state. These jobs are not actually possible to revert. With this change, the correct error causing the job to fail will be returned, and the job will enter the failed state with an error indicating that the job could not be reverted. [#61159][#61159]
- CockroachDB now drops the default value when its dependent sequence is dropped. [#60744][#60744]
- Dropping and recreating a view/table/sequence in a transaction will now correctly error out if a conflicting object exists or if the drop is incomplete. [#61135][#61135]
- The non-server `cockroach` commands now recognize the new `--log` flag properly. This had been broken in one of the earlier v21.1 alpha releases. [#61232][#61232]
- Prepared statements would sometimes get the wrong type OID for placeholder arguments used in function parameters. This is now fixed. [#60949][#60949]
- Fixed a case where empty zone configurations get created for certain indexes during `ALTER PRIMARY KEY`. [#61235][#61235]
- Schema change jobs associated with databases and schemas can no longer be canceled. Such jobs cannot actually be reverted successfully, so cancelation had no benefit and could have caused namespace corruption. [#61210][#61210]
- Fixed `cockroach demo` commands nodeName error argument index handling. [#61246][#61246]
- CockroachDB no longer displays incorrect node statuses on **Metrics** page, when page just loaded. [#61000][#61000]
- Fixed an NPE observed with a SpanFromContext call in the stack trace. [#61124][#61124]
- Limit scans are no longer counted as full scans. [#61178][#61178]
- Selecting from `crdb_internal.create_statements` will now correctly populate the `database_name` when the virtual index is not used. [#61201][#61201]
- Fixed an internal error when `EXPLAIN`ing an `INSERT` with an input that was determined by the optimizer to produce no rows. [#61278][#61278]
- Fixed a rare deadlock where a series of lease transfers concurrent with a Range merge could block each other from ever completing. [#60905][#60905]
- `ALTER TYPE ... ADD VALUE` changes are picked up by the array type alias correctly. [#61288][#61288]
- Previously, the traces of cascades and checks could be incomplete. This is now fixed. [#61321][#61321]
- Creating interleaved partitioned indexes is now disallowed. Previously, the database would crash when trying to create one. [#61106][#61106]
- Dropping and re-creating a database in a transaction will now correctly error out if an object in a dropped state is detected. [#61361][#61361] [#61358][#61358]
- CockroachDB now uses the correct `FuncExpr` when encoding sequences. [#61428][#61428]
- Alter primary key was not idempotent, so logical equivalent changes to primary keys would unnecessarily create new indexes. This is now fixed. [#61345][#61345]
- Fixed a bug where `GRANT/REVOKE` on the `system.lease` table would result in a deadlock. [#61410][#61410]
- Fixed operation hangs when a node loses access to cluster RPC (e.g., after it has been decommissioned), and immediately return an error instead. [#61356][#61356]
- Fixed a bug from v21.1-alpha where a node decommissioning process could sometimes hang or fail when the decommission request was submitted via the node being decommissioned. [#61356][#61356]
- Fixed bug where zone configurations on indexes were not copied before the backfill of an `ALTER PRIMARY KEY`. They used to be copied afterwards instead. [#61300][#61300]
- Fixed a bug where random numbers generated as default expressions during `IMPORT` would collide a few hundred rows apart from each-other. [#61214][#61214]
- Fixed a bug that caused `UPSERT` and `INSERT..ON CONFLICT..DO UPDATE `statements to fail on tables with both partial indexes and foreign key references. This bug has been present since v20.2.0. [#61416][#61416]
- An `UPDATE..FROM` statement where the `FROM` clause contained column names that match table column names erred if the table had a partial index predicate referencing those columns. This bug, present since partial indexes were released in v20.2.0, has been fixed. [#61522][#61522]
- The names of custom types are no longer sent to Cockroach Labs in telemetry and crash reports. [#60806][#60806]
- Fixed a case where an invalid tuple comparison using ANY was causing an internal error; we now return "unsupported comparison operator". [#61647][#61647]
- Added better privilege checks when creating a changefeed. [#61709][#61709]
- Fixed privileges for system.`protected_ts_meta`. [#61842][#61842]
- The `indexdef` column in the `pg_indexes` table would always report that the index belonged to the public schema. Now it correctly reports user-defined schemas if necessary. [#61754][#61754]
- Fixed "command is too large" errors in some cases when using `EXPLAIN ANALYZE (DEBUG)` or statement diagnostics on complex queries. [#61909][#61909]
- Using `EXPLAIN (OPT, ENV)` on a query that references a table in a user-defined schema would fail previously. This is now fixed. [#61888][#61888]
- Fixed a bug that caused "column does not exist errors" in specific cases of `UPDATE..FROM` statements. The error only occurred when updating a `DECIMAL` column to a column in the `FROM` clause, and the column had a `CHECK` constraint or was referenced by a partial index predicate. [#61949][#61949]
- Previously the `idle_in_session_timeout` and `idle_in_transaction_session_timeout` settings would show the wrong value when using `SHOW`. They would instead show the value of the `statement_timeout` setting. This is now fixed. The functionality was already working correctly; this just fixes a display bug. [#61959][#61959]

### Performance improvements

- Improved the performance of the `pg_table_is_visible` builtin function. [#59880][#59880]
- Added support for left and anti lookup joins in cases where the equi-join condition is not on the first column in the index, but the first column(s) are constrained to a small number of constant values using a CHECK constraint or an ENUM type. Planning a lookup join for these cases can significantly improve performance if the left input to the join is much smaller than the right-hand side. [#60302][#60302]
- The optimizer now knows that the unique columns in an implicitly partitioned unique index form a key. This can be used to enable certain optimizations and may result in better plans. [#60591][#60591]
- Improved the optimizer's ability to identify constant columns in scans. This can enable different types of optimizations and result in improved plans. [#60927][#60927]
- Follower reads no longer wait before redirecting to the leaseholder if they could not be served by a local follower due to an insufficient closed timestamp. [#60839][#60839]
- Updated the query used to build the virtual table `crdb_internal.table_row_statistics` so that it is always run at `AS OF SYSTEM TIME '-10s'`. This should reduce contention on the table and improve performance for transactions that rely on `crdb_internal.table_row_statistics`, such as `SHOW TABLES`. [#60953][#60953]
- Improved the optimizer's cost estimation of index scans that must visit multiple partitions. When an index has multiple partitions, the optimizer is now more likely to choose a constrained scan rather than a full index scan. This can lead to better plans and improved performance. It also improves the ability of the database to serve queries if one of the partitions is unavailable. [#61063][#61063]
- Optimized external sort to merge partition data faster in colexec. [#61056][#61056]
- If the session setting `locality_optimized_partitioned_index_scan` is enabled, the optimizer will try to plan scans known to produce at most one row using "locality optimized search". This optimization applies for `REGIONAL BY ROW` tables, and if enabled, it means that the execution engine will first search locally for the row before searching remote nodes. If the row is found in a local node, remote nodes will not be searched. [#60831][#60831]
- The optimizer now infers additional functional dependencies based on computed columns in tables. This may enable additional optimizations and lead to better query plans. [#61097][#61097]
- Removed uniqueness checks on the primary key for `REGIONAL BY ROW` tables with a computed region column that is a function of the primary key columns. Uniqueness checks are not necessary in this case since uniqueness can be suitably guaranteed by the primary index. Removing these checks improves performance of `INSERT`, `UPDATE`, and `UPSERT` statements. [#61097][#61097]
- The optimizer no longer plans uniqueness checks for columns in implicitly partitioned unique indexes when those columns are used as the arbiters to detect conflicts in `INSERT ... ON CONFLICT` statements. Unique checks are not needed in this case to enforce uniqueness. Removing these checks results in improved performance for `INSERT ... ON CONFLICT` statements. [#61184][#61184]
- The columns fetched for uniqueness checks of implicitly partitioned unique indexes are now pruned to only include columns necessary for determining uniqueness. [#61376][#61376]
- Introspection queries that use casts into the `REGPROC` pseudo-type are made much more efficient: they're now implemented as a constant-time lookup instead of an internal query. [#61211][#61211]
- Fixed cases where the optimizer was doing unnecessary full table scans when the table was very small (according to the last collected statistics). [#61805][#61805]
- The optimizer now estimates the cost of evaluating query filters more accurately for queries with a `LIMIT`. Previously, it was assumed that the filter would be evaluated on each input row. Now, the optimizer assumes that the filter will only be evaluated on the number of rows required to produce the LIMIT's number of rows after filtering. This may lead to more efficient query plans in some cases. [#61947][#61947]

### Contributors

This release includes 667 merged PRs by 70 authors.
We would like to thank the following contributors from the CockroachDB community:

- Abdullah Islam (first-time contributor)
- Alan Acosta (first-time contributor)
- Kumar Akshay
- Max Neverov
- Miguel Novelo (first-time contributor)
- Ratnesh Mishra (first-time contributor)
- Tharun (first-time contributor)
- Ulf Adams (first-time contributor)
- alex-berger@gmx.ch (first-time contributor)
- leoric (first-time contributor)
- shikamaru (first-time contributor)

[#41367]: https://github.com/cockroachdb/cockroach/pull/41367
[#41929]: https://github.com/cockroachdb/cockroach/pull/41929
[#56954]: https://github.com/cockroachdb/cockroach/pull/56954
[#57077]: https://github.com/cockroachdb/cockroach/pull/57077
[#57170]: https://github.com/cockroachdb/cockroach/pull/57170
[#57183]: https://github.com/cockroachdb/cockroach/pull/57183
[#57827]: https://github.com/cockroachdb/cockroach/pull/57827
[#58422]: https://github.com/cockroachdb/cockroach/pull/58422
[#58688]: https://github.com/cockroachdb/cockroach/pull/58688
[#58923]: https://github.com/cockroachdb/cockroach/pull/58923
[#59086]: https://github.com/cockroachdb/cockroach/pull/59086
[#59220]: https://github.com/cockroachdb/cockroach/pull/59220
[#59396]: https://github.com/cockroachdb/cockroach/pull/59396
[#59410]: https://github.com/cockroachdb/cockroach/pull/59410
[#59490]: https://github.com/cockroachdb/cockroach/pull/59490
[#59492]: https://github.com/cockroachdb/cockroach/pull/59492
[#59502]: https://github.com/cockroachdb/cockroach/pull/59502
[#59539]: https://github.com/cockroachdb/cockroach/pull/59539
[#59571]: https://github.com/cockroachdb/cockroach/pull/59571
[#59621]: https://github.com/cockroachdb/cockroach/pull/59621
[#59624]: https://github.com/cockroachdb/cockroach/pull/59624
[#59636]: https://github.com/cockroachdb/cockroach/pull/59636
[#59676]: https://github.com/cockroachdb/cockroach/pull/59676
[#59687]: https://github.com/cockroachdb/cockroach/pull/59687
[#59692]: https://github.com/cockroachdb/cockroach/pull/59692
[#59693]: https://github.com/cockroachdb/cockroach/pull/59693
[#59709]: https://github.com/cockroachdb/cockroach/pull/59709
[#59710]: https://github.com/cockroachdb/cockroach/pull/59710
[#59716]: https://github.com/cockroachdb/cockroach/pull/59716
[#59717]: https://github.com/cockroachdb/cockroach/pull/59717
[#59723]: https://github.com/cockroachdb/cockroach/pull/59723
[#59730]: https://github.com/cockroachdb/cockroach/pull/59730
[#59732]: https://github.com/cockroachdb/cockroach/pull/59732
[#59735]: https://github.com/cockroachdb/cockroach/pull/59735
[#59741]: https://github.com/cockroachdb/cockroach/pull/59741
[#59745]: https://github.com/cockroachdb/cockroach/pull/59745
[#59750]: https://github.com/cockroachdb/cockroach/pull/59750
[#59781]: https://github.com/cockroachdb/cockroach/pull/59781
[#59790]: https://github.com/cockroachdb/cockroach/pull/59790
[#59810]: https://github.com/cockroachdb/cockroach/pull/59810
[#59815]: https://github.com/cockroachdb/cockroach/pull/59815
[#59824]: https://github.com/cockroachdb/cockroach/pull/59824
[#59828]: https://github.com/cockroachdb/cockroach/pull/59828
[#59829]: https://github.com/cockroachdb/cockroach/pull/59829
[#59831]: https://github.com/cockroachdb/cockroach/pull/59831
[#59836]: https://github.com/cockroachdb/cockroach/pull/59836
[#59851]: https://github.com/cockroachdb/cockroach/pull/59851
[#59856]: https://github.com/cockroachdb/cockroach/pull/59856
[#59858]: https://github.com/cockroachdb/cockroach/pull/59858
[#59864]: https://github.com/cockroachdb/cockroach/pull/59864
[#59865]: https://github.com/cockroachdb/cockroach/pull/59865
[#59877]: https://github.com/cockroachdb/cockroach/pull/59877
[#59880]: https://github.com/cockroachdb/cockroach/pull/59880
[#59978]: https://github.com/cockroachdb/cockroach/pull/59978
[#59989]: https://github.com/cockroachdb/cockroach/pull/59989
[#59995]: https://github.com/cockroachdb/cockroach/pull/59995
[#60154]: https://github.com/cockroachdb/cockroach/pull/60154
[#60159]: https://github.com/cockroachdb/cockroach/pull/60159
[#60160]: https://github.com/cockroachdb/cockroach/pull/60160
[#60257]: https://github.com/cockroachdb/cockroach/pull/60257
[#60281]: https://github.com/cockroachdb/cockroach/pull/60281
[#60282]: https://github.com/cockroachdb/cockroach/pull/60282
[#60302]: https://github.com/cockroachdb/cockroach/pull/60302
[#60311]: https://github.com/cockroachdb/cockroach/pull/60311
[#60379]: https://github.com/cockroachdb/cockroach/pull/60379
[#60437]: https://github.com/cockroachdb/cockroach/pull/60437
[#60442]: https://github.com/cockroachdb/cockroach/pull/60442
[#60448]: https://github.com/cockroachdb/cockroach/pull/60448
[#60458]: https://github.com/cockroachdb/cockroach/pull/60458
[#60461]: https://github.com/cockroachdb/cockroach/pull/60461
[#60467]: https://github.com/cockroachdb/cockroach/pull/60467
[#60469]: https://github.com/cockroachdb/cockroach/pull/60469
[#60490]: https://github.com/cockroachdb/cockroach/pull/60490
[#60495]: https://github.com/cockroachdb/cockroach/pull/60495
[#60497]: https://github.com/cockroachdb/cockroach/pull/60497
[#60510]: https://github.com/cockroachdb/cockroach/pull/60510
[#60511]: https://github.com/cockroachdb/cockroach/pull/60511
[#60516]: https://github.com/cockroachdb/cockroach/pull/60516
[#60519]: https://github.com/cockroachdb/cockroach/pull/60519
[#60521]: https://github.com/cockroachdb/cockroach/pull/60521
[#60529]: https://github.com/cockroachdb/cockroach/pull/60529
[#60539]: https://github.com/cockroachdb/cockroach/pull/60539
[#60546]: https://github.com/cockroachdb/cockroach/pull/60546
[#60550]: https://github.com/cockroachdb/cockroach/pull/60550
[#60560]: https://github.com/cockroachdb/cockroach/pull/60560
[#60581]: https://github.com/cockroachdb/cockroach/pull/60581
[#60590]: https://github.com/cockroachdb/cockroach/pull/60590
[#60591]: https://github.com/cockroachdb/cockroach/pull/60591
[#60592]: https://github.com/cockroachdb/cockroach/pull/60592
[#60593]: https://github.com/cockroachdb/cockroach/pull/60593
[#60594]: https://github.com/cockroachdb/cockroach/pull/60594
[#60596]: https://github.com/cockroachdb/cockroach/pull/60596
[#60598]: https://github.com/cockroachdb/cockroach/pull/60598
[#60616]: https://github.com/cockroachdb/cockroach/pull/60616
[#60619]: https://github.com/cockroachdb/cockroach/pull/60619
[#60624]: https://github.com/cockroachdb/cockroach/pull/60624
[#60641]: https://github.com/cockroachdb/cockroach/pull/60641
[#60670]: https://github.com/cockroachdb/cockroach/pull/60670
[#60691]: https://github.com/cockroachdb/cockroach/pull/60691
[#60693]: https://github.com/cockroachdb/cockroach/pull/60693
[#60708]: https://github.com/cockroachdb/cockroach/pull/60708
[#60713]: https://github.com/cockroachdb/cockroach/pull/60713
[#60725]: https://github.com/cockroachdb/cockroach/pull/60725
[#60744]: https://github.com/cockroachdb/cockroach/pull/60744
[#60748]: https://github.com/cockroachdb/cockroach/pull/60748
[#60753]: https://github.com/cockroachdb/cockroach/pull/60753
[#60758]: https://github.com/cockroachdb/cockroach/pull/60758
[#60761]: https://github.com/cockroachdb/cockroach/pull/60761
[#60767]: https://github.com/cockroachdb/cockroach/pull/60767
[#60771]: https://github.com/cockroachdb/cockroach/pull/60771
[#60772]: https://github.com/cockroachdb/cockroach/pull/60772
[#60775]: https://github.com/cockroachdb/cockroach/pull/60775
[#60784]: https://github.com/cockroachdb/cockroach/pull/60784
[#60799]: https://github.com/cockroachdb/cockroach/pull/60799
[#60800]: https://github.com/cockroachdb/cockroach/pull/60800
[#60806]: https://github.com/cockroachdb/cockroach/pull/60806
[#60807]: https://github.com/cockroachdb/cockroach/pull/60807
[#60822]: https://github.com/cockroachdb/cockroach/pull/60822
[#60825]: https://github.com/cockroachdb/cockroach/pull/60825
[#60826]: https://github.com/cockroachdb/cockroach/pull/60826
[#60827]: https://github.com/cockroachdb/cockroach/pull/60827
[#60831]: https://github.com/cockroachdb/cockroach/pull/60831
[#60832]: https://github.com/cockroachdb/cockroach/pull/60832
[#60839]: https://github.com/cockroachdb/cockroach/pull/60839
[#60847]: https://github.com/cockroachdb/cockroach/pull/60847
[#60854]: https://github.com/cockroachdb/cockroach/pull/60854
[#60901]: https://github.com/cockroachdb/cockroach/pull/60901
[#60903]: https://github.com/cockroachdb/cockroach/pull/60903
[#60905]: https://github.com/cockroachdb/cockroach/pull/60905
[#60908]: https://github.com/cockroachdb/cockroach/pull/60908
[#60913]: https://github.com/cockroachdb/cockroach/pull/60913
[#60922]: https://github.com/cockroachdb/cockroach/pull/60922
[#60923]: https://github.com/cockroachdb/cockroach/pull/60923
[#60927]: https://github.com/cockroachdb/cockroach/pull/60927
[#60938]: https://github.com/cockroachdb/cockroach/pull/60938
[#60941]: https://github.com/cockroachdb/cockroach/pull/60941
[#60949]: https://github.com/cockroachdb/cockroach/pull/60949
[#60952]: https://github.com/cockroachdb/cockroach/pull/60952
[#60953]: https://github.com/cockroachdb/cockroach/pull/60953
[#60992]: https://github.com/cockroachdb/cockroach/pull/60992
[#61000]: https://github.com/cockroachdb/cockroach/pull/61000
[#61013]: https://github.com/cockroachdb/cockroach/pull/61013
[#61018]: https://github.com/cockroachdb/cockroach/pull/61018
[#61032]: https://github.com/cockroachdb/cockroach/pull/61032
[#61041]: https://github.com/cockroachdb/cockroach/pull/61041
[#61043]: https://github.com/cockroachdb/cockroach/pull/61043
[#61047]: https://github.com/cockroachdb/cockroach/pull/61047
[#61056]: https://github.com/cockroachdb/cockroach/pull/61056
[#61063]: https://github.com/cockroachdb/cockroach/pull/61063
[#61097]: https://github.com/cockroachdb/cockroach/pull/61097
[#61105]: https://github.com/cockroachdb/cockroach/pull/61105
[#61106]: https://github.com/cockroachdb/cockroach/pull/61106
[#61113]: https://github.com/cockroachdb/cockroach/pull/61113
[#61124]: https://github.com/cockroachdb/cockroach/pull/61124
[#61127]: https://github.com/cockroachdb/cockroach/pull/61127
[#61130]: https://github.com/cockroachdb/cockroach/pull/61130
[#61132]: https://github.com/cockroachdb/cockroach/pull/61132
[#61135]: https://github.com/cockroachdb/cockroach/pull/61135
[#61139]: https://github.com/cockroachdb/cockroach/pull/61139
[#61148]: https://github.com/cockroachdb/cockroach/pull/61148
[#61159]: https://github.com/cockroachdb/cockroach/pull/61159
[#61162]: https://github.com/cockroachdb/cockroach/pull/61162
[#61165]: https://github.com/cockroachdb/cockroach/pull/61165
[#61169]: https://github.com/cockroachdb/cockroach/pull/61169
[#61170]: https://github.com/cockroachdb/cockroach/pull/61170
[#61177]: https://github.com/cockroachdb/cockroach/pull/61177
[#61178]: https://github.com/cockroachdb/cockroach/pull/61178
[#61184]: https://github.com/cockroachdb/cockroach/pull/61184
[#61191]: https://github.com/cockroachdb/cockroach/pull/61191
[#61201]: https://github.com/cockroachdb/cockroach/pull/61201
[#61207]: https://github.com/cockroachdb/cockroach/pull/61207
[#61210]: https://github.com/cockroachdb/cockroach/pull/61210
[#61211]: https://github.com/cockroachdb/cockroach/pull/61211
[#61214]: https://github.com/cockroachdb/cockroach/pull/61214
[#61221]: https://github.com/cockroachdb/cockroach/pull/61221
[#61232]: https://github.com/cockroachdb/cockroach/pull/61232
[#61235]: https://github.com/cockroachdb/cockroach/pull/61235
[#61244]: https://github.com/cockroachdb/cockroach/pull/61244
[#61246]: https://github.com/cockroachdb/cockroach/pull/61246
[#61251]: https://github.com/cockroachdb/cockroach/pull/61251
[#61278]: https://github.com/cockroachdb/cockroach/pull/61278
[#61286]: https://github.com/cockroachdb/cockroach/pull/61286
[#61288]: https://github.com/cockroachdb/cockroach/pull/61288
[#61297]: https://github.com/cockroachdb/cockroach/pull/61297
[#61300]: https://github.com/cockroachdb/cockroach/pull/61300
[#61315]: https://github.com/cockroachdb/cockroach/pull/61315
[#61321]: https://github.com/cockroachdb/cockroach/pull/61321
[#61324]: https://github.com/cockroachdb/cockroach/pull/61324
[#61326]: https://github.com/cockroachdb/cockroach/pull/61326
[#61344]: https://github.com/cockroachdb/cockroach/pull/61344
[#61345]: https://github.com/cockroachdb/cockroach/pull/61345
[#61348]: https://github.com/cockroachdb/cockroach/pull/61348
[#61353]: https://github.com/cockroachdb/cockroach/pull/61353
[#61356]: https://github.com/cockroachdb/cockroach/pull/61356
[#61358]: https://github.com/cockroachdb/cockroach/pull/61358
[#61361]: https://github.com/cockroachdb/cockroach/pull/61361
[#61362]: https://github.com/cockroachdb/cockroach/pull/61362
[#61376]: https://github.com/cockroachdb/cockroach/pull/61376
[#61386]: https://github.com/cockroachdb/cockroach/pull/61386
[#61387]: https://github.com/cockroachdb/cockroach/pull/61387
[#61410]: https://github.com/cockroachdb/cockroach/pull/61410
[#61416]: https://github.com/cockroachdb/cockroach/pull/61416
[#61427]: https://github.com/cockroachdb/cockroach/pull/61427
[#61428]: https://github.com/cockroachdb/cockroach/pull/61428
[#61494]: https://github.com/cockroachdb/cockroach/pull/61494
[#61499]: https://github.com/cockroachdb/cockroach/pull/61499
[#61514]: https://github.com/cockroachdb/cockroach/pull/61514
[#61522]: https://github.com/cockroachdb/cockroach/pull/61522
[#61523]: https://github.com/cockroachdb/cockroach/pull/61523
[#61601]: https://github.com/cockroachdb/cockroach/pull/61601
[#61647]: https://github.com/cockroachdb/cockroach/pull/61647
[#61676]: https://github.com/cockroachdb/cockroach/pull/61676
[#61709]: https://github.com/cockroachdb/cockroach/pull/61709
[#61723]: https://github.com/cockroachdb/cockroach/pull/61723
[#61733]: https://github.com/cockroachdb/cockroach/pull/61733
[#61754]: https://github.com/cockroachdb/cockroach/pull/61754
[#61805]: https://github.com/cockroachdb/cockroach/pull/61805
[#61813]: https://github.com/cockroachdb/cockroach/pull/61813
[#61826]: https://github.com/cockroachdb/cockroach/pull/61826
[#61842]: https://github.com/cockroachdb/cockroach/pull/61842
[#61844]: https://github.com/cockroachdb/cockroach/pull/61844
[#61871]: https://github.com/cockroachdb/cockroach/pull/61871
[#61876]: https://github.com/cockroachdb/cockroach/pull/61876
[#61888]: https://github.com/cockroachdb/cockroach/pull/61888
[#61909]: https://github.com/cockroachdb/cockroach/pull/61909
[#61947]: https://github.com/cockroachdb/cockroach/pull/61947
[#61949]: https://github.com/cockroachdb/cockroach/pull/61949
[#61959]: https://github.com/cockroachdb/cockroach/pull/61959
[#61962]: https://github.com/cockroachdb/cockroach/pull/61962

## v21.1.0-alpha.2

Get future release notes emailed to you:

{% include marketo.html %}

### Downloads

<div id="os-tabs" class="clearfix">
 <a href="https://binaries.cockroachdb.com/cockroach-v21.1.0-alpha.2.darwin-10.9-amd64.tgz"><button id="mac" data-eventcategory="mac-binary-release-notes">Mac</button></a>
 <a href="https://binaries.cockroachdb.com/cockroach-v21.1.0-alpha.2.linux-amd64.tgz"><button id="linux" data-eventcategory="linux-binary-release-notes">Linux</button></a>
 <a href="https://binaries.cockroachdb.com/cockroach-v21.1.0-alpha.2.windows-6.2-amd64.zip"><button id="windows" data-eventcategory="windows-binary-release-notes">Windows</button></a>
 <a href="https://binaries.cockroachdb.com/cockroach-v21.1.0-alpha.2.src.tgz"><button id="source" data-eventcategory="source-release-notes">Source</button></a>
</div>

### Docker image

{% include copy-clipboard.html %}
~~~shell
$ docker pull cockroachdb/cockroach-unstable:v21.1.0-alpha.2
~~~

### Backward-incompatible changes

- The payload fields for certain event types in `system.eventlog` have been changed and/or renamed. Note that the payloads in `system.eventlog` were an undocumented, reserved feature so no guarantee was made about cross-version compatibility to this point. The list of changes includes (but is not limited to):
 - `TargetID` has been renamed to `NodeID` for `node_join`.
 - `TargetID` has been renamed to `TargetNodeID` for `node_decommissioning` / `node_decommissioned` / `node_recommissioned`.
 - `NewDatabaseName` has been renamed to `NewDatabaseParent` for `convert_to_schema`.
 - `grant_privilege` and `revoke_privilege` have been removed; they are replaced by `change_database_privilege`, `change_schema_privilege`, `change_type_privilege`, and `change_table_privilege`. Each event only reports a change for one user/role, so the `Grantees` field was renamed to `Grantee`.
 - Each `drop_role` event now pertains to a single [user/role](../v21.1/authorization.html#sql-users). [#57737][#57737]
- The connection and authentication logging enabled by the [cluster settings](../v21.1/cluster-settings.html) `server.auth_log.sql_connections.enabled` and `server.auth_log.sql_sessions.enabled` was previously using a text format which was hard to parse and integrate with external monitoring tools. This has been changed to use the standard notable event mechanism, with standardized payloads. The output format is now structured; see the generated [reference documentation](https://github.com/cockroachdb/cockroach/blob/master/docs/generated/eventlog.md) for details about the supported event types and payloads. [#57839][#57839] {% comment %}doc{% endcomment %}
- The logging format for [SQL audit](../v21.1/sql-audit-logging.html), [execution](../v21.1/logging-use-cases.html#sql_exec), and [query](../v21.1/logging-use-cases.html#sql_perf) logs has changed from a crude space-delimited format to JSON. To opt out of this new behavior and restore the pre-v21.1 logging format, you can set the [cluster setting](../v21.1/cluster-settings.html) `sql.log.unstructured_entries.enabled` to `true`. [#59110][#59110] {% comment %}doc{% endcomment %}

### Security updates

- The entropy of the auto-generated user account password for [`cockroach demo`](../v21.1/cockroach-demo.html) shell has been lowered, to ensure that the passwords are short and easy to copy over. This makes the password easy to brute-force and thus removes any remaining protection there may have been to the confidentiality of `demo` sessions. (The reason why a password remains, as opposed to no password whatsoever, is to prevent accidental misuse of the HTTP service by other applications running on the same machine.) Since the required shortness erases any pretense of security, the algorithm has been simplified to remove usage of a cryptographic PRNG altogether. [#58305][#58305] {% comment %}doc{% endcomment %}
- When using a SQL proxy, by default CockroachDB only knows about the network address of the proxy. That *peer* address is then used for logging, [authentication](../v21.1/authentication.html) rules, etc. This is undesirable, as security logging and authentication rules need to operate on the actual (final) client address instead. CockroachDB can now be configured to solve this problem (conf mechanism detailed below). When so configured, a SQL proxy can inform the CockroachDB server of the real address of the client via a server status parameter called `crdb:remote_addr`. The value must be the IP address of the client, followed by a colon, followed by the port number, using the standard Go syntax (e.g., `11.22.33.44:5566` for IPv4, `[11:22::33]:4455` for IPv6). When provided, this value overrides the SQL proxy's address for logging and authentication purposes. In any case, the original peer address is also logged alongside the client address (overridden or not), via the new logging tag `peer`. Security considerations:
 - Enabling this feature allows the peer to spoof its address with regard to authentication and thus bypass authentication rules that would otherwise apply to its address, which can introduce a serious security vulnerability if the peer is not trusted. This is why this feature is not enabled by default, and must only be enabled when using a trusted SQL proxy.
 - This feature should only be used with SQL proxies which actively scrub a `crdb:remote_addr` parameter received by a remote client, and replaces it by its own. If the proxy mistakenly forwards the parameter as provided by the client, it opens the door to the aforementioned security vulnerability.
 - Care must be taken in host-based authentication (HBA) rules:
    - TLS client cert validation, if requested by a rule, is still performed using the certificate presented by the proxy, not that presented by the client. This means that this new feature is not sufficient to forward TLS client cert authentication through a proxy. (If TLS client cert authentication is required, it must be performed by the proxy directly.)
    - The `protocol` field (first column) continues to apply to the connection type between CockroachDB and the proxy, not between the proxy and the client. Only the 4th column (the CIDR pattern) is matched against the proxy-provided remote address override. Therefore, it is not possible to apply different rules to different client address when proxying TCP connections via a unix socket, because HBA rules for unix connections do not use the address column. Also when proxying client SSL connections via a non-SSL proxy connection, or proxying client non-SSL connections via a SSL proxy connection, care must be taken to configure address-based rule matching using the proper connection type. A reliable way to bypass this complexity is to only use the `host` connection type which applies equally to SSL and non-SSL connections. As of this implementation, the feature is enabled using the non-documented environment variable `COCKROACH_TRUST_CLIENT_PROVIDED_SQL_REMOTE_ADDR`. The use of an environment variable is a stop-gap so that this feature can be used in CockroachCloud SQL pods, which do not have access to [cluster settings](../v21.1/cluster-settings.html). The environment variable will be eventually removed and replaced by another mechanism. [#58381][#58381]
- Added ability to set region-specific callback URLs in the OIDC config. The `server.oidc_authentication.redirect_url` [cluster setting](../v21.1/cluster-settings.html) can now accept JSON as an alternative to the basic URL string setting. If a JSON value is set, it *must* contain a `redirect_url` key that maps to an object with key-value pairs where the key is a `region` matching an existing locality setting and the value is a callback URL. [#57519][#57519] {% comment %}doc{% endcomment %}

### General changes

- CockroachDB now runs fewer threads in parallel if running inside a container with a CPU limit. [#57390][#57390]
- Upgraded the CockroachDB binary to Go 1.15.6. [#57713][#57713] {% comment %}doc{% endcomment %}
- The new [cluster setting](../v21.1/cluster-settings.html) `server.eventlog.enabled` controls whether notable events are also written to the table `system.eventlog`. Its default value is `true`. Changing this cluster setting can help recovering partial cluster availability when the `system.eventlog` table becomes unavailable. Note that even when `false`, notable events are still propagated to the logging system, where they can be redirected to files or other log sinks. [#57879][#57879] {% comment %}doc{% endcomment %}
- Moved RBAC resources in Kubernetes manifests to `rbac.authorization.k8s.io/v1`. [#55065][#55065] {% comment %}doc{% endcomment %}
- Cluster version upgrades, as initiated by [`SET CLUSTER SETTING version = <major>-<minor>`](../v21.1/set-cluster-setting.html), now perform internal maintenance duties that will increase the time that it takes for the command to complete. This delay is proportional to the amount of data currently stored in the cluster. The cluster will also experience a small amount of additional load during this period while the upgrade is being finalized. These changes expand upon our original prototype in [#57445](https://github.com/cockroachdb/cockroach/pull/57445). [#58088][#58088] {% comment %}doc{% endcomment %}
- Upgraded to v3.9.2 of `protobuf` to consume new changes for Bazel. [#58891][#58891]
- Increased the default value of `sql.tablecache.lease.refresh_limit` to 500 in order to accomodate larger schemas without encountering `RETRY_COMMIT_DEADLINE_EXCEEDED` errors and generally higher latency. [#59319][#59319] {% comment %}doc{% endcomment %}

### Enterprise edition changes

- CockroachDB now permits partitioning by user-defined [types](../v21.1/data-types.html) such as [enums](../v21.1/enum.html). [#57327][#57327] {% comment %}doc{% endcomment %}

### SQL language changes

- Added a new [builtin](../v21.1/functions-and-operators.html#built-in-functions) method to calculate voronoi polygons. [#56496][#56496] {% comment %}doc{% endcomment %}
- Added a new [builtin](../v21.1/functions-and-operators.html#built-in-functions) method to calculate voronoi lines. [#56496][#56496] {% comment %}doc{% endcomment %}
- Previously, timezones had to be entered in the same case as they were stored on the system. Now, timezone names can be case-insensitive provided they match well-known zone names according to [Go's `time/tzdata` package](https://golang.org/src/time/tzdata/tzdata.go). [#57250][#57250] {% comment %}doc{% endcomment %}
- Added `LOCALITY REGIONAL BY TABLE IN PRIMARY REGION` syntax for configuring table locality. [#57275][#57275] {% comment %}doc{% endcomment %}
- The default value for `vectorize_row_count_threshold` setting has been decreased from 1000 to 0, meaning that, by default, CockroachDB will always use the [vectorized engine](../v21.1/vectorized-execution.html) for all supported queries regardless of the row estimate (unless `vectorize=off` is set). [#55713][#55713] {% comment %}doc{% endcomment %}
- Added the ability to [`CREATE TABLE`](../v21.1/create-table.html) with LOCALITY set. [#57419][#57419] {% comment %}doc{% endcomment %}
- [`EXPLAIN`](../v21.1/explain.html) and [`EXPLAIN ANALYZE`](../v21.1/explain-analyze.html) now show counts and durations in a more user-friendly way. [#57420][#57420] {% comment %}doc{% endcomment %}
- [`EXPORT`](../v21.1/export.html) can now be used by non-`admin` users with `SELECT` privilege on the table being exported, unless the destination URI requires `admin` privileges. [#57380][#57380] {% comment %}doc{% endcomment %}
- [`CREATE DATABASE ... WITH [PRIMARY] REGIONS`](../v21.1/create-database.html) now modifies the [zone configurations](../v21.1/configure-replication-zones.html) with the settings as set by the multiregion configuration. [#57244][#57244] {% comment %}doc{% endcomment %}
- [`SHOW [BACKUP]`](../v21.1/show-backup.html) is no longer `admin`-only. It depends on the URI construct and the credentials specified in the [`SHOW [BACKUP]`](../v21.1/show-backup.html) query. [#57412][#57412] {% comment %}doc{% endcomment %}
- [builtin](../v21.1/functions-and-operators.html#built-in-functions) aggregate function `regr_avgx` is now supported. [#57295][#57295] {% comment %}doc{% endcomment %}
- Added support for running [`IMPORT`](../v21.1/import.html) in a mixed-version cluster. [#57382][#57382] {% comment %}doc{% endcomment %}
- Introduced `SHOW REGIONS FROM ALL DATABASES`, which shows region metadata for each database in the table. [#57500][#57500] {% comment %}doc{% endcomment %}
- Added `collations` table to the `information_schema`. The `collations` table contains the collations available in the current database. [#57609][#57609] {% comment %}doc{% endcomment %}
- Added `collation_character_set_applicability` table to the `information_schema`. [#57609][#57609] {% comment %}doc{% endcomment %}
- `LOCALITY` directives on [`CREATE TABLE`](../v21.1/create-table.html) are now persisted onto the database. [#57513][#57513] {% comment %}doc{% endcomment %}
- Multi-region defined table localities now display on the [`SHOW CREATE TABLE`](../v21.1/show-create.html) command. [#57513][#57513] {% comment %}doc{% endcomment %}
- Arrays in `pg_catalog` tables now are diaplayed in a format that matches PostgreSQL. [#56980][#56980] {% comment %}doc{% endcomment %}
- The [`SET TRACING`](../v21.1/set-vars.html#set-tracing) `local` option (to only trace messages issued by the local node) was removed. [#57567][#57567] {% comment %}doc{% endcomment %}
- Several `SHOW` commands have been adjusted to enforce a particular ordering of the output rows. [#57644][#57644] {% comment %}doc{% endcomment %}
- Implemented `regr_avgy` [builtin](../v21.1/functions-and-operators.html#built-in-functions) aggregation function. [#57583][#57583] {% comment %}doc{% endcomment %}
- `crdb_internal.tables` and [`SHOW TABLES`](../v21.1/show-tables.html) now show locality data on the tables. [#57653][#57653] {% comment %}doc{% endcomment %}
- [`CREATE TABLE ... LOCALITY ...`](../v21.1/create-table.html) statements now modify the [zone configurations](../v21.1/configure-replication-zones.html) to be in line with the desired locality. [#57654][#57654] {% comment %}doc{% endcomment %}
- Added `sql.trace.stmt.enable_thresold`. Similar to `sql.trace.txn.enable_threshold`, this logs a trace of any statements that take longer than the specified duration. This new setting allows for more granularity than the transaction threshold since it applies to individual statements and does not include overhead such as communication with a SQL client. [#57733][#57733] {% comment %}doc{% endcomment %}
- Added a session setting `experimental_enable_unique_without_index_constraints` and cluster default `sql.defaults.experimental_enable_unique_without_index_constraints.enabled` to enable the use of `UNIQUE WITHOUT INDEX` syntax. The default value of both settings is `false` since this feature is not yet fully supported. Use of `UNIQUE WITHOUT INDEX` also depends on all nodes being upgraded to the cluster version `UniqueWithoutIndexConstraints`. [#57666][#57666] {% comment %}doc{% endcomment %}
- Implemented [builtin](../v21.1/functions-and-operators.html#built-in-functions) function `levenshtein`. [#56843][#56843] {% comment %}doc{% endcomment %}
- Added table-view dependency information in `pg_depend` to improve compatibility with PostgreSQL. [#57240][#57240] {% comment %}doc{% endcomment %}
- The cluster event logging system has been modernized. In particular, the schema of the entries for the `info` column in `system.eventlog` has been stabilized. [#57737][#57737] {% comment %}doc{% endcomment %}
- The `targetID` and `reportingID` columns in `system.eventlog` are now deprecated. Their values, for relevant event types, can be found as fields inside the `info` column instead. [#57737][#57737] {% comment %}doc{% endcomment %}
- Added the `soundex()` and `difference()` [builtin](../v21.1/functions-and-operators.html#built-in-functions) functions. [#57615][#57615] {% comment %}doc{% endcomment %}
- New [`EXPLAIN ANALYZE (DISTSQL)`](../v21.1/explain-analyze.html) output format. [`EXPLAIN ANALYZE (DISTSQL)`](../v21.1/explain-analyze.html) now only works as a top-level statement (it can no longer be part of a bigger query). [#57804][#57804] {% comment %}doc{% endcomment %}
- Added [builtin](../v21.1/functions-and-operators.html#built-in-functions) function `ST_OrientedEnvelope` to calculate the mimimum-area rotated rectangle. [#57697][#57697] {% comment %}doc{% endcomment %}
- A new `default_transaction_use_follower_reads` session variable is now supported, which configures SQL transactions to perform stale reads from follower replicas. [#57851][#57851] {% comment %}doc{% endcomment %}
- Both [`ALTER TABLE OWNER`](../v21.1/alter-table.html) and `REASSIGN OWNED BY` now report structured notable events about the ownership changes. Note that `REASSIGN OWNED BY` currently also reports an `alter_table_owner` for views and sequences that were implicitly reassigned, even though CockroachDB does not yet support the `ALTER VIEW OWNER` / `ALTER SEQUENCE OWNER` statements. [#57969][#57969] {% comment %}doc{% endcomment %}
- [`EXPLAIN (DISTSQL)`](../v21.1/explain.html) has a new output schema and format. [#57954][#57954]
- Added an overload to `crdb_internal.pb_to_json` to suppress populating default values in fields. [#58087][#58087] {% comment %}doc{% endcomment %}
- [`IMPORT INTO`](../v21.1/import-into.html) for CSV now supports `nextval` as a default expression of a non-targeted column. [#56473][#56473] {% comment %}doc{% endcomment %}
- The [`EXPLAIN`](../v21.1/explain.html) output for foreign key checks is now labeled `constraint-check` rather than `fk-check`. This change is in preparation for adding support for unique constraint checks, which will use the same label. [#58053][#58053] {% comment %}doc{% endcomment %}
- The error message for unique constraint violations now matches the error used by PostgreSQL. For example, the new error message looks like this: `ERROR: duplicate key value violates unique constraint "primary" DETAIL: Key (k)=(1) already exists.` [#58053][#58053] {% comment %}doc{% endcomment %}
- [`EXPLAIN ANALYZE`](../v21.1/explain-analyze.html) diagrams now contain "network hops" information on streams. [#58078][#58078] {% comment %}doc{% endcomment %}
- Added support for the `IF NOT EXISTS` prefix to [`CREATE TYPE`](../v21.1/create-type.html) statements. [#58173][#58173] {% comment %}doc{% endcomment %}
- Added a `session_variables` table to the `information_schema`. The `session_variables` table exposes the session variables. [#57837][#57837] {% comment %}doc{% endcomment %}
- Indexing into scalar JSON values using an integer index is now properly supported. [#58359][#58359] {% comment %}doc{% endcomment %}
- The `crdb_internal.cluster_id` method now returns the ID of the underlying KV cluster in multi-tenant scenarios rather than the Nil UUID. The `ClusterID`
is needed for logging and metrics for SQL tenants. [#58317][#58317] {% comment %}doc{% endcomment %}
- `SHOW STATEMENTS` is now an alias of [`SHOW QUERIES`](../v21.1/show-statements.html). The new syntax is preferred by the SQL parser. [#58072][#58072] {% comment %}doc{% endcomment %}
- Implemented the `gateway_region` [builtin](../v21.1/functions-and-operators.html#built-in-functions), which returns the region of the connection's current node. [#58423][#58423] {% comment %}doc{% endcomment %}
- [`BACKUP`](../v21.1/backup.html) and [`RESTORE`](../v21.1/restore.html) now use the block-level checksums embedded in their data files instead of collecting / verifying more expensive file-level SHA512 checksums. [#58487][#58487] {% comment %}doc{% endcomment %}
- Multi-tenant clusters will now send anonymous usage information to the central CockroachDB registration server. [#58399][#58399] {% comment %}doc{% endcomment %}
- Added support for [`ALTER DATABASE ... ADD REGION`](../v21.1/alter-database.html). [#58233][#58233] {% comment %}doc{% endcomment %}
- Multiple [`SHOW ZONE CONFIGURATION`](../v21.1/show-zone-configurations.html) statements that previously used `FOR` can now also use `FROM` (e.g., `SHOW ZONE CONFIGURATION FOR RANGE`). This change standardizes the use of `FROM` for `SHOW ZONE CONFIGURATION`. [#58740][#58740] {% comment %}doc{% endcomment %}
- Implemented `SHOW REGIONS`, which shows a list of regions along with the databases associated with them. [#57618][#57618] {% comment %}doc{% endcomment %}
- Added [`ALTER DATABASE ... PRIMARY REGION`](../v21.1/alter-database.html). [#58725][#58725] {% comment %}doc{% endcomment %}
- Columns implicitly added from [hash-sharded indexes](../v21.1/experimental-features.html#hash-sharded-indexes) will no longer display on `pg_index` and `pg_indexes`. [#58749][#58749] {% comment %}doc{% endcomment %}
- Added a new `implicit` column to `crdb_internal.index_columns`, which signifies whether the column is implicitly added onto the index through [`PARTITION BY`](../v21.1/partition-by.html) with an implicit column or a [hash-sharded index](../v21.1/experimental-features.html#hash-sharded-indexes). [#58749][#58749] {% comment %}doc{% endcomment %}
- CockroachDB now omits implicit columns or [hash-sharded index](../v21.1/experimental-features.html#hash-sharded-indexes) columns from automatically generated index names. [#58898][#58898] {% comment %}doc{% endcomment %}
- Implemented `PARTITION ALL BY` syntax for [`CREATE TABLE`](../v21.1/create-table.html), which automatically partitions the table, and all indexes, with the same partitioning scheme. [#58748][#58748] {% comment %}doc{% endcomment %}
- `PARTITION ALL BY` tables now display correctly on [`SHOW CREATE TABLE`](../v21.1/show-create.html). [#58928][#58928] {% comment %}doc{% endcomment %}
- Creating a table and changing its schema within a transaction no longer schedules a schema change job. [#58888][#58888] {% comment %}doc{% endcomment %}
- Implemented geo [builtin](../v21.1/functions-and-operators.html#built-in-functions) function `ST_GeneratePoints`. [#58288][#58288] {% comment %}doc{% endcomment %}
- Hash aggregation can now spill to disk when it exhausts its memory limit when executed via the [vectorized engine](../v21.1/vectorized-execution.html). [#57817][#57817] {% comment %}doc{% endcomment %}
- Implemented [`ALTER DATABASE ... SURVIVE REGION/ZONE FAILURE`](../v21.1/alter-database.html). [#58937][#58937] {% comment %}doc{% endcomment %}
- [`CREATE INDEX`](../v21.1/create-index.html) will now inherit `PARTITION BY` clauses from `PARTITION ALL BY` tables. [#58988][#58988] {% comment %}doc{% endcomment %}
- Implemented the geometry-based [builtin](../v21.1/functions-and-operators.html#built-in-functions) functions `ST_LineSubstring({geometry,float8,float8})`. [#58125][#58125] {% comment %}doc{% endcomment %}
- Implemented `REGIONAL BY ROW` logic on [`CREATE TABLE`](../v21.1/create-table.html). This is gated behind the experimental session variable `experimental_enable_implicit_column_partitioning`. [#58987][#58987] {% comment %}doc{% endcomment %}
- Added support for `ALTER VIEW` / `SEQUENCE OWNER TO` commands. [#59049][#59049] {% comment %}doc{% endcomment %}
- Casts to type `unknown[]` are no longer accepted in CockroachDB. Any such casts will fail to parse and return the error `ERROR: type "unknown[]" does not exist`. This is consistent with PostgreSQL's behavior. [#59136][#59136] {% comment %}doc{% endcomment %}
- Implemented `REGIONAL BY ROW AS ...`, which allows a column of type `crdb_internal_region` to be used as a column for `REGIONAL BY ROW` multi-region properties. [#59121][#59121] {% comment %}doc{% endcomment %}
- Enabled altering of table locality for tables that are `REGIONAL BY TABLE` to `REGIONAL BY TABLE` (but in a different region). [#59144][#59144] {% comment %}doc{% endcomment %}
- [`PARTITION ALL BY`](../v21.1/partition-by.html) statements will now apply for tables when using [`ALTER PRIMARY KEY`](../v21.1/alter-primary-key.html). [#59178][#59178] {% comment %}doc{% endcomment %}
- Implemented the geometry [builtin](../v21.1/functions-and-operators.html#built-in-functions) function `ST_ShiftLongitude`, which is useful for plotting data on a Pacific-centred map. [#59234][#59234] {% comment %}doc{% endcomment %}
- Implemented [`ALTER TABLE ... SET LOCALITY GLOBAL`](../v21.1/alter-table.html) for tables starting as `REGIONAL BY ROW`. [#59256][#59256] {% comment %}doc{% endcomment %}
- Improved the error message when people use set `search_path` incorrectly, or with a schema that legitimately has a comma in its name. [#53974][#53974] {% comment %}doc{% endcomment %}
- Creation of interleaved tables and indexes is now disabled by default. They can be re-enabled temporarily by running [`SET CLUSTER SETTING sql.defaults.interleaved_tables.enabled=true`](../v21.1/set-cluster-setting.html). [#59248][#59248] {% comment %}doc{% endcomment %}
- CockroachDB now uses a structured logging format for the [SQL audit](../v21.1/sql-audit-logging.html), [execution](../v21.1/logging-use-cases.html#sql_exec), and [query](../v21.1/logging-use-cases.html#sql_perf) logs. See the generated [reference documentation](https://github.com/cockroachdb/cockroach/blob/master/docs/generated/eventlog.md) for details. Of note, audit and execution logs now also include information about whether a query plan contains full index scans. Previously, this information was only included in the slow query log. [#59110][#59110] {% comment %}doc{% endcomment %}
- [`CREATE INDEX`](../v21.1/create-index.html) on `REGIONAL BY ROW` tables will now correctly include the implicit partitioning and inherit the correct [zone configurations](../v21.1/configure-replication-zones.html). [#59223][#59223] {% comment %}doc{% endcomment %}
- Made a minor improvement to [`EXPLAIN`](../v21.1/explain.html) output for "render" node. [#59313][#59313] {% comment %}doc{% endcomment %}
- [`EXPLAIN ANALYZE`](../v21.1/explain-analyze.html) now defaults to the new `EXPLAIN ANALYZE (PLAN)`, which shows a text representation of the logical plan, annotated with execution statistics. {% comment %}doc{% endcomment %} [#57337][#57337]

### Command-line changes

- The logging configuration can now be specified via the `--log` parameter. See the documentation for details. The flags `--log-dir`, `--log-file-max-size`, `--log-file-verbosity`, `--log-group-max-size` are now deprecated. [#57134][#57134] {% comment %}doc{% endcomment %}
- A new command `cockroch debug check-log-config` prints out the logging configuration that results from the provided combination of `--store`, `--log`, and other logging-related flags on the command line. [#57134][#57134] {% comment %}doc{% endcomment %}
- The events that were previously only stored in `system.eventlog` are now also directed unconditionally to an external logging channel using a JSON format. Refer to the [configuration](https://github.com/cockroachdb/cockroach/blob/master/docs/generated/logsinks.md) to see how to customize how events are directed to external sinks. Note that the exact external output format (and thus how to detect/parse the events from e.g., log files) is not yet stabilized and remains subject to change. [#57737][#57737] {% comment %}doc{% endcomment %}
- Notable events that pertain to SQL schema, user, and privilege changes are now sent on the new `SQL_SCHEMA`, `USER_ADMIN`, and `PRIVILEGES` [logging channels](https://github.com/cockroachdb/cockroach/blob/master/docs/generated/logging.md). These can now be redirected to different [sinks](https://github.com/cockroachdb/cockroach/blob/master/docs/generated/logsinks.md) from the other log entries.
    - The `SQL_SCHEMA` channel is used to report changes to the SQL logical schema, excluding privilege and ownership changes (which are reported on the separate channel `PRIVILEGES`) and zone config changes (which go to `OPS`). This includes:
        - Database, schema, table, sequence, view, and type creation.
        - Adding, removing, and changing table columns.
        - Changing sequence parameters.
        - More generally, changes to the schema that affect the functional behavior of client apps using stored objects.
    - The `USER_ADMIN` channel is typically configured in "audit" mode, with event numbering and synchronous writes. It is used to report changes in users and roles, including:
        - Users added and dropped.
        - Changes to authentication credentials, including passwords, validity, etc.
        - Role grants and revocations.
        - Role option grants and revocations.
    - The `PRIVILEGES` channel is typically configured in "audit" mode, with event numbering and synchronous writes. It is used to report data authorization changes, including:
        - Privilege grants and revocations on database, objects, etc.
        - Object ownership changes. [#51987][#51987]
- Logging events that are relevant to cluster operators are now categorized under the new `OPS` and `HEALTH` [logging channels](https://github.com/cockroachdb/cockroach/blob/master/docs/generated/logging.md). These can now be redirected separately from other logging events.
    - The `OPS` channel is used to report "point" operational events, initiated by user operators or automation:
        - Operator or system actions on server processes: process starts, stops, shutdowns, and crashes (if they can be logged). Each event includes any command-line parameters and the CockroachDB version.
        - Actions that impact the topology of a cluster: node additions, removals, decommissions, etc.
        - [Cluster setting](../v21.1/cluster-settings.html) changes
        - [Zone configuration](../v21.1/configure-replication-zones.html) changes.
    - The `HEALTH` channel is the channel used to report "background" operational events, initiated by CockroachDB for reporting on automatic processes:
        - Current resource usage, including critical resource usage.
        - Node-node connection events, including connection errors and gossip details.
        - Range and table leasing events.
        - Up- and down-replication.
        - Range unavailability. [#57171][#57171]
- Server terminations that are triggered when a node encounters an internal fatal error are now reported on the `OPS` logging channel. The exact text of the error is not reported on the `OPS` channel, however, as it may be complex (e.g., when there is a replica inconsistency); and the `OPS` channel is typically monitored by tools that just detect irregularities. The text of the message refers instead to the channel where the additional details can be found. [#57171][#57171] {% comment %}doc{% endcomment %}
- The notable events `set_zone_config` and `remove_zone_config` are now sent to the `OPS` logging channel. [#57171][#57171] {% comment %}doc{% endcomment %}
- Added a flag to `cockroach debug decode-proto` to suppress populating default values in fields. [#58087][#58087] {% comment %}doc{% endcomment %}
- When a SQL notable (structured) event is logged, the payload now attempts to include the session's `application_name` as field `ApplicationName`. This is intended for use when setting up event routing and filtering in external tools. [#58130][#58130] {% comment %}doc{% endcomment %}
- It is now possible to set the `format` parameter of any log sink, including file sinks, to `json`, `json-compact`, `json-fluent`, or `json-fluent-compact` to write entries as structured JSON. Refer to the generated [reference documentation](https://github.com/cockroachdb/cockroach/blob/master/docs/generated/logformats.md) for details. [#58126][#58126] {% comment %}doc{% endcomment %}
- The DB Console URL printed by [`cockroach demo`](../v21.1/cockroach-demo.html) now automatically logs in the user when pasted into a web browser. [#56740][#56740] {% comment %}doc{% endcomment %}
- The URLs generated when [`cockroach demo`](../v21.1/cockroach-demo.html) starts have been made shorter and easier to copy/paste by shortening the generated password. [#58305][#58305] {% comment %}doc{% endcomment %}
- When using the JSON output formats for log entries, the server identifiers are now reported as part of each payload once known (either cluster ID + node ID in single-tenant or KV servers, or tenant ID + SQL instance ID in multi-tenant SQL servers). [#58128][#58128] {% comment %}doc{% endcomment %}
- Fixed [`cockroach demo --global`](../v21.1/cockroach-demo.html) from crashing with `didn't get expected magic bytes header`. [#58466][#58466] {% comment %}doc{% endcomment %}
- Previously, for certain log files, CockroachDB would both flush individual writes (i.e., propagate them from within the `cockroach` process to the OS) and also synchronize writes (i.e., ask the OS to confirm the log data was written to disk). Per-write synchronization was found to be unnecessary and possibly detrimental to performance and operating cost, so it was removed. Now, the log data continues to be flushed, as before, and CockroachDB only requests synchronization periodically (every 30s). [#58995][#58995] {% comment %}doc{% endcomment %}
- The parameter `sync-writes` for file sink configurations has been removed. (This is not a backward-incompatible change because the configuration feature is new in v21.1.) [#58995][#58995] {% comment %}doc{% endcomment %}
- The parameter `buffered-writes` for file sink configurations has been added. It is set to `true` (writes are buffered) by default and set to `false` (i.e., avoid buffering and flush every log entry) when the `auditable` flag is requested. [#58995][#58995] {% comment %}doc{% endcomment %}
- The default output format for `file-group` and `stderr` sinks has been changed to `crdb-v2`. This new format is non-ambiguous and makes it possible to reliably parse log files. Refer to the format's [documentation](https://github.com/cockroachdb/cockroach/blob/master/docs/generated/logformats.md) for details. Additionally, it prevents single log lines from exceeding a large size; this problem is inherent to the `crdb-v1` format and can prevent [`cockroach debug zip`](../v21.1/cockroach-debug-zip.html) from retrieving `v1` log files. The new format has also been designed so that existing log file analyzers for the `crdb-v1` format can read entries written the new format. However, this conversion may be imperfect. Refer to the new format's [documentation](https://github.com/cockroachdb/cockroach/blob/master/docs/generated/logformats.md) for details. In case of incompatibility, users can force the previous format by using `format: crdb-v1` in their logging configuration. [#59087][#59087] {% comment %}doc{% endcomment %}

### API endpoint changes

- The notable event `create_statistics` is only reported when the [cluster setting](../v21.1/cluster-settings.html) `sql.stats.post_events.enabled` is enabled. This fact is now also reported in the [event log reference documentation](https://github.com/cockroachdb/cockroach/blob/master/docs/generated/eventlog.md). [#57877][#57877] {% comment %}doc{% endcomment %}
- The `Timestamp` field of structured notable events is now numeric, and encodes a number of nanoseconds since the Unix epoch. [#58070][#58070] {% comment %}doc{% endcomment %}
- The Health API now checks that the SQL server is ready to accept clients when a readiness check is requested. [#59350][#59350] {% comment %}doc{% endcomment %}

### DB Console changes

- Minor style changes to represent new branding palette. [#57130][#57130]
- Changed the default per-page value on the [Transactions page](../v21.1/ui-transactions-page.html) to 20; minor style updates. [#57824][#57824]
- Added a timeseries graph indicating statement denials due to feature flags on the [SQL Dashboard](../v21.1/ui-sql-dashboard.html) of DB Console. [#57533][#57533] {% comment %}doc{% endcomment %}
- Updated labels on the [Hardware Dashboard](../v21.1/ui-hardware-dashboard.html) to be more accurate. [#57224][#57224]
- Updated the link back to [Statements](../v21.1/ui-statements-page.html) from [Statement Details](../v21.1/ui-statements-page.html#statement-details-page) so that it will always link to the Statements list instead of invoking the "back" action on the browser. [#57975][#57975]
- On the [Sessions page](../v21.1/ui-sessions-page.html), every `age` label has been replaced with `duration` and every `txn` label has been replaced with `transaction`. The actual metrics remain unchanged. [#58616][#58616] {% comment %}doc{% endcomment %}
- Renamed the `CPUs` metric column to `vCPUs` in the Node List on the [Cluster Overview page](../v21.1/ui-cluster-overview-page.html). [#58495][#58495] {% comment %}doc{% endcomment %}
- Added Open SQL Transactions to the [SQL Dashboard](../v21.1/ui-sql-dashboard.html) and renamed `SQL Queries` to `SQL Statements`. Removed references to "Distributed SQL Queries" when metrics really are discussing all SQL queries. [#57477][#57477] {% comment %}doc{% endcomment %}

### Bug fixes

- Fixed a bug in [`RESTORE`](../v21.1/restore.html) where some unusual range boundaries in interleaved tables caused an error. [#58219][#58219]
- Previously, CockroachDB would encounter an internal error when performing a `JSONB - String` operation via the [vectorized execution engine](../v21.1/vectorized-execution.html). This has been fixed. The bug was introduced in v20.2.0. [#57349][#57349]
- Previously, in rare situations, an automated replication change could result in a loss of quorum. This was possible when a cluster had down nodes and a simultaneous change in replication factor. Note that a change in the replication factor can occur automatically if the cluster is comprised of fewer than five available nodes. Experimentally the likelihood of encountering this issue, even under contrived conditions, was small. [#56735][#56735]
- Fixed an internal error when using aggregates and window functions in an `ORDER BY` for a `UNION` or `VALUES` clause. [#57498][#57498]
- `DROP TYPE` and certain other statements that work over SQL scalar types now properly support type names containing special characters. [#57354][#57354]
- Fixed a performance regression introduced in v20.2 to reading virtual tables which introspect the schema. [#57542][#57542]
- Removed `system.jobs` full table scan that is expensive in the face of many completed jobs. [#57587][#57587]
- In v20.2.0 we mistakenly permitted users with the `admin` role to drop tables in the system database. This commit revokes that privilege. [#57568][#57568]
- Previously, users could not perform a cluster restore from old backup chains (incrementals on top of fulls) when using the [`BACKUP INTO`](../v21.1/backup.html) syntax. [#57656][#57656]
- Fixed a bug that could cause [`IMPORT`](../v21.1/import.html) to incorrectly read files stored on Google Cloud if uploaded using its compression option (`gsutil -Z`). [#57745][#57745]
- Fixed a bug where `ST_MakeLine` and `ST_Collect` did not respect ordering when used over a window clause. [#57724][#57724]
- Fixed a bug where schema change jobs to add foreign keys to existing tables, via [`ALTER TABLE`](../v21.1/alter-table.html), could sometimes not be successfully reverted (either due to being canceled or having failed). [#57598][#57598]
- Fixed a bug where concurrent addition of a foreign key constraint and drop of a unique index could cause the [foreign key constraint](../v21.1/foreign-key.html) to be added with no unique constraint on the referenced columns. [#57598][#57598]
- Adding a primary key constraint to a table without a primary key no longer ignores the name specified for the primary key. [#57146][#57146]
- Previously, when displaying replica counts during the [decommissioning process](../v21.1/remove-nodes.html), we were overcounting the replicas displayed for r1. This is no longer the case. [#57812][#57812]
- Fixed a bug whereby tables in schemas other than `public` would not be displayed when running [`SHOW TABLES FROM <db>`](../v21.1/show-tables.html). [#57749][#57749]
- Fixed a bug where canceled queries reading from virtual tables could cause a crashing panic. [#57828][#57828]
- Fixed an assertion error caused by some DDL statements used in conjunction with common table expressions (`WITH`). [#57927][#57927]
- Previously, [`SHOW GRANTS ON DATABASE`](../v21.1/show-grants.html) did not include privileges that were granted on a database. Now it does. The `SHOW GRANTS ON DATABASE` output no longer includes a column for `schema_name`, as these grants are not specific to any schema. [#56866][#56866]
- The `information_schema.schema_privileges` table now includes the correct schema-level privileges for non-user-defined schemas. Previously, all of these schemas were ommitted from the table. [#56866][#56866]
- The `has_schema_privilege` [builtin](../v21.1/functions-and-operators.html#built-in-functions) function now works on user-defined schemas when checking for the `USAGE` privilege. [#56866][#56866]
- The `ST_FrechetDistance` [builtin](../v21.1/functions-and-operators.html#built-in-functions) function no longer causes a `SIGFPE` panic for very small values of `densifyFrac` (e.g., 1e-20), and returns an error instead. [#57966][#57966]
- CockroachDB now removes a node's status entry when the node is [decommissioned](../v21.1/remove-nodes.html), to prevent it from appearing in API calls and UIs, and prevent it from affecting node constraints such as localities and attributes for various operations. [#56529][#56529]
- Fixed a bug which caused type information to be omitted when decoding descriptors using either `crdb_internal.pb_to_json` or `cockroach debug decode-proto`. [#58087][#58087]
- Fixed a bug from v21.1.0-alpha.1 where the binary could crash if a running node lost its claim to a job while updating. [#58161][#58161]
- Fixed a bug where multiple invocations of `AddGeometryColumn` affecting the same table would result in only the last invocation applying. [#56663][#56663]
- Previously, CockroachDB could return non-deterministic output when querying the `information_schema.statistics` virtual table (internally used by [`SHOW INDEXES`](../v21.1/show-index.html))namely, the implicit columns of the secondary indexes could be in arbitrary order. This is now fixed, and the columns will be in the same order as they are in the primary index. [#58191][#58191]
- Fixed a `column family 0 not found` crash caused by explaining or gathering [statement diagnostics](../v21.1/ui-statements-page.html#diagnostics) on certain queries involving virtual tables. [#58208][#58208]
- Added a safeguard against crashes while running `SHOW STATISTICS USING JSON`, which is used internally for statement diagnostics and [`EXPLAIN ANALYZE (DEBUG)`](../v21.1/explain-analyze.html). [#58221][#58221]
- Fixed a bug where prior schema changes on a table that failed and could not be fully reverted could prevent the table from being dropped. [#57836][#57836]
- Previously, CockroachDB could crash when performing a `DELETE` operation after an alteration of the primary key when in some cases. This is now fixed. The bug was introduced in v20.1. [#58153][#58153]
- Fixed a bug that could cause incremental backups to a backup in a collection (i.e., [`BACKUP INTO ... IN ...`](../v21.1/backup.html)) on some cloud storage providers to ignore existing incremental backups previously appended to that destination and instead backup incrementally from the base backup in that destination. [#58292][#58292]
- Fixed an internal panic when using the `SHOW STATISTICS USING JSON` statement on a table containing `ENUM` types. [#58251][#58251]
- A memory leak in the optimizer has been fixed. The leak could have caused unbounded growth of memory usage for a session when planning queries on tables with partial indexes. [#58306][#58306]
- Fixed a bug where primary key changes on tables being watched by [changefeeds](../v21.1/stream-data-out-of-cockroachdb-using-changefeeds.html) would be silently ignored. [#58140][#58140]
- The `pg_catalog` metadata tables were using the `CHAR` data type for single-byte character columns. Now they use the `char` data type, to match PostgreSQL. This resolves errors that would occur when using some drivers (like `tokio-postgres` for Rust) to access `pg_catalog` tables in the binary query format. [#58084][#58084]
- Prepared statements that include [enums](../v21.1/enum.html) and use the binary format will no longer result in an error. [#58043][#58043]
- Fixed an internal error that could occur when executing prepared statements with placeholders that delete data from columns referenced by a foreign key with `ON DELETE CASCADE`. [#58431][#58431]
- Fixed a bug which caused errors when querying a table with a disjunctive filter (an `OR` expression) that is the same or similar to the predicate of one of the table's partial indexes. [#58434][#58434]
- Previously, in event log entries for `ALTER TYPE` and `DROP TYPE` statements, the `TypeName` field did not contain fully qualified names. [#58257][#58257]
- A [`CREATE TABLE`](../v21.1/create-table.html) statement with indexes with duplicate names will no longer result in an assertion failure. This bug was present since v20.2. [#58433][#58433]
- Previously, event logs were not capturing the qualified table names for [`COMMENT ON INDEX`](../v21.1/comment-on.html) and [`COMMENT ON COLUMN`](../v21.1/comment-on.html) commands. This PR changes the event logs to use the qualified table name. Tests were also added for these changes. [#58472][#58472]
- The `has_${OBJECT}_privilege` built-in methods such as `has_schema_privilege` now additionally check whether the roles of which a user is a direct or indirect member also have privileges on the object. Previously only one user was checked, which was incorrect. This bug has been present since v2.0 but became more prominent in v20.2 when [role-based access control](../v21.1/authorization.html#roles) was made available in the core version of CockroachDB. [#58254][#58254]
- CockroachDB previously would return an internal error when attempting to execute a hash join on a JSON column via the [vectorized engine](../v21.1/vectorized-execution.html). Now a more user-friendly error is returned. [#57994][#57994]
- Fixed a panic in protobuf decoding. [#58716][#58716]
- The user authentication flow no longer performs extraneous name lookups. This performance regression was present since v20.2. [#58671][#58671]
- CockroachDB could previously return an internal error when evaluating a binary expression between a Decimal and an Interval that required a cast to a Float when the value is out of range. A more user-friendly error is now returned instead. [#58743][#58743]
- Qualified table name for `alter_table_owner` event log. [#58504][#58504]
- Fixed a bug that caused errors when accessing a tuple column (`tuple.column` syntax) of a tuple that could be statically determined to be null. [#58747][#58747]
- The `indoption` column in `pg_catalog.index` is now populated correctly. [#58947][#58947]
- Previously, CockroachDB could encounter an internal error when executing queries with tuples containing null values and [enums](../v21.1/enum.html) in a distributed setting. This is now fixed. [#58894][#58894]
- Fixed a nil pointer panic edge case in query setup code. [#59002][#59002]
- Non-ASCII characters in `NAME` results in [`cockroach sql`](../v21.1/cockroach-sql.html) / [`demo`](../v21.1/cockroach-demo.html) (e.g., in the results [`SHOW TABLES`](../v21.1/show-tables.html), [SHOW CONSTRAINTS](../v21.1/show-constraints.html)) are now displayed without being escaped to octal codes. [#56630][#56630]
- Garbage collection (GC) jobs now populate the `running_status` column for [`SHOW JOBS`](../v21.1/show-jobs.html). This bug has been present since v20.1. [#58612][#58612]
- Previously, CockroachDB could encounter an internal error when executing queries with `BYTES` or `STRING` types via the [vectorized engine](../v21.1/vectorized-execution.html) in rare circumstances. This is now fixed. [#59028][#59028]
- Previously, the `substring` function on byte arrays would treat its input as unicode code points, which would cause the wrong bytes to be returned. Now it only operates on the raw bytes. [#58265][#58265]
- Previously, the `substring(byte[])` functions were not able to interpret bytes that had the `\` character since it was being treated as the beginning of an escape sequence. This is now fixed. [#58265][#58265]
- Fixed a bug in which some non-conflicting rows provided as input to an [`INSERT ... ON CONFLICT DO NOTHING`](../v21.1/insert.html) statement could be discarded, and not inserted. This could happen in cases where the table had one or more unique indexes in addition to the primary index, and some of the rows in the input conflicted with existing values in one or more unique index. This scenario could cause the rows that did not conflict to be erroneously discarded. This has now been fixed. [#59147][#59147]
- Fixed an internal error that could occur when `ARRAY[NULL]` was used in a query due to incorrect typing. `ARRAY[NULL]` is now typed as `string[]` if the type cannot be otherwise inferred from the context. This is the same logic that PostgreSQL uses, thus improving compatibility in addition to fixing the internal error. [#59136][#59136]
- Fix a slow / hanging query that can be caused by using large `max_decimal_digits` on `ST_AsGeoJSON`. [#59165][#59165]
- Queries that attempt to retrieve just the key columns of a single system table row will no longer return erroneous values. [#58659][#58659]
- Fixed a bug in URL handling of HTTP external storage paths on Windows. [#59216][#59216]
- Previously, CockroachDB could crash when executing `ALTER INDEX ... SPLIT/UNSPLIT AT` when more values were provided than are explicitly specified in the index. This has been fixed. [#59213][#59213]
- Fixed a bug where multi-tenancy SQL pods would not successfully initialize the GEOS library. [#59259][#59259]
- Placeholder values are now included alongside statements in structured events. [#59110][#59110]
- Added qualification prefix for user-defined schema names in event logs. [#58617][#58617]
- Added qualification prefix for dropped views in event logs. [#59058][#59058]
- Parsing errors are no longer thrown when importing a `pgdump` file with array data. [#58244][#58244]
- Fixed a crash when creating backup schedules writing to GCS buckets. [#57617][#57617]
- CockroachDB now correctly exports `schedules_BACKUP_*` metrics as well as backup RPO metrics. [#57488][#57488]

### Performance improvements

- Previously, CockroachDB when performing an unordered `DISTINCT` operation via the [vectorized execution engine](../v21.1/vectorized-execution.html) would buffer up all tuples from the input, which is a suboptimal behavior when the query has a `LIMIT` clause. This has now been fixed. This behavior was introduced in v20.1. Note that the row-by-row engine doesn't have this issue. [#57579][#57579]
- The query optimizer can use filters that constrain columns to multiple constant values to generate lookup joins. For example, a join filter `x.a = y.a AND y.b IN (1, 2)` can be used to generate a lookup join on table `y` assuming that it has an index on `(a, b)` or `(b, a)`. [#57690][#57690]
- The query optimizer now explores plans with lookup joins on partitioned indexes, resulting in more efficient query plans in some cases. [#57690][#57690]
- Potentially improved performance for [`UPDATE`](../v21.1/update.html) statements where the table has computed columns that do not depend on updated columns. [#58188][#58188]
- CockroachDB now allows the storage engine to compact `sstables` based on reads, on read-heavy workloads. [#58247][#58247]
- Partial indexes with `IS NOT NULL` predicates can be used in cases where `JOIN` filters implicitly imply the predicate. This results in more efficient query plans for `JOIN`s and foreign checks. [#58204][#58204]
- Queries that use a geospatial inverted index can now take advantage of [vectorized execution](../v21.1/vectorized-execution.html) for some parts of the query plan, resulting in improved performance. [#58241][#58241]
- Previously, indexed columns of partial indexes were always fetched for [`UPDATE`s](../v21.1/update.html) and [`UPSERT`s](../v21.1/upsert.html). Now they are only fetched if they are required for maintaining the state of the index. If an `UPDATE` or `UPSERT` mutates columns that are neither indexed by a partial index nor referenced in a partial index predicate, they will no longer be fetched (assuming that they are not needed to maintain the state of other indexes, including the primary index). [#58358][#58358]
- [`UPDATE`](../v21.1/update.html) operations on tables with partial indexes no longer evaluate partial index predicate expressions when it is guaranteed that the operation will not alter the state of the partial index. In some cases, this can eliminate fetching the existing value of columns that are referenced in partial index predicates. [#58358][#58358]
- The `sum_int` aggregate function is now evaluated more efficiently in a distributed setting. [#58345][#58345]
- [`INSERT ... ON CONFLICT ... DO NOTHING`](../v21.1/insert.html) statements now use anti-joins for detecting conflicts. This simplifies the query plan for these statements, which may result in more efficient execution. [#58679][#58679]
- Improved the accuracy of histogram calculations for the following types: `string`/`uuid`/`inet` family. Additionally, support for `time`/`timetz` histogram calculations was also added. This improves optimizer's estimates and results in better query plans in certain instances. [#55797][#55797]
- The optimizer now uses collected histogram statistics to better estimate the cost of JSON and ARRAY inverted index scans, which may lead to more efficient query plans. [#59326][#59326]

### Build changes

- CockroachDB now builds on Ubuntu 20.10 and other distros using `gcc-10`. [#58895][#58895] {% comment %}doc{% endcomment %}

### Doc updates

- The types of logging sinks available through configuration are now [automatically documented](https://github.com/cockroachdb/cockroach/blob/master/docs/generated/logsinks.md). [#59083][#59083]
- The various output formats available for logging configurations are now documented. See the generated [reference documentation](https://github.com/cockroachdb/cockroach/blob/master/docs/generated/logformats.md) for details. [#58075][#58075]
- The cluster event logging system has been standardized. [Reference documentation](https://github.com/cockroachdb/cockroach/blob/master/docs/generated/eventlog.md) is now available (auto-generated from source code); changes to non-reserved payloads will now be announced at least one release version in advance. The event types are organized into broad categories: SQL Logical Schema Changes, SQL Privilege Changes, SQL User Management, CLuster-level events and SQL Miscellaneous operations. [#57737][#57737]
- A report of the possible logging severities and channels is now [automatically generated](https://github.com/cockroachdb/cockroach/blob/master/docs/generated/logging.md). [#57134][#57134]

### Contributors

This release includes 615 merged PRs by 85 authors. We would like to thank the following contributors from the CockroachDB community:

- Alan Acosta (first-time contributor)
- ArjunM98
- Azdim Zul Fahmi
- Cheng Jing (first-time contributor)
- Cyrus Javan
- Erik Grinaker
- Javier Fernandez-Ivern (first-time contributor)
- Kumar Akshay (first-time contributor)
- Maciej Rzasa (first-time contributor)
- Marcin Knychaa
- Max Neverov
- Miguel Novelo (first-time contributor)
- Omar Bahareth (first-time contributor)
- Petr Jedin
- Ruixin Bao
- Saif Al-Harthi (first-time contributor)
- Vaibhav
- Yanxin (first-time contributor)
- b41sh (first-time contributor)
- mosquito2333 (first-time contributor)
- neeral

[#51987]: https://github.com/cockroachdb/cockroach/pull/51987
[#52745]: https://github.com/cockroachdb/cockroach/pull/52745
[#53974]: https://github.com/cockroachdb/cockroach/pull/53974
[#55065]: https://github.com/cockroachdb/cockroach/pull/55065
[#55713]: https://github.com/cockroachdb/cockroach/pull/55713
[#55797]: https://github.com/cockroachdb/cockroach/pull/55797
[#56329]: https://github.com/cockroachdb/cockroach/pull/56329
[#56473]: https://github.com/cockroachdb/cockroach/pull/56473
[#56496]: https://github.com/cockroachdb/cockroach/pull/56496
[#56529]: https://github.com/cockroachdb/cockroach/pull/56529
[#56630]: https://github.com/cockroachdb/cockroach/pull/56630
[#56663]: https://github.com/cockroachdb/cockroach/pull/56663
[#56735]: https://github.com/cockroachdb/cockroach/pull/56735
[#56740]: https://github.com/cockroachdb/cockroach/pull/56740
[#56843]: https://github.com/cockroachdb/cockroach/pull/56843
[#56866]: https://github.com/cockroachdb/cockroach/pull/56866
[#56980]: https://github.com/cockroachdb/cockroach/pull/56980
[#57130]: https://github.com/cockroachdb/cockroach/pull/57130
[#57134]: https://github.com/cockroachdb/cockroach/pull/57134
[#57136]: https://github.com/cockroachdb/cockroach/pull/57136
[#57146]: https://github.com/cockroachdb/cockroach/pull/57146
[#57171]: https://github.com/cockroachdb/cockroach/pull/57171
[#57195]: https://github.com/cockroachdb/cockroach/pull/57195
[#57224]: https://github.com/cockroachdb/cockroach/pull/57224
[#57240]: https://github.com/cockroachdb/cockroach/pull/57240
[#57244]: https://github.com/cockroachdb/cockroach/pull/57244
[#57250]: https://github.com/cockroachdb/cockroach/pull/57250
[#57272]: https://github.com/cockroachdb/cockroach/pull/57272
[#57274]: https://github.com/cockroachdb/cockroach/pull/57274
[#57275]: https://github.com/cockroachdb/cockroach/pull/57275
[#57295]: https://github.com/cockroachdb/cockroach/pull/57295
[#57327]: https://github.com/cockroachdb/cockroach/pull/57327
[#57337]: https://github.com/cockroachdb/cockroach/pull/57337
[#57349]: https://github.com/cockroachdb/cockroach/pull/57349
[#57354]: https://github.com/cockroachdb/cockroach/pull/57354
[#57380]: https://github.com/cockroachdb/cockroach/pull/57380
[#57382]: https://github.com/cockroachdb/cockroach/pull/57382
[#57387]: https://github.com/cockroachdb/cockroach/pull/57387
[#57390]: https://github.com/cockroachdb/cockroach/pull/57390
[#57412]: https://github.com/cockroachdb/cockroach/pull/57412
[#57419]: https://github.com/cockroachdb/cockroach/pull/57419
[#57420]: https://github.com/cockroachdb/cockroach/pull/57420
[#57423]: https://github.com/cockroachdb/cockroach/pull/57423
[#57477]: https://github.com/cockroachdb/cockroach/pull/57477
[#57488]: https://github.com/cockroachdb/cockroach/pull/57488
[#57498]: https://github.com/cockroachdb/cockroach/pull/57498
[#57500]: https://github.com/cockroachdb/cockroach/pull/57500
[#57513]: https://github.com/cockroachdb/cockroach/pull/57513
[#57519]: https://github.com/cockroachdb/cockroach/pull/57519
[#57533]: https://github.com/cockroachdb/cockroach/pull/57533
[#57542]: https://github.com/cockroachdb/cockroach/pull/57542
[#57567]: https://github.com/cockroachdb/cockroach/pull/57567
[#57568]: https://github.com/cockroachdb/cockroach/pull/57568
[#57579]: https://github.com/cockroachdb/cockroach/pull/57579
[#57583]: https://github.com/cockroachdb/cockroach/pull/57583
[#57587]: https://github.com/cockroachdb/cockroach/pull/57587
[#57598]: https://github.com/cockroachdb/cockroach/pull/57598
[#57609]: https://github.com/cockroachdb/cockroach/pull/57609
[#57615]: https://github.com/cockroachdb/cockroach/pull/57615
[#57617]: https://github.com/cockroachdb/cockroach/pull/57617
[#57618]: https://github.com/cockroachdb/cockroach/pull/57618
[#57644]: https://github.com/cockroachdb/cockroach/pull/57644
[#57653]: https://github.com/cockroachdb/cockroach/pull/57653
[#57654]: https://github.com/cockroachdb/cockroach/pull/57654
[#57656]: https://github.com/cockroachdb/cockroach/pull/57656
[#57666]: https://github.com/cockroachdb/cockroach/pull/57666
[#57690]: https://github.com/cockroachdb/cockroach/pull/57690
[#57697]: https://github.com/cockroachdb/cockroach/pull/57697
[#57713]: https://github.com/cockroachdb/cockroach/pull/57713
[#57724]: https://github.com/cockroachdb/cockroach/pull/57724
[#57730]: https://github.com/cockroachdb/cockroach/pull/57730
[#57733]: https://github.com/cockroachdb/cockroach/pull/57733
[#57737]: https://github.com/cockroachdb/cockroach/pull/57737
[#57745]: https://github.com/cockroachdb/cockroach/pull/57745
[#57749]: https://github.com/cockroachdb/cockroach/pull/57749
[#57776]: https://github.com/cockroachdb/cockroach/pull/57776
[#57804]: https://github.com/cockroachdb/cockroach/pull/57804
[#57811]: https://github.com/cockroachdb/cockroach/pull/57811
[#57812]: https://github.com/cockroachdb/cockroach/pull/57812
[#57817]: https://github.com/cockroachdb/cockroach/pull/57817
[#57824]: https://github.com/cockroachdb/cockroach/pull/57824
[#57828]: https://github.com/cockroachdb/cockroach/pull/57828
[#57836]: https://github.com/cockroachdb/cockroach/pull/57836
[#57837]: https://github.com/cockroachdb/cockroach/pull/57837
[#57839]: https://github.com/cockroachdb/cockroach/pull/57839
[#57851]: https://github.com/cockroachdb/cockroach/pull/57851
[#57877]: https://github.com/cockroachdb/cockroach/pull/57877
[#57879]: https://github.com/cockroachdb/cockroach/pull/57879
[#57927]: https://github.com/cockroachdb/cockroach/pull/57927
[#57954]: https://github.com/cockroachdb/cockroach/pull/57954
[#57966]: https://github.com/cockroachdb/cockroach/pull/57966
[#57969]: https://github.com/cockroachdb/cockroach/pull/57969
[#57975]: https://github.com/cockroachdb/cockroach/pull/57975
[#57991]: https://github.com/cockroachdb/cockroach/pull/57991
[#57994]: https://github.com/cockroachdb/cockroach/pull/57994
[#58014]: https://github.com/cockroachdb/cockroach/pull/58014
[#58034]: https://github.com/cockroachdb/cockroach/pull/58034
[#58043]: https://github.com/cockroachdb/cockroach/pull/58043
[#58045]: https://github.com/cockroachdb/cockroach/pull/58045
[#58053]: https://github.com/cockroachdb/cockroach/pull/58053
[#58070]: https://github.com/cockroachdb/cockroach/pull/58070
[#58072]: https://github.com/cockroachdb/cockroach/pull/58072
[#58075]: https://github.com/cockroachdb/cockroach/pull/58075
[#58078]: https://github.com/cockroachdb/cockroach/pull/58078
[#58084]: https://github.com/cockroachdb/cockroach/pull/58084
[#58087]: https://github.com/cockroachdb/cockroach/pull/58087
[#58088]: https://github.com/cockroachdb/cockroach/pull/58088
[#58117]: https://github.com/cockroachdb/cockroach/pull/58117
[#58118]: https://github.com/cockroachdb/cockroach/pull/58118
[#58120]: https://github.com/cockroachdb/cockroach/pull/58120
[#58121]: https://github.com/cockroachdb/cockroach/pull/58121
[#58125]: https://github.com/cockroachdb/cockroach/pull/58125
[#58126]: https://github.com/cockroachdb/cockroach/pull/58126
[#58128]: https://github.com/cockroachdb/cockroach/pull/58128
[#58130]: https://github.com/cockroachdb/cockroach/pull/58130
[#58140]: https://github.com/cockroachdb/cockroach/pull/58140
[#58146]: https://github.com/cockroachdb/cockroach/pull/58146
[#58153]: https://github.com/cockroachdb/cockroach/pull/58153
[#58161]: https://github.com/cockroachdb/cockroach/pull/58161
[#58173]: https://github.com/cockroachdb/cockroach/pull/58173
[#58188]: https://github.com/cockroachdb/cockroach/pull/58188
[#58191]: https://github.com/cockroachdb/cockroach/pull/58191
[#58192]: https://github.com/cockroachdb/cockroach/pull/58192
[#58204]: https://github.com/cockroachdb/cockroach/pull/58204
[#58208]: https://github.com/cockroachdb/cockroach/pull/58208
[#58212]: https://github.com/cockroachdb/cockroach/pull/58212
[#58219]: https://github.com/cockroachdb/cockroach/pull/58219
[#58221]: https://github.com/cockroachdb/cockroach/pull/58221
[#58233]: https://github.com/cockroachdb/cockroach/pull/58233
[#58241]: https://github.com/cockroachdb/cockroach/pull/58241
[#58244]: https://github.com/cockroachdb/cockroach/pull/58244
[#58247]: https://github.com/cockroachdb/cockroach/pull/58247
[#58251]: https://github.com/cockroachdb/cockroach/pull/58251
[#58254]: https://github.com/cockroachdb/cockroach/pull/58254
[#58257]: https://github.com/cockroachdb/cockroach/pull/58257
[#58265]: https://github.com/cockroachdb/cockroach/pull/58265
[#58288]: https://github.com/cockroachdb/cockroach/pull/58288
[#58292]: https://github.com/cockroachdb/cockroach/pull/58292
[#58305]: https://github.com/cockroachdb/cockroach/pull/58305
[#58306]: https://github.com/cockroachdb/cockroach/pull/58306
[#58317]: https://github.com/cockroachdb/cockroach/pull/58317
[#58345]: https://github.com/cockroachdb/cockroach/pull/58345
[#58349]: https://github.com/cockroachdb/cockroach/pull/58349
[#58354]: https://github.com/cockroachdb/cockroach/pull/58354
[#58358]: https://github.com/cockroachdb/cockroach/pull/58358
[#58359]: https://github.com/cockroachdb/cockroach/pull/58359
[#58381]: https://github.com/cockroachdb/cockroach/pull/58381
[#58399]: https://github.com/cockroachdb/cockroach/pull/58399
[#58423]: https://github.com/cockroachdb/cockroach/pull/58423
[#58431]: https://github.com/cockroachdb/cockroach/pull/58431
[#58433]: https://github.com/cockroachdb/cockroach/pull/58433
[#58434]: https://github.com/cockroachdb/cockroach/pull/58434
[#58452]: https://github.com/cockroachdb/cockroach/pull/58452
[#58454]: https://github.com/cockroachdb/cockroach/pull/58454
[#58466]: https://github.com/cockroachdb/cockroach/pull/58466
[#58470]: https://github.com/cockroachdb/cockroach/pull/58470
[#58472]: https://github.com/cockroachdb/cockroach/pull/58472
[#58487]: https://github.com/cockroachdb/cockroach/pull/58487
[#58495]: https://github.com/cockroachdb/cockroach/pull/58495
[#58504]: https://github.com/cockroachdb/cockroach/pull/58504
[#58612]: https://github.com/cockroachdb/cockroach/pull/58612
[#58616]: https://github.com/cockroachdb/cockroach/pull/58616
[#58617]: https://github.com/cockroachdb/cockroach/pull/58617
[#58659]: https://github.com/cockroachdb/cockroach/pull/58659
[#58671]: https://github.com/cockroachdb/cockroach/pull/58671
[#58679]: https://github.com/cockroachdb/cockroach/pull/58679
[#58716]: https://github.com/cockroachdb/cockroach/pull/58716
[#58725]: https://github.com/cockroachdb/cockroach/pull/58725
[#58740]: https://github.com/cockroachdb/cockroach/pull/58740
[#58743]: https://github.com/cockroachdb/cockroach/pull/58743
[#58747]: https://github.com/cockroachdb/cockroach/pull/58747
[#58748]: https://github.com/cockroachdb/cockroach/pull/58748
[#58749]: https://github.com/cockroachdb/cockroach/pull/58749
[#58888]: https://github.com/cockroachdb/cockroach/pull/58888
[#58891]: https://github.com/cockroachdb/cockroach/pull/58891
[#58894]: https://github.com/cockroachdb/cockroach/pull/58894
[#58895]: https://github.com/cockroachdb/cockroach/pull/58895
[#58898]: https://github.com/cockroachdb/cockroach/pull/58898
[#58903]: https://github.com/cockroachdb/cockroach/pull/58903
[#58928]: https://github.com/cockroachdb/cockroach/pull/58928
[#58937]: https://github.com/cockroachdb/cockroach/pull/58937
[#58947]: https://github.com/cockroachdb/cockroach/pull/58947
[#58987]: https://github.com/cockroachdb/cockroach/pull/58987
[#58988]: https://github.com/cockroachdb/cockroach/pull/58988
[#58995]: https://github.com/cockroachdb/cockroach/pull/58995
[#59002]: https://github.com/cockroachdb/cockroach/pull/59002
[#59008]: https://github.com/cockroachdb/cockroach/pull/59008
[#59009]: https://github.com/cockroachdb/cockroach/pull/59009
[#59028]: https://github.com/cockroachdb/cockroach/pull/59028
[#59049]: https://github.com/cockroachdb/cockroach/pull/59049
[#59058]: https://github.com/cockroachdb/cockroach/pull/59058
[#59083]: https://github.com/cockroachdb/cockroach/pull/59083
[#59087]: https://github.com/cockroachdb/cockroach/pull/59087
[#59110]: https://github.com/cockroachdb/cockroach/pull/59110
[#59121]: https://github.com/cockroachdb/cockroach/pull/59121
[#59136]: https://github.com/cockroachdb/cockroach/pull/59136
[#59144]: https://github.com/cockroachdb/cockroach/pull/59144
[#59147]: https://github.com/cockroachdb/cockroach/pull/59147
[#59165]: https://github.com/cockroachdb/cockroach/pull/59165
[#59178]: https://github.com/cockroachdb/cockroach/pull/59178
[#59206]: https://github.com/cockroachdb/cockroach/pull/59206
[#59212]: https://github.com/cockroachdb/cockroach/pull/59212
[#59213]: https://github.com/cockroachdb/cockroach/pull/59213
[#59216]: https://github.com/cockroachdb/cockroach/pull/59216
[#59223]: https://github.com/cockroachdb/cockroach/pull/59223
[#59234]: https://github.com/cockroachdb/cockroach/pull/59234
[#59248]: https://github.com/cockroachdb/cockroach/pull/59248
[#59256]: https://github.com/cockroachdb/cockroach/pull/59256
[#59259]: https://github.com/cockroachdb/cockroach/pull/59259
[#59313]: https://github.com/cockroachdb/cockroach/pull/59313
[#59319]: https://github.com/cockroachdb/cockroach/pull/59319
[#59326]: https://github.com/cockroachdb/cockroach/pull/59326
[#59350]: https://github.com/cockroachdb/cockroach/pull/59350

## v21.1.0-alpha.1

Get future release notes emailed to you:

{% include marketo.html %}

### Downloads

<div id="os-tabs" class="clearfix os-tabs_button-outline-primary">
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.0-alpha.1.darwin-10.9-amd64.tgz"><button id="mac" data-eventcategory="mac-binary-release-notes">Mac</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.0-alpha.1.linux-amd64.tgz"><button id="linux" data-eventcategory="linux-binary-release-notes">Linux</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.0-alpha.1.windows-6.2-amd64.zip"><button id="windows" data-eventcategory="windows-binary-release-notes">Windows</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.1.0-alpha.1.src.tgz"><button id="source" data-eventcategory="source-release-notes">Source</button></a>
</div>

### Docker image

{% include copy-clipboard.html %}
~~~shell
$ docker pull cockroachdb/cockroach-unstable:v21.1.0-alpha.1
~~~

### Backward-incompatible changes

- RocksDB can no longer be used as the storage engine. Passing in `--storage-engine=rocksdb` now returns an error. [#55509][#55509] {% comment %}doc{% endcomment %}
- Rows containing empty arrays in [`ARRAY`](../v21.1/array.html) columns are now contained in [inverted indexes](../v21.1/inverted-indexes.html). This change is backward-incompatible because prior versions of CockroachDB will not be able to recognize and decode keys for empty arrays. Note that rows containing `NULL` values in an indexed column will still not be included in inverted indexes. [#55970][#55970] {% comment %}doc{% endcomment %}
- Concatenation between a non-null argument and a null argument is now typed as string concatenation, whereas it was previously typed as array concatenation. This means that the result of `NULL || 1` will now be `NULL` instead of `{1}`. To preserve the old behavior, the null argument can be casted to an explicit type. [#55611][#55611] {% comment %}doc{% endcomment %}

### General changes

- Added increased logging and metrics around slow disk operations. [#54215][#54215] {% comment %}doc{% endcomment %}
- CockroachDB now detects stalled disk operations better and crashes the process if a disk operation is taking longer than a minute. Added cluster settings to allow for tuning of this behavior. [#55186][#55186] {% comment %}doc{% endcomment %}
- Added some metrics surrounding schema changes. [#54855][#54855] {% comment %}doc{% endcomment %}
- Upgraded CockroachDB's version of Go to v1.15.4. [#56363][#56363] {% comment %}doc{% endcomment %}
- The timezone data is now built in to the CockroachDB binary, which is the fallback source of time if `tzdata` is not located by the default Go standard library. [#56634][#56634] {% comment %}doc{% endcomment %}
- Renamed instances of "Admin UI" to "DB Console" in the documentation of OIDC cluster settings. [#56869][#56869]
- Included `tar` in docker images. This allows users to use `kubectl cp` on 20.2.x containers. [#57241][#57241]

### Enterprise edition changes

- It is no longer allowed to widen an incremental-backup chain with the inclusion of new complete empty DBs. [#54329][#54329] {% comment %}doc{% endcomment %}
- Added cluster settings to enable/ disable the `BACKUP` and `RESTORE` commands. Attempts to use these features while they are disabled returns an error indicating that the database administrator has disabled the feature. Example usage: `SET CLUSTER SETTING feature.backup.enabled = FALSE; SET CLUSTER SETTING feature.backup.enabled = TRUE; SET CLUSTER SETTING feature.restore.enabled = FALSE; SET CLUSTER SETTING feature.restore.enabled = TRUE;`. [#56533][#56533] {% comment %}doc{% endcomment %}
- Added cluster settings to enable/ disable the `IMPORT`, `EXPORT`, and changefeed  commands. Attempts to use these features while they are disabled returns an error indicating that the database administrator has disabled the feature. Example usage: `SET CLUSTER SETTING feature.import.enabled = FALSE; SET CLUSTER SETTING feature.import.enabled = TRUE; SET CLUSTER SETTING feature.export.enabled = FALSE; SET CLUSTER SETTING feature.export.enabled = TRUE; SET CLUSTER SETTING feature.changefeed.enabled = FALSE; SET CLUSTER SETTING feature.changefeed.enabled = TRUE;`. [#56872][#56872] {% comment %}doc{% endcomment %}

### SQL language changes

- Interleaved joins have been removed; merge joins are now planned in all cases when interleaved joins would have been planned previously. [#54163][#54163] {% comment %}doc{% endcomment %}
- It is now possible to create partial inverted indexes. The optimizer will choose to scan partial inverted indexes when the partial index predicate is implied and scanning the inverted index has the lowest estimated cost. [#54376][#54376] {% comment %}doc{% endcomment %}
- `EXPLAIN ANALYZE` diagrams now contain "bytes sent" information on streams. [#54518][#54518] {% comment %}doc{% endcomment %}
- Implemented the geometry built-in functions `ST_Rotate({geometry, float8, geometry})`. [#54610][#54610]
- Implemented the geometry built-in function `ST_ClosestPoint()`. [#54843][#54843]
- Implement the string built-in function `unaccent()`. [#54628][#54628]
- When enterprise features are not enabled, the `follower_read_timestamp()` function now returns `(statement_time - 4.8s)` instead of an error. [#54951][#54951] {% comment %}doc{% endcomment %}
- Added a new virtual table `crdb_internal.invalid_descriptors`, which runs validations on descriptors in the database context and reports any errors. [#54017][#54017]
- Implemented the built-in operator `add jsonb_exists_any(jsonb, text[])`. [#55172][#55172]
- Added the ability to optionally specify the `PRIVILEGES` keyword when issuing the `GRANT ALL` or `REVOKE ALL` statements, for Postgres compatibility. Previously, a statement like the following would fail with a syntax error: `GRANT ALL PRIVILEGES ON DATABASE a TO user1;`. [#55304][#55304] {% comment %}doc{% endcomment %}
- Implemented the built-in function `pg_column_size()`, which counts the amount of bytes stored by column. [#55312][#55312]
- Implemented the geometry built-in functions `ST_Rotate({geometry, float8, float8, float8})`. [#55428][#55428]
- Implemented the built-in function `ST_MemSize()`, which returns the memory space a geometry takes. [#55416][#55416]
- `SHOW ENUMS` now returns an array aggregation of enum values instead of having them separated by the `|` character. [#55386][#55386]
- Implemented the geometry built-in function `ST_PointInsideCircle()`. [#55464][#55464]
- Implement the geometry built-in function `ST_LineFromEncodedPolyline()`. [#55429][#55429]
- Implement the geometry built-in function `ST_AsEncodedPolyline()`. [#55515][#55515]
- Implement the geometry built-in function `ST_LineLocatePoint()`, which computes the fraction of the line segment that represents the location of the given point to the closest point on the original line. [#55470][#55470]
- Implemented the `REASSIGN OWNED BY ... TO ...` statement, which changes ownership of all database objects in the current database, owned by any roles in the first argument, to the new role in the second argument. [#54594][#54594]
- Implemented the geometry built-in function `ST_MinimumBoundingRadius()`, which returns a record containing the center point and radius of the smallest circle that can fully contain a geometry. [#55532][#55532]
- The vectorized engine now supports the JSONFetchValPath (`#>`) operator. [#55570][#55570]
- Added the ability to cast a string containing all integers into a given regtype, e.g., `'1234'::regproc`. [#55607][#55607]
- Potentially hazardous `DROP COLUMN` operations when `sql_safe_updates` is enabled now return a note and link to https://github.com/cockroachdb/cockroach/issues/46541. [#55248][#55248] {% comment %}doc{% endcomment %}
- Changed the `SPLIT AT` output to be consistent with the output from `SHOW RANGES`. [#55543][#55543] {% comment %}doc{% endcomment %}
- Implemented the geometry built-in function `ST_MinimumBoundingCircle()`, which returns polygon shape that approximates minimum bounding circle to contain geometry. [#55567][#55567]
- Added the constraint name to constraint errors, for increased wire-level Postgres compatibility. [#55660][#55660] {% comment %}doc{% endcomment %}
- Added support for using the syntax `... UNIQUE WITHOUT INDEX ...` in `CREATE TABLE` and `ALTER TABLE` statements, both when defining columns and unique constraints. Although this syntax can now be parsed successfully, using this syntax currently returns an error: `unique constraints without an index are not yet supported`. [#55700][#55700] {% comment %}doc{% endcomment %}
- Add the built-in functions `sha224()` and `sha384()`. [#55720][#55720]
- Implemented `SHOW REGIONS`, which returns all of regions available in a cluster. [#55831][#55831] {% comment %}doc{% endcomment %}
- Implemented the geography built-in function `ST_UnaryUnion()` [#55894][#55894]
- Implemented `ALTER TABLE ... SET LOCALITY/REGIONAL AFFINITY` statements, which configure multi-region properties of given tables. These are subject to change. [#55827][#55827] {% comment %}doc{% endcomment %}
- All expressions in `EXPLAIN` output that operate on indexes now show the table name the index is declared on, rather than just an alias. If the query aliases the table, the alias is also shown. For example, a scan on table `foo` that is aliased as `f` was previously displayed as `scan f`. It is now displayed as `scan foo [as=f]`. [#55641][#55641] {% comment %}doc{% endcomment %}
- Changed the underlying type for the version cluster setting. Previously, it was of an internal type representing "state machine", but now it's simply "version". This has no operational implications, but the `Type` column in `cockroach gen settings-list` now shows "version" instead of "custom validation". [#55994][#55994],[#56546][#56546] {% comment %}doc{% endcomment %}
- Removed the `201auto` value for the `vectorize` session variable and the corresponding cluster setting. [#55907][#55907] {% comment %}doc{% endcomment %}
- Expanded the `CREATE SCHEMA`, `DROP SCHEMA`, `ALTER SCHEMA`, `GRANT ... ON SCHEMA`, `REVOKE ... ON SCHEMA`, and `SHOW GRANTS ON SCHEMA` statements to allow schema names prefixed with database names. [#55647][#55647] {% comment %}doc{% endcomment %}
- Added support for dollar-quoted strings with digit. [#55958][#55958] {% comment %}doc{% endcomment %}
- Added a new single-column output format for `EXPLAIN` and `EXPLAIN (VERBOSE)`. [#55866][#55866] {% comment %}doc{% endcomment %}
- Creating multi-column inverted indexes is now allowed by setting the `experimental_enable_mutlti_column_inverted_indexes` session setting to `true`. At this time, these indexes are not fully supported and their behavior is undefined. Using this feature will likely result in errors. Do not enable this setting in a production database. [#55993][#55993] {% comment %}doc{% endcomment %}
- Constraints that have not been validated are now marked "NOT VALID" in the output of `SHOW CREATE` and `SHOW CONSTRAINTS`. [#53485][#53485] {% comment %}doc{% endcomment %}
- The `NOT VALID` option can now be provided for `CHECK` and `FOREIGN KEY` constraints listed as table constraints in `CREATE TABLE` statements. This option has no affect on the constraint created. It will not skip validation. [#53485][#53485] {% comment %}doc{% endcomment %}
- Added a pgcode (`42704`, `undefined_object`) to the error returned when attempting to drop an index by a table and index name that doesn't exist. [#55417][#55417]
- Added the `WITH row_limit="{$num}"` option for importing CSVs to allow users to do a quick test run on an import of `$num` rows. Exampel: `IMPORT TABLE test ... CSV DATA ... WITH row_limit="3";` [#56080][#56080] {% comment %}doc{% endcomment %}
- Added the `WITH row_limit="{$num}"` option for importing `DELIMITED/AVRO` data to allow users to do a quick test run on an import of $num rows. Example: `IMPORT TABLE test ... DELIMITED/AVRO DATA ... WITH row_limit="3";` [#56135][#56135] {% comment %}doc{% endcomment %}
- Added `WITH row_limit="{$num}"` option for importing bundle formats to allow users to do a quick test run on an import of $num rows. Example: `IMPORT ... WITH row_limit="3";`. [#56587][#56587] {% comment %}doc{% endcomment %}
- `EXPLAIN ANALYZE` diagrams now contain "network latency" information on streams. [#55705][#55705] {% comment %}doc{% endcomment %}
- Implemented the `covar_pop()` and `covar_samp()` aggregation functions. [#55707][#55707]
- Prevented column type modification of columns that are depended on by views. [#56213][#56213]
- Implemented the geometry built-in functions `ST_TransScale({geometry,float8,float8,float8,float8})` [#56198][#56198]
- Implemented the geometry built-in function `ST_Node()`. [#56183][#56183]
- The concatenation operator `||` can now be used between strings and any other non-array types. [#55611][#55611]
- CockroachDB now returns a float instead of a decimal when at least one argument of an aggregate function is decimal. [#56296][#56296]
- Implemented the `regr_intercept()`, `regr_r2()`, and `regr_slope()` aggregation functions. [#56296][#56296]
- `EXPLAIN ANALYZE` diagrams now show "deserialization time" on streams instead of "io time". [#56144][#56144]
- Added a pgcode (`42804`, `DatatypeMismatch`) when adding a default value of the wrong type to a column. [#56455][#56455]
- Attempting to rename an undefined index now returns a `pgcode.UndefinedObject` (`42704`) error instead of an uncategorized error. [#56455][#56455]
- Implemented the `regr_sxx()`, `regr_sxy()`, and `regr_syy()` aggregation functions. [#56585][#56585]
- `SHOW REGIONS` has changed the column name for availability zones to "zones" from "availability_zones". [#56344][#56344] {% comment %}doc{% endcomment %}
- Introduced a `pg_collation` of "default". Strings now return the "default" collation OID in the `pg_attribute` table (this was previously `en_US`). The "default" collation is also visible on the `pg_collation` virtual table. [#56598][#56598]
- A table can now successfully be dropped in a transaction following other schema changes to the table in the same transaction. [#56589][#56589] {% comment %}doc{% endcomment %}
- Added a new variant of explain: `EXPLAIN ANALYZE (PLAN)`. [#56524][#56524] {% comment %}doc{% endcomment %}
- `SHOW REGIONS` functionality is now deferred to `SHOW REGIONS FROM CLUSTER`. [#56627][#56627] {% comment %}doc{% endcomment %}
- It is now possible to hint to the optimizer that it should plan an inverted join by using the syntax `... INNER INVERTED JOIN ...` or `... LEFT INVERTED JOIN ...`. If the hint is provided and it is possible to plan an inverted join, the optimizer will now plan an inverted join, even if it estimates that a different plan would have a lower cost. If the hint is provided but it is not possible to plan an inverted join because there is no inverted index on the right side table or the join condition is not a valid inverted join condition, the database will return an error. [#55679][#55679] {% comment %}doc{% endcomment %}
- Added the empty `pg_catalog.pg_opclass` table to improve compatibility with Postgres. [#56653][#56653]
- `SURVIVE AVAILABILITY ZONE FAILURE` is now `SURVIVE ZONE FAILURE`. [#56837][#56837] {% comment %}doc{% endcomment %}
- Added admin-only, `crdb_internal` functions to enable descriptor repair in dire circumstances. [#55699][#55699]
- Added support for an optional `=` character for `SURVIVE`, e.g., `ALTER DATABASE d SURVIVE = ZONE FAILURE`. [#56881][#56881] {% comment %}doc{% endcomment %}
- Introduced stubs for `ALTER DATABASE ... PRIMARY REGION` and `CREATE TABLE ... PRIMARY REGION`. [#56883][#56883] {% comment %}doc{% endcomment %}
- Dropping the primary index using `DROP INDEX` now returns a `FeatureNotSupported` error along with hints showing supported ways to drop primary indexes. [#56858][#56858]
- Renaming an index to a name that is already being used for another index will now return a `pgcode.DuplicateRelation` (`42P07`) error instead of an uncategorized error. [#56681][#56681]
- The `relpersistence` column in `pg_catalog.pg_class` now correctly displays `t` as the persistence status for temporary tables. [#56827][#56827]
- Added a deprecation notice to statements containing the `INTERLEAVE IN PARENT` clause. [#56874][#56874]
- `SHOW DATABASES` and `crdb_internal.databases` now display all regions as well as survival goals for a given database. [#56880][#56880] {% comment %}doc{% endcomment %}
- Adds a feature flag via cluster settings for the `CREATE STATISTICS` and `ANALYZE` feature. If a user attempts to use the command while disabled, an error indicating that the database administrator had disabled the feature is surfaced. Example usage: `SET CLUSTER SETTING feature.stats.enabled = FALSE; SET CLUSTER SETITNG feature.stats.enabled = TRUE;`. [#57076][#57076] {% comment %}doc{% endcomment %}
- `CREATE DATABASE ... PRIMARY REGION` is now stored on the database descriptor. [#57038][#57038]
- `SHOW DATABASES` and `crdb_internal.databases` now display the `PRIMARY REGION` set on the database descriptor as the `primary_region` column. [#57038][#57038] {% comment %}doc{% endcomment %}
- Added a feature flag via cluster settings for all schema change-related features. If a user attempts to use these features while they are disabled, an error indicating that the database administrator has disabled the feature is surfaced.  Example usage: `SET CLUSTER SETTING feature.schema_change.enabled = FALSE; SET CLUSTER SETTING feature.schema_change.enabled = TRUE;`. [#57040][#57040] {% comment %}doc{% endcomment %}
- Changed `pg_constraint` column types for `confkey` and `conkey` to `smallint[]` to improve compatibility with Postgres. [#56975][#56975]
- The `ALTER TABLE...SPLIT/UNSPLIT` and `ALTER INDEX...SPLIT/UNSPLIT` commands are now gated by a schema change feature flag. If a user attempts to use these features while they are disabled, an error indicating that the system administrator has disabled the feature is surfaced. Example usage: `SET CLUSTER SETTING feature.schema_change.enabled = FALSE SET CLUSTER SETTING feature.schema_change.enabled = TRUE;`. [#57142][#57142] {% comment %}doc{% endcomment %}
- When creating a database with the regions clause specified, CockroachDB now creates a `regions` enum type automatically. [#56628][#56628] {% comment %}doc{% endcomment %}
- Implemented `SHOW REGION FROM DATABASE` and `SHOW REGION FROM DATABASE db`, which shows all regions for the given database, as well as whether that region is the primary region. [#57106][#57106] {% comment %}doc{% endcomment %}
- `CREATE TABLE AS SELECT ... FROM ... AS OF SYSTEM TIME x` is now supported. [#55916][#55916]
- Implemented the function `regr_count()`. [#56822][#56822]
- Added the `character_sets` table to the `information_schema`. [#56953][#56953] {% comment %}doc{% endcomment %}
- `SHOW ENUMS` is now extended to take an optional `FROM` clause. The user can specify either the schema name or both the database name and schema name separated by `.`. If a hierarchy is specified, the statement returns enums falling in that hierarchy rather than all of the enums in the current database. [#57197][#57197] {% comment %}doc{% endcomment %}
- The multi-region enum, created implicitly for all multi-region databases, can be introspected using the `pg_catalog.pg_enum` table. It is also displayed in `SHOW ENUMS`. [#57197][#57197] {% comment %}doc{% endcomment %}
- Implemented the geography built-in function `ST_Subdivide()`. [#56898][#56898]
- A `pgcode.UndefinedColumn` error is now returned when adding a unique constraint to one or more undefined columns. [#57316][#57316]
- The database name is now displayed in `SHOW REGIONS FROM DATABASE`. [#57278][#57278] {% comment %}doc{% endcomment %}
- Added `SHOW SURVIVAL GOAL FROM DATABASE [database]`, which shows the survival goal for a multi-region database. [#57278][#57278] {% comment %}doc{% endcomment %}
- Added the `uuid_generate_v4()` built-in function. It works exactly like `gen_random_uuid()` but was added for compatibility with Postgres versions older than PG13. [#57212][#57212]

### Command-line changes

- A `debug.zip` file now includes a script, `hot-ranges.sh`, which will summarize the hottest ranges in the cluster. [#53547][#53547] {% comment %}doc{% endcomment %}
- `cockroach sql` and `cockroach demo` now support the command-line parameter `--file` (shorthand `-f`) to read commands from a named file. The behavior is the same as if the file was redirected on the standard input; in particular, the processing stops at the first error encountered (which is different from interactive usage with a prompt).  Note that it is not yet possible to combine `-f` with `-e`. [#54741][#54741] {% comment %}doc{% endcomment %}
- The large banner message "Replication has been disabled for this cluster ..." that was unconditionally emitted on the standard error stream for `cockroach start-single-node` has now become a simple log message at severity `INFO`. [#54749][#54749]
- `cockroach demo` now pre-creates a `demo` user account with a random password to discourage the user of `root`. The `demo` account is currently granted the `admin` role. [#54749][#54749] {% comment %}doc{% endcomment %}
- The CLI help text for `--max-disk-temp-storage` now properly reports the default value. [#54853][#54853]
- The help text displayed by `\?` in `cockroach sql` and `cockroach demo` now groups the recognized client-side commands into sections for easier reading. [#54796][#54796]
- The client-side command `\show` for the SQL shell is deprecated in favor of the new command `\p`. This prints the contents of the query buffer entered so far. [#54796][#54796] {% comment %}doc{% endcomment %}
- The new client-side command `\r` for the SQL shell erases the contents of the query buffer entered so far. This provides a convenient way to reset the input, for example, when the user gets themselves confused with string delimiters. [#54796][#54796] {% comment %}doc{% endcomment %}
- The SQL shell (`cockroach sql`, `cockroach demo`) now supports the client-side command `\echo`, like `psql`. This can be used, for example, to generate informational output when executing SQL scripts non-interactively. [#54796][#54796] {% comment %}doc{% endcomment %}
- The SQL shell (`cockroach sql`, `cockroach demo`) now support the `\i` and `\ir` client-side command which reads SQL file and evaluates its content in-place.  `\ir` differs from `\i` in that the file name is resolved relative to the location of the script containing the `\ir` command. This makes `\ir` likely more desirable in the general case. Instances of `\q` inside a file included via `\i`/`\ir` stop evaluation of the file and resume evaluation of the file that included it. This feature is compatible with the identically named `psql` commands. It is meant to help compose complex initialization scripts from a library of standard components.  For example, one could be defining each table and its initial contents in separate SQL files, and then use different super-files to include different tables depending on the desired final schema. [#54796][#54796] {% comment %}doc{% endcomment %}
- Removed the `debug sstables` command, superseded by the `debug pebble lsm` command. [#54890][#54890]
- Added the `cockroach debug pebble db checkpoint` debug command to easily create a checkpoint without using rocksdb. [#55751][#55751] {% comment %}doc{% endcomment %}
- Updated the `--storage-engine` help text to reflect RocksDB deletion. [#55509][#55509]
- Added support for `\connect DATABASE` and `\c DATABASE`. [#55934][#55934] {% comment %}doc{% endcomment %}
- Added an import CLI command that allows users to upload and import local dump files into a running cockroach cluster. `PGDUMP` and `MYSQLDUMP` formats are currently supported. [#54896][#54896] {% comment %}doc{% endcomment %}
- `cockroach demo` now allows for nodes to be added using the `\demo` client-side command.  This works in both single node and multi-node configurations, for example, when started with `--nodes int` or `--geo-partitioned-replicas`. [#56344][#56344] {% comment %}doc{% endcomment %}
- Some specific situations now have dedicated exit status codes. The following codes are defined:

    Code | Description
    -----|------------
    0 | Process terminated without error.
    1 | An unspecified error was encountered. Explanation should be present in the stderr or logging output.
    2 | Go runtime error, or uncaught panic. Likely a bug in CockroachDB. Explanation may be present in logging output.
    3 | Server process interrupted gracefully with Ctrl+C / SIGINT.
    4 | Command-line flag error.
    5 | A logging operation to the process' stderr stream failed (e.g., stderr has been closed). Some details may be present in the file output, if enabled.
    6 | A logging operation to file has failed (e.g., log disk full, no inodes, permission issue, etc). Some details may be present in the stderr stream.
    7 | Server detected an internal error and triggered an emergency shutdown.
    8 | Logging failed while processing an emergency shutdown.
    [#56574][#56574]
- `cockroach demo` now tries to use the same TCP port numbers for the SQL and HTTP servers on every invocation. This is meant to simplify documentation. These defaults can be overridden with the new (`demo`-specific) command line flags `--sql-port` and/or `--http-port`. [#56737][#56737] {% comment %}doc{% endcomment %}
- The SQL shell now accepts `yes`/`no` as boolean options for slash commands, following `psql` behavior. [#56829][#56829] {% comment %}doc{% endcomment %}
- A `\x [on|off]` command has been added to toggle the `records` display format, following `psql` behavior. [#56829][#56829] {% comment %}doc{% endcomment %}
- CockroachDB now prints a warning if the `--locality` flag does not contain a "region" tier. [#57179][#57179] {% comment %}doc{% endcomment %}

### API endpoint changes

- Added a new prometheus metric called `seconds_until_license_expiry` that reports the number of seconds until the enterprise license on the cluster expires, a negative number if the expiration is in the past, or `0` if there is no license. [#55565][#55565] {% comment %}doc{% endcomment %}

### DB Console changes

- Changed the view for tables without data on main pages. [#54943][#54943]
- Updated the design of the custom date range selector on the Cluster > Maps view and Metrics pages [#54851][#54851]
- The DB Console now shows messages provided by server instead of custom generic messages defined on the client side, for example, messages about permission restrictions to show pages for non-admin roles. [#50869][#50869]
- Added a new metric called `raft.scheduler.latency`, which monitors the latency for operations to be picked up and processed by the Raft scheduler. [#56943][#56943]
- Redesigned inline error alerts when a user has insufficient rights to see some resources. [#50869][#50869]
- Implemented a permission denied error for non-admin users on the Node Map and Events views. [#50869][#50869]
- Tables within user-defined schemas are now included in the Data Distribution page. [#56388][#56388] {% comment %}doc{% endcomment %}
- Creating, dropping, and altering roles or users now causes events to be logged and displayed. [#55945][#55945]
- If statement diagnostics are enabled for a statement, the bytes sent over the network are now shown. [#55969][#55969]
- `ALTER DATABASE OWNER` and `CONVERT TO SCHEMA` now cause events to be logged and displayed. [#55891][#55891]
- Changing schema objects now causes events to be logged and displayed. [#55785][#55785]
- Changing privileges (i.e., with `GRANT` or `REVOKE`) now causes events to be logged and displayed. [#55612][#55612]
- Renaming databases or tables now causes events to be logged and displayed. [#55269][#55269]
- Added descriptions for failed job on the Job Details page. [#54268][#54268] {% comment %}doc{% endcomment %}

### Bug fixes

- Fixed the `rpath` and `so` names of `libgeos.so` and `libgeos_c.so` such that a `dlopen` to `libgeos.so` is not needed. [#55129][#55129]
- Made lease transfers during rebalancing adhere to the rate limit utilized in other lease transfer cases which eliminates unexpected lease oscillations when adding a new node. [#54322][#54322]
- CockroachDB now handles PostgreSQL "cancel" messages on TLS connections in the same way as when they are sent without TLS: the connection is closed, but no action takes place. No error is logged. As a reminder, PostgreSQL "cancel" messages are still unsupported in CockroachDB and client should still use `CANCEL QUERY` instead. [#54618][#54618]
- Cleared table statistics from job description in failed and canceled backup jobs. [#54446][#54446]
- Fixed an error message that referred to `experimental_enable_hash_sharded_indexes` as a cluster setting when it is in fact a session variable. [#54960][#54960]
- Fixed a nil pointer error that could occur at planning time for some spatial queries when an inverted index existed on a geometry or geography column. [#55076][#55076]
- Fixed `SHOW ENUMS` column names to have `values` instead of `string_agg` for column names, and `owner` for the owner itself. [#55139][#55139]
- Fixed `SHOW TYPES` to show the `owner` column instead of the `value` column. [#55139][#55139]
- Fixed a bug where empty enums did not show up for `SHOW ENUMS` or `SHOW TYPES`. [#55143][#55143]
- Fixed a bug where, on failure of `CREATE TABLE AS` or `CREATE MATERIALIZED VIEW`, tables would be left in an invalid non-public state until GC instead of being marked as dropped, possibly causing spurious validation failures. The bug was introduced in earlier 20.2 pre-releases. [#55272][#55272]
- Fixed a rare scenario in which a node would refuse to start after updating the binary. The log message would indicate: `store [...], last used with cockroach version [...], is too old for running version [...] (which requires data from [...] or later)`. [#55240][#55240]
- Changefeeds defined on multiple tables will now only backfill affected tables after a schema change. [#55135][#55135]
- Fixed a bug where adding child tables or types to a schema being restored would cause those new child objects to become corrupted with no parent schema if the restore job had to be rolled back. [#55157][#55157]
- Fixed a bug where the seconds component of a zone offset of a `TIMESTAMPTZ` value was not displayed. [#55071][#55071]
- Fixed a bug where casts to regclass were not escaped, e.g., when the type or table name had `"` characters. [#55607][#55607]
- Fixed a bug where casts from string to regproc, regtype or regprocedure would not work if they contained `"` characters at the beginning or at the end. [#55607][#55607]
- Fixed a bug which could cause `IMPORT`, `BACKUP`, or `RESTORE` to experience an error when they occur concurrently to when the cluster sets its version to upgraded. [#55524][#55524]
- Fixed a rare crash during tracing when reading un-decodable data. [#55783][#55783]
- Prevented a crash, introduced in the 20.2 series, caused by range scans over virtual tables with virtual indexes. [#56459][#56459]
- In some cases CockroachDB, would attempt to transfer ranges to nodes in the process of being decommissioned or being shut down; this could cause disruption the moment the node did actually terminate. This bug has been fixed. It had been introduced some time before v2.0. [#55808][#55808]
- Fixed a bug causing queries sent to a freshly-restarted node to sometimes hang for a long time while the node catches up with replication. [#55148][#55148]
- Fixed typing of collated strings so that collation names are case-insensitive and hyphens/underscores are interchangeable. [#56352][#56352]
- Fixed internal errors related to very large `LIMIT` and/or `OFFSET` values. [#56672][#56672]
- Improved the accuracy of reported CPU usage when running in containers. [#56461][#56461]
- Fixed a bug which can lead to canceled schema change jobs ending in the failed rather than canceled state. [#55513][#55513]
- Prevented an opportunity for livelock in the jobs subsystem due to frequent updates to already finished jobs. [#56855][#56855]
- The `LogFile` reserved API, which was used by `cockroach debug zip`, could corrupt log entries. This has been fixed. [#56901][#56901]
- `DELETE` statements no longer have a chance of returning an incorrect number of deleted rows in transactions that will eventually need to restart due to contention. [#56458][#56458]
- Fixed a race condition in the `tpcc` workload with the `--scatter` flag where tables could be scattered multiple times or not at all. [#56942][#56942]
- Fixed a bug where reg* types were not parsed properly over pgwire, `COPY` or prepared statements. [#56298][#56298]
- Previously, casts and parsing of strings to types could allow an out-of-bounds value to be successfully used (e.g., `SELECT -232321321312::int2`) but fail with an out-of-bounds message when it is inserted into the table. This is now checked when the value is parsed or being casted to. [#55095][#55095]
- `cockroach debug merge-logs --redact=true --redactable-output=false` now properly removes redaction markers. [#57121][#57121]
- Fixed a bug related to validation of un-upgraded pre-19.2 inbound foreign keys. [#57132][#57132]
- Creating a materialized view that references a column with a NULL value no longer results in an error. [#57139][#57139]
- `ST_GeomFromGeoJSON` now sets the SRID to 4326, matching PostGIS 3.0 / RFC7946 behavior. [#57152][#57152]
- Fixed a bug that caused an "ambiguous column reference" error during foreign key cascading updates. This error was incorrectly produced when the child table's reference column name was equal to the concatenation of the parent's reference column name and "_new", and when the child table had a `CHECK` constraint, computed column, or partial index predicate expression that referenced the column. This bug was introduce in version 20.2. [#57153][#57153]
- Fixed a bug that caused errors or corrupted partial indexes of child tables in foreign key relationships with cascading `UPDATE`s and `DELETE`s. The corrupt partial indexes could result in incorrect query results. Any partial indexes on child tables of foreign key relationships with `ON DELETE CASCADE` or `ON UPDATE CASCADE` actions may be corrupt and should be dropped and re-created. This bug was introduce in version 20.2. [#57100][#57100]
- Second timezone offsets for `TIMETZ` now correctly display over the Postgres wire protocol; these were previously omitted. [#57265][#57265]
- `SELECT FOR UPDATE` now requires both `SELECT` and `UPDATE` privileges, instead of just `UPDATE` privileges. [#57309][#57309]
- Fixed a bug where users of an OSS build of CockroachDB would see "Page Not Found" when loading the DB Console. [#56591][#56591]

### Performance improvements

- The optimizer can now deduce that certain variable arguments to functions must be non-null. This improves cardinality estimation for those variables and unlocks other types of optimizations. As a result, the optimizer may choose better query plans when a function is used as a filter predicate. [#54558][#54558]
- Improved the selectivity estimate for array contains predicates (e.g., `arr @> ARRAY[1]`) in the optimizer. This improves the optimizer's cardinality estimation for queries containing these predicates, and may result in better query plans in some cases. [#54768][#54768]
- Updated the cost model in the optimizer to make index joins more expensive and better reflect the reality of their cost. As a result, the optimizer will choose index joins less frequently, generally resulting in more efficient query plans. [#54768][#54768]
- The optimizer simplifies join expressions to only scan a single table when the join filter is a contradiction. A limitation, now removed, was preventing this simplification from occurring in some cases, leading to more efficient query plans in some cases. [#54813][#54813]
- Improved the efficiency of plans for the execution of left outer spatial joins. [#55216][#55216]
- The optimizer now considers partial indexes when exploring zigzag joins. This may lead to more efficient query plans for queries that (1) operate on tables with partial indexes and (2) have a filter that holds two columns, indexed by two indexes, constant. [#55401][#55401]
- The optimizer now attempts to split a query with a disjunctive filter (OR expression) into a UNION of index scans, where one or both of the scans is an unconstrained partial index scan. As a result, more efficient query plans may be generated for queries with disjunctive filters that operate on tables with partial indexes. [#55915][#55915]
- CSV imports should now be slightly faster. [#55845][#55845]
- Previously, all `CHECK` constraints defined on a table would be tested for every `UPDATE` to the table. Now, a check constraint will not be tested for validity when the values of columns it references are not being updated. The referenced columns are no longer fetchecd in cases where they were only fetched to test `CHECK` constraints. [#56007][#56007]
- Indexes on computed columns can now be utilized when filters reference the computed expression and not the computed column directly. [#55867][#55867]
- The query optimizer can now generate inverted zigzag joins over partial inverted indexes. This may lead to more efficient query plans when filtering by a column that is indexed by a partial inverted index. [#56101][#56101]
- They query optimizer can now plan zigzag joins on two partial indexes with the same predicate, leading to more efficient query plans in some cases. [#56103][#56103]
- The optimizer now converts inner joins with single-row values expressions into projections. This allows decorrelation of subqueries that only reference variables from the outer query, such as `SELECT (SELECT value + 10) FROM table`. [#55961][#55961]
- The optimizer may now plan an inverted join if two tables are joined on `JSONB` or `ARRAY` columns using a contains predicate (e.g., `WHERE a @> b`), and the first column has an inverted index. The inverted join will be chosen if the optimizer expects it to be more efficient than any alternative plan. For queries in which the only alternative is a cartesian product followed by a filter, the inverted join will likely result in a performance improvement. [#55679][#55679]
- The hybrid logical clock used to coordinate distributed operations now performs significantly better under high contention with many concurrent updates from remote nodes. [#56708][#56708]
- The Raft processing goroutine pool's size is now capped at 96. This was observed to prevent instability on large machines (32+ vCPU) in clusters with many ranges (50k+ per node). [#56860][#56860]
- Interactions between Raft heartbeats and the Raft goroutine pool scheduler are now more efficient and avoid excessive mutex contention. This was observed to prevent instability on large machines (32+ vCPU) in clusters with many ranges (50k+ per node). [#56860][#56860]
- The Raft scheduler now prioritizes the node liveness Range. This was observed to prevent instability on large machines (32+ vCPU) in clusters with many ranges (50k+ per node). [#56860][#56860]
- The optimizer now supports using an inverted index on `JSONB` or `ARRAY` columns for a wider variety of filter predicates. Previously, inverted index usage was only supported for simple predicates (e.g., `WHERE a @> '{"foo": "bar"}'`), but now more complicated predicates are supported by combining simple contains (`@>`) expressions with `AND` and `OR` (e.g., `WHERE a @> '{"foo": "bar"}' OR a @> '{"foo": "baz"}'`). An inverted index will be used if it is available on the filtered column and the optimizer expects it to be more efficient than any alternative plan. This may result in performance improvements for queries involving `JSONB` and `ARRAU` columns. [#56732][#56732]

### Doc updates

- Updated several Hello World tutorials to use `cockroach demo` as the backend and an external repository for code samples, including Go with [pgx](../v21.1/build-a-go-app-with-cockroachdb.html), [pq](../v21.1/build-a-go-app-with-cockroachdb-pq.html), and [GORM](../v21.1/build-a-go-app-with-cockroachdb-gorm.html), Java with [JDBC](../v21.1/build-a-java-app-with-cockroachdb.html) and [Hibernate](../v21.1/build-a-java-app-with-cockroachdb-hibernate.html), and Python with [psycopg2](../v21.1/build-a-python-app-with-cockroachdb.html), [SQLAlchemy](../v21.1/build-a-python-app-with-cockroachdb-sqlalchemy.html), and [Django](../v21.1/build-a-python-app-with-cockroachdb-django.html). [#9025](https://github.com/cockroachdb/docs/pull/9025),[#8991](https://github.com/cockroachdb/docs/pull/8991),
- Updated the [Production Checklist](../v21.1/recommended-production-settings.html) to recommend disabling Linux memory swapping to avoid over-allocating memory. [#8979](https://github.com/cockroachdb/docs/pull/8979)

### Contributors

This release includes 1040 merged PRs by 88 authors. We would like to thank the following contributors from the CockroachDB community:

- Adrian Popescu (first-time contributor)
- Alan Acosta (first-time contributor)
- ArjunM98 (first-time contributor)
- Artem Barger
- Azdim Zul Fahmi (first-time contributor)
- David Pacheco (first-time contributor)
- Erik Grinaker
- Gabriel Jaldon (first-time contributor)
- Jake Rote (first-time contributor)
- Joshua M. Clulow (first-time contributor)
- Marcin Knychaa (first-time contributor)
- Max Neverov (first-time contributor)
- Miguel Novelo (first-time contributor)
- Ruixin Bao (first-time contributor)
- TAKAHASHI Yuto (first-time contributor)
- Tayo (first-time contributor)
- Tim Graham (first-time contributor)
- Tom Milligan (first-time contributor)
- Vaibhav
- alex-berger@gmx.ch (first-time contributor)
- alex.berger@nexiot.ch (first-time contributor)
- haseth (first-time contributor)
- hewei03 (first-time contributor)
- neeral
- xinyue (first-time contributor)

[#30624]: https://github.com/cockroachdb/cockroach/pull/30624
[#50869]: https://github.com/cockroachdb/cockroach/pull/50869
[#53390]: https://github.com/cockroachdb/cockroach/pull/53390
[#53485]: https://github.com/cockroachdb/cockroach/pull/53485
[#53547]: https://github.com/cockroachdb/cockroach/pull/53547
[#53926]: https://github.com/cockroachdb/cockroach/pull/53926
[#54017]: https://github.com/cockroachdb/cockroach/pull/54017
[#54026]: https://github.com/cockroachdb/cockroach/pull/54026
[#54044]: https://github.com/cockroachdb/cockroach/pull/54044
[#54064]: https://github.com/cockroachdb/cockroach/pull/54064
[#54140]: https://github.com/cockroachdb/cockroach/pull/54140
[#54143]: https://github.com/cockroachdb/cockroach/pull/54143
[#54163]: https://github.com/cockroachdb/cockroach/pull/54163
[#54215]: https://github.com/cockroachdb/cockroach/pull/54215
[#54230]: https://github.com/cockroachdb/cockroach/pull/54230
[#54268]: https://github.com/cockroachdb/cockroach/pull/54268
[#54317]: https://github.com/cockroachdb/cockroach/pull/54317
[#54322]: https://github.com/cockroachdb/cockroach/pull/54322
[#54329]: https://github.com/cockroachdb/cockroach/pull/54329
[#54349]: https://github.com/cockroachdb/cockroach/pull/54349
[#54350]: https://github.com/cockroachdb/cockroach/pull/54350
[#54352]: https://github.com/cockroachdb/cockroach/pull/54352
[#54355]: https://github.com/cockroachdb/cockroach/pull/54355
[#54376]: https://github.com/cockroachdb/cockroach/pull/54376
[#54446]: https://github.com/cockroachdb/cockroach/pull/54446
[#54518]: https://github.com/cockroachdb/cockroach/pull/54518
[#54558]: https://github.com/cockroachdb/cockroach/pull/54558
[#54594]: https://github.com/cockroachdb/cockroach/pull/54594
[#54610]: https://github.com/cockroachdb/cockroach/pull/54610
[#54618]: https://github.com/cockroachdb/cockroach/pull/54618
[#54628]: https://github.com/cockroachdb/cockroach/pull/54628
[#54668]: https://github.com/cockroachdb/cockroach/pull/54668
[#54673]: https://github.com/cockroachdb/cockroach/pull/54673
[#54741]: https://github.com/cockroachdb/cockroach/pull/54741
[#54749]: https://github.com/cockroachdb/cockroach/pull/54749
[#54768]: https://github.com/cockroachdb/cockroach/pull/54768
[#54796]: https://github.com/cockroachdb/cockroach/pull/54796
[#54811]: https://github.com/cockroachdb/cockroach/pull/54811
[#54813]: https://github.com/cockroachdb/cockroach/pull/54813
[#54843]: https://github.com/cockroachdb/cockroach/pull/54843
[#54851]: https://github.com/cockroachdb/cockroach/pull/54851
[#54853]: https://github.com/cockroachdb/cockroach/pull/54853
[#54855]: https://github.com/cockroachdb/cockroach/pull/54855
[#54870]: https://github.com/cockroachdb/cockroach/pull/54870
[#54880]: https://github.com/cockroachdb/cockroach/pull/54880
[#54890]: https://github.com/cockroachdb/cockroach/pull/54890
[#54896]: https://github.com/cockroachdb/cockroach/pull/54896
[#54943]: https://github.com/cockroachdb/cockroach/pull/54943
[#54951]: https://github.com/cockroachdb/cockroach/pull/54951
[#54960]: https://github.com/cockroachdb/cockroach/pull/54960
[#55050]: https://github.com/cockroachdb/cockroach/pull/55050
[#55063]: https://github.com/cockroachdb/cockroach/pull/55063
[#55071]: https://github.com/cockroachdb/cockroach/pull/55071
[#55076]: https://github.com/cockroachdb/cockroach/pull/55076
[#55095]: https://github.com/cockroachdb/cockroach/pull/55095
[#55120]: https://github.com/cockroachdb/cockroach/pull/55120
[#55129]: https://github.com/cockroachdb/cockroach/pull/55129
[#55135]: https://github.com/cockroachdb/cockroach/pull/55135
[#55139]: https://github.com/cockroachdb/cockroach/pull/55139
[#55143]: https://github.com/cockroachdb/cockroach/pull/55143
[#55147]: https://github.com/cockroachdb/cockroach/pull/55147
[#55148]: https://github.com/cockroachdb/cockroach/pull/55148
[#55157]: https://github.com/cockroachdb/cockroach/pull/55157
[#55172]: https://github.com/cockroachdb/cockroach/pull/55172
[#55186]: https://github.com/cockroachdb/cockroach/pull/55186
[#55216]: https://github.com/cockroachdb/cockroach/pull/55216
[#55222]: https://github.com/cockroachdb/cockroach/pull/55222
[#55240]: https://github.com/cockroachdb/cockroach/pull/55240
[#55248]: https://github.com/cockroachdb/cockroach/pull/55248
[#55263]: https://github.com/cockroachdb/cockroach/pull/55263
[#55269]: https://github.com/cockroachdb/cockroach/pull/55269
[#55272]: https://github.com/cockroachdb/cockroach/pull/55272
[#55300]: https://github.com/cockroachdb/cockroach/pull/55300
[#55304]: https://github.com/cockroachdb/cockroach/pull/55304
[#55312]: https://github.com/cockroachdb/cockroach/pull/55312
[#55373]: https://github.com/cockroachdb/cockroach/pull/55373
[#55386]: https://github.com/cockroachdb/cockroach/pull/55386
[#55401]: https://github.com/cockroachdb/cockroach/pull/55401
[#55416]: https://github.com/cockroachdb/cockroach/pull/55416
[#55417]: https://github.com/cockroachdb/cockroach/pull/55417
[#55428]: https://github.com/cockroachdb/cockroach/pull/55428
[#55429]: https://github.com/cockroachdb/cockroach/pull/55429
[#55459]: https://github.com/cockroachdb/cockroach/pull/55459
[#55464]: https://github.com/cockroachdb/cockroach/pull/55464
[#55470]: https://github.com/cockroachdb/cockroach/pull/55470
[#55509]: https://github.com/cockroachdb/cockroach/pull/55509
[#55513]: https://github.com/cockroachdb/cockroach/pull/55513
[#55515]: https://github.com/cockroachdb/cockroach/pull/55515
[#55517]: https://github.com/cockroachdb/cockroach/pull/55517
[#55524]: https://github.com/cockroachdb/cockroach/pull/55524
[#55532]: https://github.com/cockroachdb/cockroach/pull/55532
[#55543]: https://github.com/cockroachdb/cockroach/pull/55543
[#55565]: https://github.com/cockroachdb/cockroach/pull/55565
[#55567]: https://github.com/cockroachdb/cockroach/pull/55567
[#55570]: https://github.com/cockroachdb/cockroach/pull/55570
[#55607]: https://github.com/cockroachdb/cockroach/pull/55607
[#55611]: https://github.com/cockroachdb/cockroach/pull/55611
[#55612]: https://github.com/cockroachdb/cockroach/pull/55612
[#55626]: https://github.com/cockroachdb/cockroach/pull/55626
[#55638]: https://github.com/cockroachdb/cockroach/pull/55638
[#55641]: https://github.com/cockroachdb/cockroach/pull/55641
[#55644]: https://github.com/cockroachdb/cockroach/pull/55644
[#55647]: https://github.com/cockroachdb/cockroach/pull/55647
[#55660]: https://github.com/cockroachdb/cockroach/pull/55660
[#55679]: https://github.com/cockroachdb/cockroach/pull/55679
[#55699]: https://github.com/cockroachdb/cockroach/pull/55699
[#55700]: https://github.com/cockroachdb/cockroach/pull/55700
[#55705]: https://github.com/cockroachdb/cockroach/pull/55705
[#55707]: https://github.com/cockroachdb/cockroach/pull/55707
[#55720]: https://github.com/cockroachdb/cockroach/pull/55720
[#55721]: https://github.com/cockroachdb/cockroach/pull/55721
[#55751]: https://github.com/cockroachdb/cockroach/pull/55751
[#55759]: https://github.com/cockroachdb/cockroach/pull/55759
[#55760]: https://github.com/cockroachdb/cockroach/pull/55760
[#55783]: https://github.com/cockroachdb/cockroach/pull/55783
[#55785]: https://github.com/cockroachdb/cockroach/pull/55785
[#55808]: https://github.com/cockroachdb/cockroach/pull/55808
[#55812]: https://github.com/cockroachdb/cockroach/pull/55812
[#55827]: https://github.com/cockroachdb/cockroach/pull/55827
[#55831]: https://github.com/cockroachdb/cockroach/pull/55831
[#55845]: https://github.com/cockroachdb/cockroach/pull/55845
[#55866]: https://github.com/cockroachdb/cockroach/pull/55866
[#55867]: https://github.com/cockroachdb/cockroach/pull/55867
[#55891]: https://github.com/cockroachdb/cockroach/pull/55891
[#55894]: https://github.com/cockroachdb/cockroach/pull/55894
[#55907]: https://github.com/cockroachdb/cockroach/pull/55907
[#55915]: https://github.com/cockroachdb/cockroach/pull/55915
[#55916]: https://github.com/cockroachdb/cockroach/pull/55916
[#55934]: https://github.com/cockroachdb/cockroach/pull/55934
[#55945]: https://github.com/cockroachdb/cockroach/pull/55945
[#55958]: https://github.com/cockroachdb/cockroach/pull/55958
[#55961]: https://github.com/cockroachdb/cockroach/pull/55961
[#55969]: https://github.com/cockroachdb/cockroach/pull/55969
[#55970]: https://github.com/cockroachdb/cockroach/pull/55970
[#55982]: https://github.com/cockroachdb/cockroach/pull/55982
[#55983]: https://github.com/cockroachdb/cockroach/pull/55983
[#55993]: https://github.com/cockroachdb/cockroach/pull/55993
[#55994]: https://github.com/cockroachdb/cockroach/pull/55994
[#56007]: https://github.com/cockroachdb/cockroach/pull/56007
[#56025]: https://github.com/cockroachdb/cockroach/pull/56025
[#56080]: https://github.com/cockroachdb/cockroach/pull/56080
[#56101]: https://github.com/cockroachdb/cockroach/pull/56101
[#56103]: https://github.com/cockroachdb/cockroach/pull/56103
[#56135]: https://github.com/cockroachdb/cockroach/pull/56135
[#56144]: https://github.com/cockroachdb/cockroach/pull/56144
[#56183]: https://github.com/cockroachdb/cockroach/pull/56183
[#56198]: https://github.com/cockroachdb/cockroach/pull/56198
[#56213]: https://github.com/cockroachdb/cockroach/pull/56213
[#56283]: https://github.com/cockroachdb/cockroach/pull/56283
[#56296]: https://github.com/cockroachdb/cockroach/pull/56296
[#56298]: https://github.com/cockroachdb/cockroach/pull/56298
[#56344]: https://github.com/cockroachdb/cockroach/pull/56344
[#56352]: https://github.com/cockroachdb/cockroach/pull/56352
[#56363]: https://github.com/cockroachdb/cockroach/pull/56363
[#56373]: https://github.com/cockroachdb/cockroach/pull/56373
[#56388]: https://github.com/cockroachdb/cockroach/pull/56388
[#56392]: https://github.com/cockroachdb/cockroach/pull/56392
[#56455]: https://github.com/cockroachdb/cockroach/pull/56455
[#56458]: https://github.com/cockroachdb/cockroach/pull/56458
[#56459]: https://github.com/cockroachdb/cockroach/pull/56459
[#56461]: https://github.com/cockroachdb/cockroach/pull/56461
[#56470]: https://github.com/cockroachdb/cockroach/pull/56470
[#56477]: https://github.com/cockroachdb/cockroach/pull/56477
[#56524]: https://github.com/cockroachdb/cockroach/pull/56524
[#56533]: https://github.com/cockroachdb/cockroach/pull/56533
[#56546]: https://github.com/cockroachdb/cockroach/pull/56546
[#56574]: https://github.com/cockroachdb/cockroach/pull/56574
[#56585]: https://github.com/cockroachdb/cockroach/pull/56585
[#56587]: https://github.com/cockroachdb/cockroach/pull/56587
[#56589]: https://github.com/cockroachdb/cockroach/pull/56589
[#56591]: https://github.com/cockroachdb/cockroach/pull/56591
[#56598]: https://github.com/cockroachdb/cockroach/pull/56598
[#56627]: https://github.com/cockroachdb/cockroach/pull/56627
[#56628]: https://github.com/cockroachdb/cockroach/pull/56628
[#56631]: https://github.com/cockroachdb/cockroach/pull/56631
[#56634]: https://github.com/cockroachdb/cockroach/pull/56634
[#56653]: https://github.com/cockroachdb/cockroach/pull/56653
[#56672]: https://github.com/cockroachdb/cockroach/pull/56672
[#56679]: https://github.com/cockroachdb/cockroach/pull/56679
[#56681]: https://github.com/cockroachdb/cockroach/pull/56681
[#56708]: https://github.com/cockroachdb/cockroach/pull/56708
[#56732]: https://github.com/cockroachdb/cockroach/pull/56732
[#56737]: https://github.com/cockroachdb/cockroach/pull/56737
[#56762]: https://github.com/cockroachdb/cockroach/pull/56762
[#56773]: https://github.com/cockroachdb/cockroach/pull/56773
[#56822]: https://github.com/cockroachdb/cockroach/pull/56822
[#56827]: https://github.com/cockroachdb/cockroach/pull/56827
[#56829]: https://github.com/cockroachdb/cockroach/pull/56829
[#56837]: https://github.com/cockroachdb/cockroach/pull/56837
[#56855]: https://github.com/cockroachdb/cockroach/pull/56855
[#56858]: https://github.com/cockroachdb/cockroach/pull/56858
[#56860]: https://github.com/cockroachdb/cockroach/pull/56860
[#56869]: https://github.com/cockroachdb/cockroach/pull/56869
[#56872]: https://github.com/cockroachdb/cockroach/pull/56872
[#56874]: https://github.com/cockroachdb/cockroach/pull/56874
[#56880]: https://github.com/cockroachdb/cockroach/pull/56880
[#56881]: https://github.com/cockroachdb/cockroach/pull/56881
[#56883]: https://github.com/cockroachdb/cockroach/pull/56883
[#56898]: https://github.com/cockroachdb/cockroach/pull/56898
[#56901]: https://github.com/cockroachdb/cockroach/pull/56901
[#56942]: https://github.com/cockroachdb/cockroach/pull/56942
[#56943]: https://github.com/cockroachdb/cockroach/pull/56943
[#56953]: https://github.com/cockroachdb/cockroach/pull/56953
[#56964]: https://github.com/cockroachdb/cockroach/pull/56964
[#56974]: https://github.com/cockroachdb/cockroach/pull/56974
[#56975]: https://github.com/cockroachdb/cockroach/pull/56975
[#57003]: https://github.com/cockroachdb/cockroach/pull/57003
[#57004]: https://github.com/cockroachdb/cockroach/pull/57004
[#57006]: https://github.com/cockroachdb/cockroach/pull/57006
[#57007]: https://github.com/cockroachdb/cockroach/pull/57007
[#57038]: https://github.com/cockroachdb/cockroach/pull/57038
[#57040]: https://github.com/cockroachdb/cockroach/pull/57040
[#57050]: https://github.com/cockroachdb/cockroach/pull/57050
[#57076]: https://github.com/cockroachdb/cockroach/pull/57076
[#57100]: https://github.com/cockroachdb/cockroach/pull/57100
[#57106]: https://github.com/cockroachdb/cockroach/pull/57106
[#57121]: https://github.com/cockroachdb/cockroach/pull/57121
[#57132]: https://github.com/cockroachdb/cockroach/pull/57132
[#57139]: https://github.com/cockroachdb/cockroach/pull/57139
[#57142]: https://github.com/cockroachdb/cockroach/pull/57142
[#57143]: https://github.com/cockroachdb/cockroach/pull/57143
[#57152]: https://github.com/cockroachdb/cockroach/pull/57152
[#57153]: https://github.com/cockroachdb/cockroach/pull/57153
[#57179]: https://github.com/cockroachdb/cockroach/pull/57179
[#57180]: https://github.com/cockroachdb/cockroach/pull/57180
[#57197]: https://github.com/cockroachdb/cockroach/pull/57197
[#57212]: https://github.com/cockroachdb/cockroach/pull/57212
[#57241]: https://github.com/cockroachdb/cockroach/pull/57241
[#57256]: https://github.com/cockroachdb/cockroach/pull/57256
[#57265]: https://github.com/cockroachdb/cockroach/pull/57265
[#57278]: https://github.com/cockroachdb/cockroach/pull/57278
[#57284]: https://github.com/cockroachdb/cockroach/pull/57284
[#57309]: https://github.com/cockroachdb/cockroach/pull/57309
[#57316]: https://github.com/cockroachdb/cockroach/pull/57316
[#57320]: https://github.com/cockroachdb/cockroach/pull/57320
[#57355]: https://github.com/cockroachdb/cockroach/pull/57355
