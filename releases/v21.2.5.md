---
title: What&#39;s New in v21.2.5
toc: true
summary: Additions and changes in CockroachDB version v21.2.5 since version v21.2.4
docs_area: releases
---

## February 7, 2022

- For a comprehensive summary of features in v21.2, see the [v21.2 GA release notes](v21.2.0.html).
- To upgrade to v21.2, see [Upgrade to CockroachDB v21.2](../v21.2/upgrade-cockroach-version.html).

Get future release notes emailed to you:

{% include_cached marketo.html %}


### Downloads

<div id="os-tabs" class="filters clearfix">
    <a href="https://binaries.cockroachdb.com/cockroach-v21.2.5.linux-amd64.tgz"><button id="linux" class="filter-button" data-scope="linux" data-eventcategory="linux-binary-release-notes">Linux</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.2.5.darwin-10.9-amd64.tgz"><button id="mac" class="filter-button" data-scope="mac" data-eventcategory="mac-binary-release-notes">Mac</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.2.5.windows-6.2-amd64.zip"><button id="windows" class="filter-button" data-scope="windows" data-eventcategory="windows-binary-release-notes">Windows</button></a>
    <a href="https://binaries.cockroachdb.com/cockroach-v21.2.5.src.tgz"><button id="source" class="filter-button" data-scope="source" data-eventcategory="source-release-notes">Source</button></a>
</div>

<section class="filter-content" data-scope="windows">
{% include_cached windows_warning.md %}
</section>

### Docker image

{% include_cached copy-clipboard.html %}
~~~shell
$ docker pull cockroachdb/cockroach:v21.2.5
~~~

### Enterprise edition changes

- Redacted more potentially-sensitive URI elements from [changefeed](../v21.2/change-data-capture-overview.html) job descriptions. This is a breaking change for workflows involving copying URIs. As an alternative, the unredacted URI may be accessed from the [jobs](../v21.2/show-jobs.html) table directly. [#75187][#75187]

### SQL language changes

- New [role](../v21.2/authorization.html#roles) `VIEWACTIVITYREDACTED` that works similar as `VIEWACTIVITY` but restricts the usage of the [statements diagnostics bundle](../v21.2/ui-statements-page.html#diagnostics). It is possible for a user to have both roles (`VIEWACTIVITY` and `VIEWACTIVITYREDACTED`), but the role `VIEWACTIVITYREDACTED` takes precedent on restrictions. [#74862][#74862]
- New role `NOSQLLOGIN` (and its inverse `SQLLOGIN`), which restricts [SQL CLI login](../v21.2/cockroach-sql.html#prerequisites) ability for a user while retaining their ability to log in to the [DB Console](../v21.2/ui-overview.html) (as opposed to `NOLOGIN` which restricts both SQL and DB Console). Without any role options all login behavior remains permitted as it does today. OIDC logins to the DB Console continue to be permitted with `NOSQLLOGIN` set. [#75185][#75185]
- Added support for [SQL arrays](../v21.2/array.html) containing [JSON](../v21.2/jsonb.html) for in-memory processing. This does not add support for storing SQL arrays of JSON in tables. [#75529][#75529]
- The default [SQL stats](../v21.2/cost-based-optimizer.html#table-statistics) flush interval is now 10 minutes. [#75524][#75524]

### Operational changes

- The meaning of `sql.distsql.max_running_flows` [cluster setting](../v21.2/cluster-settings.html) has been extended so that when the value is negative, it would be multiplied by the number of CPUs on the node to get the maximum number of concurrent remote flows on the node. The default value is -128, meaning that on a 4 CPU machine we will have up to 512 concurrent remote [DistSQL](../v21.2/explain-analyze.html#distsql-option) flows, but on a 8 CPU machine up to 1024. The previous default was 500. [#75509][#75509]

### Command-line changes

- Not finding the right certs in the [certs dir](../v21.2/cockroach-cert.html#certificate-directory) or not [specifying a certs dir](../v21.2/cockroach-start.html#security) or certificate path now falls back on checking server CA using Go's TLS code to find the certificates in the OS trust store. If no matching certificate is found, an x509 error will occur announcing that the certificate is signed by an unknown authority. [#74544][#74544]
- Fixed the CLI help text for [`ALTER DATABASE`](../v21.2/alter-database.html) to show correct options for [`ADD REGION`](../v21.2/add-region.html) and [`DROP REGION`](../v21.2/drop-region.html), and include some missing options such as [`CONFIGURE ZONE`](../v21.2/configure-zone.html). [#75067][#75067]

### DB Console changes

- The **clear SQL stats** links on the [Statements](../v21.2/ui-statements-page.html) and [Transactions](../v21.2/ui-transactions-page.html) pages were relabeled **reset SQL stats**, for consistency with the language in the [SQL shell](../v21.2/cockroach-sql.html). [#74417][#74417]
- The [Terminate Session and Terminate Statement buttons](../v21.2/ui-sessions-page.html#session-details) are available to be enabled in the DB Console. [#74530][#74530]
- In the [Statement Details](../v21.2/ui-statements-page.html#statement-details-page) page, replaced raw statement with statement ID in the page URL. [#75463][#75463]
- Removed `$ internal` as one of the [app filter options](../v21.2/ui-statements-page.html#filter) under the Statements and Transactions page filters. [#75485][#75485]
- Changed the order of tabs under [SQL Activity](../v21.2/ui-overview.html#sql-activity) page to be Statements, Transactions, and Sessions. [#75503][#75503]
- If the user has the role `VIEWACTIVITYREDACTED`, the [statement diagnostics bundle](../v21.2/ui-statements-page.html#diagnostics) info on [Statements page (Diagnostics column)](../v21.2/ui-statements-page.html#statements-table), [Statement Details page (diagnostics tab)](../v21.2/ui-statements-page.html#diagnostics)  and [Advanced Debug page (diagnostics history)](../v21.2/ui-debug-pages.html#reports) is hidden. [#75521][#75521]
- In the Statements and Transactions pages, loading and error pages no longer obscure the page filter controls. [#75527][#75527]

### Bug fixes

- Fixed a panic when attempting to access the hottest ranges (e.g. via the `/_status/hotranges` [endpoint](../v21.2/cluster-api.html)) before initial statistics had been gathered. [#74515][#74515]
- A doubly nested [enum](../v21.2/enum.html) in a [DistSQL](../v21.2/explain-analyze.html#distsql-option) query would not get hydrated on remote nodes resulting in panic.  Release justification: Fix node crashing panic [#74490][#74490]
- Servers no longer crash due to panics in HTTP handlers. [#74539][#74539]
- When [foreign keys](../v21.2/foreign-key.html) were included inside an [`ADD COLUMN`](../v21.2/add-column.html) statement and multiple columns were added in a single statement then the first added column would have the foreign key applied (or an error generated based on the wrong column). [#74528][#74528]
- Setting `sslmode=require` in a [connection string](../v21.2/connection-parameters.html#additional-connection-parameters) would check for local certificates, so omitting a certs path would cause an error even though "require" does not verify server certificates. This has been fixed by bypassing certificate path checking for `sslmode=require`. This bug has been present since 21.2.0. [#74544][#74544]
- Uninitialized [replicas](../v21.2/architecture/overview.html#glossary) that are abandoned after an unsuccessful snapshot no longer perform periodic background work, so they no longer have a non-negligible cost. [#74185][#74185]
- Fixed a bug where a [backed up](../v21.2/take-full-and-incremental-backups.html) `defaultdb` that is configured to be MR, is not restored as a [multi-region](../v21.2/multiregion-overview.html) database on cluster restore.  Release justification: bug fix. [#74607][#74607]
- Fixed a bug where deleting data via [schema changes](../v21.2/online-schema-changes.html) (e.g. when dropping an index or table) could fail with a "command too large" error. [#74798][#74798]
- Previously, CockroachDB could return incorrect results or internal errors on queries with [window functions](../v21.2/window-functions.html) returning `INT`, `FLOAT`, `BYTES`, `STRING`, `UUID`, or `JSON` [type](../v21.2/data-types.html) when the disk spilling occurred. The bug was introduced in 21.2.0 and is now fixed. [#74589][#74589]
- CockroachDB could previously incorrectly calculate `MIN`/`MAX` when used as [window functions](../v21.2/window-functions.html) in some cases after spilling to disk. The bug was introduced in 21.2.0 and is now fixed. [#74589][#74589]
- Fixed panics possible in some distributed queries using [enums](../v21.2/enum.html) in [join](../v21.2/joins.html) predicates. [#74733][#74733]
- Previously, CockroachDB could encounter an internal error when performing [`UPSERT`](../v21.2/upsert.html) or [`INSERT ... ON CONFLICT`](../v21.2/insert.html#on-conflict-clause) queries in some cases when the new rows contained `NULL` values (either `NULL`s explicitly specified or `NULL`s  used since some columns were omitted). [#74872][#74872]
- A bug has been fixed that caused internal errors when altering the [primary key](../v21.2/primary-key.html) of a table. The bug was only present if the table had a [partial index](../v21.2/partial-indexes.html) with a predicate that referenced a [virtual computed column](../v21.2/computed-columns.html). This bug was present since virtual computed columns were added in version 21.1.0. [#75183][#75183]
- A bug has been fixed which caused errors in rare cases when trying to divide [`INTERVAL`](../v21.2/interval.html) values by `INT4` or `INT2` [values](../v21.2/int.html). [#75079][#75079]
- Fixed a bug that could occur when a [`TIMETZ`](../v21.2/time.html) column was indexed, and a query predicate constrained that column using a < or > operator with a `TIMETZ` constant. If the column contained values with time zones that did not match the time zone of the `TIMETZ` constant, it was possible that not all matching values could be returned by the query. Specifically, the results may not have included values within one microsecond of the predicate's absolute time. This bug was introduced when the `TIMETZ` datatype was first added in 20.1. It exists on all versions of 20.1, 20.2, 21.1, and 21.2 prior to this patch. [#75172][#75172]
- Fixed an internal error, "estimated row count must be non-zero", that could occur during planning for queries over a table with a `TIMETZ` column. This error was due to a faulty assumption in the [statistics](../v21.2/cost-based-optimizer.html#table-statistics) estimation code about ordering of `TIMETZ` values, which has now been fixed. The error could occur when `TIMETZ` values used in the query had a different time zone offset than the `TIMETZ` values stored in the table. [#75172][#75172]
- [`RESTORE`](../v21.2/restore.html) now inserts a `system.namespace` entry for synthetic [public schemas](../v21.2/show-schemas.html). [#74759][#74759]
- A bug has been fixed that caused internal errors in queries with set operations, like [`UNION`](../v21.2/selection-queries.html#union-combine-two-queries), when corresponding columns on either side of the set operation were not the same. This error only occurred with a limited set of types. This bug is present in versions 20.2.6+, 21.1.0+, and 21.2.0+. [#75276][#75276]
- Fixed [SQL Activity](../v21.2/ui-overview.html#sql-activity) pages crashing when a column was sorted by the 3rd time. [#75486][#75486]
- Updated the `String()` function of `roleOption` to add a space on the role [`VALID UNTIL`](../v21.2/create-role.html#role-options). [#75494][#75494]
- In particular cases, some queries that involve [a scan that returns many results](../v21.2/performance-best-practices-overview.html#table-scan-best-practices) and which includes lookups for individual keys were not returning all results from the table. [#75512][#75512]

### Performance improvements

- Allow [rangefeed](../v21.2/use-changefeeds.html#enable-rangefeeds) streams to use separate HTTP connection when `kv.rangefeed.use_dedicated_connection_class.enabled` [cluster setting](../v21.2/cluster-settings.html) is turned on.  Using separate connection class reduces the possibility of out of memory errors when running rangefeeds against very large tables.  The connection window size for rangefeed can be adjusted via `COCKROACH_RANGEFEED_INITIAL_WINDOW_SIZE` [environment variable](../v21.2/cockroach-commands.html#environment-variables), whose default is 128KB. [#74456][#74456]
- Incremental [`BACKUP`](../v21.2/backup.html)s now use less memory to verify coverage of prior backups. [#74588][#74588]
- The merging of incremental backup layers during [`RESTORE`](../v21.2/restore.html) now uses a simpler and less memory intensive algorithm. [#74593][#74593]

### Contributors

This release includes 64 merged PRs by 30 authors.

[#74185]: https://github.com/cockroachdb/cockroach/pull/74185
[#74417]: https://github.com/cockroachdb/cockroach/pull/74417
[#74456]: https://github.com/cockroachdb/cockroach/pull/74456
[#74490]: https://github.com/cockroachdb/cockroach/pull/74490
[#74515]: https://github.com/cockroachdb/cockroach/pull/74515
[#74528]: https://github.com/cockroachdb/cockroach/pull/74528
[#74530]: https://github.com/cockroachdb/cockroach/pull/74530
[#74539]: https://github.com/cockroachdb/cockroach/pull/74539
[#74544]: https://github.com/cockroachdb/cockroach/pull/74544
[#74588]: https://github.com/cockroachdb/cockroach/pull/74588
[#74589]: https://github.com/cockroachdb/cockroach/pull/74589
[#74593]: https://github.com/cockroachdb/cockroach/pull/74593
[#74607]: https://github.com/cockroachdb/cockroach/pull/74607
[#74677]: https://github.com/cockroachdb/cockroach/pull/74677
[#74733]: https://github.com/cockroachdb/cockroach/pull/74733
[#74759]: https://github.com/cockroachdb/cockroach/pull/74759
[#74798]: https://github.com/cockroachdb/cockroach/pull/74798
[#74862]: https://github.com/cockroachdb/cockroach/pull/74862
[#74872]: https://github.com/cockroachdb/cockroach/pull/74872
[#75067]: https://github.com/cockroachdb/cockroach/pull/75067
[#75079]: https://github.com/cockroachdb/cockroach/pull/75079
[#75164]: https://github.com/cockroachdb/cockroach/pull/75164
[#75172]: https://github.com/cockroachdb/cockroach/pull/75172
[#75183]: https://github.com/cockroachdb/cockroach/pull/75183
[#75185]: https://github.com/cockroachdb/cockroach/pull/75185
[#75187]: https://github.com/cockroachdb/cockroach/pull/75187
[#75276]: https://github.com/cockroachdb/cockroach/pull/75276
[#75463]: https://github.com/cockroachdb/cockroach/pull/75463
[#75485]: https://github.com/cockroachdb/cockroach/pull/75485
[#75486]: https://github.com/cockroachdb/cockroach/pull/75486
[#75494]: https://github.com/cockroachdb/cockroach/pull/75494
[#75503]: https://github.com/cockroachdb/cockroach/pull/75503
[#75509]: https://github.com/cockroachdb/cockroach/pull/75509
[#75512]: https://github.com/cockroachdb/cockroach/pull/75512
[#75521]: https://github.com/cockroachdb/cockroach/pull/75521
[#75524]: https://github.com/cockroachdb/cockroach/pull/75524
[#75527]: https://github.com/cockroachdb/cockroach/pull/75527
[#75529]: https://github.com/cockroachdb/cockroach/pull/75529
