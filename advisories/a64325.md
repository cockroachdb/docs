---
title: Technical Advisory 64325
summary: Race condition between long running reads and replica removal
toc: true
---

Publication date: May 3, 2021

## Description

Cockroach Labs has discovered a race condition, where a long running read request submitted during replica removal may be evaluated on the removed replica, returning an empty result. Common causes of replica removal are range merges and replica rebalancing in the cluster. When a replica is removed there is a small window, where the data is already deleted but a read request will still see it as a valid replica. In this case a read request will always return an empty result for the part of the query that relied on this range.

This is a very rare scenario that can only be encountered under the following conditions:
 - A long running read request, longer than 5 seconds.
 - The node processing the request experiences a liveness heartbeat failure, which is typically a sign of an overloaded node. This failure will cause the node to loose the lease on the range processing the read request.
 - Another node picks up the lease, and decides to perform a merge operation on the range in question.
 - The replica is marked for removal and data cleared.  
 - The read request fails to see this operation returning an empty result.

This issue affects CockroachDB [versions](/docs/releases/) 19.2 and later.

## Statement
This is resolved in CockroachDB by PR [#64324] and [#64471], which fix the race condition between read requests and replica removal.

The fix has been applied to maintenance releases of CockroachDB v20.1, v20.2, and v21.1.

This public issue is tracked by [#64325] and [#46329]

## Mitigation

Users of CockroachDB v19.2, v20.1, or v20.2 are invited to upgrade to v20.1.16, v20.2.9, or a later version.

This issue may impact the backups of CockroachDB. You can take the following steps to validate backups to make sure they are correct and complete. TODO: @mattsherman.

## Impact

This issue may impact all read operations, while the window of opportunity to see is very limited it may have happened to without your knowledge. Read operations include backup, incremental backup, so if your cluster has experienced overloaded conditions we encourage you to verify your backups using the instructions provided above.
