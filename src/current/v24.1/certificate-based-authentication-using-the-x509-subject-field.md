---
title: Certificate-based authentication using multiple values from the X.509 Subject field
summary: Learn about how to authenticate users using additional features already present in your X.509 security certificates
toc: true
docs_area: manage
keywords: authentication, ldap, X.509, X509, tls
---

{% include_cached new-in.html version="v24.1" %} For customers that need to use their established Certificate Authority (CA) infrastructure to manage SQL user authentication, CockroachDB supports mapping of SQL user [roles]({% link {{ page.version.version }}/security-reference/authorization.md %}#roles) to values in the Subject field of the [X.509 certificate](https://en.wikipedia.org/wiki/X.509) used for TLS authentication.

This mapping can be used to automate the synchronization of SQL user roles with specific certificate attributes, leading to improved scalability of access control mechanisms.

For instructions showing how to map SQL user roles to values in the Subject field of the X.509 certificate, see the [Example](#example).

{% include enterprise-feature.md %}

## Prerequisites

- You run your own [Certificate Authority (CA)]({% link {{ page.version.version }}/security-reference/transport-layer-security.md %}#certificates-signing-trust-and-authority) infrastructure.
- You need to use your existing CA infrastructure to manage [SQL user authentication]({% link {{ page.version.version }}/create-user.md %}#user-authentication).
- You need to automate the synchronization of certificates generated by your CA infra with [SQL user roles]({% link {{ page.version.version }}/security-reference/authorization.md %}#roles).

## Alternatives

Prior to CockroachDB v24.1, the only way to use certificates generated by CAs that placed restrictions on the contents of the `commonName` field was to use [the `--cert-principal-map` flag]({% link {{ page.version.version }}/cockroach-start.md %}#flags-cert-principal-map), which was [first added in v20.1]({% link releases/v20.1.md %}#v20-1-0-beta-3-changes-to-operational-workflows). The instructions on this page provide an easier way to manage mapping SQL users to certificates than `--cert-principal-map`. That approach still works, but is superseded by the functionality described on this page.

The [default workflow using `cockroach cert`]({% link {{ page.version.version }}/cockroach-cert.md %}#examples) doesn't apply to this use case; it has the limitation that it only matches the CN (common name) in the certificate.

## Example

This example shows how to set up a mapping between the Subject field of an [X.509 certificate](https://en.wikipedia.org/wiki/X.509) and a SQL [user or role]({% link {{page.version.version}}/security-reference/authorization.md %}#roles).

### Step 1. Create certificates using your infrastructure

These instructions assume that you have already created certificates using your own infrastructure for the following users:

- The [`root` user]({% link {{ page.version.version }}/security-reference/authorization.md %}#root-user).
- The [`node` user]({% link {{ page.version.version }}/security-reference/authorization.md %}#node-user).
- Any [SQL user]({% link {{ page.version.version }}/security-reference/authorization.md %}#sql-users) who needs to authenticate with your cluster. In this example, we will call the user `maxroach`.

### Step 2. Start your cluster with root and node certificate flags

At cluster startup, you'll need to pass the [`cockroach start`]({% link {{ page.version.version }}/cockroach-start.md %}) flags [`--node-cert-distinguished-name`]({% link {{ page.version.version }}/cockroach-start.md %}#flags-node-cert-distinguished-name) and [`--root-cert-distinguished-name`]({% link {{ page.version.version }}/cockroach-start.md %}#flags-root-cert-distinguished-name).

The argument to each flag is a string with a comma separated list of distinguished name (DN) mappings in `{attribute-type}={attribute-value}` format in accordance with [RFC4514](https://www.rfc-editor.org/rfc/rfc4514). When each of these flags are set, the argument needs to be an exact match with the DN subject in the client certificate provided.

{% include_cached copy-clipboard.html %}
~~~ shell
cockroach start --certs-dir=/path/to/certs --node-cert-distinguished-name="O=Cockroach,CN=node" --root-cert-distinguished-name="O=Cockroach,CN=root" # other startup flags, etc.
~~~

The DN mappings in the certificates you create should match what you pass in at cluster start time. One way to create a certificate matching the `node` user in the example above is:

{% include_cached copy-clipboard.html %}
~~~ shell
openssl req -new -key /path/to/certs/client.node.key -out client.node.csr -batch -subj /O=Cockroach/CN=node
~~~

The same command can be used to generate a certificate for the `root` user.

### Step 3. Enable the cluster setting to require the Subject field in certificates

Once the cluster is started, enable the following [cluster setting]({% link {{ page.version.version }}/cluster-settings.md %}#setting-security-client-cert-subject-required-enabled):

{% include_cached copy-clipboard.html %}
~~~ sql
SET CLUSTER SETTING security.client_cert.subject_required.enabled = true;
~~~

When the setting is enabled, CockroachDB will verify the following during user authentication: 

- For the `root` user, that the distinguished name in the certificate Subject matches the distinguished name fields passed in via `cockroach start --root-cert-distinguished-name`.
- For the `node` user, that the distinguished name in the certificate Subject matches the distinguished name fields passed in via `cockroach start --node-cert-distinguished-name`.
- For all other SQL users, that the values in the Subject field of the [X.509 certificate](https://en.wikipedia.org/wiki/X.509) match the values attached to the user or role with `CREATE ROLE ... SUBJECT` or `ALTER ROLE ... SUBJECT`.

### Step 4. Set the `SUBJECT` role option using `CREATE ROLE` or `ALTER ROLE` to match your certificates

{% include {{page.version.version}}/sql/role-subject-option.md %}

{% include_cached copy-clipboard.html %}
~~~ sql
CREATE ROLE maxroach WITH SUBJECT 'CN=myName,OU=myOrgUnit,O=myOrg,L=myLocality,ST=myState,C=myCountry' LOGIN;
~~~

Alternatively, you can update existing users with [`ALTER ROLE ... SUBJECT`]({% link {{ page.version.version }}/alter-role.md %}#set-the-subject-role-option-for-certificate-based-authentication).

{% include_cached copy-clipboard.html %}
~~~ sql
ALTER ROLE maxroach WITH SUBJECT 'CN=myName2,OU=myOrgUnit2,O=myOrg2,L=myLocality2,ST=myState2,C=myCountry2' LOGIN;
~~~

Note that `ALTER ROLE ... SUBJECT` cannot be applied to the `root` user. You must use `cockroach start --root-cert-distinguished-name` instead.

~~~
ERROR: role "root" cannot have a SUBJECT%!(EXTRA string=use the --%s CLI flag to configure root, string=root-cert-distinguished-name)
SQLSTATE: 22023
~~~

If you do not have an enterprise license, the following error is signalled:

{% include_cached copy-clipboard.html %}
~~~
ERROR: use of SUBJECT role option requires an enterprise license. see https://cockroachlabs.com/pricing for details on how to enable enterprise features
SQLSTATE: XXC02
~~~

## See also

- [`ALTER ROLE ... SUBJECT`]({% link {{ page.version.version }}/alter-role.md %}#set-the-subject-role-option-for-certificate-based-authentication)
- [`CREATE ROLE ... SUBJECT`]({% link {{ page.version.version }}/create-role.md %}#set-the-subject-role-option-for-certificate-based-authentication)
- [Authenticate to CockroachDB Self-Hosted Clusters]({% link {{ page.version.version }}/authentication.md %})
- [GSSAPI Authentication]({% link {{ page.version.version }}/gssapi_authentication.md %})
- [SQL Authentication]({% link {{ page.version.version }}/security-reference/authentication.md %})
- [Cloud Storage Authentication]({% link {{ page.version.version }}/cloud-storage-authentication.md %})
- [Cluster Settings]({% link {{ page.version.version }}/cluster-settings.md %})
- [`cockroach start`]({% link {{ page.version.version }}/cockroach-start.md %})
- [`cockroach cert`]({% link {{ page.version.version }}/cockroach-cert.md %})
- [`cockroach auth-session`]({% link {{ page.version.version }}/cockroach-auth-session.md %})
