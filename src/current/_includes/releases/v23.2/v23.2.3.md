## v23.2.3

Release Date: March 19, 2024

{% include releases/release-downloads-docker-image.md release=include.release %}

<h3 id="v23-2-3-security-updates">Security updates</h3>

- DB Console `session` cookie is now marked `HttpOnly` to prevent it from being read by any Javascript code. [#119399][#119399]
- DB Console cookies are marked `Secure` for the browser when the cluster is running in secure mode. [#119399][#119399]
- DB Console `session` cookie is now marked `HttpOnly` to prevent it from being read by any Javascript code. [#119259][#119259]
- DB Console cookies are marked `Secure` for the browser when the cluster is running in secure mode. [#119259][#119259]

<h3 id="v23-2-3-{{-site.data.products.enterprise-}}-edition-changes">{{ site.data.products.enterprise }} edition changes</h3>

- Fixed a bug where creating a changefeed that targeted tables with a `DECIMAL(n)` column (i.e. zero-scale `DECIMAL` column), `format='avro'`, and `diff` would cause a panic. [#118847][#118847]
- Fixed a bug where creating a changefeed that targeted tables with a `DECIMAL(n)` column (i.e. zero-scale `DECIMAL` column), `format='avro'`, and `diff` would cause a panic. [#119399][#119399]

<h3 id="v23-2-3-sql-language-changes">SQL language changes</h3>

- Make the cluster setting `sql.index_recommendation.drop_unused_duration` public for docs. [#118764][#118764]
- Added the server.max_open_transactions_per_gateway cluster setting. When set to a non-negative value, then non-admin users cannot execute a query if the number of transactions open on the current gateway node is already at the configured limit. [#118933][#118933]
- Out-of-process SQL servers will start exporting a new sql.aggregated_livebytes metric. This metric gets updated once every 60 seconds by default, and its update interval can be configured via the `tenant_global_metrics_exporter_interval` cluster setting. [#119371][#119371]
- New field `SkippedTransactions` in the SampledTransaction event, which is emitted to the TELEMETRY logging channel when telemetry logging is enabled and set to "transaction" mode. [#118432][#118432]
- Added support for index hints with INSERT and UPSERT statements. This allows INSERT ... ON CONFLICT and UPSERT queries to use index hints in the same way they are already supported for UPDATE and DELETE statements. [#119601][#119601]

<h3 id="v23-2-3-operational-changes">Operational changes</h3>

- Expanded --include-range-info flag to additionally include problem ranges. This is still defaulted to true.  Release justification: low risk cli change to debug zip flag [#119234][#119234]
- New cluster settings:  - sql.telemetry.transaction_sampling.statement_events_per_transaction.max: controls the maximum number of statement events to emit per sampled transaction for TELEMETRY - sql.telemetry.transaction_sampling.frequency: controls the maximum frequency at which we sample transactions for telemetry [#118432][#118432]
- Transactions sampled for the telemetry logging channel will now emit a SampledTransaction event. To sample transactions, set the cluster setting `sql.telemetry.query_sampling.mode = 'transaction'` and enable telemetry logging via `sql.telemetry.query_sampling.enabled = true`. [#118432][#118432]
- In (unredacted) debug zips, the crdb_internal.transaction_contention_events table file has 2 new columns: - waiting_stmt_query: query of the waiting stmt - blocking_txn_queries_unordered: unordered list of the blocking txn's queries [#118831][#118831]

<h3 id="v23-2-3-command-line-changes">Command-line changes</h3>

- Change the SQL shell help URL to point to cockroach-sql.html. [#118994][#118994]
- Cockroach debug tsdump creates tsdump.yaml  1. tsdump raw format automatically creates yaml file in default location `/tmp/tsdump.yaml`  2. new flag: `--yaml`. Allows users to specify path to create `tsdump.yaml` instead of default location  Usage:  cockroach debug tsdump --host <host>:<port> \ --format raw --yaml=/some_path/tsdump.yaml > /some_path/tsdump.gob  Authored by: Daniel Almeida  Epic: none [#117741][#117741]

<h3 id="v23-2-3-db-console-changes">DB Console changes</h3>

- Properly remove warning of old date on Active Executions when auto refresh is enabled. [#118703][#118703]
- On Statement Details page always show the entire selected period, instead of just the period that had data. [#118805][#118805]
- The Overload Dashboard page now includes two additional graphs: - Elastic CPU Utilization - This is used the show the CPU utilization by   elastic work, compared to the limit set for elastic work. - Elastic CPU Exhausted Duration Per Second - This is used to show the   duration of CPU exhaustion by elastic work, in microseconds. [#118896][#118896]
- The `Full Table/Index Scans` chart in the sql metrics dashboard now shows the non-negative derivative of the number of full scans tracked. [#118860][#118860]

<h3 id="v23-2-3-bug-fixes">Bug fixes</h3>

- Fixed a bug where a changefeed could omit events in rare cases, logging the error "cdc ux violation: detected timestamp ... that is less or equal to the local frontier". This can happen if a rangefeed runs on a follower replica that lags significantly behind the leaseholder, a transaction commits and removes its transaction record before its intent resolution is applied on the follower, the follower's closed timestamp has advanced past the transaction commit timestamp, and the rangefeed attempts to push the transaction to a new timestamp (at least 10 seconds after the transaction began). This may cause the rangefeed to prematurely emit a checkpoint before emitting writes at lower timestamps, which in turn may cause the changefeed to drop these events entirely, never emitting them. [#118413][#118413]
- Decommissioning replicas which are part of a mis-replicated range will no longer get stuck on a rebalance operation that was falsely determined to be unsafe. This bug was introduced in 23.1.0. [#118343][#118343]
- Cockroach will no longer spam the logs with "unable to get CPU capacity" errors every 10 seconds when running outside of a CPU cgroup. [#118672][#118672]
- AUTO CREATE STATS jobs could previously lead to growth in an internal system table resulting in slower job-system related queries. [#118942][#118942]
- Fixed a bug which caused an inscrutable error when a sequence name allocated by `SERIAL` conflicted with an existing type name. [#118947][#118947]
- This commit fixes an internal error with message like: "LeafTxn ... incompatible with locking request" that occurs when performing an update under read committed isolation which cascades to a table with multiple other foreign keys. [#118931][#118931]
- ALTER PRIMARY KEY could fail with a "non-nullable column <x> with no value! Index scanned .." when validating recreated secondary indexes. [#118974][#118974]
- Fixed a bug where COMMENT statements could fail with an "unexpected value" error if multiple COMMENT statements were running concurrently. [#119020][#119020]
- Previously, CockroachDB could encounter an internal error "attempting to append refresh spans after the tracked timestamp has moved forward" in some cases when using virtual tables (like `crdb_internal.system_jobs`, etc), and this has now been fixed. The bug was introduced in 23.1 version. [#119184][#119184]
- Fixed a bug where a changefeed could omit events in rare cases, logging the error "cdc ux violation: detected timestamp ... that is less or equal to the local frontier". This can happen if a rangefeed runs on a follower replica that lags significantly behind the leaseholder, a transaction commits and removes its transaction record before its intent resolution is applied on the follower, the follower's closed timestamp has advanced past the transaction commit timestamp, and the rangefeed attempts to push the transaction to a new timestamp (at least 10 seconds after the transaction began). This may cause the rangefeed to prematurely emit a checkpoint before emitting writes at lower timestamps, which in turn may cause the changefeed to drop these events entirely, never emitting them. [#119399][#119399]
- Crdb_internal.leases could cause a node to become unavailable due to a deadlock in the leasing subsystem. [#119341][#119341]
- Fixed a bug where rangefeed resolved timestamps could get stuck, continually emitting the log message "pushing old intents failed: range barrier failed, range split", typically following a range merge. This bug was introduced in v23.2.1. [#119541][#119541]
- Fixed a rare panic that could happen during a pg_dump import that contains a function like `SELECT addgeometrycolumn(...)`. Now, attempting to import a pg_dump with a function that has a subquery in one of its arguments results in an expected error. [#118612][#118612]
- Those with VIEWACTIVITY privilege can now request statement bundles using crdb_internal.requets_statement_bundle or via db-console's sql activity page. [#118809][#118809]
- Fixes a bug in the webhook sink where the http request body may not be initialized on retries, resulting in the error "http: ContentLength=... with Body length 0". [#119496][#119496]
- A bug has been fixed that caused internal errors when executing EXPORT statement. [#119711][#119711]
- Schema changes with a large number of descriptors could end up doing full table scans on system.leases. [#119464][#119464]
- Fixed a bug where rangefeed resolved timestamps could get stuck, continually emitting the log message "pushing old intents failed: range barrier failed, range split", typically following a range merge. This bug was introduced in v23.2.1. [#119702][#119702]
- Fixed a bug that caused the sql.txns.open.internal and sql.statements.active.internal metrics to never get updated. These metrics are gauges that count the number of transactions and statements being executed by operations internal to CockroachDB; they do not include any operations executed by the external SQL client. This bug was present since v22.1.0. [#119337][#119337]
- Fixed a bug that occurred when using ALTER TABLE to drop and re-add a CHECK constraint with the same name. [#120076][#120076]
- A slow memory leak that can accumulate when opening many new connections has been fixed. The bug is present in 22.2.9+ and 23.1+ versions. [#120245][#120245]

<h3 id="v23-2-3-miscellaneous">Miscellaneous</h3>

<h4 id="v23-2-3-changes-without-release-note-annotation">Changes without release note annotation</h4>

- [#118917][#118917] [fe18b7eb8][fe18b7eb8] release-23.2: sql/row: include pretty key in value decode error message (Jayant Shrivastava <jshrivastava03@gmail.com>)

<h3 id="v23-2-3-doc-updates">Doc updates</h3>

{% comment %}Docs team: Please add these manually.{% endcomment %}

<div class="release-note-contributors" markdown="1">

<h3 id="v23-2-3-contributors">Contributors</h3>

This release includes 118 merged PRs by 42 authors.
We would like to thank the following contributors from the CockroachDB community:

- Darryl Wong (first-time contributor, CockroachDB team member)
- David Hartunian (first-time contributor, CockroachDB team member)
- daniel-crlabs (first-time contributor)
- rharding6373

</div>

[#117741]: https://github.com/cockroachdb/cockroach/pull/117741
[#118343]: https://github.com/cockroachdb/cockroach/pull/118343
[#118413]: https://github.com/cockroachdb/cockroach/pull/118413
[#118432]: https://github.com/cockroachdb/cockroach/pull/118432
[#118612]: https://github.com/cockroachdb/cockroach/pull/118612
[#118672]: https://github.com/cockroachdb/cockroach/pull/118672
[#118703]: https://github.com/cockroachdb/cockroach/pull/118703
[#118764]: https://github.com/cockroachdb/cockroach/pull/118764
[#118805]: https://github.com/cockroachdb/cockroach/pull/118805
[#118809]: https://github.com/cockroachdb/cockroach/pull/118809
[#118831]: https://github.com/cockroachdb/cockroach/pull/118831
[#118847]: https://github.com/cockroachdb/cockroach/pull/118847
[#118860]: https://github.com/cockroachdb/cockroach/pull/118860
[#118896]: https://github.com/cockroachdb/cockroach/pull/118896
[#118917]: https://github.com/cockroachdb/cockroach/pull/118917
[#118931]: https://github.com/cockroachdb/cockroach/pull/118931
[#118933]: https://github.com/cockroachdb/cockroach/pull/118933
[#118942]: https://github.com/cockroachdb/cockroach/pull/118942
[#118947]: https://github.com/cockroachdb/cockroach/pull/118947
[#118974]: https://github.com/cockroachdb/cockroach/pull/118974
[#118994]: https://github.com/cockroachdb/cockroach/pull/118994
[#119020]: https://github.com/cockroachdb/cockroach/pull/119020
[#119184]: https://github.com/cockroachdb/cockroach/pull/119184
[#119234]: https://github.com/cockroachdb/cockroach/pull/119234
[#119259]: https://github.com/cockroachdb/cockroach/pull/119259
[#119337]: https://github.com/cockroachdb/cockroach/pull/119337
[#119341]: https://github.com/cockroachdb/cockroach/pull/119341
[#119371]: https://github.com/cockroachdb/cockroach/pull/119371
[#119399]: https://github.com/cockroachdb/cockroach/pull/119399
[#119464]: https://github.com/cockroachdb/cockroach/pull/119464
[#119496]: https://github.com/cockroachdb/cockroach/pull/119496
[#119541]: https://github.com/cockroachdb/cockroach/pull/119541
[#119601]: https://github.com/cockroachdb/cockroach/pull/119601
[#119702]: https://github.com/cockroachdb/cockroach/pull/119702
[#119711]: https://github.com/cockroachdb/cockroach/pull/119711
[#120076]: https://github.com/cockroachdb/cockroach/pull/120076
[#120245]: https://github.com/cockroachdb/cockroach/pull/120245
[fe18b7eb8]: https://github.com/cockroachdb/cockroach/commit/fe18b7eb8
