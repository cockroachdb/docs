## v23.2.6

Release Date: June 6, 2024

{% include releases/new-release-downloads-docker-image.md release=include.release %}

<h3 id="v23-2-6-{{-site.data.products.enterprise-}}-edition-changes">{{ site.data.products.enterprise }} edition changes</h3>

- Fixed a bug in v22.2+ where long running initial scans may incorrectly restore checkpoint job progress and drop events during node / changefeed restart. This issue was most likely to occur in clusters with: 1) changefeed.shutdown_checkpoint.enabled (v23.2) is set 2) Multiple table targets in a changefeed, or 3) Low changefeed.frontier_checkpoint_frequency or low changefeed.frontier_highwater_lag_checkpoint_threshold. [#123966][#123966]

<h3 id="v23-2-6-sql-language-changes">SQL language changes</h3>

- Object_type can now be seen with the show grants command and relation_name column is now shown as object_name. [#122822][#122822]
- External connection granted privileges can now be seen with the SHOW GRANTS command. [#122822][#122822]
- Introduce three new cluster settings for controlling table statistics forecasting:  1. `sql.stats.forecasts.min_observations` is the minimum number of    observed statistics required to produce a forecast.  2. `sql.stats.forecasts.min_goodness_of_fit` is the minimum RÂ² (goodness    of fit) measurement required from all predictive models to use a    forecast.  3. `sql.stats.forecasts.max_decrease` is the most a prediction can    decrease, expressed as the minimum ratio of the prediction to the    lowest prior observation. [#122458][#122458]
- Added a setting optimizer_use_improved_multi_column_selectivity_estimate, which if enabled, causes the optimizer to use an improved selectivity estimate for multi-column predicates. This setting will default to true on versions 24.2+, and false on prior versions. [#123100][#123100]
- The optimizer can now plan constrained scans over partial indexes in more cases, particularly on partial indexes with predicates referencing virtual computed columns. [#123469][#123469]
- The optimizer can now plan constrained scans over partial indexes in more cases, particularly on partial indexes with predicates referencing virtual computed columns. [#124071][#124071]
- We are now setting ttl_delete_rate_limit to 100, this sets the default rate limit for deleting expired rows to 100. [#124353][#124353]

<h3 id="v23-2-6-operational-changes">Operational changes</h3>

- Two new metrics have been added to track the status of the SQL activity update job, which is used to pre-aggregate top K information within the SQL stats subsytem and write the results to `system.statement_activity` and `system.transaction_activity`.  The new metrics are: - `sql.stats.activity.updates.successful`: Number of successful updates made    by the SQL activity updater job. - `sql.stats.activity.update.latency`: The latency of updates  made by   the SQL activity updater job. Includes failed update attempts. [#123960][#123960]
- A new counter metric, `sql.stats.flush.done_signals.ignored`, has been introduced. The metric tracks the number of times the SQL Stats activity update job ignored the signal sent to it indicating a flush has completed. This may indicate that the SQL Activity update job is taking longer than expected to complete. [#123960][#123960]
- A new counter metric, `sql.stats.activity.updates.failed`, has been introduced to measure the number of update attempts made by the SQL activity updater job that failed with errors. The SQL activity update job is used to pre-aggregate top K information within the SQL stats subsystem and write the results to `system.statement_activity` and `system.transaction_activity`. [#123960][#123960]
- A new counter metric, `sql.stats.flush.fingerprint.count`, has been introduced. The metric tracks the number of unique statement and transaction fingerprints included in the SQL Stats flush. [#123960][#123960]
- Added the sql.pgwire.pipeline.count metric, which is a gauge that measures how many wire protocol commands have been received by the server, but have not yet begun processing. This metric will only grow if clients are using the "pipeline mode" of the Postgres wire protocol. [#124260][#124260]
- The client_authentication_ok and client_session_end messages are now logged to the SESSIONS log channel unconditionally. Previously, these would only be logged if the server.auth_log.sql_sessions.enabled cluster setting was changed to true. All other SESSIONS log messages are still only logged if server.auth_log.sql_sessions.enabled or server.auth_log.sql_connections.enabled are set to true.  If you do not want to see client_authentication_ok or client_session_end messages, then the SESSIONS log channel can be disabled entirely. [#124374][#124374]

<h3 id="v23-2-6-command-line-changes">Command-line changes</h3>

- Added `--max-concurrency` flag to `debug recover` commands to control the maximum concurrency when fanning out RPCs to nodes in the cluster. The flag defaults to `2 x num_cpus`. [#123067][#123067]

<h3 id="v23-2-6-db-console-changes">DB Console changes</h3>

- The database details and table details pages in the cluster-ui now display the correct "stats last created" value. [#122815][#122815]
- Viewing SQL Activity sorted by `% of Runtime` now correctly sorts entries by the runtime amount. [#123901][#123901]

<h3 id="v23-2-6-bug-fixes">Bug fixes</h3>

- Client Certificate Auth combined with identity maps(server.identity_map.configuration) was broken in 23.1. This bug is fixed; note that the feature to work correctly, the client must specify a valid db user in connection string. [#122749][#122749]
- Fixed an issue where the row-based execution engine could drop a LIMIT clause when there was an ORDER BY clause, and the ordering was partially provided by an input operator. For example, this bug could occur with an ordering such as `ORDER BY a, b` when the scanned index was only ordered on column `a`. The impact of this bug was that more rows may have been returned than specified by the LIMIT clause. This bug is only present when not using the vectorized execution engine, i.e., when running with `SET vectorize = off;`. The bug has existed since CockroachDB version 22.1. [#122836][#122836]
- A bug has been fixed in the DB Console's custom chart tool, where store-level metrics were not being displayed properly. Previously, if a store-level metric was selected to be displayed at the store-level on a multi-store node, only data for the 1st store ID associated with that node would be displayed.  This patch ensures that data is displayed for all stores present on a node. Additionally, it updates the behavior to show a single timeseries for each store, as opposed to aggregating (e.g. SUM) all stores across the node. This allows finer-grained observability into store-level metrics when using the custom chart tool in DB Console. [#122703][#122703]
- Privileges granted for external connections were incorrectly showing up in SHOW SYSTEM GRANTS, but were not useful since there is no associated object name. Now they do not appear there. Instead, the SHOW GRANTS ON EXTERNAL CONNECTION should be used. [#122905][#122905]
- Statistics forecasts of zero rows can cause bad plans. This commit changes forecasting to avoid predicting zero rows for most downward-trending statistics. [#122458][#122458]
- Fixed a bug introduced in v23.2 that could cause a PL/pgSQL routine to return incorrect results when there was at least one parameter, and an `IF` statement with one leak-proof branch, and one branch with side effects. [#120742][#120742]
- Fixed a bug that could result in an internal error when attempting to create a PL/pgSQL routine using the (currently unsupported) `%ROWTYPE` syntax for a variable declaration. [#123010][#123010]
- Fixes an issue in which a RESTORE of a backup that itself contained a table created by the RESTORE of a table with an in-progress IMPORT would fail to restore all rows. [#120543][#120543]
- Fixed a bug introduced in v23.2 that could cause a PL/pgSQL variable assignment to not be executed if the variable was never referenced after the assignment. [#123116][#123116]
- CockroachDB could previously run into `attempting to append refresh spans after the tracked timestamp has moved forward` internal error in some edge cases, and this is now fixed. The bug has been present since 22.2 version. [#123150][#123150]
- A job will now log rather than fail if it reports an out-of bound progress fraction. [#122964][#122964]
- Fixed a bug that would occur when `ALTER TYPE ... DROP VALUE` is followed by `DROP SCHEMA CASCADE ...` in the same transaction. Previously, the `ALTER TYPE` schema change would get queued up to run at commit time, but by that point, the type may have already been removed, so the commit could fail. This is fixed now. [#123576][#123576]
- Automatically repair tables which see the following error "invalid inbound foreign key ... origin table ID should be" or "invalid outbound foreign key ... reference table ID should be". [#123681][#123681]
- Fix a bug where a failed RESTORE could leave the system in a state where re-attempting the restore was not possible without manual intervention. [#123463][#123463]
- Index recommendations in the DB Console will now function properly for indexes on tables/columns whose names contain quotation marks and/or whitespace. For example: `CREATE INDEX ON "my table" ("my col");` [#122119][#122119]
- Fix a crash introduced in v23.2.5 that could occur when planning statistics collection on a table with a virtual computed column using a user-defined type when the newly-introduced cluster setting `sql.stats.virtual_computed_columns.enabled` is set to true. (The setting was introduced in v23.2.4 default false.) [#124080][#124080]
- Add automated clean up / validation for dropped roles inside descriptors. [#124670][#124670]
- Drop role/user could leave references behind inside types, which could prevent SHOW GRANTS from working [#124668][#124668]

<h3 id="v23-2-6-performance-improvements">Performance improvements</h3>

- More efficient query plans are now generated for queries with text similarity filters, e.g., `text_col % 'foobar'`. These plans are generated if the `optimizer_use_trigram_similarity_optimization` session setting is enabled. It is disabled by default. [#122753][#122753]
- The optimizer now costs distinct-on operators more accurately. It may produce more efficient query plans in some cases. [#122844][#122844]
- Added a new setting optimizer_use_improved_zigzag_join_costing. When enabled, the cost of zigzag joins is updated so they will be never be chosen over scans unless they produce fewer rows. This change only matters if the setting enable_zigzag_join is also true. [#123100][#123100]
- Improved the selectivity estimation of multi-column filters when the multi-column distinct count is high. This avoids cases where we significantly over-estimate the selectivity of a multi-column predicate and as a result can prevent the optimizer from choosing a bad query plan. [#123100][#123100]
- Make error handling in the vectorized execution engine much cheaper. This should help avoid bad metastable regimes perpetuated by statement timeout handling consuming all CPU time, leading to more statement timeouts. [#123502][#123502]

<h3 id="v23-2-6-miscellaneous">Miscellaneous</h3>

<h4 id="v23-2-6-missing-category">Missing category</h4>

- Disabled a changefeed optimization on reducing duplicates during aggregator restarts due to its bad performance. [#124071][#124071]
- Disabled a changefeed optimization on reducing duplicates during aggregator restarts due to its bad performance. [#123594][#123594]

<h4 id="v23-2-6-changes-without-release-note-annotation">Changes without release note annotation</h4>

- [#124298][#124298] [0abdb2c90][0abdb2c90] release-23.2: roachprod, roachtest: use same cluster name sanitization (Darryl Wong <darryl.wong@cockroachlabs.com>)
- [#124083][#124083] [391453fd2][391453fd2] release-23.2: roachtest: run sequelize on insecure mode and default sql port (Darryl Wong <darryl.wong@cockroachlabs.com>)
- [#123374][#123374] [1875bf6ec][1875bf6ec] release-23.2: roachprod: deduplicate cluster loading code (Darryl Wong <darryl.wong@cockroachlabs.com>)

<h3 id="v23-2-6-doc-updates">Doc updates</h3>

{% comment %}Docs team: Please add these manually.{% endcomment %}

<div class="release-note-contributors" markdown="1">

<h3 id="v23-2-6-contributors">Contributors</h3>

This release includes 115 merged PRs by 32 authors.
We would like to thank the following contributors from the CockroachDB community:

- Bergin Dedej (first-time contributor, CockroachDB team member)
- Darryl Wong (first-time contributor, CockroachDB team member)
- David Hartunian (first-time contributor, CockroachDB team member)
- Rachael Harding (first-time contributor, CockroachDB team member)

</div>

[#120543]: https://github.com/cockroachdb/cockroach/pull/120543
[#120742]: https://github.com/cockroachdb/cockroach/pull/120742
[#122119]: https://github.com/cockroachdb/cockroach/pull/122119
[#122458]: https://github.com/cockroachdb/cockroach/pull/122458
[#122703]: https://github.com/cockroachdb/cockroach/pull/122703
[#122749]: https://github.com/cockroachdb/cockroach/pull/122749
[#122753]: https://github.com/cockroachdb/cockroach/pull/122753
[#122815]: https://github.com/cockroachdb/cockroach/pull/122815
[#122822]: https://github.com/cockroachdb/cockroach/pull/122822
[#122836]: https://github.com/cockroachdb/cockroach/pull/122836
[#122844]: https://github.com/cockroachdb/cockroach/pull/122844
[#122905]: https://github.com/cockroachdb/cockroach/pull/122905
[#122964]: https://github.com/cockroachdb/cockroach/pull/122964
[#123010]: https://github.com/cockroachdb/cockroach/pull/123010
[#123067]: https://github.com/cockroachdb/cockroach/pull/123067
[#123100]: https://github.com/cockroachdb/cockroach/pull/123100
[#123116]: https://github.com/cockroachdb/cockroach/pull/123116
[#123150]: https://github.com/cockroachdb/cockroach/pull/123150
[#123374]: https://github.com/cockroachdb/cockroach/pull/123374
[#123463]: https://github.com/cockroachdb/cockroach/pull/123463
[#123469]: https://github.com/cockroachdb/cockroach/pull/123469
[#123502]: https://github.com/cockroachdb/cockroach/pull/123502
[#123576]: https://github.com/cockroachdb/cockroach/pull/123576
[#123594]: https://github.com/cockroachdb/cockroach/pull/123594
[#123681]: https://github.com/cockroachdb/cockroach/pull/123681
[#123901]: https://github.com/cockroachdb/cockroach/pull/123901
[#123960]: https://github.com/cockroachdb/cockroach/pull/123960
[#123966]: https://github.com/cockroachdb/cockroach/pull/123966
[#124071]: https://github.com/cockroachdb/cockroach/pull/124071
[#124080]: https://github.com/cockroachdb/cockroach/pull/124080
[#124083]: https://github.com/cockroachdb/cockroach/pull/124083
[#124260]: https://github.com/cockroachdb/cockroach/pull/124260
[#124298]: https://github.com/cockroachdb/cockroach/pull/124298
[#124353]: https://github.com/cockroachdb/cockroach/pull/124353
[#124374]: https://github.com/cockroachdb/cockroach/pull/124374
[#124668]: https://github.com/cockroachdb/cockroach/pull/124668
[#124670]: https://github.com/cockroachdb/cockroach/pull/124670
[0abdb2c90]: https://github.com/cockroachdb/cockroach/commit/0abdb2c90
[1875bf6ec]: https://github.com/cockroachdb/cockroach/commit/1875bf6ec
[391453fd2]: https://github.com/cockroachdb/cockroach/commit/391453fd2
