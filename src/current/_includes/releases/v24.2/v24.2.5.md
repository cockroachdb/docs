## v24.2.5

Release Date: November 14, 2024

{% include releases/new-release-downloads-docker-image.md release=include.release %}

<h3 id="v24-2-5-security-updates">Security updates</h3>

- HBA config entry for LDAP will be evaluated with validations for proper ldap config parameter values and any invalid/incomplete options list will be disallowed to amend the HBA setting. We will validate all fields provided as ldap auth method options in HBA entry. [#132748][#132748]

<h3 id="v24-2-5-general-changes">General changes</h3>

- Change the license cockroach is distributed under to the new CockroachDB Software License. [#131707][#131707]
- Change the license cockroach is distributed under to the new CockroachDB Software License (CSL). [#131956][#131956]
- Change the license cockroach is distributed under to the new CockroachDB Software License (CSL). [#131961][#131961]
- Change the license cockroach is distributed under to the new CockroachDB Software License (CSL). [#131983][#131983]
- Change the license cockroach is distributed under to the new CockroachDB Software License (CSL). [#132011][#132011]
- Change the license cockroach is distributed under to the new CockroachDB Software License (CSL). [#132013][#132013]
- Change the license cockroach is distributed under to the new CockroachDB Software License (CSL). [#132012][#132012]
- Change the license cockroach is distributed under to the new CockroachDB Software License (CSL). [#132015][#132015]
- Change the license cockroach is distributed under to the new CockroachDB Software License (CSL). [#132014][#132014]
- Change the license cockroach is distributed under to the new CockroachDB Software License (CSL). [#132016][#132016]
- Change the license cockroach is distributed under to the new CockroachDB Software License (CSL). [#132054][#132054]
- Attempting to install a second enterprise trial license on the same cluster will now fail. [#131970][#131970]
- Change the license cockroach is distributed under to the new CockroachDB Software License (CSL). [#132056][#132056]
- The cluster setting `diagnostics.reporting.enabled` is now ignored if the cluster has a Trial or Free license, or if the reporting job is unable to load any license at all. [#132464][#132464]
- Change the license cockroach is distributed under to the new CockroachDB Software License (CSL). [#132801][#132801]
- Change the license cockroach is distributed under to the new CockroachDB Software License (CSL). [#132704][#132704]

<h3 id="v24-2-5-{{-site.data.products.enterprise-}}-edition-changes">{{ site.data.products.enterprise }} edition changes</h3>

- Add sink error metric (`changefeed.sink_errors`) and expand reporting of internal retries metric (`changefeed.internal_retry_message_count`) to all sinks that perform internal retries. [#132353][#132353]
- Added a timer for inner sink client flushes. Fixed a bug where timers were not correctly registered with the metric system. [#133197][#133197]
- Allowed access to DB console APIs via JWT, which can be supplied as a Bearer token in Authorization header. [#133534][#133534]

<h3 id="v24-2-5-db-console-changes">DB Console changes</h3>

- DB Console will reflect any throttling behavior from the cluster due to an expired license or missing telemetry data. Enterprise licenses are not affected. [#132093][#132093]
- Due to the inaccuracy of the "Range Count" column on the "Databases" page and the cost incurred to fetch the correct range count for every database in a cluster, this data will no longer be visible. This data is still available via a `SHOW RANGES` query. [#133268][#133268]

<h3 id="v24-2-5-bug-fixes">Bug fixes</h3>

- Fixed a bug where the CLI would not correctly escape JSON values that had double-quotes inside of a string when using the --format=sql flag. [#131931][#131931]
- Fixed an error that could happen if an aggregate function was used as the value in a SET command. [#131960][#131960]
- Ordering by `VECTOR` columns now results in an "unimplemented" error. Previously it would result in internal errors in some cases. See #92165. [#132107][#132107]
- Add automated clean-up/validation for dropped roles inside of default privileges. [#132136][#132136]
- A bug has been fixed that caused incorrect evaluation of `CASE`, `COALESCE`, and `IF` expressions with branches producing fixed-width string-like types, such as `CHAR`. In addition, the `BPCHAR` type has been fixed so that it no longer incorrectly imposes a length limit of 1. [#130889][#130889]
- Addressed a rare bug that could prevent backups taken during a DROP COLUMN operation with a sequence owner from restoring with the error: "rewriting descriptor ids: missing rewrite for <id> in SequenceOwner..." [#132326][#132326]
- Fixed a bug existing since before v23.1 which could lead to incorrect results in rare cases. The bug requires a join between two tables, with an equality between columns with equivalent but not identical types (e.g. OID and REGCLASS). In addition, the join must lookup into an index that includes a computed column that references one of the equivalent columns. [#132508][#132508]
- Fixed a bug existing since before v23.1 which could lead to incorrect results in rare cases. The bug requires a lookup join into a table with a computed index column, where the computed column expression is composite sensitive. A composite sensitive expression can compare differently if supplied non-identical but equivalent input values (e.g. `2.0::DECIMAL` vs `2.00::DECIMAL`). [#132508][#132508]
- Fixes a bug where a span stats request on a mixed version cluster resulted in an NPE [#132680][#132680]
- The franz-go library has been updated to fix a potential deadlock on changefeed restarts. [#132787][#132787]
- Fixed an issue where changefeeds would fail to update protected timestamp records in the face of retryable errors. [#132773][#132773]
- Fix a bug which could result in changefeeds using cdc queries failing due to a system table being GC'd. [#131649][#131649]
- Fix a rare bug in which an update of a primary key column which is also the only column in a separate column family can sometimes fail to update the primary index. This bug has existed since v22.2. Requirements to hit the bug are:  1. A table with multiple column families. 2. A column family containing a single PK column. 3. That column family is not the first column family. 4. That column family existed before its column was in the PK. 5. That column must be of type FLOAT4/8, DECIMAL, JSON, collated string    type, or array. 6. An update that changes that column from a composite value to a non-    composite value. [#132120][#132120]
- The proretset column of the pg_catalog.pg_proc table is now properly set to true for set-returning builtin functions. [#132876][#132876]
- A bug has been fixed that could cause incorrect evaluation of scalar expressions involving `NULL` values in rare cases. [#132946][#132946]
- A bug has been fixed that could cause incorrect evaluation of scalar expressions involving NULL values in rare cases. [#132946][#132946]
- A bug in the query optimizer which could cause CockroachDB nodes to crash in rare cases has been fixed. The bug could occur when a query contains a filter in the form `col IN (elem0, elem1, ..., elemN)` only when `N` is very large, e.g., 1.6+ million, and when `col` exists in a hash-sharded index or exists a table with an indexed, computed column dependent on `col`. [#132868][#132868]
- Users with the admin role can now run `ALTER DEFAULT PRIVILEGES FOR target_role ...` on any target_role. Previously, this could result in a privilege error, which is incorrect as admins are allowed to perform any operation. [#133071][#133071]
- REASSIGN OWNED BY will now transfer ownership of the public schema. Previously, it would always skip over the public schema even if it was owned by the target role. [#133071][#133071]
- This commit fixes a bug which causes new connections to fail with the following error after upgrading to v24.2:  ``` ERROR: invalid value for parameter "vectorize": "unknown(1)" SQLSTATE: 22023 HINT: Available values: off,on,experimental_always ```  In order to hit this bug, the cluster must have: 1. been on version v21.1 at some point in the past 2. run `SET CLUSTER SETTING sql.defaults.vectorize = 'on';` on v21.1 3. not set sql.defaults.vectorize after upgrading past v21.1 4. upgraded all the way to v24.2  The conditions required for this bug can be detected using:  ``` SELECT * FROM system.settings WHERE name = 'sql.defaults.vectorize'; ```  If the value is '1', the following statement should be run to fix it before upgrading to v24.2:  ``` RESET CLUSTER SETTING sql.defaults.vectorize; ```  This commit fixes the bug by making '1' a legal value for sql.defaults.vectorize again (mapping to 'on'). [#133368][#133368]
- Fixes a rare instance of higher-than-necessary disk space usage in the presence of high rebalance activity. Epic: none. [#133565][#133565]

<h3 id="v24-2-5-performance-improvements">Performance improvements</h3>

- Enhanced performance when schema_locked is not in use by improving error handling during periodic table history polling.  ``` ❯ benchstat before.txt after.txt goos: darwin goarch: arm64                                         │  before.txt  │              after.txt               │                                         │    sec/op    │    sec/op     vs base                │ PauseOrResumePolling/non-terminal_error    5.533µ ± 5%   3.849µ ± 29%  -30.44% (p=0.000 n=10) PauseOrResumePolling/not_schema_locked    7069.5n ± 4%   176.4n ±  9%  -97.50% (p=0.000 n=10) PauseOrResumePolling/schema_locked         136.2n ± 4%   131.8n ±  7%        ~ (p=0.306 n=10) geomean                                    1.747µ        447.2n        -74.39% ``` [#132191][#132191]

<h3 id="v24-2-5-miscellaneous">Miscellaneous</h3>

<h4 id="v24-2-5-changes-without-release-note-annotation">Changes without release note annotation</h4>

- [#133470][#133470] [729d0dad0][729d0dad0] release-24.2: roachtest: string match for transient errors as a fallback
- [#133470][#133470] [356b8b742][356b8b742] release-24.2: roachtest: string match for transient errors as a fallback
- [#133470][#133470] [3b5328f4b][3b5328f4b] release-24.2: roachtest: string match for transient errors as a fallback
- [#132959][#132959] [d9b041903][d9b041903] release-24.2: roachprod: preserve error object in Get
- [#132739][#132739] [609114a08][609114a08] release-24.2: hba,rulebasedscanner: handle double quotes in HBA conf option value
- [#132455][#132455] [badf7cc37][badf7cc37] release-24.2: sql: fix panic caused by type resolution in AOST expression

<h3 id="v24-2-5-doc-updates">Doc updates</h3>

{% comment %}Docs team: Please add these manually.{% endcomment %}



[#130889]: https://github.com/cockroachdb/cockroach/pull/130889
[#131649]: https://github.com/cockroachdb/cockroach/pull/131649
[#131707]: https://github.com/cockroachdb/cockroach/pull/131707
[#131931]: https://github.com/cockroachdb/cockroach/pull/131931
[#131956]: https://github.com/cockroachdb/cockroach/pull/131956
[#131960]: https://github.com/cockroachdb/cockroach/pull/131960
[#131961]: https://github.com/cockroachdb/cockroach/pull/131961
[#131970]: https://github.com/cockroachdb/cockroach/pull/131970
[#131983]: https://github.com/cockroachdb/cockroach/pull/131983
[#132011]: https://github.com/cockroachdb/cockroach/pull/132011
[#132012]: https://github.com/cockroachdb/cockroach/pull/132012
[#132013]: https://github.com/cockroachdb/cockroach/pull/132013
[#132014]: https://github.com/cockroachdb/cockroach/pull/132014
[#132015]: https://github.com/cockroachdb/cockroach/pull/132015
[#132016]: https://github.com/cockroachdb/cockroach/pull/132016
[#132054]: https://github.com/cockroachdb/cockroach/pull/132054
[#132056]: https://github.com/cockroachdb/cockroach/pull/132056
[#132093]: https://github.com/cockroachdb/cockroach/pull/132093
[#132107]: https://github.com/cockroachdb/cockroach/pull/132107
[#132120]: https://github.com/cockroachdb/cockroach/pull/132120
[#132136]: https://github.com/cockroachdb/cockroach/pull/132136
[#132191]: https://github.com/cockroachdb/cockroach/pull/132191
[#132326]: https://github.com/cockroachdb/cockroach/pull/132326
[#132353]: https://github.com/cockroachdb/cockroach/pull/132353
[#132455]: https://github.com/cockroachdb/cockroach/pull/132455
[#132464]: https://github.com/cockroachdb/cockroach/pull/132464
[#132508]: https://github.com/cockroachdb/cockroach/pull/132508
[#132680]: https://github.com/cockroachdb/cockroach/pull/132680
[#132704]: https://github.com/cockroachdb/cockroach/pull/132704
[#132739]: https://github.com/cockroachdb/cockroach/pull/132739
[#132748]: https://github.com/cockroachdb/cockroach/pull/132748
[#132773]: https://github.com/cockroachdb/cockroach/pull/132773
[#132787]: https://github.com/cockroachdb/cockroach/pull/132787
[#132801]: https://github.com/cockroachdb/cockroach/pull/132801
[#132868]: https://github.com/cockroachdb/cockroach/pull/132868
[#132876]: https://github.com/cockroachdb/cockroach/pull/132876
[#132946]: https://github.com/cockroachdb/cockroach/pull/132946
[#132959]: https://github.com/cockroachdb/cockroach/pull/132959
[#133071]: https://github.com/cockroachdb/cockroach/pull/133071
[#133197]: https://github.com/cockroachdb/cockroach/pull/133197
[#133268]: https://github.com/cockroachdb/cockroach/pull/133268
[#133368]: https://github.com/cockroachdb/cockroach/pull/133368
[#133470]: https://github.com/cockroachdb/cockroach/pull/133470
[#133534]: https://github.com/cockroachdb/cockroach/pull/133534
[#133565]: https://github.com/cockroachdb/cockroach/pull/133565
[356b8b742]: https://github.com/cockroachdb/cockroach/commit/356b8b742
[3b5328f4b]: https://github.com/cockroachdb/cockroach/commit/3b5328f4b
[609114a08]: https://github.com/cockroachdb/cockroach/commit/609114a08
[729d0dad0]: https://github.com/cockroachdb/cockroach/commit/729d0dad0
[badf7cc37]: https://github.com/cockroachdb/cockroach/commit/badf7cc37
[d9b041903]: https://github.com/cockroachdb/cockroach/commit/d9b041903
