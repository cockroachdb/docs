## v24.2.4

Release Date: October 17, 2024

{% include releases/new-release-downloads-docker-image.md release=include.release %}
<h3 id="v24-2-4-security-updates">Security updates</h3>

- TODO Cluster settings for LDAP cluster settings `server.ldap_authentication.client.tls_certificate` and `server.ldap_authentication.client.tls_key` don't have callbacks installed to reload the settings value for LDAP authManager. This change fixes this by adding the necessary callbacks. [#131210][#131210]

<h3 id="v24-2-4-{{-site.data.products.enterprise-}}-edition-changes">{{ site.data.products.enterprise }} edition changes</h3>

- Updated the cluster setting [`changefeed.sink_io_workers`]({% link v24.2/cluster-settings.md %}#setting-changefeed-sink-io-workers) with all the [changefeed sinks]({% link v24.2/changefeed-sinks.md %}) that support the setting.ates the cluster setting `changefeed.sink_io_workers` with all the sinks that support the setting. [#130374][#130374]
- Added two network metrics, `changefeed.network.bytes_in` and `changefeed.network.bytes_out`. [#130578][#130578] [#131619][#131619] These metrics track the number of bytes sent by individual [changefeeds]({% link v24.2/change-data-capture-overview.md %}) to the following sinks: 
	- [Kafka sinks]({% link v24.2/changefeed-sinks.md %}#kafka). If [child metrics are enabled]({% link v24.2/cluster-settings.md %}#setting-server-child-metrics-enabled), the metric will have a `kafka` label. 
	- [Webhook sinks]({% link v24.2/changefeed-sinks.md %}#webhook-sink). If child metrics are enabled, the metric will have a `webhook` label. 
	- [Pub/Sub sinks]({% link v24.2/changefeed-sinks.md %}#google-cloud-pub-sub). If child metrics are enabled, the metric will have a `pubsub` label. 
	- [SQL sink]({% link v24.2/changefeed-for.md %}). If child metrics are enabled, the metric will have a `sql` label.
- Added a `changefeed.total_ranges` metric that can be used to monitor the number of ranges that are watched by [changefeed]({% link v24.2/change-data-capture-overview.md %}) aggregators. It shares the same polling interval as `changefeed.lagging_ranges`, which is controlled by the existing `lagging_ranges_polling_interval` option. [#130982][#130982]
- Disambiguated [metrics]({% link v24.2/essential-metrics-self-hosted.md %}) and logs for the two buffers used by the KV feed. The following metrics now have a suffix indicating which buffer they correspond to: `changefeed.buffer_entries.*`, `changefeed.buffer_entries_mem.*`, `changefeed.buffer_pushback_nanos.*`. The old versions are kept for backward compatibility, though using the new format is recommended. [#131419][#131419]
- Added timers around key parts of the [changefeed]({% link v24.2/change-data-capture-overview.md %}) pipeline to help debug feeds experiencing issues. The `changefeed.stage.{stage}.latency` metrics now emit latency histograms for each stage. The metric respects the changefeed `scope` label for debugging specific feeds. [#131372][#131372]

<h3 id="v24-2-4-sql-language-changes">SQL language changes</h3>

- TODO Session variable `enforce_home_region_follower_reads_enabled` is now deprecated, and will be removed in a future release. (Note that related session variable `enforce_home_region` is _not_ deprecated.) [#129587][#129587]

<h3 id="v24-2-4-operational-changes">Operational changes</h3>

- Added a `ranges.decommissioning` [metric]({% link v24.2/metrics.md %}) representing the number of ranges that have a replica on a [decommissioning node]({% link v24.2/node-shutdown.md %}?filters=decommission). [#130247][#130247]
- You can now configure the log format for the [`stderr` log sink]({% link v24.2/configure-logs.md %}#output-to-stderr) by setting the `stderr.format` field in the [YAML configuration]({% link v24.2/configure-logs.md %}#yaml-payload). [#131539][#131539]

<h3 id="v24-2-4-db-console-changes">DB Console changes</h3>

- TODO Some metric charts on the overview and replication pages have more terse legends to facilitate easier browsing. [#129359][#129359]
- The [DB Console]({% link v24.2/ui-overview.md %}) will now show a notification alerting customers without an [Enterprise license]({% link v24.2/enterprise-licensing.md %}) to [upcoming license changes](https://www.cockroachlabs.com/enterprise-license-update/) with a link to more information. [#130417][#130417]

<h3 id="v24-2-4-bug-fixes">Bug fixes</h3>

- Addressed a bug in the [upgrade]({% link v24.2/upgrade-cockroach-version.md %}) pre-condition for repairing descriptor corruption, which could lead to upgrade finalization being stuck. [#130517][#130517]
- Fixed a potential memory leak in [changefeeds]({% link v24.2/change-data-capture-overview.md %}) using a [cloud storage sink]({% link v24.2/changefeed-sinks.md %}#cloud-storage-sink). The memory leak could occur if both [`changefeed.fast_gzip.enabled`]({% link v24.2/cluster-settings.md %}#setting-changefeed-fast-gzip-enabled) and `changefeed.cloudstorage.async_flush.enabled` were `true`, and the changefeed received an error while attempting to write to the cloud storage sink. [#130602][#130602] [#131619][#131619]
- Fixed a bug where zone configuration changes issued by the declarative schema changer were not blocked if a table had `schema_locked` set. For more information about the declarative schema changer, see: https://www.cockroachlabs.com/docs/stable/online-schema-changes#declarative-schema-changer/. [#130705][#130705]
- Fixed a bug in which some [`SELECT FOR UPDATE`]({% link v24.2/select-for-update.md %}) or [`SELECT FOR SHARE`]({% link v24.2/select-for-update.md %}) queries using `NOWAIT` could still block on locked rows when using the `optimizer_use_lock_op_for_serializable` [session setting]({% link v24.2/session-variables.md %}) under [`SERIALIZABLE`]({% link v24.2/demo-serializable.md %}) isolation. This bug was introduced with [`optimizer_use_lock_op_for_serializable`]({% link v24.2/session-variables.md %}#optimizer-use-lock-op-for-serializable) in v23.2.0. [#130430][#130430]
- Fixed a bug that caused the [optimizer]({% link v24.2/cost-based-optimizer.md %}) to plan unnecessary post-query uniqueness checks during [`INSERT`]({% link v24.2/insert.md %}), [`UPSERT`]({% link v24.2/upsert.md %}), and [`UPDATE`]({% link v24.2/update.md %}) statements on tables with [partial]({% link v24.2/partial-indexes.md %}), [unique]({% link v24.2/create-index.md %}#unique-indexes), [hash-sharded indexes]({% link v24.2/hash-sharded-indexes.md %}). These unnecessary checks added overhead to execution of these statements, and caused the statements to error when executed under [`READ COMMITTED`]({% link v24.2/read-committed.md %}) isolation. [#130570][#130570]
- Fixed a bug that could result in the inability to garbage collect an [MVCC]({% link v24.2/architecture/storage-layer.md %}#mvcc) range tombstone within a [global table]({% link v24.2/global-tables.md %}). [#130940][#130940] [#131199][#131199]
- Previously, if a connection was attempting a [schema change]({% link v24.2/online-schema-changes.md %}) while the same schema objects were being dropped, it was possible for the connection to be incorrectly dropped. This is now fixed. [#130962][#130962]
- TODO Previously, CockroachDB could incorrectly evaluate `IS NOT NULL` filter if it was applied to non-NULL tuples that had NULL elements (like `(1, NULL)` or `(NULL, NULL)`). The bug is present since 20.2 version and is now fixed. [#130947][#130947]
- Fixed a bug that could cause errors with the message `internal error: Non-nullable column ...` when executing statements under [`READ COMMITTED`]({% link v24.2/read-committed.md %}) isolation that involved tables with [`NOT NULL`]({% link v24.2/not-null.md %}) virtual columns. [#131019][#131019]
- The AWS endpoint and cloud custom HTTP client configuration are now considered when [implicit authentication]({% link v24.2/cloud-storage-authentication.md %}) is used for cloud storage. Previously, these were only considered when using explicit credentials. [#131173][#131173]
- Fixed a bug that could cause incorrect results for queries containing a correlated subquery with a [`GROUP BY`]({% link v24.2/select-clause.md %}#create-aggregate-groups) or [`DISTINCT ON`]({% link v24.2/select-clause.md %}#eliminate-duplicate-rows) operator referencing an outer column. This issue would occur if the correlated subquery was in the input of a [`SELECT`]({% link v24.2/select-clause.md %}) or [`JOIN`]({% link v24.2/joins.md %}) operator that had a filter equating the outer-column reference to a non-outer column in the grouping operator's input, while the grouping column set did not include the replacement column but functionally determined it. This bug was introduced in v23.1. [#130990][#130990]
- Fixed a bug where jobs created in sessions with non-zero session timezone offsets could hang before starting or report incorrect creation times when viewed in [`SHOW JOBS`]({% link v24.2/show-jobs.md %}) and the DB Console. [#131407][#131407]
- Fixed a bug that could prevent a [changefeed]({% link v24.2/change-data-capture-overview.md %}) from being able to resume after being paused for a prolonged period of time. [#130921][#130921]

<h3 id="v24-2-4-performance-improvements">Performance improvements</h3>

- The [query optimizer]({% link v24.2/cost-based-optimizer.md %}) now plans limited, [partial index]({% link v24.2/partial-indexes.md %}) scans in more cases when the new session setting [`optimizer_push_limit_into_project_filtered_scan`]({% link v24.2/session-variables.md %}) is set to `on`. [#130335][#130335]
- TODO Reduce the write-amplification impact of rebalances by splitting snapshot sstable files into smaller ones before ingesting them into Pebble. [#128997][#128997]

[#128997]: https://github.com/cockroachdb/cockroach/pull/128997
[#129359]: https://github.com/cockroachdb/cockroach/pull/129359
[#129587]: https://github.com/cockroachdb/cockroach/pull/129587
[#130247]: https://github.com/cockroachdb/cockroach/pull/130247
[#130335]: https://github.com/cockroachdb/cockroach/pull/130335
[#130374]: https://github.com/cockroachdb/cockroach/pull/130374
[#130417]: https://github.com/cockroachdb/cockroach/pull/130417
[#130430]: https://github.com/cockroachdb/cockroach/pull/130430
[#130517]: https://github.com/cockroachdb/cockroach/pull/130517
[#130570]: https://github.com/cockroachdb/cockroach/pull/130570
[#130578]: https://github.com/cockroachdb/cockroach/pull/130578
[#130602]: https://github.com/cockroachdb/cockroach/pull/130602
[#130673]: https://github.com/cockroachdb/cockroach/pull/130673
[#130676]: https://github.com/cockroachdb/cockroach/pull/130676
[#130705]: https://github.com/cockroachdb/cockroach/pull/130705
[#130921]: https://github.com/cockroachdb/cockroach/pull/130921
[#130935]: https://github.com/cockroachdb/cockroach/pull/130935
[#130940]: https://github.com/cockroachdb/cockroach/pull/130940
[#130947]: https://github.com/cockroachdb/cockroach/pull/130947
[#130962]: https://github.com/cockroachdb/cockroach/pull/130962
[#130982]: https://github.com/cockroachdb/cockroach/pull/130982
[#130990]: https://github.com/cockroachdb/cockroach/pull/130990
[#131019]: https://github.com/cockroachdb/cockroach/pull/131019
[#131173]: https://github.com/cockroachdb/cockroach/pull/131173
[#131199]: https://github.com/cockroachdb/cockroach/pull/131199
[#131210]: https://github.com/cockroachdb/cockroach/pull/131210
[#131239]: https://github.com/cockroachdb/cockroach/pull/131239
[#131311]: https://github.com/cockroachdb/cockroach/pull/131311
[#131372]: https://github.com/cockroachdb/cockroach/pull/131372
[#131391]: https://github.com/cockroachdb/cockroach/pull/131391
[#131407]: https://github.com/cockroachdb/cockroach/pull/131407
[#131419]: https://github.com/cockroachdb/cockroach/pull/131419
[#131539]: https://github.com/cockroachdb/cockroach/pull/131539
[#131619]: https://github.com/cockroachdb/cockroach/pull/131619
[04c161f65]: https://github.com/cockroachdb/cockroach/commit/04c161f65
[1d9dc95b8]: https://github.com/cockroachdb/cockroach/commit/1d9dc95b8
[38ed1228f]: https://github.com/cockroachdb/cockroach/commit/38ed1228f
[a8c4f088d]: https://github.com/cockroachdb/cockroach/commit/a8c4f088d
[a94db30fe]: https://github.com/cockroachdb/cockroach/commit/a94db30fe
[d3e7855c7]: https://github.com/cockroachdb/cockroach/commit/d3e7855c7
[e5e2b273f]: https://github.com/cockroachdb/cockroach/commit/e5e2b273f
