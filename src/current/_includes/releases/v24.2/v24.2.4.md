## v24.2.4

Release Date: October 17, 2024

{% include releases/new-release-downloads-docker-image.md release=include.release %}
<h3 id="v24-2-4-security-updates">Security updates</h3>

- Cluster settings for LDAP cluster settings `server.ldap_authentication.client.tls_certificate` and `server.ldap_authentication.client.tls_key` don't have callbacks installed to reload the settings value for LDAP authManager. This change fixes this by adding the necessary callbacks. [#131210][#131210]

<h3 id="v24-2-4-{{-site.data.products.enterprise-}}-edition-changes">{{ site.data.products.enterprise }} edition changes</h3>

- Updates the cluster setting `changefeed.sink_io_workers` with all the sinks that support the setting. [#130374][#130374]
- Added network metrics to the kafka v1 sink. [#130578][#130578]
- Added network metrics to webhook sinks. [#130578][#130578]
- Added network metrics to the pubsub sinks. [#130578][#130578]
- Added network metrics to the sql sink. [#130578][#130578]
- A new `changefeed.total_ranges` metric has been added and can be used to monitor the number of ranges that are watched by changefeed aggregators. It shares the same polling interval as `changefeed.lagging_ranges`, which is controlled by the existing `lagging_ranges_polling_interval` option. [#130982][#130982]
- Disambiguate metrics and logs for the 2 buffers used by the kv feed. Affected metrics now have a suffix indicating which buffer they correspond to. Affected metrics: `changefeed.buffer_entries.*`, `changefeed.buffer_entries_mem.*`, `changefeed.buffer_pushback_nanos.*`. The old versions are kept around for backwards compatibility, though their use is not recommended. [#131419][#131419]
- Added timers around key parts of the changefeed pipeline to help debug feeds experiencing issues. The `changefeed.stage.<stage>.latency` metrics now emit latency histograms for each stage. The metric respects the changefeed `scope` label for debugging specific feeds. [#131372][#131372]
- Added network metrics to the kafka v1 sink. [#131619][#131619]
- Added network metrics to webhook sinks. [#131619][#131619]
- Added network metrics to the pubsub sinks. [#131619][#131619]
- Added network metrics to the sql sink. [#131619][#131619]

<h3 id="v24-2-4-sql-language-changes">SQL language changes</h3>

- Session variable `enforce_home_region_follower_reads_enabled` is now deprecated, and will be removed in a future release. (Note that related session variable `enforce_home_region` is _not_ deprecated.) [#129587][#129587]

<h3 id="v24-2-4-operational-changes">Operational changes</h3>

- The `ranges.decommissioning` metric is added, representing the number of ranges which have a replica on a decommissioning node. [#130247][#130247]
- This commit adds two metrics changefeed.network.bytes_in and changefeed.network.bytes_out. These metrics track the number of bytes sent by the individual changefeeds to different sinks. [#130578][#130578]
- Users may set the log format for the stderr sink by setting the `format` field in the logging config under the `stderr` sink section. [#131539][#131539]
- This commit adds two metrics changefeed.network.bytes_in and changefeed.network.bytes_out. These metrics track the number of bytes sent by the individual changefeeds to different sinks. [#131619][#131619]

<h3 id="v24-2-4-db-console-changes">DB Console changes</h3>

- Some metric charts on the overview and replication pages have more terse legends to facilitate easier browsing. [#129359][#129359]
- DB Console will show a notification alerting customers without an Enterprise license, to upcoming license changes with a link to more information. [#130417][#130417]

<h3 id="v24-2-4-bug-fixes">Bug fixes</h3>

- Addressed a bug in the upgrade pre-condition for repairing descriptor corruption, which could lead to finalization being stuck [#130517][#130517]
- Fixes a potential memory leak in changefeeds using a cloud storage sink. The memory leak could occur if both changefeed.fast_gzip.enabled and changefeed.cloudstorage.async_flush.enabled are true and the changefeed received an error while attempting to write to the cloud storage sink. [#130602][#130602]
- Fixed a bug where zone configuration changes issued by the declarative schema changer were not blocked if a table had `schema_locked` set. For more information about the declarative schema changer, see: https://www.cockroachlabs.com/docs/stable/online-schema-changes#declarative-schema-changer/. [#130705][#130705]
- Fix a bug in which some SELECT FOR UPDATE or SELECT FOR SHARE queries using NOWAIT could still block on locked rows when using `optimizer_use_lock_op_for_serializable` under Serializable isolation. This bug was present when `optimizer_use_lock_op_for_serializable` was introduced in v23.2.0. [#130430][#130430]
- A bug has been fixed that the optimizer to plan unnecessary post-query uniqueness checks during `INSERT`, `UPSERT`, and `UPDATE` statements on tables with partial, unique, hash-sharded indexes. These unnecessary checks added overhead to execution of these statements, and caused the statements to error when executed under read-committed isolation. [#130570][#130570]
- Fixes a bug that could result in the inability to garbage collect a MVCC range tombstone within a global table. Epic: none Informs #129592. [#130940][#130940]
- If a connection was attempting a schema change while the same schema objects were being dropped, it was possible for the connection to be incorrectly dropped. [#130962][#130962]
- Previously, CockroachDB could incorrectly evaluate `IS NOT NULL` filter if it was applied to non-NULL tuples that had NULL elements (like `(1, NULL)` or `(NULL, NULL)`). The bug is present since 20.2 version and is now fixed. [#130947][#130947]
- A bug has been fixed which could cause errors with the message "internal error: Non-nullable column ..." when executing statements under read-committed isolation that involve tables with `NOT NULL` virtual columns. [#131019][#131019]
- The AWS endpoint and cloud custom HTTP client configuration are now considered when implicit authentication is used, whereas previously these were only considered when using explicit credentials.  Epic: none. [#131173][#131173]
- Fixes a bug that could result in the inability to garbage collect a MVCC range tombstone within a global table. Epic: none Informs #129592. [#131199][#131199]
- Fixed a bug introduced in v23.1 that can cause incorrect results when: 1. The query contains a correlated subquery. 2. The correlated subquery has a GroupBy or DistinctOn operator with an    outer-column reference in its input. 3. The correlated subquery is in the input of a Select or Join operator 4. The Select or Join has a filter that sets the outer-column reference from    (2) equal to a non-outer column in the input of the grouping operator. 5. The grouping column set does not include the replacement column, and    functionally determines the replacement column. [#130990][#130990]
- Fixes a bug where jobs created in session with non-zero session timezone offsets could hang before starting or report incorrect creation times when viewed in SHOW JOBS and the console.  Epic: none. [#131407][#131407]
- Fixes a bug that could result in the inability to garbage collect a MVCC range tombstone within a global table. Epic: none Informs #129592. [#131619][#131619]
- Fixes a potential memory leak in changefeeds using a cloud storage sink. The memory leak could occur if both changefeed.fast_gzip.enabled and changefeed.cloudstorage.async_flush.enabled are true and the changefeed received an error while attempting to write to the cloud storage sink. [#131619][#131619]
- Fix bug that could prevent a CHANGEFEED from being able to resume after being paused for prolonged period of time. [#130921][#130921]

<h3 id="v24-2-4-performance-improvements">Performance improvements</h3>

- The query optimizer now plans limited, partial index scans in more cases when the new session setting, `optimizer_push_limit_into_project_filtered_scan` is set to `on`. [#130335][#130335]
- Reduce the write-amplification impact of rebalances by splitting snapshot sstable files into smaller ones before ingesting them into Pebble. [#128997][#128997]

<h3 id="v24-2-4-miscellaneous">Miscellaneous</h3>

<h4 id="v24-2-4-changes-without-release-note-annotation">Changes without release note annotation</h4>

- [#131391][#131391] [e5e2b273f][e5e2b273f] release-24.2: backupccl: fix scheduled backup pts pushing race
- [#131311][#131311] [1d9dc95b8][1d9dc95b8] release-24.2: Console: fix sources for network ui graphs
- [#131239][#131239] [a94db30fe][a94db30fe] release-24.2: roachtest, teamcity: publish runner logs to same directory
- [#131239][#131239] [38ed1228f][38ed1228f] release-24.2: roachtest, teamcity: publish runner logs to same directory
- [#130935][#130935] [04c161f65][04c161f65] release-24.2: sqlproxyccl: static directory server lists pods when watch starts
- [#130676][#130676] [a8c4f088d][a8c4f088d] release-24.2: sqlproxyccl: skip TestFailedConnection under stress
- [#130673][#130673] [d3e7855c7][d3e7855c7] release-24.2: sqlproxyccl: add ServerlessOnly test helper

<h3 id="v24-2-4-doc-updates">Doc updates</h3>

{% comment %}Docs team: Please add these manually.{% endcomment %}



[#128997]: https://github.com/cockroachdb/cockroach/pull/128997
[#129359]: https://github.com/cockroachdb/cockroach/pull/129359
[#129587]: https://github.com/cockroachdb/cockroach/pull/129587
[#130247]: https://github.com/cockroachdb/cockroach/pull/130247
[#130335]: https://github.com/cockroachdb/cockroach/pull/130335
[#130374]: https://github.com/cockroachdb/cockroach/pull/130374
[#130417]: https://github.com/cockroachdb/cockroach/pull/130417
[#130430]: https://github.com/cockroachdb/cockroach/pull/130430
[#130517]: https://github.com/cockroachdb/cockroach/pull/130517
[#130570]: https://github.com/cockroachdb/cockroach/pull/130570
[#130578]: https://github.com/cockroachdb/cockroach/pull/130578
[#130602]: https://github.com/cockroachdb/cockroach/pull/130602
[#130673]: https://github.com/cockroachdb/cockroach/pull/130673
[#130676]: https://github.com/cockroachdb/cockroach/pull/130676
[#130705]: https://github.com/cockroachdb/cockroach/pull/130705
[#130921]: https://github.com/cockroachdb/cockroach/pull/130921
[#130935]: https://github.com/cockroachdb/cockroach/pull/130935
[#130940]: https://github.com/cockroachdb/cockroach/pull/130940
[#130947]: https://github.com/cockroachdb/cockroach/pull/130947
[#130962]: https://github.com/cockroachdb/cockroach/pull/130962
[#130982]: https://github.com/cockroachdb/cockroach/pull/130982
[#130990]: https://github.com/cockroachdb/cockroach/pull/130990
[#131019]: https://github.com/cockroachdb/cockroach/pull/131019
[#131173]: https://github.com/cockroachdb/cockroach/pull/131173
[#131199]: https://github.com/cockroachdb/cockroach/pull/131199
[#131210]: https://github.com/cockroachdb/cockroach/pull/131210
[#131239]: https://github.com/cockroachdb/cockroach/pull/131239
[#131311]: https://github.com/cockroachdb/cockroach/pull/131311
[#131372]: https://github.com/cockroachdb/cockroach/pull/131372
[#131391]: https://github.com/cockroachdb/cockroach/pull/131391
[#131407]: https://github.com/cockroachdb/cockroach/pull/131407
[#131419]: https://github.com/cockroachdb/cockroach/pull/131419
[#131539]: https://github.com/cockroachdb/cockroach/pull/131539
[#131619]: https://github.com/cockroachdb/cockroach/pull/131619
[04c161f65]: https://github.com/cockroachdb/cockroach/commit/04c161f65
[1d9dc95b8]: https://github.com/cockroachdb/cockroach/commit/1d9dc95b8
[38ed1228f]: https://github.com/cockroachdb/cockroach/commit/38ed1228f
[a8c4f088d]: https://github.com/cockroachdb/cockroach/commit/a8c4f088d
[a94db30fe]: https://github.com/cockroachdb/cockroach/commit/a94db30fe
[d3e7855c7]: https://github.com/cockroachdb/cockroach/commit/d3e7855c7
[e5e2b273f]: https://github.com/cockroachdb/cockroach/commit/e5e2b273f
