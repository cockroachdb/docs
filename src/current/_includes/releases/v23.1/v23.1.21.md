## v23.1.21

Release Date: May 7, 2024

{% include releases/release-downloads-docker-image.md release=include.release %}

<h3 id="v23-1-21-sql-language-changes">SQL language changes</h3>

- The `FORCE_INVERTED_INDEX` hint is now supported. This makes the optimizer prefer a query plan scan over any inverted index of the hinted table. The query will result in an error if no such query plan can be generated. [#122301][#122301]
- Introduce three new cluster settings for controlling table statistics forecasting:  1. `sql.stats.forecasts.min_observations` is the minimum number of    observed statistics required to produce a forecast.  2. `sql.stats.forecasts.min_goodness_of_fit` is the minimum RÂ² (goodness    of fit) measurement required from all predictive models to use a    forecast.  3. `sql.stats.forecasts.max_decrease` is the most a prediction can    decrease, expressed as the minimum ratio of the prediction to the    lowest prior observation. [#122990][#122990]
- Added a setting optimizer_use_improved_multi_column_selectivity_estimate, which if enabled, causes the optimizer to use an improved selectivity estimate for multi-column predicates. This setting will default to true on versions 24.2+, and false on prior versions. [#123068][#123068]

<h3 id="v23-1-21-operational-changes">Operational changes</h3>

- A minimum Raft scheduler concurrency is now enforced per store so that nodes with many stores do not spread workers too thin. This avoids high scheduler latency across replicas on a store when load is imbalanced. [#120797][#120797]

<h3 id="v23-1-21-bug-fixes">Bug fixes</h3>

- A slow memory leak that can accumulate when opening many new connections has been fixed. The bug is present in 22.2.9+ and 23.1+ versions. [#121056][#121056]
- Sequence options for 'NO MINVALUE' and 'NO MAXVALUE' now replicate postgreSQL.  Sequence MINVALUE and MAXVALUE automatical adjust to new types bounds mirroring behavior of postgreSQL. [#121307][#121307]
- The timeseries graphs shown on the SQL Activity statement details page in DB Console will now render properly, after fixing a bug related to setting the time range of the charts. [#121382][#121382]
- CockroachDB could previously incorrectly evaluate IN expressions that had INT2 or INT4 type on the left side and values outside of the range of the left side on the right side. The bug has been present since at least 21.1 and is now fixed. [#121955][#121955]
- CockroachDB could previously "leak" reported memory usage (as accounted by the internal memory accounting system, the limit for which is configured via --max-sql-memory flag) on long-running sessions that issue many (hundreds of thousands or more) transactions. This, in turn, could result in "root: memory budget exceeded" errors for other queries. The bug is present in versions 23.1.17 and 23.2.3 and is now fixed. [#121949][#121949]
- The timeseries graphs shown on the SQL Activity statement details page in DB Console will now render properly, after fixing a bug related to setting the time range of the charts. [#122235][#122235]
- CockroachDB could previously "leak" reported memory usage (as accounted by the internal memory accounting system, the limit for which is configured via --max-sql-memory flag) on long-running sessions that issue many (hundreds of thousands or more) transactions. This, in turn, could result in "root: memory budget exceeded" errors for other queries. The bug is present in versions 23.1.17 and 23.2.3 and is now fixed. [#122235][#122235]
- Reintroduce sql.auth.modify_cluster_setting_applies_to_all.enabled so that mixed version clusters can migrate off this setting. [#122055][#122055]
- GRANT <...> ON ALL TABLES could fail if sequences existed and they did not support a privilege (for example BACKUP). [#122057][#122057]
- Reintroduce sql.auth.modify_cluster_setting_applies_to_all.enabled so that mixed version clusters can migrate off this setting. [#122635][#122635]
- Client Certificate Auth combined with identity maps(server.identity_map.configuration) was broken in 23.1. This bug is fixed; note that the feature to work correctly, the client must specify a valid db user in connection string.  Release justification: the fix needs to go in for addressing bug related to the issue [#122746][#122746]
- Statistics forecasts of zero rows can cause bad plans. This commit changes forecasting to avoid predicting zero rows for most downward-trending statistics. [#122990][#122990]

<h3 id="v23-1-21-performance-improvements">Performance improvements</h3>

- More efficient query plans are now generated for queries with text similarity filters, e.g., `text_col % 'foobar'`. These plans are generated if the `optimizer_use_trigram_similarity_optimization` session setting is enabled. It is disabled by default. [#122683][#122683]
- Added a new setting optimizer_use_improved_zigzag_join_costing. When enabled, the cost of zigzag joins is updated so they will be never be chosen over scans unless they produce fewer rows. This change only matters if the setting enable_zigzag_join is also true. [#123068][#123068]
- Improved the selectivity estimation of multi-column filters when the multi-column distinct count is high. This avoids cases where we significantly over-estimate the selectivity of a multi-column predicate and as a result can prevent the optimizer from choosing a bad query plan. [#123068][#123068]

<h3 id="v23-1-21-doc-updates">Doc updates</h3>

{% comment %}Docs team: Please add these manually.{% endcomment %}

<div class="release-note-contributors" markdown="1">

<h3 id="v23-1-21-contributors">Contributors</h3>

This release includes 59 merged PRs by 26 authors.
We would like to thank the following contributors from the CockroachDB community:

- Andrew Delph (first-time contributor)
- Darryl Wong (first-time contributor, CockroachDB team member)
- David Hartunian (first-time contributor, CockroachDB team member)
- Sourav Sarangi (first-time contributor, CockroachDB team member)

</div>

[#120797]: https://github.com/cockroachdb/cockroach/pull/120797
[#121056]: https://github.com/cockroachdb/cockroach/pull/121056
[#121307]: https://github.com/cockroachdb/cockroach/pull/121307
[#121382]: https://github.com/cockroachdb/cockroach/pull/121382
[#121949]: https://github.com/cockroachdb/cockroach/pull/121949
[#121955]: https://github.com/cockroachdb/cockroach/pull/121955
[#122055]: https://github.com/cockroachdb/cockroach/pull/122055
[#122057]: https://github.com/cockroachdb/cockroach/pull/122057
[#122235]: https://github.com/cockroachdb/cockroach/pull/122235
[#122301]: https://github.com/cockroachdb/cockroach/pull/122301
[#122635]: https://github.com/cockroachdb/cockroach/pull/122635
[#122683]: https://github.com/cockroachdb/cockroach/pull/122683
[#122746]: https://github.com/cockroachdb/cockroach/pull/122746
[#122990]: https://github.com/cockroachdb/cockroach/pull/122990
[#123068]: https://github.com/cockroachdb/cockroach/pull/123068
