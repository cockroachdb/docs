## v23.1.2

Release Date: May 30, 2023

{% include releases/new-release-downloads-docker-image.md release=include.release %}

<h3 id="v23-1-2-backward-incompatible-changes">Backward-incompatible changes</h3>

- Schema names in the [`search_path`](https://www.cockroachlabs.com/docs/v23.1/sql-name-resolution#search-path) session variable now respect case and must be delimited with double quotation marks. Previously, if a `search_path` was specified in the connection string parameters, it would be treated case insensitive by default. [#101493][#101493]

 [#101493][#101493]

<h3 id="v23-1-2-general-changes">General changes</h3>

- Queries with invalid syntax are now logged at [the `INFO` level](https://www.cockroachlabs.com/docs/v23.1/logging#info) in the `SQL_EXEC` log channel. Previously, these were logged at the `ERROR` level. [#101094][#101094]

<h3 id="v23-1-2-{{-site.data.products.enterprise-}}-edition-changes">{{ site.data.products.enterprise }} edition changes</h3>

- [CDC queries](https://www.cockroachlabs.com/docs/v23.1/cdc-queries) now support wrapped envelope with diff (`envelope='wrapped', diff`). [#101392][#101392]
- [Changefeeds using the `WITH confluent_schema_registry` option](https://www.cockroachlabs.com/docs/v23.1/stream-a-changefeed-to-a-confluent-cloud-kafka-cluster) will make fewer duplicate schema registrations. [#100844][#100844]
- Added logic to set the cluster's multi-region system database's [survival goal](https://www.cockroachlabs.com/docs/v23.1/multiregion-overview#survival-goals) to the max non-system database's survival whenever an `ALTER DATABASE...SURVIVE...FAILURE` is issued. [#102379][#102379]
- [Cluster SSO using JSON web tokens](https://www.cockroachlabs.com/docs/v23.1/sso-sql) (JWT) can now read SQL usernames from any JWT claims instead of requiring the subject claim to be used. The claim can be controlled by the `server.jwt_authentication.claim` [cluster setting](https://www.cockroachlabs.com/docs/v23.1/cluster-settings) with an empty string or "sub" equivalent to the previous behavior. [#103526][#103526]

<h3 id="v23-1-2-sql-language-changes">SQL language changes</h3>

- Added a new [session variable](https://www.cockroachlabs.com/docs/v23.1/set-vars) `unbounded_parallel_scans`, which controls whether scans will be parallelized across [ranges](https://www.cockroachlabs.com/docs/v23.1/architecture/overview#architecture-range) in more cases. Note that using this feature can lead to increased likelihood of [out-of-memory errors (OOMs)](https://www.cockroachlabs.com/docs/v23.1/cluster-setup-troubleshooting#out-of-memory-oom-crash), so it should be used with care (namely when you expect that the scan should read a "reasonable" number of rows - probably less than 10k). Also note that [queries with `LIMIT`s](https://www.cockroachlabs.com/docs/v23.1/limit-offset) aren't affected by this variable; cross-range parallelism of scans continue to be disabled for such queries. [#100948][#100948]
- Statements of type [`SET ...`](https://www.cockroachlabs.com/docs/v23.1/set-vars) are not longer displayed on the [Insights page](https://www.cockroachlabs.com/docs/v23.1/ui-insights-page). [#101669][#101669]
- Fixed [`crdb_internal.transaction_contention_events`](https://www.cockroachlabs.com/docs/v23.1/crdb-internal#transaction_contention_events), so it generates even if an error occurs when getting the names. [#101870][#101870]
- Added a new SQL activity updater job which updates the `system.transaction_activity` and `system.statement_activity` tables based on the [statistics](https://www.cockroachlabs.com/docs/v23.1/ui-statements-page#statement-statistics) tables. [#101996][#101996]
- Added two views to the [`crdb_internal catalog`](https://www.cockroachlabs.com/docs/v23.1/crdb-internal): `crdb_internal.statement_activity`, which surfaces data in the `persisted system.statement_activity` table and `crdb_internal.transaction_activity`, which surfaces the `system.transaction_activity` table. [#102002][#102002]
- Tables with [Row-level TTL](https://www.cockroachlabs.com/docs/v23.1/row-level-ttl) settings can now have outbound [foreign keys](https://www.cockroachlabs.com/docs/v23.1/foreign-key). [#101874][#101874]
- Span statistics are now unavailable on mixed-version clusters. [#101877][#101877]
- Introduced the `to_char(date, format)` [built-in function](https://www.cockroachlabs.com/docs/v23.1/functions-and-operators), which converts a given date to a string using the given format string. [#102989][#102989]
- Renamed an existing metric `changefeed.table_metadata_nanos` to `changefeed.schemafeed.table_metadata_nanos` and introduced a new metric `changefeed.schemafeed.table_history_scans`, which records the number of table history scans the [schema feed](https://www.cockroachlabs.com/docs/v23.1/changefeed-examples) performs. [#102977][#102977]
- Changed the [`OID`](https://www.cockroachlabs.com/docs/v23.1/oid) generation for `pg_catalog`. For example `column`, `index` and `constraint` `OID`'s will have different values. `Relation`, `type` and `function` `OID`'s remain unchanged. [#103556][#103556]
- Added a new [session setting](https://www.cockroachlabs.com/docs/v23.1/set-vars) `optimizer_use_improved_computed_column_filters_derivation`, which defaults to `FALSE`. When `TRUE`, the optimizer will derive filters on computed columns in more cases. [#103412][#103412]
- `Crdb_internal.transaction_contention_events`, `crdb_internal.node_contention_events`, and `crdb_internal.cluster_locks` will now redact keys provided the user has [`VIEWACTIVITYREDACTED`](https://www.cockroachlabs.com/docs/v23.1/security-reference/authorization). `Crdb_internal.node_contention_events` can only be viewed if the user has any of `admin`, `VIEWACTIVITY` or `VIEWACTIVITYREDACTED`. [#103637][#103637]

<h3 id="v23-1-2-operational-changes">Operational changes</h3>

- Added the `rebalancing.replicas.cpunanospersecond` histogram [metric](https://www.cockroachlabs.com/docs/v23.1/metrics), which provides insight into the distribution of replica CPU usage within a store. [#100509][#100509]
- Added the `rebalancing.replicas.queriespersecond` histogram [metric](https://www.cockroachlabs.com/docs/v23.1/metrics), which provides insight into the distribution of queries per replica within a store. [#100509][#100509]
- The amount of [replication](https://www.cockroachlabs.com/docs/v23.1/architecture/replication-layer) traffic in flight from a single [Raft leader](https://www.cockroachlabs.com/docs/v23.1/architecture/reads-and-writes-overview#architecture-raft-leader) to a follower has been reduced from 256 MB to 32 MB. This reduces the chance of running out-of-memory during bulk write operations. This can be controlled via the environment variable `COCKROACH_RAFT_MAX_INFLIGHT_BYTES`. [#101507][#101507]
- Added the [metric](https://www.cockroachlabs.com/docs/v23.1/metrics) `leases.requests.latency`, which records a histogram of lease request latencies. [#100475][#100475]
- When local corruption of data is encountered by a background job in the [storage engine](https://www.cockroachlabs.com/docs/v23.1/architecture/storage-layer), a node will now exit immediately. [#102274][#102274]
- When the [`--experimental-dns-srv`](https://www.cockroachlabs.com/docs/v23.1/cockroach-start#networking) flag is enabled, the `crdb` node will always attempt to query SRV records of an address when dialing remote targets, and fall back to use the address verbatim if the SRV query fails. Previously, SRV queries were only attempted once when a node starts. [#102468][#102468]
- The default Raft scheduler concurrency, controlled by `COCKROACH_SCHEDULER_CONCURRENCY` and defaulting to 8 per CPU core capped at 96, is now divided evenly across stores instead of applying individually per store. This avoids excessive Go scheduler pressure and memory usage on nodes with many stores. The common case of 1 store per node is not affected. [#103073][#103073]
- Workload generators now export Go runtime metrics via [Prometheus](https://www.cockroachlabs.com/docs/v23.1/monitor-cockroachdb-with-prometheus) endpoint. [#102392][#102392]
- [Multi-region](https://www.cockroachlabs.com/docs/v23.1/multiregion-overview) Serverless databases that are created without a primary region will now inherit regions from the Serverless cluster's regions. [#102627][#102627]

<h3 id="v23-1-2-command-line-changes">Command-line changes</h3>

- The [`cockroach debug zip`](https://www.cockroachlabs.com/docs/v23.1/cockroach-debug-zip) command now accepts an `--include-range-info` flag, which determines whether CockroachDB retrieves individual `nodes/*/ranges/*.json` files, which was previously done by default. For large clusters, this can dramatically reduce the size of the generated artifacts. This flag defaults to `FALSE`. [#102862][#102862]
- [Workload](https://www.cockroachlabs.com/docs/v23.1/cockroach-workload) now jitters the teardown of connections to prevent a [thundering herd](https://wikipedia.org/wiki/Thundering_herd_problem) of queries impacting P99 latency results. [#102395][#102395]
- Workload utility now has flags to tune the [connection pool](https://www.cockroachlabs.com/docs/v23.1/connection-pooling) used for testing.  See `--conn-healthcheck-period`, `--min-conns`, and `--max-conn-*` flags for details. [#102395][#102395]
- Workload now supports every [PostgreSQL query mode](https://github.com/jackc/pgx/blob/fa5fbed497bc75acee05c1667a8760ce0d634cba/conn.go#L167-L182) available via the underlying `pgx` driver. [#102395][#102395]
- The `\connect` client-side command for the SQL shell (included in `cockroach sql`, `cockroach demo`, `cockroach-sql`) now recognizes the option `autocerts` as its last argument.  When provided, `\c` will now try to discover a [Transport Layer Security (TLS)](https://www.cockroachlabs.com/docs/v23.1/security-reference/transport-layer-security) client certificate and key in the same directory(ies) as used by the previous connection URL.  This feature makes it easier to switch usernames when TLS client/key files are available for both the previous and new username. [#103144][#103144]

<h3 id="v23-1-2-db-console-changes">DB Console changes</h3>

- The `Application Name` column is now shown by default in the [Fingerprints Overview](https://www.cockroachlabs.com/docs/v23.1/ui-statements-page#statement-fingerprints-view) pages. Statements and transactions fingerprints will be displayed per application on the Overview pages rather than grouped into a single fingerprint ID. [#101164][#101164]
- When going from the [Fingerprints Overview](https://www.cockroachlabs.com/docs/v23.1/ui-statements-page#statement-fingerprints-view) pages or the [Insight Details](https://www.cockroachlabs.com/docs/v23.1/ui-insights-page) pages to the Fingerprint Details page, the Details page will fetch data for the statement with the provided application name. For Overview pages, this is the application name of the selected row. For Insight details, this is the application of the execution that generated the insight. [#101164][#101164]
- Updated the [Network Latency](https://www.cockroachlabs.com/docs/v23.1/ui-network-latency-page) side nav name and Network Diagnostics page title to Network. Updated the [Advanced Debugging](https://www.cockroachlabs.com/docs/v23.1/ui-debug-pages) page title to Advanced Debug. [#101758][#101758]
- Added an option to select the trace rate for [Statement Diagnostics](https://www.cockroachlabs.com/docs/v23.1/ui-statements-page#diagnostics) collection. [#101759][#101759]
- Added a time scale selector to the [Statement Diagnostics](https://www.cockroachlabs.com/docs/v23.1/ui-statements-page#diagnostics) page, making it possible to see bundles only from the selected period. [#101802][#101802]
- Added draining node as its own value on the [DB Console Overview](https://www.cockroachlabs.com/docs/v23.1/ui-overview) page, instead of counting it as a dead node. [#101793][#101793]
- Added the ability for users to view timestamps in [DB Console](https://www.cockroachlabs.com/docs/v23.1/ui-overview) in their preferred timezone via the cluster setting `ui.display_timezone`. Previously, only the timezones Coordinated Universal Time and America/New_York were supported. [#102195][#102195]
- An alert on [DB Console Overview](https://www.cockroachlabs.com/docs/v23.1/ui-overview) page is shown when the cluster setting `cluster.preserve_downgrade_option` is set, and no longer waits 48 hours to show. [#102913][#102913]
- Added [Transaction Insights](https://www.cockroachlabs.com/docs/cockroachcloud/insights-page) for Serverless. [#103363][#103363]
- Added `_status/load` to the list of Raw Status Endpoints on the [Advanced Debug](https://www.cockroachlabs.com/docs/v23.1/ui-debug-pages) page. [#103420][#103420]
- If a page crashed, a force refresh is no longer required to be able to see the other pages on [DB Console](https://www.cockroachlabs.com/docs/v23.1/ui-overview). [#103328][#103328]
- The filter on the [SQL Activity](https://www.cockroachlabs.com/docs/v23.1/ui-overview#sql-activity) page is now working properly. Fixed the type on the JSON object from `stmtTyp` to `stmtType`. [#103411][#103411]
- Added missing information on the [Index Details](https://www.cockroachlabs.com/docs/v23.1/ui-databases-page#index-recommendations) page about latency information of most used fingerprints. [#103421][#103421]

<h3 id="v23-1-2-bug-fixes">Bug fixes</h3>

- Fixed the `sql.mem.distsql.current` [metric](https://www.cockroachlabs.com/docs/v23.1/metrics) so it would no longer double count the memory usage of remote DistSQL flows. [#100049][#100049]
- Fixed a rare bug introduced prior to v22.1 where distributed plans could cause the graceful drain of a node to become stuck retrying forever during [node shutdown](https://www.cockroachlabs.com/docs/v23.1/node-shutdown). This bug led to errors like `drain details: distSQL execution flows:`, together with a non-zero number of flows that does not reduce over a long period of time. [#100841][#100841]
- Fixed a bug that caused a [restore](https://www.cockroachlabs.com/docs/v23.1/restore) to fail occasionally due to incorrect schema ID resolution when restoring a backup with [user-defined schemas](https://www.cockroachlabs.com/docs/v23.1/schema-design-schema). [#101309][#101309]
- Fixed a bug that caused suboptimal query plans to be generated by [the optimizer](https://www.cockroachlabs.com/docs/v23.1/cost-based-optimizer) when the table being queried contained infinite values, e.g., `'+Infinity'::DECIMAL`. This bug was present since v22.1 (and likely earlier). It could also be triggered in rare cases when [table statistics](https://www.cockroachlabs.com/docs/v23.1/show-statistics) forecasts created a forecasted bucket with an infinite value. [#101135][#101135]
- Fixed a rare internal error in [the optimizer](https://www.cockroachlabs.com/docs/v23.1/cost-based-optimizer) that existed since before v22.1, which could occur while enforcing orderings between SQL operators. [#101173][#101173]
- Fixed a bug so that `crdb_internal.deserialize_session` internal function works properly with prepared statements that have more param type hints than params. [#101367][#101367]
- Fixed a bug that caused internal errors when executing [user-defined functions](https://www.cockroachlabs.com/docs/v23.1/user-defined-functions) with empty bodies. This bug was only present in alpha pre-release versions of 23.1. [#101382][#101382]
- The `search_path` [session variable](https://www.cockroachlabs.com/docs/v23.1/set-vars) now supports schema names that have commas in them. Also, fixed a bug in parsing a `search_path` with a quote in it when specified in the [connection string](https://www.cockroachlabs.com/docs/v23.1/connection-parameters). [#101493][#101493]
- Fixed a bug that has existed since [user-defined functions](https://www.cockroachlabs.com/docs/v23.1/user-defined-functions) were introduced that could cause a function call to resolve to the wrong function after changes to the [schema `search_path`](https://www.cockroachlabs.com/docs/v23.1/sql-name-resolution#current-schema). [#101491][#101491]
- Fixed an internal error that could occur when the `enforce_home_region` [session setting](https://www.cockroachlabs.com/docs/v23.1/set-vars) is on and the input to the lookup join is a `SELECT` of scalar expressions (e.g., `1+1`). Also, [subqueries](https://www.cockroachlabs.com/docs/v23.1/subqueries) with no home region now error out with `enforce_home_region` set. [#101483][#101483]
- Previously, CockroachDB alpha and beta versions of 23.1 would panic on [`cockroach start`](https://www.cockroachlabs.com/docs/v23.1/cockroach-start) command when the `GOMEMLIMIT` environment variable was set and the `--max-go-memory` flag wasn't specified. This is now fixed. [#101564][#101564]
- Fixed a bug whereby some tables' physical disk space could not be calculated by [the storage engine](https://www.cockroachlabs.com/docs/v23.1/architecture/storage-layer). [#100939][#100939]
- Fixed a bug that caused errors in test builds and potentially incorrect results in release builds when invoking a [user-defined function](https://www.cockroachlabs.com/docs/v23.1/user-defined-functions) with a subquery argument. This bug was only present in v23.1 alpha versions. [#101641][#101641]
- Point [inserts](https://www.cockroachlabs.com/docs/v23.1/insert) and [updates](https://www.cockroachlabs.com/docs/v23.1/update) that write to a remote region of a table created with the [`REGIONAL BY ROW AS`](https://www.cockroachlabs.com/docs/v23.1/create-table#create-a-table-with-a-regional-by-row-locality-using-a-custom-region-column) clause will now error out.
- Fixed a bug in the [built-in functions](https://www.cockroachlabs.com/docs/v23.1/functions-and-operators) `pg_get_indexdef` and `col_description` that could cause the functions to return errors if the user created tables named `pg_indexes` or `pg_attribute`. Or, if the user created a schema named `system` with a table named `comments`. This bug was only present in pre-release versions of v23.1. [#101688][#101688]
- The descriptions of `rebalancing.readbytespersecond` and `rebalancing.writebytespersecond` metrics now correctly reference bytes read and bytes written, respectively. [#101709][#101709]
- Fixed a bug to ensure that the [list of fingerprints](https://www.cockroachlabs.com/docs/v23.1/ui-statements-page#statement-fingerprints-view) used per index is shown even when there is a max-size limit on the SQL API. [#101783][#101783]
- Fixed a bug where, when CockroachDB failed to retrieve [contention information](https://www.cockroachlabs.com/docs/v23.1/performance-best-practices-overview#transaction-contention), the full [Insights](https://www.cockroachlabs.com/docs/v23.1/ui-insights-page) page would return an error. Now, the Insights page will load even when there is an issue with decoding contention information. [#101782][#101782]
- Fixed a bug where a [`RESTORE`](https://www.cockroachlabs.com/docs/v23.1/restore) operation with `skip_localities_check` could fail with errors if regions were missing on a cluster. [#101797][#101797]
- Fixed a bug in [the optimizer](https://www.cockroachlabs.com/docs/v23.1/cost-based-optimizer) that could cause an internal error in rare cases for a query with [outer joins](https://www.cockroachlabs.com/docs/v23.1/joins#full-outer-joins) that could be simplified to non-outer joins and at least one semi-join. This bug was present since before v22.1. [#100670][#100670]
- Fixed a bug where CockroachDB previously incorrectly evaluated [`EXPORT`](https://www.cockroachlabs.com/docs/v23.1/export) statements that had projections or rendering on top of the `EXPORT` (e.g. the [common table expression](https://www.cockroachlabs.com/docs/v23.1/common-table-expressions) `WITH cte AS (EXPORT INTO CSV 'nodelocal://1/export1/' FROM SELECT * FROM t) SELECT filename FROM cte;`). Such statements would result in panics or incorrect query results. Note that the exported data wasn't affected, only the presentation of the query result. This bug had been present since v22.1 or earlier. [#101805][#101805]
- Fixed a bug in [the optimizer](https://www.cockroachlabs.com/docs/v23.1/cost-based-optimizer) introduced in v22.2.0 that could cause queries containing a [subquery](https://www.cockroachlabs.com/docs/v23.1/subqueries) with a lateral join, in which the right side of the lateral join was an [aliased data source](https://www.cockroachlabs.com/docs/v23.1/table-expressions#aliased-table-expressions), to return an internal error in some cases. For example, it could cause an error if the subquery was provided as an argument to an [aggregate function](https://www.cockroachlabs.com/docs/v23.1/functions-and-operators#aggregate-functions). [#101863][#101863]
- Fixed handling of expressions in `IN` clauses such as `(c1, c2) IN (SELECT c3+1, c4+1 FROM ...)`. Previously, such query expressions would error out during type checking. [#102027][#102027]
- Fixed a potential bug whereby a failed or cancelled [`IMPORT`](https://www.cockroachlabs.com/docs/v23.1/import) could leave some of the imported rows behind after it was cancelled, in the rare event that the writing processes were slow enough to continue writing after the cleanup process had started. [#101443][#101443]
- Fixed a bug that could cause incorrect results for queries invoking `STRICT` [user-defined functions](https://www.cockroachlabs.com/docs/v23.1/user-defined-functions). This bug was only present in pre-release versions of 23.1. [#101950][#101950]
- Fixed a bug where CockroachDB's [pgwire](https://www.cockroachlabs.com/docs/v23.1/postgresql-compatibility) implementation would incorrectly parse arrays if they were sent as placeholder arguments to a prepared statement, and the argument had spaces in between the array elements. [#101596][#101596]
- Fixed a very rare bug that could cause keys to be unexpectedly deleted locally within a [store](https://www.cockroachlabs.com/docs/v23.1/cockroach-start#flags-store) by [replica rebalancing](https://www.cockroachlabs.com/docs/v23.1/architecture/replication-layer) during a write heavy workload. [#102167][#102167]
- Fixed a bug in the behavior of the `enforce_home_region` [session variable](https://www.cockroachlabs.com/docs/v23.1/set-vars) that may have allowed a hash join to be favored over a lookup join, or failed to error out remote accesses done by uniqueness checks for mutations on [`REGIONAL BY ROW` tables](https://www.cockroachlabs.com/docs/v23.1/regional-tables). Also, fixed static erroring of some locality-optimized lookup joins to now be handled dynamically during query execution. [#102207][#102207]
- Fixed a bug introduced in testing releases of v23.1 where a node could crash when evaluating a [`COPY`](https://www.cockroachlabs.com/docs/v23.1/copy-from) command when the schema had `INT2` or `INT4` type. [#102306][#102306]
- Fixed a bug where a [backup](https://www.cockroachlabs.com/docs/v23.1/backup-and-restore-overview) with a key's revision history split across multiple [SST files](https://www.cockroachlabs.com/docs/v23.1/architecture/storage-layer#ssts) may not have correctly restored the proper revision of the key. [#102343][#102343]
- Fixed a bug in testing releases of v23.1 where a user could be prevented from logging in or viewing or changing [`GRANT`s](https://www.cockroachlabs.com/docs/v23.1/grant) if the cluster had a long enough period of inactivity. [#102489][#102489]
- Previously, CockroachDB could encounter a "command is too large" error when evaluating [`UPSERT`](https://www.cockroachlabs.com/docs/v23.1/upsert) statements such that the new values combined exceeded the size of the `kv.raft.command.max_size` cluster setting. This bug had been present since before v21.1 and initially all write operations ([`INSERT`](https://www.cockroachlabs.com/docs/v23.1/insert), [`UPDATE`](https://www.cockroachlabs.com/docs/v23.1/update), [`DELETE`](https://www.cockroachlabs.com/docs/v23.1/delete)) were affected; however, in v21.2 those three were fixed, but `UPSERT` was forgotten about. This is now fixed. [#102514][#102514]
- Fixed a bug introduced in v22.1.19, v22.2.8, and pre-release versions of 23.1 that could cause queries to return spurious insufficient [privilege](https://www.cockroachlabs.com/docs/v23.1/security-reference/authorization) errors. For the bug to occur, two databases would need to have duplicate tables each with a [foreign key](https://www.cockroachlabs.com/docs/v23.1/foreign-key) reference to another table. The error would then occur if the same SQL string was executed against both databases concurrently by users that have [privileges](https://www.cockroachlabs.com/docs/v23.1/security-reference/authorization) over only one of the tables. [#102626][#102626]
- Fixed a bug where [`RENAME COLUMN`](https://www.cockroachlabs.com/docs/v23.1/alter-table#rename-column) was incorrectly allowed and would modify these columns node-wide. [#102460][#102460]
- Fixed a bug where the internal `node` pseudo-role was not viewable through introspection of `pg_catalog` tables. [#102662][#102662]
- Fixed a bug where [`COPY ... TO`](https://www.cockroachlabs.com/docs/v23.1/copy-from) statements would always fail when used in a prepared statement. CockroachDB now matches the pgwire handling of prepared `COPY ... TO` statements. [#102663][#102663]
- Fixed a bug where the [`ALTER DEFAULT PRIVILEGES ... GRANT USAGE ON SEQUENCES`](https://www.cockroachlabs.com/docs/v23.1/alter-default-privileges) statement would fail because the sequence object was mapped to an incorrect internal privilege object. [#102724][#102724]
- Fixed a minor bug that caused an internal error for some queries with nested [subqueries](https://www.cockroachlabs.com/docs/v23.1/subqueries) instead of the more appropriate "could not decorrelate subquery" error. This bug was only present in pre-release alpha and beta versions of 23.1. [#102384][#102384]
- Fixed a bug that allowed values to be inserted into an [`ARRAY`](https://www.cockroachlabs.com/docs/v23.1/array)-type column that did not conform to the inner-type of the array. For example, it was possible to insert `ARRAY['foo']` into a column of type `CHAR(1)[]`. This could cause incorrect results when querying the table. The insert now errors, which is expected. This bug was present since v21.1. [#102807][#102807]
- Fixed an issue where running `SHOW HISTOGRAM` to see the histogram for an [`ENUM`](https://www.cockroachlabs.com/docs/v23.1/enum)-type column could cause a panic and crash the cockroach process. This issue has existed since v20.2.0. [#102828][#102828]
- Fixed the behavior of [user-defined functions (UDFs)](https://www.cockroachlabs.com/docs/v23.1/user-defined-functions) to return its results as a row instead of a tuple when UDFs are called in a query as a data source. This is now compatible with PostgreSQL behavior. [#102188][#102188]
- Fixed a bug in [closed timestamp](https://www.cockroachlabs.com/docs/v23.1/architecture/transaction-layer#closed-timestamps) updates within its side-transport. Previously, during asymmetric partitions, a node that transfers a lease away, and misses a liveness heartbeat, could then erroneously update the closed timestamp during the stasis period of its liveness. This could lead to closed timestamp invariant violation, and node crashes; in extreme cases, this could lead to inconsistencies in read-only queries. [#102601][#102601]
- Fixed a bug where [Row-level TTL](https://www.cockroachlabs.com/docs/v23.1/row-level-ttl) jobs would incorrectly process a table that spanned multiple ranges in rare cases. This bug had been present since v22.2.0. You were affected by this bug if you saw the error message `"error decoding EncDatum of ...: did not find terminator ... in buffer ..."`. [#102881][#102881]
- The `Retry.Max` field of the [`webhook_sink_config`](https://www.cockroachlabs.com/docs/v23.1/changefeed-sinks#webhook-sink) option for changefeeds was not correctly defined in the docs. The existing docs mention that it is "The maximum amount of time the sink will retry a single HTTP request to send a batch", but this is incorrect. It actually represents the maximum number of retries which will be attempted when sending a batch in an HTTP request fails. This is now fixed to correctly capture its behavior. Also, fixed a bug where the retry time would wait for 4 seconds, regardless of `Retry.Max`. With this change, the new maximum retry time is 30 seconds. The initial backoff will keep doubling every time a retry occurs until the maximum of 30 seconds is reached.  E.g. If `Retry.Max = 4` and the initial backoff is 10 seconds, at most 4 retries will be performed with the backoff times 10, 20, 30, 30 seconds respectively. [#102958][#102958]
- Stopped using a `NULL` value for `pg_constraint.conparentid`. Now the value is hard-coded to `0`, since CockroachDB does not support constraints on [partitions](https://www.cockroachlabs.com/docs/v23.1/partitioning). [#103234][#103234]
- Fixed a bug where [`COPY`](https://www.cockroachlabs.com/docs/v23.1/copy-from) in v23.1.0 and beta versions would incorrectly encode data with multiple column families. The data must be dropped and re-imported to be encoded correctly. [#103355][#103355]
- Optimized over-head of [`pg_catalog.pg_description`](https://www.cockroachlabs.com/docs/v23.1/pg-catalog) and [`pg_catalog.pg_shdescription`](https://www.cockroachlabs.com/docs/v23.1/pg-catalog), which can lead to performance regression relative to v22.2 [#103331][#103331]
- Timeseries [metric](https://www.cockroachlabs.com/docs/v23.1/metrics) counts will now show cumulative counts for a histogram rather than a windowed count. A `-sum` timeseries is also exported to keep track of the cumulative sum of all samples in the histogram. [#103444][#103444]
- Fixed a bug where CockroachDB could produce incorrect results when evaluating queries with [`ORDER BY`](https://www.cockroachlabs.com/docs/v23.1/order-by) clause in rare circumstances. In particular, some rows could be duplicated if all of the following conditions were met:
    1. The query had a `LIMIT` clause.
    1. The `SORT` operation had to spill to disk (meaning that `LIMIT` number of rows used up non-trivial amounts of memory, e.g. the rows were "wide").
    1. The `ORDER BY` clause contained multiple columns **and** the ordering on the prefix of those columns was already provided by the index.

    The bug has been present since at least v22.1. [#102790][#102790]
- Fixed a bug where CockroachDB could previously encounter a nil pointer crash when populating data for [SQL Activity](https://www.cockroachlabs.com/docs/v23.1/ui-overview#sql-activity) page in some rare cases. The bug was present in v22.2.9 and v23.1.1 releases. [#103521][#103521]
- Fixed calls to undefined objects. [#103520][#103520]
- Fixed a bug where `0` with `exponents < -6` would display as `0E(exponent)` instead of printing all `0`s, e.g. `0E-7` should be `0.0000000`. [#103640][#103640]
- Fixed a bug that could prevent [`RESTORE`](https://www.cockroachlabs.com/docs/v23.1/restore) from working if the backup had a refresh materialized view mutation in it. [#103233][#103233]
- In earlier patch releases of v23.1, it was possible for [backups](https://www.cockroachlabs.com/docs/v23.1/backup-and-restore-overview) to be excessively slow, slower than they were in earlier releases. It was also possible for them to fail with errors of the following form: `operation "Export Request for span ..." timed out after 5m0.001s`. At least one of the reasons for this behavior is now addressed. This problem also affected v22.2 clusters if using a hidden-by-default, default-as-disabled `admission.elastic_cpu.enabled` cluster setting. [#103626][#103626]
- Fixed a crash/panic that could occur if placeholder arguments were used with the `with_min_timestamp(to_timestamp($1))` [functions](https://www.cockroachlabs.com/docs/v23.1/functions-and-operators). [#103630][#103630]
- Fixed a panic that could occur if a [`COPY TO`](https://www.cockroachlabs.com/docs/v23.1/copy-from) statement had a subquery that was logged with redaction markers. [#103689][#103689]
- Fixed a bug where [`SET PRIMARY REGION`](https://www.cockroachlabs.com/docs/v23.1/alter-database#set-primary-region) and [`SET SECONDARY REGION`](https://www.cockroachlabs.com/docs/v23.1/alter-database#set-secondary-region) did not validate transactionally, which could prevent cleaning up removed regions after a [restore](https://www.cockroachlabs.com/docs/v23.1/restore). [#103631][#103631]
- [`DROP ROLE`](https://www.cockroachlabs.com/docs/v23.1/drop-role) now correctly returns a 2BP01 error when the given role has been granted privileges on a schema. [#103546][#103546]
- Fixed a bug where, under high CPU load, HTTP requests to certain API endpoints such as the `health` endpoint would start failing and then never succeed again until the node was restarted. This bug was introduced in v23.1. [#103775][#103775]
- When the option `WITH TABLES` or `WITH INDEXES` is passed to [`SHOW RANGES`](https://www.cockroachlabs.com/docs/v23.1/show-ranges), the per-object start/end key columns now properly refers to the part of the object included inside the range identified by the current row. Previously, they could incorrectly point to keys outside of the current range's boundaries. This bug had been introduced in v23.1. [#103777][#103777]
- Fixed a bug in `VALUES` clauses containing a call to a record-returning [UDF](https://www.cockroachlabs.com/docs/v23.1/user-defined-functions) that could manifest as an internal error in some queries. [#103639][#103639]
- Fixed a bug with choosing optimal plan where [prepared statements](https://www.cockroachlabs.com/docs/v23.1/savepoint#savepoints-and-prepared-statements) using placeholders in recursive CTEs sometimes did not re-optimize correctly after plugging in the parameters. [#99823][#99823]
- Fixed a bug where `kv` was read when fetching a qualified name of a leased [UDF](https://www.cockroachlabs.com/docs/v23.1/user-defined-functions). [#103089][#103089]

<h3 id="v23-1-2-performance-improvements">Performance improvements</h3>

- Added an opt-in pacing mechanism to [rangefeed](https://www.cockroachlabs.com/docs/v23.1/create-and-configure-changefeeds#enable-rangefeeds) closed timestamp notifications. Pacing is controlled by the `kv.rangefeed.closed_timestamp_smear_interval` [cluster setting](https://www.cockroachlabs.com/docs/v23.1/cluster-settings), which defaults to `kv.rangefeed.closed_timestamp_refresh_interval`. Lowering the smear interval makes the rangefeed closed timestamp delivery less spikey, which ultimately reduces its impact on foreground SQL latencies. [#99946][#99946]
- Queries that have [subqueries](https://www.cockroachlabs.com/docs/v23.1/subqueries) in equality expressions are now more efficiently planned by [the optimizer](https://www.cockroachlabs.com/docs/v23.1/cost-based-optimizer) when `optimizer_hoist_uncorrelated_equality_subqueries` is set to `true`. [#101753][#101753]
- [SQL Activity](https://www.cockroachlabs.com/docs/v23.1/ui-sql-dashboard) dashboards now default to using a table optimized with the top data for the most used cases. Else, they use persisted data if available, and in-memory data otherwise. [#102309][#102309]
- Statistics on the `system.jobs` table are now automatically collected, which will enable [the optimizer](https://www.cockroachlabs.com/docs/v23.1/cost-based-optimizer) to produce better query plans for internal queries that access the `system.jobs` table. This may result in better performance of the system. [#102637][#102637]
- Improved [changefeeds](https://www.cockroachlabs.com/docs/v23.1/change-data-capture-overview) to decrease the commit-to-emit latency (i.e. The difference between an event's MVCC timestamp and the time it is ready to emit to a downstream sink). Previously, it is determined by a non-documented cluster setting (`changefeed.experimental_poll_interval`) which defaults to `1s`.  To enable this performance improvement, users should "lock" the watched table with [`ALTER TABLE <tbl> SET (schema_locked =t);`](https://www.cockroachlabs.com/docs/v23.1/alter-table#set-storage-parameter), which would disallow schema changes on `<tbl>`. If a schema change statement is attempted on a locked table, CockroachDB will reject it and return an error. The user could lock the table either before creating a changefeed or, when a changefeed is running, CockroachDB will be able to detect that and enable this performance improvement automatically. If the user is running a changefeed on a locked table but wishes to perform schema changes to the table, they need to explicitly unlock the table first with [`ALTER TABLE <tbl> RESET schema_locked`](https://www.cockroachlabs.com/docs/v23.1/alter-table#reset-storage-parameter). After the schema change completes, the user can lock the table again to re-gain this performance improvement. The changefeed job itself does not need to be modified in any way by the user (e.g. the user does not need to pause the job when locking/unlocking a table). This change is a "pure" optimization in that if the table is not locked, everything should still work the way it used to. [#102977][#102977]
- Improved performance when joining with the `pg_description` table. [#103331][#103331]
- Added concurrency to speed up the phase of the [restore](https://www.cockroachlabs.com/docs/v23.1/restore) that ingests backed up table statisitcs. [#102694][#102694]
- Added support for constrained scans using computed columns which are part of an [index](https://www.cockroachlabs.com/docs/v23.1/indexes) when there is an `IN` list or `OR`'ed predicate on the columns that appear in the computed column expression. [#103412][#103412]
- Added two new statistics which are useful for tracking the efficiency of [snapshot transfers](https://www.cockroachlabs.com/docs/v23.1/architecture/replication-layer#snapshots). Some snapshots will always fail due to system level "races", but the goal is to keep it as low as possible.
    - `range.snapshots.recv-failed` - The number of snapshots sent attempts that are initiated but not accepted by the recipient.
    - `range.snapshots.recv-unusable` - The number of snapshots that were fully transmitted but not used. [#101837][#101837]

<h3 id="v23-1-2-build-changes">Build changes</h3>

- Updated the reported `Build Tag` for nightly (non-release) builds. [#101998][#101998]

<div class="release-note-contributors" markdown="1">

<h3 id="v23-1-2-contributors">Contributors</h3>

This release includes 329 merged PRs by 70 authors.
We would like to thank the following contributors from the CockroachDB community:

- Eric.Yang

</div>

[#100049]: https://github.com/cockroachdb/cockroach/pull/100049
[#100475]: https://github.com/cockroachdb/cockroach/pull/100475
[#100509]: https://github.com/cockroachdb/cockroach/pull/100509
[#100670]: https://github.com/cockroachdb/cockroach/pull/100670
[#100841]: https://github.com/cockroachdb/cockroach/pull/100841
[#100844]: https://github.com/cockroachdb/cockroach/pull/100844
[#100939]: https://github.com/cockroachdb/cockroach/pull/100939
[#100948]: https://github.com/cockroachdb/cockroach/pull/100948
[#101094]: https://github.com/cockroachdb/cockroach/pull/101094
[#101135]: https://github.com/cockroachdb/cockroach/pull/101135
[#101164]: https://github.com/cockroachdb/cockroach/pull/101164
[#101173]: https://github.com/cockroachdb/cockroach/pull/101173
[#101301]: https://github.com/cockroachdb/cockroach/pull/101301
[#101309]: https://github.com/cockroachdb/cockroach/pull/101309
[#101367]: https://github.com/cockroachdb/cockroach/pull/101367
[#101382]: https://github.com/cockroachdb/cockroach/pull/101382
[#101392]: https://github.com/cockroachdb/cockroach/pull/101392
[#101428]: https://github.com/cockroachdb/cockroach/pull/101428
[#101443]: https://github.com/cockroachdb/cockroach/pull/101443
[#101483]: https://github.com/cockroachdb/cockroach/pull/101483
[#101491]: https://github.com/cockroachdb/cockroach/pull/101491
[#101493]: https://github.com/cockroachdb/cockroach/pull/101493
[#101507]: https://github.com/cockroachdb/cockroach/pull/101507
[#101564]: https://github.com/cockroachdb/cockroach/pull/101564
[#101596]: https://github.com/cockroachdb/cockroach/pull/101596
[#101641]: https://github.com/cockroachdb/cockroach/pull/101641
[#101669]: https://github.com/cockroachdb/cockroach/pull/101669
[#101688]: https://github.com/cockroachdb/cockroach/pull/101688
[#101697]: https://github.com/cockroachdb/cockroach/pull/101697
[#101709]: https://github.com/cockroachdb/cockroach/pull/101709
[#101753]: https://github.com/cockroachdb/cockroach/pull/101753
[#101758]: https://github.com/cockroachdb/cockroach/pull/101758
[#101759]: https://github.com/cockroachdb/cockroach/pull/101759
[#101782]: https://github.com/cockroachdb/cockroach/pull/101782
[#101783]: https://github.com/cockroachdb/cockroach/pull/101783
[#101793]: https://github.com/cockroachdb/cockroach/pull/101793
[#101797]: https://github.com/cockroachdb/cockroach/pull/101797
[#101802]: https://github.com/cockroachdb/cockroach/pull/101802
[#101805]: https://github.com/cockroachdb/cockroach/pull/101805
[#101809]: https://github.com/cockroachdb/cockroach/pull/101809
[#101837]: https://github.com/cockroachdb/cockroach/pull/101837
[#101863]: https://github.com/cockroachdb/cockroach/pull/101863
[#101870]: https://github.com/cockroachdb/cockroach/pull/101870
[#101874]: https://github.com/cockroachdb/cockroach/pull/101874
[#101877]: https://github.com/cockroachdb/cockroach/pull/101877
[#101950]: https://github.com/cockroachdb/cockroach/pull/101950
[#101996]: https://github.com/cockroachdb/cockroach/pull/101996
[#101998]: https://github.com/cockroachdb/cockroach/pull/101998
[#102002]: https://github.com/cockroachdb/cockroach/pull/102002
[#102027]: https://github.com/cockroachdb/cockroach/pull/102027
[#102167]: https://github.com/cockroachdb/cockroach/pull/102167
[#102188]: https://github.com/cockroachdb/cockroach/pull/102188
[#102195]: https://github.com/cockroachdb/cockroach/pull/102195
[#102207]: https://github.com/cockroachdb/cockroach/pull/102207
[#102274]: https://github.com/cockroachdb/cockroach/pull/102274
[#102306]: https://github.com/cockroachdb/cockroach/pull/102306
[#102309]: https://github.com/cockroachdb/cockroach/pull/102309
[#102343]: https://github.com/cockroachdb/cockroach/pull/102343
[#102379]: https://github.com/cockroachdb/cockroach/pull/102379
[#102384]: https://github.com/cockroachdb/cockroach/pull/102384
[#102392]: https://github.com/cockroachdb/cockroach/pull/102392
[#102395]: https://github.com/cockroachdb/cockroach/pull/102395
[#102460]: https://github.com/cockroachdb/cockroach/pull/102460
[#102468]: https://github.com/cockroachdb/cockroach/pull/102468
[#102489]: https://github.com/cockroachdb/cockroach/pull/102489
[#102514]: https://github.com/cockroachdb/cockroach/pull/102514
[#102601]: https://github.com/cockroachdb/cockroach/pull/102601
[#102626]: https://github.com/cockroachdb/cockroach/pull/102626
[#102627]: https://github.com/cockroachdb/cockroach/pull/102627
[#102637]: https://github.com/cockroachdb/cockroach/pull/102637
[#102662]: https://github.com/cockroachdb/cockroach/pull/102662
[#102663]: https://github.com/cockroachdb/cockroach/pull/102663
[#102694]: https://github.com/cockroachdb/cockroach/pull/102694
[#102700]: https://github.com/cockroachdb/cockroach/pull/102700
[#102724]: https://github.com/cockroachdb/cockroach/pull/102724
[#102790]: https://github.com/cockroachdb/cockroach/pull/102790
[#102807]: https://github.com/cockroachdb/cockroach/pull/102807
[#102828]: https://github.com/cockroachdb/cockroach/pull/102828
[#102862]: https://github.com/cockroachdb/cockroach/pull/102862
[#102881]: https://github.com/cockroachdb/cockroach/pull/102881
[#102913]: https://github.com/cockroachdb/cockroach/pull/102913
[#102947]: https://github.com/cockroachdb/cockroach/pull/102947
[#102958]: https://github.com/cockroachdb/cockroach/pull/102958
[#102977]: https://github.com/cockroachdb/cockroach/pull/102977
[#102989]: https://github.com/cockroachdb/cockroach/pull/102989
[#103073]: https://github.com/cockroachdb/cockroach/pull/103073
[#103089]: https://github.com/cockroachdb/cockroach/pull/103089
[#103144]: https://github.com/cockroachdb/cockroach/pull/103144
[#103233]: https://github.com/cockroachdb/cockroach/pull/103233
[#103234]: https://github.com/cockroachdb/cockroach/pull/103234
[#103328]: https://github.com/cockroachdb/cockroach/pull/103328
[#103331]: https://github.com/cockroachdb/cockroach/pull/103331
[#103355]: https://github.com/cockroachdb/cockroach/pull/103355
[#103363]: https://github.com/cockroachdb/cockroach/pull/103363
[#103411]: https://github.com/cockroachdb/cockroach/pull/103411
[#103412]: https://github.com/cockroachdb/cockroach/pull/103412
[#103420]: https://github.com/cockroachdb/cockroach/pull/103420
[#103421]: https://github.com/cockroachdb/cockroach/pull/103421
[#103444]: https://github.com/cockroachdb/cockroach/pull/103444
[#103450]: https://github.com/cockroachdb/cockroach/pull/103450
[#103451]: https://github.com/cockroachdb/cockroach/pull/103451
[#103466]: https://github.com/cockroachdb/cockroach/pull/103466
[#103474]: https://github.com/cockroachdb/cockroach/pull/103474
[#103520]: https://github.com/cockroachdb/cockroach/pull/103520
[#103521]: https://github.com/cockroachdb/cockroach/pull/103521
[#103526]: https://github.com/cockroachdb/cockroach/pull/103526
[#103546]: https://github.com/cockroachdb/cockroach/pull/103546
[#103556]: https://github.com/cockroachdb/cockroach/pull/103556
[#103559]: https://github.com/cockroachdb/cockroach/pull/103559
[#103626]: https://github.com/cockroachdb/cockroach/pull/103626
[#103630]: https://github.com/cockroachdb/cockroach/pull/103630
[#103631]: https://github.com/cockroachdb/cockroach/pull/103631
[#103637]: https://github.com/cockroachdb/cockroach/pull/103637
[#103639]: https://github.com/cockroachdb/cockroach/pull/103639
[#103640]: https://github.com/cockroachdb/cockroach/pull/103640
[#103689]: https://github.com/cockroachdb/cockroach/pull/103689
[#103775]: https://github.com/cockroachdb/cockroach/pull/103775
[#103777]: https://github.com/cockroachdb/cockroach/pull/103777
[#99823]: https://github.com/cockroachdb/cockroach/pull/99823
[#99946]: https://github.com/cockroachdb/cockroach/pull/99946
[0903f9790]: https://github.com/cockroachdb/cockroach/commit/0903f9790
[194007ac9]: https://github.com/cockroachdb/cockroach/commit/194007ac9
[26f915186]: https://github.com/cockroachdb/cockroach/commit/26f915186
[406baeb6b]: https://github.com/cockroachdb/cockroach/commit/406baeb6b
[448802fbd]: https://github.com/cockroachdb/cockroach/commit/448802fbd
[653aba7be]: https://github.com/cockroachdb/cockroach/commit/653aba7be
[8734e2c66]: https://github.com/cockroachdb/cockroach/commit/8734e2c66
[ad2e4eda2]: https://github.com/cockroachdb/cockroach/commit/ad2e4eda2
[c6f062a53]: https://github.com/cockroachdb/cockroach/commit/c6f062a53
[cab396771]: https://github.com/cockroachdb/cockroach/commit/cab396771
[ccfd125aa]: https://github.com/cockroachdb/cockroach/commit/ccfd125aa
