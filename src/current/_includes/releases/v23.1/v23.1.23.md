## v23.1.23

Release Date: June 20, 2024

{% include releases/new-release-downloads-docker-image.md release=include.release %}

<h3 id="v23-1-23-{{-site.data.products.enterprise-}}-edition-changes">{{ site.data.products.enterprise }} edition changes</h3>

- Fixed a bug in v22.2+ where long running initial scans may incorrectly restore checkpoint job progress and drop events during node / changefeed restart. This issue was most likely to occur in clusters with: 1) changefeed.shutdown_checkpoint.enabled (v23.2) is set 2) Multiple table targets in a changefeed, or 3) Low changefeed.frontier_checkpoint_frequency or low changefeed.frontier_highwater_lag_checkpoint_threshold. [#123970][#123970]
- Fixed a bug in v22.2+ where long running initial scans may incorrectly restore checkpoint job progress and drop events during node / changefeed restart. This issue was most likely to occur in clusters with: 1) changefeed.shutdown_checkpoint.enabled (v23.2) is set 2) Multiple table targets in a changefeed, or 3) Low changefeed.frontier_checkpoint_frequency or low changefeed.frontier_highwater_lag_checkpoint_threshold. [#124759][#124759]
- Changefeeds now use the BulkOracle for planning, which distributes work evenly across all replica in the locality filter, including followers if enabled. This is enabled by default with the cluster setting `changefeed.balanced_distribution.enabled`. If disabled, changefeed planning reverts to its previous bin packing oracle. [#124930][#124930]

<h3 id="v23-1-23-sql-language-changes">SQL language changes</h3>

- Introduce three new cluster settings for controlling table statistics forecasting:  1. `sql.stats.forecasts.min_observations` is the minimum number of    observed statistics required to produce a forecast.  2. `sql.stats.forecasts.min_goodness_of_fit` is the minimum RÂ² (goodness    of fit) measurement required from all predictive models to use a    forecast.  3. `sql.stats.forecasts.max_decrease` is the most a prediction can    decrease, expressed as the minimum ratio of the prediction to the    lowest prior observation. [#124076][#124076]
- Added a setting optimizer_use_improved_multi_column_selectivity_estimate, which if enabled, causes the optimizer to use an improved selectivity estimate for multi-column predicates. This setting will default to true on versions 24.2+, and false on prior versions. [#124076][#124076]
- We are now setting ttl_delete_rate_limit to 100, this sets the default rate limit for deleting expired rows to 100. [#124362][#124362]
- Do not limit precision when encoding geo data types to JSON. [#124534][#124534]

<h3 id="v23-1-23-operational-changes">Operational changes</h3>

- The client_authentication_ok and client_session_end messages are now logged to the SESSIONS log channel unconditionally. Previously, these would only be logged if the server.auth_log.sql_sessions.enabled cluster setting was changed to true. All other SESSIONS log messages are still only logged if server.auth_log.sql_sessions.enabled or server.auth_log.sql_connections.enabled are set to true.  If you do not want to see client_authentication_ok or client_session_end messages, then the SESSIONS log channel can be disabled entirely. [#124375][#124375]

<h3 id="v23-1-23-db-console-changes">DB Console changes</h3>

- Viewing SQL Activity sorted by `% of Runtime` now correctly sorts entries by the runtime amount. [#123899][#123899]
- The favicon now renders properly for DB Console along with other image files. [#122702][#122702]

<h3 id="v23-1-23-bug-fixes">Bug fixes</h3>

- Fix a bug where a failed RESTORE could leave the system in a state where re-attempting the restore was not possible without manual intervention. [#123462][#123462]
- Index recommendations in the DB Console will now function properly for indexes on tables/columns whose names contain quotation marks and/or whitespace. For example: `CREATE INDEX ON "my table" ("my col");` [#122117][#122117]
- Client Certificate Auth combined with identity maps(server.identity_map.configuration) was broken in 23.1. This bug is fixed; note that the feature to work correctly, the client must specify a valid db user in connection string.  Release justification: the fix needs to go in for addressing bug related to the issue [#124076][#124076]
- Statistics forecasts of zero rows can cause bad plans. This commit changes forecasting to avoid predicting zero rows for most downward-trending statistics. [#124076][#124076]
- Drop role/user could leave references behind inside types, which could prevent SHOW GRANTS from working [#124645][#124645]
- Scattering a range with replication factor=1, no longer erroneously up-replicates the range to two replicas. Leases will also no longer thrash between nodes when perturbed with replication factor=1. [#124500][#124500]
- Previously, if the ttl_row_stats_poll_interval storage parameter was non-zero for a table with row level TTL enabled, the queries issued to update row stats could block the job from completing. Now, if the job completes, these stats queries are cancelled instead. This means that the jobs.row_level_ttl.total_rows and jobs.row_level_ttl.total_expired_rows metrics will report 0 if the job finishes before the row stats queries complete. [#124625][#124625]
- The results_buffer_size session variable previously could not be configured by using the "options" query parameter in the connection string; it could only be configured as a top-level query parameter. Now, it can be configured in either part of the connection string. (This variable still cannot be changed with the SET command after the session begins.) [#124773][#124773]
- SHOW TYPES includes user defined composite types. It omitted those types ever since composite types were added in 23.1. [#124815][#124815]
- Fix a bug where a change to a user-defined type could cause queries against tables using that type to fail with an error message like:    "histogram.go:694: span must be fully contained in the bucket"  The change to the user-defined type could come directly from an ALTER TYPE statement, or indirectly from an ALTER DATABASE ADD REGION or DROP REGION statement (which implicitly change the crdb_internal_region type).  This bug has existed since UDTs were introduced in v20.2. [#125473][#125473]

<h3 id="v23-1-23-performance-improvements">Performance improvements</h3>

- More efficient query plans are now generated for queries with text similarity filters, e.g., `text_col % 'foobar'`. These plans are generated if the `optimizer_use_trigram_similarity_optimization` session setting is enabled. It is disabled by default. [#124076][#124076]
- Added a new setting optimizer_use_improved_zigzag_join_costing. When enabled, the cost of zigzag joins is updated so they will be never be chosen over scans unless they produce fewer rows. This change only matters if the setting enable_zigzag_join is also true. [#124076][#124076]
- Improved the selectivity estimation of multi-column filters when the multi-column distinct count is high. This avoids cases where we significantly over-estimate the selectivity of a multi-column predicate and as a result can prevent the optimizer from choosing a bad query plan. [#124076][#124076]

<h3 id="v23-1-23-miscellaneous">Miscellaneous</h3>

<h4 id="v23-1-23-changes-without-release-note-annotation">Changes without release note annotation</h4>

- [#124296][#124296] [268fbf5b4][268fbf5b4] release-23.1: roachprod, roachtest: use same cluster name sanitization (Darryl Wong <darryl.wong@cockroachlabs.com>)

<h3 id="v23-1-23-doc-updates">Doc updates</h3>

{% comment %}Docs team: Please add these manually.{% endcomment %}

<div class="release-note-contributors" markdown="1">

<h3 id="v23-1-23-contributors">Contributors</h3>

This release includes 48 merged PRs by 23 authors.
We would like to thank the following contributors from the CockroachDB community:

- Darryl Wong (first-time contributor, CockroachDB team member)
- David Hartunian (first-time contributor, CockroachDB team member)
- Matt Spilchen (first-time contributor, CockroachDB team member)
- Rachael Harding (first-time contributor, CockroachDB team member)

</div>

[#122117]: https://github.com/cockroachdb/cockroach/pull/122117
[#122702]: https://github.com/cockroachdb/cockroach/pull/122702
[#123462]: https://github.com/cockroachdb/cockroach/pull/123462
[#123899]: https://github.com/cockroachdb/cockroach/pull/123899
[#123970]: https://github.com/cockroachdb/cockroach/pull/123970
[#124076]: https://github.com/cockroachdb/cockroach/pull/124076
[#124296]: https://github.com/cockroachdb/cockroach/pull/124296
[#124362]: https://github.com/cockroachdb/cockroach/pull/124362
[#124375]: https://github.com/cockroachdb/cockroach/pull/124375
[#124500]: https://github.com/cockroachdb/cockroach/pull/124500
[#124534]: https://github.com/cockroachdb/cockroach/pull/124534
[#124625]: https://github.com/cockroachdb/cockroach/pull/124625
[#124645]: https://github.com/cockroachdb/cockroach/pull/124645
[#124759]: https://github.com/cockroachdb/cockroach/pull/124759
[#124773]: https://github.com/cockroachdb/cockroach/pull/124773
[#124815]: https://github.com/cockroachdb/cockroach/pull/124815
[#124930]: https://github.com/cockroachdb/cockroach/pull/124930
[#125473]: https://github.com/cockroachdb/cockroach/pull/125473
[268fbf5b4]: https://github.com/cockroachdb/cockroach/commit/268fbf5b4
