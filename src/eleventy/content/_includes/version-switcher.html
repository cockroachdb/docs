{% assign DEBUG=false %}

{% comment %}In Eleventy, version data comes from the directory data file (v26.1.11tydata.js){% endcomment %}
{% comment %}It's accessed as 'version' directly, not 'page.version' like in Jekyll{% endcomment %}

{% comment %}Get current version's pre-computed data from allVersions{% endcomment %}
{% assign current_version_data = null %}
{% for v in allVersions %}
  {% if v.version.version == version.version %}
    {% assign current_version_data = v %}
    {% break %}
  {% endif %}
{% endfor %}

{% unless current_version_data %}
  {% comment %}Fallback - version not found in allVersions{% endcomment %}
  <!-- Warning: Could not find version data for {{ version.version }} -->
{% endunless %}

{% comment %}Calculate the current page's path segment (after the version){% endcomment %}
{% comment %}page.url is like /v26.1/start-a-local-cluster - extract the part after version{% endcomment %}
{% assign current_page_path = page.url | replace: version.version, "VERSION_PLACEHOLDER" | split: "VERSION_PLACEHOLDER/" | last %}

{% if DEBUG %}
<!-- DEBUG: version = {{ version | json }} -->
<!-- DEBUG: current_version_data = {{ current_version_data | json }} -->
<!-- DEBUG: page.url = {{ page.url }} -->
<!-- DEBUG: current_page_path = {{ current_page_path }} -->
{% endif %}

<div class="mt-3 mb-4">
<div id="version-switcher">
  <ul class="nav">
    <li class="tier-1">
      <a href="#">

        {% comment %}Display the page version we are currently viewing{% endcomment %}
        {% if current_version_data.hasReleases == false %}
          {% comment %}No releases yet - show special text{% endcomment %}
          Version <span class="version-name">{{ version.version }} (No testing releases available)</span>{% if current_version_data.isLts %}&nbsp;LTS&nbsp;{% endif %}
        {% else %}
          {% comment %}Has releases - show normal text{% endcomment %}
          Version <span class="version-name">{{ version.name }}</span>{% if current_version_data.isLts %}&nbsp;LTS&nbsp;{% endif %}
        {% endif %}
        <div class="arrow"></div>
      </a>
      <ul class="list-unstyled"  style="display: none">
        {% comment %}Build the list of versions{% endcomment %}

        {% for v in allVersions %}
          {% comment %}Only show versions that have releases{% endcomment %}
          {% if v.hasReleases %}

        {% comment %}Calculate the URL for this version by combining version + page path{% endcomment %}
        {% assign version_page_url = "/" | append: v.version.version | append: "/" | append: current_page_path %}
        <li class="tier-2 {% if v.version.version == version.version %}active{% endif %}">
          <a data-proofer-ignore
            href="{{ version_page_url | relative_url | replace: "/index.html", "" | replace: ".html", "" | downcase }}"
            class="version--mobile">
            {{ v.version.name }}{% if v.isLts %}&nbsp;LTS&nbsp;{% endif %}
          </a>
          <a data-proofer-ignore
            href="{{ version_page_url | relative_url | replace: "/index.html", "" | replace: ".html", "" | downcase }}"
            class="version--desktop">
            {{ v.version.name }}{% if v.isLts %}&nbsp;LTS&nbsp;{% endif %}
          </a>
        </li>
          {% endif %}
        {% endfor %}
      </ul>
    </li>
  </ul>
</div>
</div>

<script src="{{ 'js/initVersionSwitcher.js' | relative_url }}" async></script>
