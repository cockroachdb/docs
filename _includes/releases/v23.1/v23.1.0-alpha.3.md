## v23.1.0-alpha.3

Release Date: February 21, 2023

{% include releases/release-downloads-docker-image.md release=include.release %}

<h3 id="v23-1-0-alpha-3-general-changes">General changes</h3>

- Added new metrics to count [paused jobs](https://www.cockroachlabs.com/docs/stable/pause-job.html) for every job type. For example, the metric for paused changefeed jobs is `jobs.changefeed.currently_paused`. These metrics are updated at an interval defined by the cluster setting `jobs.metrics.interval.poll`, which defaults to 10 seconds. [#89752][#89752]

<h3 id="v23-1-0-alpha-3-{{-site.data.products.enterprise-}}-edition-changes">{{ site.data.products.enterprise }} edition changes</h3>

- Added [KMS](https://www.cockroachlabs.com/docs/stable/take-and-restore-encrypted-backups.html#use-key-management-service) support for Azure KeyVaults. Added App Registration authentication for Azure Storage and Azure KeyVault support. [#96459][#96459]
- Added a new 'coordinator_locality' option to coordinate [BACKUP](https://www.cockroachlabs.com/docs/stable/backup.html) jobs. Writing of BACKUP metadata can be restricted to nodes within designated [localities](https://www.cockroachlabs.com/docs/stable/take-and-restore-locality-aware-backups.html) using the option. [#95791][#95791]
- Fixed a bug where the server would crash if trying to restore a table from a backup generated with `BACKUP TABLE` from a schema with user defined functions, and the restore target database doesn't have a schema with the same name. [#96911][#96911]
- [Changefeeds](https://www.cockroachlabs.com/docs/v22.2/create-changefeed) with the `WITH` unordered flag can now use multiregion Google Cloud Pub/Sub topics. [#96567][#96567]
- Fixed a bug in [changefeeds](https://www.cockroachlabs.com/docs/stable/change-data-capture-overview.html), where long running initial scans will fail to generate [checkpoint](https://www.cockroachlabs.com/docs/stable/change-data-capture-overview.html). Failure to generate checkpoint is particularly bad if the changefeed restarts for whatever reason.  Without checkpoints, the changefeed will restart from the beginning, and in the worst case, when exporting substantially sized tables, the changefeed initial scan may have a hard time completing. [#96995][#96995]

<h3 id="v23-1-0-alpha-3-sql-language-changes">SQL language changes</h3>

- Added [latency info](https://www.cockroachlabs.com/docs/cockroachcloud/statements-page.html#statement-statistics) (min, max, p50, p90, p99) to crdb_internal.statement_statistics, system.statement_statistics and crdb_internal.cluster_statement_statistics. Also adds `latency_seconds_min`, `latency_seconds_max`, `latency_seconds_p50`, `latency_seconds_p90` and `latency_seconds_p99` to crdb_internal.node_statement_statistics. [#96396][#96396]
- Deprecated the PGDUMP and MYSQLDUMP formats for [IMPORT](https://www.cockroachlabs.com/docs/stable/import-performance-best-practices.html). They are still present, but will be removed in a future release. View this [page](https://www.cockroachlabs.com/docs/v22.2/migration-overview) for alternatives. [#96386][#96386]
- [`COPY ... FROM ... QUOTE '"'`](https://www.cockroachlabs.com/docs/v22.2/copy-from) will no longer error. [#96572][#96572]
- Added `last_error_code` column to the `crdb_internal.node_statement_statistics` table. Added `last_error_code` field to the `statistics` JSON blob in the `crdb_internal.statement_statistics` and `system.statement_statistics` tables. [#96436][#96436]
- Added support for expressions of the form `COLLATE "default"`, `COLLATE "C"`, and `COLLATE "POSIX"`. Since the default [collation](https://www.cockroachlabs.com/docs/stable/collate.html) cannot be changed currently, these expressions are all equivalent. The expressions are evaluated by treating the input as a normal string, and ignoring the collation.  This means that comparisons between strings and collated strings that use "default", "C", or "POSIX" are now supported.  Creating a column with the "C" or "POSIX" collations is still not supported. [#96828][#96828]
- The insights subsystem in `sqlstats` is now able to detect failed executions, regardless if they were slow or not. [#97039][#97039]
- The internal `statement_statistics` and `transaction_statistics` tables now include sampled execution statistics on storage iteration. [#96016][#96016]
- Introduced the `declare_cursor_statement_timeout_enabled` session variable which disables statement timeouts during FETCH when using DECLARE CURSOR. [#96607][#96607]

<h3 id="v23-1-0-alpha-3-operational-changes">Operational changes</h3>

- A [BACKUP](https://www.cockroachlabs.com/docs/stable/backup.html) which encounters too many retryable errors will now fail instead of pausing to allow subsequent backups the chance to succeed. [#96673][#96673]
- Added option to balance CPU time (cpu) instead of queries per second (qps) among stores in a cluster. This is done by setting `kv.allocator.load_based_rebalancing.objective='cpu'`. `kv.allocator.cpu_rebalance_threshold` is also added, similar to `kv.allocator.qps_rebalance_threshold` to control the target range for store cpu above and below the cluster mean. [#96127][#96127]
- The [load-based splitter](https://www.cockroachlabs.com/docs/v22.2/load-based-splitting) now supports using request CPU usage to split ranges. This is introduced with the previous cluster setting `kv.allocator.load_based_rebalancing.objective`, which when set to `cpu`, will use request CPU usage. The threshold above which CPU usage of a range is considered for splitting is defined in the cluster setting `kv.range_split.load_cpu_threshold`, which has a default value of `250ms`. [#96128][#96128]
- Added the flag `--disable-max-offset-check` to disable node self-termination when it detects [clock skew](https://www.cockroachlabs.com/docs/stable/operational-faqs.html#what-happens-when-node-clocks-are-not-properly-synchronized) with the rest of the cluster beyond `--max-offset`. The operator assumes responsibility for ensuring that real clock skew never exceeds `--max-offset`. [#96141][#96141]

<h3 id="v23-1-0-alpha-3-db-console-changes">DB Console changes</h3>

- Added execution insights to the [Statement Fingerprint Details](https://www.cockroachlabs.com/docs/cockroachcloud/statements-page.html#sql-statement-fingerprints) and [Transaction Fingerprint Details](https://www.cockroachlabs.com/docs/stable/ui-transactions-page.html#transaction-fingerprints-view) Pages. [#96440][#96440]
- Txn insights that were not found will now display a message `Insight not found`. [#96832][#96832]
- Added waiting statement ID and fingerprint to the [insights transaction](https://www.cockroachlabs.com/docs/stable/ui-insights-page.html#transaction-executions-view) details page. Added blocking transaction ID and fingerprint to the the [insights statement](https://www.cockroachlabs.com/docs/stable/ui-insights-page.html#statement-executions-view) page. [#96872][#96872]

<h3 id="v23-1-0-alpha-3-bug-fixes">Bug fixes</h3>

- Fixed a bug where casting a [TimeTZ](https://www.cockroachlabs.com/docs/stable/time.html) to an array results in displaying second offsets even if they are zero. [#96583][#96583]
- Allowed [`ALTER TABLE .. ADD/DROP CONSTRAINT .. NOT VALID`](https://www.cockroachlabs.com/docs/stable/alter-table.html) and [`VALIDATE CONSTRAINT ..`](https://www.cockroachlabs.com/docs/stable/alter-table.html#validate-constraints) to behave consistently with PostgreSQL. Previously, the `VALIDATE CONSTRAINT` would fail and cause the whole statement to fail.[#96648][#96648]
- Resolved the [TimestampTZ](https://www.cockroachlabs.com/docs/stable/timestamp.html) to match PostgreSQL. We previously included the minute/second offset for TimestampTZ in certain places when casting it to string even when they were zero. [#96833][#96833]
- Resolved using negative years instead of BC when casting a [TimestampTZ](https://www.cockroachlabs.com/docs/stable/timestamp.html) to a string. [#96833][#96833]
- Fixed the [`SHOW GRANTS FOR public`](https://www.cockroachlabs.com/docs/stable/show-grants.html) command so it works correctly. Previously, this would return an error saying that the `public` role does not exist. [#96957][#96957]
- Statement source (square bracket) syntax is no longer allowed in [user-defined functions](https://www.cockroachlabs.com/docs/stable/user-defined-functions.html). Prior to this fix, using this syntax in a UDF would cause a panic. This restriction will be lifted in the future. [#96824][#96824]

<h3 id="v23-1-0-alpha-3-performance-improvements">Performance improvements</h3>

- The execution of multiple [FOREIGN KEY](https://www.cockroachlabs.com/docs/stable/foreign-key.html) and [UNIQUE](https://www.cockroachlabs.com/docs/stable/unique.html) constraint checks have been parallelized in some cases. As a result, these checks should be completed faster, especially so in multi-region environments where the checks require cross-region reads. [#96123][#96123]

<h4 id="v23-1-0-alpha-3-changes-without-release-note-annotation">Changes without release note annotation</h4>

- [#96652][#96652] [8cf2cedb6][8cf2cedb6] sql/tests: add scan benchmark with multiple versions (Sumeer Bhola <sumeer@cockroachlabs.com>)

<div class="release-note-contributors" markdown="1">

<h3 id="v23-1-0-alpha-3-contributors">Contributors</h3>

This release includes 137 merged PRs by 56 authors.
We would like to thank the following contributors from the CockroachDB community:

- Ivan Gorbachev (first-time contributor)

</div>

[#89752]: https://github.com/cockroachdb/cockroach/pull/89752
[#94825]: https://github.com/cockroachdb/cockroach/pull/94825
[#95791]: https://github.com/cockroachdb/cockroach/pull/95791
[#96016]: https://github.com/cockroachdb/cockroach/pull/96016
[#96123]: https://github.com/cockroachdb/cockroach/pull/96123
[#96127]: https://github.com/cockroachdb/cockroach/pull/96127
[#96128]: https://github.com/cockroachdb/cockroach/pull/96128
[#96141]: https://github.com/cockroachdb/cockroach/pull/96141
[#96386]: https://github.com/cockroachdb/cockroach/pull/96386
[#96396]: https://github.com/cockroachdb/cockroach/pull/96396
[#96436]: https://github.com/cockroachdb/cockroach/pull/96436
[#96440]: https://github.com/cockroachdb/cockroach/pull/96440
[#96459]: https://github.com/cockroachdb/cockroach/pull/96459
[#96567]: https://github.com/cockroachdb/cockroach/pull/96567
[#96572]: https://github.com/cockroachdb/cockroach/pull/96572
[#96583]: https://github.com/cockroachdb/cockroach/pull/96583
[#96607]: https://github.com/cockroachdb/cockroach/pull/96607
[#96648]: https://github.com/cockroachdb/cockroach/pull/96648
[#96652]: https://github.com/cockroachdb/cockroach/pull/96652
[#96673]: https://github.com/cockroachdb/cockroach/pull/96673
[#96824]: https://github.com/cockroachdb/cockroach/pull/96824
[#96828]: https://github.com/cockroachdb/cockroach/pull/96828
[#96832]: https://github.com/cockroachdb/cockroach/pull/96832
[#96833]: https://github.com/cockroachdb/cockroach/pull/96833
[#96872]: https://github.com/cockroachdb/cockroach/pull/96872
[#96902]: https://github.com/cockroachdb/cockroach/pull/96902
[#96911]: https://github.com/cockroachdb/cockroach/pull/96911
[#96957]: https://github.com/cockroachdb/cockroach/pull/96957
[#96995]: https://github.com/cockroachdb/cockroach/pull/96995
[#97039]: https://github.com/cockroachdb/cockroach/pull/97039
[0529c92d4]: https://github.com/cockroachdb/cockroach/commit/0529c92d4
[14301f0d8]: https://github.com/cockroachdb/cockroach/commit/14301f0d8
[15b1c6ae6]: https://github.com/cockroachdb/cockroach/commit/15b1c6ae6
[470777fa3]: https://github.com/cockroachdb/cockroach/commit/470777fa3
[8cf2cedb6]: https://github.com/cockroachdb/cockroach/commit/8cf2cedb6
[9266fdc2a]: https://github.com/cockroachdb/cockroach/commit/9266fdc2a
[ac23f4667]: https://github.com/cockroachdb/cockroach/commit/ac23f4667
