## v22.2.1

Release Date: December 22, 2022

{% include releases/release-downloads-docker-image.md release=include.release %}

<h3 id="v22-2-1-general-changes">General changes</h3>

- CockroachDB Docker images are now multi-architecture manifests supporting the `x86_64` (`amd64`) and `arm64` architectures. [#90307][#90307]
- Bulk operations now log the destinations they are connecting to in redacted form. For example, `backup planning to connect to destination gs://test/backupadhoc?AUTH=specified&CREDENTIALS=redacted`. [#92208][#92208]

<h3 id="v22-2-0-alpha-1-backward-incompatible-changes">Backward-incompatible changes</h3>

- Changefeeds will now treat all errors, unless otherwise indicated, as [retryable errors](../v22.2/monitor-and-debug-changefeeds.html). As a result, a changefeed may not fail when it previously would have, which could cause it to become stuck retrying. [#92824][#92824]

<h3 id="v22-2-1-{{-site.data.products.enterprise-}}-edition-changes">{{ site.data.products.enterprise }} edition changes</h3>

- Changefeeds connected to [Kafka sinks](../v22.2/changefeed-sinks.html#kafka) no longer automatically retry when emitting a message batch that is rejected by the server. This is a temporary rollback of the functionality. [#90036][#90036]
- Improved the performance of the [changefeed](../v22.2/change-data-capture-overview.html) JSON encoder by 50%. [#91002][#91002]
- Added the [cluster setting](../v22.2/cluster-settings.html) `changefeed.event_consumer_workers` that allows changefeeds to process events concurrently. [#91002][#91002]
- Improved the throughput of changefeeds emitting to [cloud storage sinks](../v22.2/changefeed-sinks.html#cloud-storage-sink). [#91002][#91002]
- Changefeeds can now emit files [compressed](../v22.2/create-changefeed.html#compression-opt) with the `zstd` algorithm, which provides good compression, and is much faster than `gzip`. In addition, a new faster implementation of `gzip` is used by default. [#91002][#91002]
- Changefeed exports are up to 25% faster due to uniform work assignment. [#91002][#91002]
- The JWT authentication [cluster setting](../v22.2/cluster-settings.html) can now be modified from within tenants to better support {{ site.data.products.serverless }} use cases. [#92755][#92755]
- Added the optional JSON field `"Compression"` to the changefeed [`kafka_sink_config` option](../v22.2/changefeed-sinks.html#kafka-sink-configuration). This field can be set to `"none"` (default), `"GZIP"`, `"SNAPPY"`, `"LZ4"`, or `"ZSTD"`. Setting this field will result in the specified compression algorithm being used when emitting events. [#91275][#91275]

<h3 id="v22-2-1-sql-language-changes">SQL language changes</h3>

- Changed the `backup.restore_span.target_size` [cluster setting](../v22.2/cluster-settings.html) to default to `384MiB` so that a [restore](../v22.2/restore.html) merges up to that size of spans when reading from the backup before actually ingesting data. This should reduce the number of ranges created during restore and thereby reduce the merging of ranges that needs to occur after the restore completes. [#89351][#89351]
- Added the `SHOW FUNCTIONS` command, which lists [user-defined functions](../v22.2/user-defined-functions.html). The `SHOW FUNCTIONS FROM <schema>` syntax is supported too. [#89760][#89760]
- [`SHOW CREATE TABLE`](../v22.2/show-create.html) now shows the hash-sharded index check constraints if it is set to `NOT VALID`. [#89750][#89750]
- Marked the `sql.defaults.experimental_auto_rehoming.enabled` [cluster setting](../v22.2/cluster-settings.html) as hidden. Also, renamed the `experimental_enable_auto_rehoming` [session variable](../v22.2/set-vars.html) to `enable_auto_rehoming` and created an alias `experimental_enable_auto_rehoming` for the renamed session variable. [#90182][#90182]
- Star expressions, e.g., `SELECT * FROM ...` are no longer allowed in statements in [user-defined functions](../v22.2/user-defined-functions.html). They were allowed in early betas of v22.2 from v22.2.0-beta.1 to v22.2.0-beta.4, but have been disallowed because they do not behave correctly. [Issue #90080](https://github.com/cockroachdb/cockroach/issues/90080) tracks re-enabling star expressions in UDFs. [#90170][#90170]
- The [cluster setting](../v22.2/cluster-settings.html) `sql.ttl.default_range_concurrency` and the [table storage parameter](../v22.2/with-storage-parameter.html) `ttl_range_concurrency` are no longer configurable. [#90294][#90294]
- Added the [cluster setting](../v22.2/cluster-settings.html) `cloudstorage.azure.concurrent_upload_buffers` that configures the number of concurrent buffers used when uploading files to [Azure storage](../v22.2/use-cloud-storage-for-bulk-operations.html). [#90409][#90409]
- Added the new column `plan_gist` to [`crdb_internal.{node,cluster}_queries`](../v22.2/crdb-internal.html#cluster_queries) in order to represent the compressed logical plan. [#90557][#90557]
- Added the `sql.auth.change_own_password.enabled` [cluster setting](../v22.2/cluster-settings.html), which defaults to `false`. When set to `true`, any user is allowed to change their own password to a non-null value. Changing other [role options](../v22.2/security-reference/authorization.html#role-options) still has the same privilege requirements as before (either `CREATEROLE` or `CREATELOGIN`, depending on the option). [#90626][#90626]
- Added a new column `implicit_txn` (boolean) to [`crdb_internal.cluster_execution_insights`](../v22.2/crdb-internal.html#tables) and `crdb_internal.node_execution_insights`. [#90860][#90860]
- Previously, if a primary key name was a reserved SQL keyword, attempting to use the [`DROP CONSTRAINT, ADD CONSTRAINT`](../v22.2/drop-constraint.html#drop-and-add-a-primary-key-constraint) statements to change a primary key would result in a constraint already exists error. This is now fixed.[#90992][#90992]
- Currently the `AS OF SYSTEM TIME` value is set at the start of the TTL job (TTL cutoff - `30s`), but this results in an error similar to the following for TTL jobs that run longer than `gc.ttlseconds`: 

    ~~~
    error selecting rows to delete: ttl select defaultdb.public.events: batch timestamp 1666883527.780656000,0 must be after replica GC threshold 1666883574.542825089,0 
    ~~~

    Now, the `AS OF SYSTEM TIME` value is relative to when each `SELECT` query is run (query time - `30s`), which will prevent the error. However, each `SELECT` query will run against a different table state. If records are missed during one job invocation, they should still be picked up in the next. [#91111][#91111]
- Changed the default value of the `sql.metrics.statement_details.plan_collection.enabled` [cluster setting](../v22.2/cluster-settings.html) to `false`. [#89920][#89920]
- Implemented the `to_char(timestamp, string)` and `to_char(interval, string)` [built-in functions](../v22.2/functions-and-operators.html). [#91541][#91541]
- Added an estimate for the number of request units consumed by a query to the output of [`EXPLAIN ANALYZE`](../v22.2/explain-analyze.html) for tenant sessions. [#93179][#93179]
- `to_char` now has caching for parse formats. This shows a speed improvement when running `to_char` with the same format between sessions. [#93330][#93330]
- SQL queries running on remote nodes now show up in CPU profiles with `distsql.*` labels. Currently, these include `appname`, `gateway`, `txn`, and `stmt`. [#93516][#93516]
- Implemented the `parse_ident` [built-in](../v22.2/functions-and-operators.html). The function splits a qualified identifier into an array of identifiers, removing any quoting of individual identifiers. By default, extra characters after the last identifier are considered an error; but if the second parameter is `false`, then such extra characters are ignored. [#93635][#93635]

<h3 id="v22-2-1-operational-changes">Operational changes</h3>

- Introduced a [cluster setting](../v22.2/cluster-settings.html) `kv.mvcc_gc.queue_interval` that controls how long the MVCC GC queue waits between processing replicas. It was previously hardcoded to `1s`, but is now configurable (`1s` continues to be the default value). Incidents were observed where a large volume of MVCC GC work can prove to be disruptive to foreground traffic. Previously, this GC work had been reduced in priority to make it less disruptive. This [cluster setting](../v22.2/cluster-settings.html) can serve as a manual form of pacing if the automatic approach proves insufficient. [#89423][#89423]
- Renamed the following [TTL metrics](../v22.2/row-level-ttl.html#ttl-metrics): 
    - `jobs.row_level_ttl.range_total_duration` to `jobs.row_level_ttl.span_total_duration` 
    - `jobs.row_level_ttl.num_active_ranges` to `jobs.row_level_ttl.num_active_spans` 
[#90359][#90359]
- The [cluster setting](../v22.2/cluster-settings.html) `kv.store.admission.provisioned_bandwidth` was renamed to `kvadmission.store.provisioned_bandwidth`. [#92439][#92439]
- Made the consistency check failure message more informative by suggesting a few actions that operatios should/could do in the event it occurs. [#90564][#90564]
- Logs produced by setting an increased `vmodule` setting for `s3_storage` are now directed to the `DEV` channel rather than `STDOUT`. [#89140][#89140]
- SQL tenants now support the HTTP endpoint under `/api/v2/sql`, which allows the caller to execute an HTTP request containing SQL statements to execute, and returns the results in the JSON response. This endpoint works identically as on a non-tenant server, except that it naturally scopes to the target tenant for SQL execution. [#91994][#91994]
- Introduced the metric `replicas.leaders_invalid_lease` that indicates how many replicas are raft group leaders, but holding invalid leases. [#91193][#91193]

<h3 id="v22-2-1-command-line-changes">Command-line changes</h3>

- The `\df` metacommand was added to the SQL shell, which will list all [user-defined functions](../v22.2/user-defined-functions.html) in the current database. [#89760][#89760]

<h3 id="v22-2-1-db-console-changes">DB Console changes</h3>

- Fixed a bug that prevented usage of profiling links on the [Advanced Debug page](../v22.2/ui-debug-pages.html). [#89197][#89197]
- The [High Contention Time insight](../v22.2/ui-insights-page.html) description now accurately reflects the event's contention duration in the DB Console. [#89125][#89125]
- Requests to fetch table and database statistics now have limited concurrency. This may make loading these pages slower, but should result in reducing any performance impact these pages might have on the database under high-traffic scenarios. [#90496][#90496]
- The [Jobs Page](../v22.2/ui-jobs-page.html) now includes a column picker. [#90484][#90484]
- Added Overview and Explain Plan tabs to the **Active Statement Details** and **Statement Insight Details** pages. [#90557][#90557]
- Added a link for each fingerprint ID value for statements and transactions on [Insights page](../v22.2/ui-insights-page.html) to its respective Details page, displaying the time period of the execution of that statement/transaction. [#90860][#90860]
- Fixed the Transaction filter label on the [SQL Activity page](../v22.2/ui-overview.html#sql-activity). [#91314][#91314]
- Changed the height of the column selector to better indicate when there are more options to be selected once scrolled. [#91909][#91909]
- Added the fingerprint ID in hexadecimal format to the [Statement Details page](../v22.2/ui-statements-page.html) and [Transaction Details page](../v22.2/ui-transactions-page.html). [#91938][#91938]
- Added the `Service Latency: SQL Statements, 99.9th percentile` and `Service Latency: SQL Statements, 99.99th percentile` charts to the [Metrics page](../v22.2/ui-overview-dashboard.html), under the SQL view. [#92715][#92715]
- Updated the tooltip in the `SQL Statement Errors` chart on the [Metrics page](../v22.2/ui-overview-dashboard.html). [#92712][#92712]
- Graphs on the [Metrics page](../v22.2/ui-overview-dashboard.html) now downsample using maximum value instead of average value. Previously, zooming out on a graph would cause any spikes in the graph to smooth out, potentially hiding anomalies. By using the maximum value, these anomalies are visible even when looking at a zoomed-out interval. [#92296][#92296]
- Renamed the chart on the [Statement Details page](../v22.2/ui-statements-page.html) from `Statement Execution and Planning Time` to `Statement Times`. [#92780][#92780]
- Switched the order of Transaction and Statement views on the [Workload Insights tab](../v22.2/ui-insights-page.html#workload-insights-tab). [#92936][#92936]
- The [Insights pages](../v22.2/ui-insights-page.html) in the DB Console now includes the unit of time (seconds and milliseconds) for all timestamp values. [#92945][#92945]
- Added a link to the fingerprint ID in the high contention table on the [Transaction Insights Details page](../v22.2/ui-insights-page.html). [#92922][#92922]
- Added an **Apply** button on [Table Details page](../v22.2/ui-databases-page.html#table-details) when there is a recommendation to drop an unused index. [#92921][#92921]
- Added a Goroutine scheduling latency graph to the [Overload dashboard](../v22.2/ui-overload-dashboard.html) in the UI. It shows what the per-node p99 scheduling latency is for Goroutines. [#93235][#93235]
- Removed the feedback survey link from the DB Console. [#93279][#93279]
- Previously, graphs that displayed totals based on `totalCount` could show an "undefined value" if no value was passed. Now, a default value of `0` is used for the total if no value is otherwise provided. [#89931][#89931]
- Adjusted the [Statement Details page](../v22.2/ui-statements-page.html) so that displayed charts no longer overlap. [#90088][#90088]
- Sending the proper start/end values to the endpoint used on SQL Activity page now returns the full hour as described on the UI. [#90860][#90860]
- Displayed filters in the DB Console will now scroll if a filter is large, ensuring that the Apply button is always reachable. [#90480][#90480]
- Added a horizontal scroll to the table on the Explain Plan tab under the [Statement Details page](../v22.2/ui-statements-page.html). [#91326][#91326]
- The filter is no longer cut on the [Sessions page](../v22.2/ui-sessions-page.html). [#91327][#91327]
- Added a horizontal scroll to the Waited On table on [Transaction Insight details page](../v22.2/ui-insights-page.html). [#91480][#91480]
- Fixed the [Statement Activity page](../v22.2/ui-statements-page.html) so that it no longer shows multi-statement implicit transactions as "explicit." [#92429][#92429]
- Added a sort setting to tables on the Transaction and Statement [Insights Details pages](../v22.2/ui-insights-page.html). [#92752][#92752]
- Fixed a bug where selecting a relatively small timeframe in the past causes no data to render on graphs. [#93621][#93621]
- Loading the [Database Details page](../v22.2/ui-databases-page.html) in the UI is now somewhat less expensive when there are a large number of databases and a large number of tables in each database and a large number of ranges in the cluster. [#91015][#91015]

<h3 id="v22-2-1-bug-fixes">Bug fixes</h3>

- Fixed a bug in the legacy schema changer where database [comments](../v22.2/comment-on.html) were not dropped together with the database. [#91708][#91708]
- Fixed a bug that could cause crashes when parsing malformed [change data capture transformations](../v22.2/cdc-transformations.html). [#90843][#90843]
- Fixed a bug that could cause [changefeeds](../v22.2/change-data-capture-overview.html) to fail during a rolling restart. [#90661][#90661]
- Previously, when a statement bundle was collected for a query that resulted in an error due to a `statement_timeout` the bundle would not be saved. This is now fixed. [#89129][#89129]
- Fixed a bug that has existed since v2.1.0 where queries containing a subquery with `EXCEPT` could produce incorrect results. This could happen if the [optimizer](../v22.2/cost-based-optimizer.html) could guarantee that the left side of the `EXCEPT` always returned more rows than the right side. In this case, the optimizer made a faulty assumption that the `EXCEPT` subquery always returned at least one row, which could cause the optimizer to perform an invalid transformation, which could possibly cause the full query to return incorrect results. [#89135][#89135]
- Fixed a bug causing incorrect results from the floor division operator, `//`, when the numerator is non-constant and the denominator is the constant 1. [#89262][#89262]
- Fixed a bug causing missing automatic statistics collection at cluster startup when the `sql.stats.automatic_collection.enabled` [cluster setting](../v22.2/cluster-settings.html) is `false`, but there are tables with the storage parameter `sql_stats_automatic_collection_enabled` set to `true`. [#88763][#88763]
- Fixed a bug in the `Concat` projection operators for arrays that could cause non-null values to be added to the array when one of the arguments was `NULL`. [#89055][#89055]
- Fixed a bug that has existed in v21.1 and earlier that could cause an internal error when executing a query with a limit ordering on the output of a [window function](../v22.2/window-functions.html). [#87747][#87747]
- Fixed a longstanding bug that could cause a panic when running a query with [`EXPLAIN`](../v22.2/explain.html) that attempts to order on a non-output column. [#88687][#88687]
- Fixed a bug that could cause incorrect results in rare cases. The bug could only present if the following conditions were true:
    1. A query with `ORDER BY` and `LIMIT` was executed.   
    2. The table containing the `ORDER BY` columns had an index containing those columns.   
    3. The index in (2) contained a prefix of columns held to a fixed number of values by the query filter (e.g., `WHERE a IN (1, 3)`), a `CHECK` constraint (e.g., `CHECK (a IN (1, 3))`), inferred by a computed column expression (e.g., `WHERE a IN (1, 3)` and a column `b INT AS (a + 10) STORED`), or inferred by a `PARTITION BY` clause (e.g., `INDEX (a, ...) PARTITION BY LIST (a) (PARTITION p VALUES ((1), (3)))`). 
This bug was present since version v22.1.0. [#89250][#89250]
- Previously, when writing storage checkpoints on consistency checker failures, flushing WAL was disabled, so some checkpoints could be slightly out of date. This is now fixed. [#89403][#89403]
- Adjusted [optimizer](../v22.2/cost-based-optimizer.html) selectivity and cost estimates of zigzag joins in order to prevent query plans from using it when it would perform poorly (when many rows are qualified). [#89427][#89427]
- Updated hot ranges, problem ranges, data distribution, stores report, range status, Raft for all ranges features to require `VIEWCLUSTERMETADATA`. Updated the [`SHOW CLUSTER SETTING`](../v22.2/show-cluster-setting.html) SQL command to require `VIEWCLUSTERSETTING/MODIFYCLUSTERSETTING` privileges. Fixed a visual bug on stores report where an error shows an infinite spinner only. [#89508][#89508]
- Fixed a bug introduced in v20.2 that could cause filters to be dropped from a query plan with many joins in rare cases. [#89158][#89158]
- Narrowed the conditions under which a `VOTER_DEMOTING_LEARNER` can acquire the lease in a joint configuration to:
    a) There must be a `VOTER_INCOMING` in the configuration, and 
    b) The `VOTER_DEMOTING_LEARNER` was the last leaseholder. 
This prevents it from acquiring the lease unless it is the only one that can acquire it. Transferring the lease away is necessary before exiting the joint configuration (without the fix the system can be stuck in a joint configuration in some rare situations). [#89594][#89594]
- Fixed tables created by [userfile storage](../v22.2/use-userfile-for-bulk-operations.html) that have invalid foreign key constraints. [#89371][#89371]
- Fixed a crash that could occur when dropping a role that owned two schemas with the same name in different databases. The bug was introduced in v22.1.0. [#89534][#89534]
- Excluded check constraints of hash-sharded indexes from being invalidated when executing [`IMPORT INTO`](../v22.2/import-into.html). [#89525][#89525]
- Avoided a source of internal connectivity problems that would resolve after restarting the affected node. [#89597][#89597]
- Previously, uncommitted privileges could be cached if a transaction is rolled back. This is now fixed. This bug was only present in the v22.2 alpha and beta versions. Example:

    ~~~sql
    BEGIN; 
    GRANT SELECT ON crdb_internal.tables TO testuser; 
    SELECT has_table_privilege('testuser', 'crdb_internal.tables', 'SELECT'); --- this caches the privilege --- 
    ROLLBACK; --- SELECT IS STILL CACHED UNTIL ANOTHER GRANT/REVOKE HAPPENS TO INVALIDATE THE CACHE--- 
    ~~~ 

[#89717][#89717]

- Fixed a bug in `pg_catalog` tables that could result in an internal error if a schema is concurrently dropped. [#88602][#88602]
- Fixed a bug that caused queries with expressions like `'foo' LIKE col` to return incorrect values. The bug only occurs when an inverted trigram index exists on `col`. The bug is only present in beta versions of v22.2. [#89700][#89700]
- Fixed a bug that caused internal errors in rare cases when running [common table expressions](../v22.2/common-table-expressions.html) (statements with `WITH` clauses). This bug is only present in v22.2.0-beta.2, v22.2.0-beta.3, v21.2.16, and v22.1.9. [#89855][#89855]
- Fixed a bug that caused trailing characters to be silently truncated when attempting to convert corrupt JSON string input into JSONb. [#89926][#89926]
- Fixed a bug that caused [changefeeds](../v22.2/change-data-capture-overview.html) to permanently error on a `failed to send RPC` error. [#89527][#89527]
- Restoring a [backup](../v22.2/backup.html) with a table containing `UniqueWithoutIndexConstraints` would fail because of incorrect tableIDs being referenced in the constraints stored on the restored table. This is now fixed. [#89745][#89745]
- Fixed a bug that caused incorrect results for queries with string similar filters (e.g., `col % 'abc'`) on tables with [trigram indexes](../v22.2/trigram-indexes.html). This bug is only present in v22.2 pre-release versions up to and including v22.2.0-beta.3. [#90163][#90163]
- Fixed a bug where zone configs generated for a database with a secondary region were invalid. The `voter_constraints` and the lease preferences called for voters and leaseholders to exist in both the primary and secondary region, which is impossible. This bug was present since v22.2.0-alpha.1. [#90184][#90184]
- Fixed a bug causing an issue with the `enforce_home_region` session setting, which may cause [`SHOW CREATE TABLE`](../v22.2/show-create.html) or other non-DML statements to error out if the optimizer plan for the statement involves accessing a multi-region table. [#90204][#90204]
- Fixed a bug that could potentially cause changefeeds with [`initial_scan_only`](../v22.2/create-changefeed.html#initial-scan) to miss messages. Now, the changefeed ensures that all messages have successfully flushed to the sink prior to completion. [#90277][#90277]
- Now, during [JWT-based authentication](../v22.2/sso-sql.html), algorithm type is inferred if it is not specified by the JWKS. This enables support for a wider range of JWKS. [#90289][#90289]
- Fixed a bug that caused incorrect evaluation of comparison expressions involving time and interval types, like `col::TIME + '10 hrs'::INTERVAL' > '01:00'::TIME`. [#90368][#90368]
- Fixed a bug causing detection and erroring out of queries using a locality-optimized join when session setting `enforce_home_region` is `true` and the input table to the join has no home region or its home region does not match the gateway region. [#90199][#90199]
- Fixed a bug introduced in v22.1.9 that caused nodes to refuse to run jobs under rare circumstances. [#90271][#90271]
- Fixed the calculation of the `pg_attribute.attnum` column for indexes so that the `attnum` is always based on the order the column appears in the index. Also fixed the `pg_attribute` table so that it includes stored columns in secondary indexes. [#90458][#90458]
- Previously, during [restore](../v22.2/restore.html) planning, the restoring cluster's codec was accidentally used to reason about spans in the [backup manifest](../v22.2/backup-architecture.html). When a backup was restored by a different tenant, two bugs described in [#90475](https://github.com/cockroachdb/cockroach/issues/90475) and [#90474](https://github.com/cockroachdb/cockroach/issues/90474) could occur. This is now fixed. [#90527][#90527]
- TTL decoding error messages now correctly contain hex-encoded key bytes instead of hex-encoded key pretty-printed output. [#90723][#90723]
- When running Cockroach inside of a Docker container on macOS and mounting a host filesystem into the container, the total available capacity calculation of the filesystem could be reported incorrectly. This is now fixed. [#90873][#90873]
- Fixed a bug that caused incorrect results and internal errors when a `LEFT JOIN` operated on a table with [virtual computed columns](../v22.2/computed-columns.html). The bug only presented when the optimizer planned a "paired joiner". Only values of the virtual columns would be incorrect—they could be `NULL` when their correct value was not `NULL`. An internal error would occur in the same situation if the virtual column had a `NOT NULL` constraint. This bug was present since version v22.1.0. [#90997][#90997]
- In large, [multi-region clusters](../v22.2/movr-flask-overview.html), it was possible for the leasing mechanism used for jobs to get caught in a live-lock scenario whereby jobs could not be adopted. This bug has been resolved. [#91037][#91037]
- `REASSIGN OWNED BY` could run into errors, if any descriptor owned by the user is currently being dropped. This is now fixed [#90388][#90388]
- Fixed a bug that could cause `SELECT *` operations on tables with [virtual computed columns](../v22.2/computed-columns.html) undergoing schema changes to potentially fail. [#91007][#91007]
- Fixed a bug where point lookups on the `pg_catalog.pg_type` table would fail to find the implicit record type that gets created for tables in the `pg_catalog`, `information_schema`, and `crdb_internal` schemas. [#91217][#91217]
- Fixed a bug that prevented the usage of implicit record types for tables in the `pg_catalog`, `information_schema`, and `crdb_internal` schemas. [#91217][#91217]
- Fixed a bug which caused a migration in v22.1 to fail to drop an index on the `system.statement_diagnostics_requests` table. This caused upgrades from v22.1 to v22.2, which had used the previous, faulty upgrade migration to now fail to create a new index with the same name, as the index was assumed to have been dropped previously. [#91308][#91308] 
- A nil pointer crash that could be encountered when interleaving `SELECT FOR UPDATE SKIP LOCKED` statements has been resolved. [#91256][#91256]
- Fixed a bug present only in v22.2 release candidates, in which an [`ALTER PRIMARY KEY USING COLUMNS (x, x)`](../v22.2/alter-primary-key.html) statement would result in an internal error instead of the expected user-facing error with a pg-code. [#91478][#91478]
- Fixed a bug in which panics triggered by certain DDL statements were not properly recovered, leading to the cluster node crashing. [#91552][#91552]
- Fixed a rare bug where concurrent follower read/split operations could lead to invalid read results. [#90624][#90624]
- Previously, certain aggregate histograms would appear in `_status/vars`, but not be available for graphing in the DB Console. These are now available. They include changefeed-related histograms and row-level TTL histograms. [#90806][#90806]
- Fixed a panic that could occur when calling `st_distancespheroid` or `st_distancesphere` with a spatial object containing an `NaN` coordinate. This now produces an error, `"input is out of range"`. [#91535][#91535]
- Fixed a bug that could result in a [changefeed](../v22.2/change-data-capture-overview.html) missing rows which occur around the time of a split in writing transactions that take longer than the closed timestamp target duration (defaults to 3s). [#91748][#91748]
- Fixed a bug that resulted in the regions listed for databases and tables including an incorrect list of regions due to the logic including information about tables which are adjacent in the keyspace. [#91393][#91393]
- Fixed a bug that would cause `SHOW BACKUP` and `RESTORE` of [encrypted incremental backups](../v22.2/take-and-restore-encrypted-backups.html) to fail. [#91925][#91925]
- Added leading zeros to fingerprint IDs with less than 16 characters. [#91938][#91938]
- Fixed a bug that resulted in some retryable errors not being retried during an [import](../v22.2/import.html). [#89426][#89426]
- Fixed a bug in `changefeed.batch_reduction_retry` that erroneously limited retries to a single level. [#90205][#90205]
- Fixed a bug pre-v21.1 wherein `cgroup` memory limit was undetected when using `systemd`. [#92032][#92032]
- Fixed a bug introduced in v21.2 that could cause an internal error in rare cases when a query required a constrained index scan to return results in order. [#87735][#87735]
- Fixed an unhandled error that could happen if [`ALTER DEFAULT PRIVILEGES`](../v22.2/alter-default-privileges.html) was run on the system database. [#92079][#92079]
- Fixed a bug existing since v20.2 that could cause incorrect results in rare cases for queries with [inner joins](../v22.2/joins.html#inner-joins) and [left joins](../v22.2/joins.html#left-outer-joins). For the bug to occur, the left join had to be in the input of the inner join and the inner join filters had to reference both inputs of the left join, and not filter `NULL` values from the right input of the left join. Additionally, the right input of the left join had to contain at least one join, with one input not referenced by the left join's `ON` condition. [#92033][#92033]
- Fixed a bug causing changefeeds to fail when a value is deleted while running on a non-primary column family with [multiple columns](../v22.2/changefeeds-on-tables-with-column-families.html). [#91956][#91956]
- Fixed a bug to prevent schema changes on the `crdb_internal_expiration` column. [#92291][#92291]
- The `sql.metrics.statement_details.dump_to_logs` [cluster setting](../v22.2/cluster-settings.html) no longer causes a mutex deadlock when set to true. [#92279][#92279]
- Fixed incorrect cancellation logic when attempting to detect stuck rangefeeds. [#92704][#92704]
- Fixed the `attidentity` value for the `GENERATED BY DEFAULT AS IDENTITY` column should be `d`. [#92836][#92836]
- Fixed a rare panic only present in v22.2.0 that occurs when using particular forms of old statistics in table statistics forecasting. This panic can also be mitigated by deleting old statistics, or by disabling forecasting with either `SET CLUSTER SETTING sql.stats.forecasts.enabled = false;` or, if the specific table with the problematic statistics is known: `ALTER TABLE t SET (sql_stats_forecasts_enabled = false);`. [#92969][#92969]
- CockroachDB previously could incorrectly evaluate queries that performed left-semi and left-anti "virtual lookup" [joins](../v22.2/joins.html) on tables in `pg_catalog` or `information_schema`. These join types can be planned when a subquery is used inside of a filter condition. The bug was introduced in v22.1.0 and is now fixed. [#92880][#92880]
- Improved the speed of slow listing calls that could manifest as [restore](../v22.2/restore.html) queries hanging during execution in the presence of several backup files. [#93204][#93204]
- Previously, empty [`COPY`](../v22.2/copy-from.html) commands would not escape after an EOF character or error if encountering a `\.` with no input. This is now resolved. [#93261][#93261]
- Prepared statements that use type hints can now succeed type-checking in more cases when the placeholder type is ambiguous. [#93332][#93332]
- Fixed an error that could occur when dropping a user/role before the [upgrade to v22.2](../v22.2/upgrade-cockroach-version.html) was finalized. [#93435][#93435]
- Fixed a bug in which the non-default nulls ordering, `NULLS LAST`, was ignored in [window](../v22.2/window-functions.html) and [aggregate](../v22.2/functions-and-operators.html#aggregate-functions) functions. This bug could cause incorrect query results when `NULLS LAST` was used, and was introduced in v22.1.0. [#93566][#93566]
- Fixed a bug that could lead to errors when running multiple schema change statements in a single command using a driver that uses the extended pgwire protocol internally (Npgsql in .Net as an example). These errors would have the form `"attempted to update job for mutation 2, but job already exists with mutation 1"`. [#92305][#92305]
- Fixed an internal error that could occur when comparing a column of type void to `NULL` using `col IS NULL` or `col IS NOT NULL`. [#93680][#93680]
- Fixed an issue where `DISTINCT ON` queries would fail with the error `"SELECT DISTINCT ON expressions must match initial ORDER BY expressions"` when the query included an `ORDER BY` clause containing `ASC NULLS LAST` or `DESC NULLS FIRST`. [#93609][#93609]
- Previously, CockroachDB would error when receiving Geometry/Geography using binary parameters. This is now resolved. [#93685][#93685]
- Fixed a rare bug where CockroachDB could encounter an internal error when evaluating the `crdb_internal.range_stats` built-in (which is used in the `SHOW RANGES` command, among others). The bug was introduced in v22.2.0. [#93869][#93869]
- Fixed a bug where some input to `crdb_internal.trim_tenant_prefix` would cause a node crash. [#90541][#90541]

<h3 id="v22-2-1-performance-improvements">Performance improvements</h3>

- The [optimizer](../v22.2/cost-based-optimizer.html) now explores plans with a single lookup join expressions in rare cases where it previously planned two lookup join expressions. [#88864][#88864]
- Some types of queries with comparisons between one or more constant values now execute faster. [#89554][#89554]
- `pg_catalog.col_description` is now much faster when resolving columns for tables in the `pg_catalog`, `crdb_internal`, or `information_schema` namespaces. [#89496][#89496]
- HTTP requests with `'Accept-encoding: gzip'` previously resulted in valid gzip-encoded, but uncompressed responses. This resulted in inefficient HTTP transfer times, as far more bytes were transferred than necessary. Those responses are now properly compressed, resulting in smaller network responses. [#89510][#89510]
- The [optimizer](../v22.2/cost-based-optimizer.html) now does less copying of histograms while planning queries, which will reduce memory pressure. [#89957][#89957]
- Tables in `pg_catalog` and `information_schema` (when not explicitly referenced as `"".information_schema`) may now be much faster if the current database has a small number of relations relative to the total number in the cluster. [#91054][#91054]
- Adjusted the garbage collection score threshold needed to trigger a MVCC [garbage collection](../v22.2/architecture/storage-layer.html#garbage-collection) run to be more aggressive. This should result in garbage collection runs being triggered earlier on average. [#92675][#92675]
- CockroachDB in some cases now correctly incorporates the value of the `OFFSET` clause when determining the number of rows that need to be read when the `LIMIT` clause is also present. Note that there was no correctness issue here—only that extra unnecessary rows could be read. [#92840][#92840]
- In v22.2, privileges on virtual tables (system catalogs like `pg_catalog`, `information_schema`, and `crdb_internal`) were introduced. A problem with this new feature is those privileges must be fetched into a cache before using those tables or determining their visibility in other system catalogs. This process used to occur on-demand, when the privilege was needed. Now these privileges are fetched proactively during startup to mitigate the latency when accessing `pg_catalog` right after the server boots up. [#93655][#93655]

<h3 id="v22-2-1-build-changes">Build changes</h3>

- Added support for MacOS `arm64`. [#89304][#89304]

<h3 id="v22-2-1-contributors">Contributors</h3>

This release includes 448 merged PRs by 73 authors.
We would like to thank the following contributors from the CockroachDB community:

- quanuw (first-time contributor)

</div>

[#87735]: https://github.com/cockroachdb/cockroach/pull/87735
[#87747]: https://github.com/cockroachdb/cockroach/pull/87747
[#88315]: https://github.com/cockroachdb/cockroach/pull/88315
[#88602]: https://github.com/cockroachdb/cockroach/pull/88602
[#88687]: https://github.com/cockroachdb/cockroach/pull/88687
[#88763]: https://github.com/cockroachdb/cockroach/pull/88763
[#88864]: https://github.com/cockroachdb/cockroach/pull/88864
[#89055]: https://github.com/cockroachdb/cockroach/pull/89055
[#89102]: https://github.com/cockroachdb/cockroach/pull/89102
[#89125]: https://github.com/cockroachdb/cockroach/pull/89125
[#89129]: https://github.com/cockroachdb/cockroach/pull/89129
[#89135]: https://github.com/cockroachdb/cockroach/pull/89135
[#89140]: https://github.com/cockroachdb/cockroach/pull/89140
[#89158]: https://github.com/cockroachdb/cockroach/pull/89158
[#89197]: https://github.com/cockroachdb/cockroach/pull/89197
[#89250]: https://github.com/cockroachdb/cockroach/pull/89250
[#89262]: https://github.com/cockroachdb/cockroach/pull/89262
[#89304]: https://github.com/cockroachdb/cockroach/pull/89304
[#89351]: https://github.com/cockroachdb/cockroach/pull/89351
[#89371]: https://github.com/cockroachdb/cockroach/pull/89371
[#89403]: https://github.com/cockroachdb/cockroach/pull/89403
[#89423]: https://github.com/cockroachdb/cockroach/pull/89423
[#89426]: https://github.com/cockroachdb/cockroach/pull/89426
[#89427]: https://github.com/cockroachdb/cockroach/pull/89427
[#89496]: https://github.com/cockroachdb/cockroach/pull/89496
[#89508]: https://github.com/cockroachdb/cockroach/pull/89508
[#89510]: https://github.com/cockroachdb/cockroach/pull/89510
[#89518]: https://github.com/cockroachdb/cockroach/pull/89518
[#89525]: https://github.com/cockroachdb/cockroach/pull/89525
[#89527]: https://github.com/cockroachdb/cockroach/pull/89527
[#89534]: https://github.com/cockroachdb/cockroach/pull/89534
[#89554]: https://github.com/cockroachdb/cockroach/pull/89554
[#89594]: https://github.com/cockroachdb/cockroach/pull/89594
[#89597]: https://github.com/cockroachdb/cockroach/pull/89597
[#89657]: https://github.com/cockroachdb/cockroach/pull/89657
[#89700]: https://github.com/cockroachdb/cockroach/pull/89700
[#89717]: https://github.com/cockroachdb/cockroach/pull/89717
[#89745]: https://github.com/cockroachdb/cockroach/pull/89745
[#89750]: https://github.com/cockroachdb/cockroach/pull/89750
[#89760]: https://github.com/cockroachdb/cockroach/pull/89760
[#89852]: https://github.com/cockroachdb/cockroach/pull/89852
[#89855]: https://github.com/cockroachdb/cockroach/pull/89855
[#89920]: https://github.com/cockroachdb/cockroach/pull/89920
[#89926]: https://github.com/cockroachdb/cockroach/pull/89926
[#89931]: https://github.com/cockroachdb/cockroach/pull/89931
[#89957]: https://github.com/cockroachdb/cockroach/pull/89957
[#90036]: https://github.com/cockroachdb/cockroach/pull/90036
[#90088]: https://github.com/cockroachdb/cockroach/pull/90088
[#90163]: https://github.com/cockroachdb/cockroach/pull/90163
[#90170]: https://github.com/cockroachdb/cockroach/pull/90170
[#90182]: https://github.com/cockroachdb/cockroach/pull/90182
[#90184]: https://github.com/cockroachdb/cockroach/pull/90184
[#90199]: https://github.com/cockroachdb/cockroach/pull/90199
[#90204]: https://github.com/cockroachdb/cockroach/pull/90204
[#90205]: https://github.com/cockroachdb/cockroach/pull/90205
[#90271]: https://github.com/cockroachdb/cockroach/pull/90271
[#90277]: https://github.com/cockroachdb/cockroach/pull/90277
[#90289]: https://github.com/cockroachdb/cockroach/pull/90289
[#90294]: https://github.com/cockroachdb/cockroach/pull/90294
[#90307]: https://github.com/cockroachdb/cockroach/pull/90307
[#90359]: https://github.com/cockroachdb/cockroach/pull/90359
[#90368]: https://github.com/cockroachdb/cockroach/pull/90368
[#90388]: https://github.com/cockroachdb/cockroach/pull/90388
[#90409]: https://github.com/cockroachdb/cockroach/pull/90409
[#90458]: https://github.com/cockroachdb/cockroach/pull/90458
[#90480]: https://github.com/cockroachdb/cockroach/pull/90480
[#90484]: https://github.com/cockroachdb/cockroach/pull/90484
[#90496]: https://github.com/cockroachdb/cockroach/pull/90496
[#90527]: https://github.com/cockroachdb/cockroach/pull/90527
[#90541]: https://github.com/cockroachdb/cockroach/pull/90541
[#90557]: https://github.com/cockroachdb/cockroach/pull/90557
[#90564]: https://github.com/cockroachdb/cockroach/pull/90564
[#90624]: https://github.com/cockroachdb/cockroach/pull/90624
[#90626]: https://github.com/cockroachdb/cockroach/pull/90626
[#90661]: https://github.com/cockroachdb/cockroach/pull/90661
[#90723]: https://github.com/cockroachdb/cockroach/pull/90723
[#90796]: https://github.com/cockroachdb/cockroach/pull/90796
[#90806]: https://github.com/cockroachdb/cockroach/pull/90806
[#90843]: https://github.com/cockroachdb/cockroach/pull/90843
[#90860]: https://github.com/cockroachdb/cockroach/pull/90860
[#90873]: https://github.com/cockroachdb/cockroach/pull/90873
[#90992]: https://github.com/cockroachdb/cockroach/pull/90992
[#90997]: https://github.com/cockroachdb/cockroach/pull/90997
[#91002]: https://github.com/cockroachdb/cockroach/pull/91002
[#91007]: https://github.com/cockroachdb/cockroach/pull/91007
[#91015]: https://github.com/cockroachdb/cockroach/pull/91015
[#91037]: https://github.com/cockroachdb/cockroach/pull/91037
[#91054]: https://github.com/cockroachdb/cockroach/pull/91054
[#91091]: https://github.com/cockroachdb/cockroach/pull/91091
[#91111]: https://github.com/cockroachdb/cockroach/pull/91111
[#91193]: https://github.com/cockroachdb/cockroach/pull/91193
[#91217]: https://github.com/cockroachdb/cockroach/pull/91217
[#91256]: https://github.com/cockroachdb/cockroach/pull/91256
[#91275]: https://github.com/cockroachdb/cockroach/pull/91275
[#91308]: https://github.com/cockroachdb/cockroach/pull/91308
[#91314]: https://github.com/cockroachdb/cockroach/pull/91314
[#91326]: https://github.com/cockroachdb/cockroach/pull/91326
[#91327]: https://github.com/cockroachdb/cockroach/pull/91327
[#91345]: https://github.com/cockroachdb/cockroach/pull/91345
[#91393]: https://github.com/cockroachdb/cockroach/pull/91393
[#91478]: https://github.com/cockroachdb/cockroach/pull/91478
[#91480]: https://github.com/cockroachdb/cockroach/pull/91480
[#91535]: https://github.com/cockroachdb/cockroach/pull/91535
[#91541]: https://github.com/cockroachdb/cockroach/pull/91541
[#91552]: https://github.com/cockroachdb/cockroach/pull/91552
[#91669]: https://github.com/cockroachdb/cockroach/pull/91669
[#91708]: https://github.com/cockroachdb/cockroach/pull/91708
[#91748]: https://github.com/cockroachdb/cockroach/pull/91748
[#91909]: https://github.com/cockroachdb/cockroach/pull/91909
[#91925]: https://github.com/cockroachdb/cockroach/pull/91925
[#91938]: https://github.com/cockroachdb/cockroach/pull/91938
[#91956]: https://github.com/cockroachdb/cockroach/pull/91956
[#91994]: https://github.com/cockroachdb/cockroach/pull/91994
[#92032]: https://github.com/cockroachdb/cockroach/pull/92032
[#92033]: https://github.com/cockroachdb/cockroach/pull/92033
[#92079]: https://github.com/cockroachdb/cockroach/pull/92079
[#92208]: https://github.com/cockroachdb/cockroach/pull/92208
[#92279]: https://github.com/cockroachdb/cockroach/pull/92279
[#92291]: https://github.com/cockroachdb/cockroach/pull/92291
[#92296]: https://github.com/cockroachdb/cockroach/pull/92296
[#92305]: https://github.com/cockroachdb/cockroach/pull/92305
[#92429]: https://github.com/cockroachdb/cockroach/pull/92429
[#92439]: https://github.com/cockroachdb/cockroach/pull/92439
[#92675]: https://github.com/cockroachdb/cockroach/pull/92675
[#92704]: https://github.com/cockroachdb/cockroach/pull/92704
[#92712]: https://github.com/cockroachdb/cockroach/pull/92712
[#92715]: https://github.com/cockroachdb/cockroach/pull/92715
[#92717]: https://github.com/cockroachdb/cockroach/pull/92717
[#92752]: https://github.com/cockroachdb/cockroach/pull/92752
[#92755]: https://github.com/cockroachdb/cockroach/pull/92755
[#92780]: https://github.com/cockroachdb/cockroach/pull/92780
[#92824]: https://github.com/cockroachdb/cockroach/pull/92824
[#92836]: https://github.com/cockroachdb/cockroach/pull/92836
[#92840]: https://github.com/cockroachdb/cockroach/pull/92840
[#92880]: https://github.com/cockroachdb/cockroach/pull/92880
[#92921]: https://github.com/cockroachdb/cockroach/pull/92921
[#92922]: https://github.com/cockroachdb/cockroach/pull/92922
[#92936]: https://github.com/cockroachdb/cockroach/pull/92936
[#92945]: https://github.com/cockroachdb/cockroach/pull/92945
[#92969]: https://github.com/cockroachdb/cockroach/pull/92969
[#93035]: https://github.com/cockroachdb/cockroach/pull/93035
[#93179]: https://github.com/cockroachdb/cockroach/pull/93179
[#93204]: https://github.com/cockroachdb/cockroach/pull/93204
[#93235]: https://github.com/cockroachdb/cockroach/pull/93235
[#93261]: https://github.com/cockroachdb/cockroach/pull/93261
[#93279]: https://github.com/cockroachdb/cockroach/pull/93279
[#93330]: https://github.com/cockroachdb/cockroach/pull/93330
[#93332]: https://github.com/cockroachdb/cockroach/pull/93332
[#93435]: https://github.com/cockroachdb/cockroach/pull/93435
[#93516]: https://github.com/cockroachdb/cockroach/pull/93516
[#93566]: https://github.com/cockroachdb/cockroach/pull/93566
[#93609]: https://github.com/cockroachdb/cockroach/pull/93609
[#93621]: https://github.com/cockroachdb/cockroach/pull/93621
[#93635]: https://github.com/cockroachdb/cockroach/pull/93635
[#93655]: https://github.com/cockroachdb/cockroach/pull/93655
[#93680]: https://github.com/cockroachdb/cockroach/pull/93680
[#93685]: https://github.com/cockroachdb/cockroach/pull/93685
[#93869]: https://github.com/cockroachdb/cockroach/pull/93869
