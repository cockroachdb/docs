## v22.2.0-alpha.2

Release Date: September 6, 2022

{% include releases/release-downloads-docker-image.md release=include.release %}

<h3 id="v22-2-0-alpha-2-enterprise-edition-changes">Enterprise edition changes</h3>

- The [`ALTER BACKUP SCHEDULE`](../{{site.versions["dev"]}}/alter-backup.html) statement will now fail if the new backup statement does not pass planning. [#86819][#86819]

<h3 id="v22-2-0-alpha-2-sql-language-changes">SQL language changes</h3>

- Added the `enforce_home_region` [session setting](../{{site.versions["dev"]}}/set-vars.html), which when `true` causes queries which have no home region or which may scan rows via a database connection outside of the query's home region to error out. Also, only tables in [multi-region](../{{site.versions["dev"]}}/multiregion-overview.html) databases with `ZONE` [survivability](../{{site.versions["dev"]}}/multiregion-overview.html#survival-goals) may be scanned without error when this setting is `true`, because ranges in an offline region may be served non-locally to the gateway region when using `REGION` survivability, and therefore cannot be guaranteed to have low latency. [#85704][#85704]
- Introduced a new `BACKUP` privilege that is grantable as a system, database or table/type/schema level privilege. You can opt-in to the new privilege model by granting the appropriate privileges as per the following model:
    1. Cluster backups - user requires the system `BACKUP` privilege.
    1. Database backups - user requires the database `BACKUP` privilege.
    1. Table backups - user requires the table `BACKUP` privilege.
    In CockroachDB v22.2, the previous privilege model will continue to be respected, but will be completely replaced with the `BACKUP` privilege in CockroachDB v23.1. [#86495][#86495]
- Added the `optimizer_use_forecasts` [session setting](../{{site.versions["dev"]}}/set-vars.html), which can be set to `false` to disable usage of statistics forecasts when optimizing a query. [#86834][#86834]
- Added the `json{,b}_to_record{,set}` [built-in function](../{{site.versions["dev"]}}/functions-and-operators.html), which transforms JSON into structured SQL records. [#82435][#82435]
- Added the `sql.stats.forecasts.enabled` [cluster setting](../{{site.versions["dev"]}}/cluster-settings.html), which controls whether statistics forecasts are generated by default for all tables. This behaves differently than the `optimizer_use_forecasts` session setting, which controls whether statistics forecasts are used when optimizing the current query. If `sql.stats.forecasts.enabled` is disabled, then even if `optimizer_use_forecasts` is `true` for a given query it won't have any forecasts to use to generate its output. [#86932][#86932]
- Added the `sql_stats_forecasts_enabled` table setting, which controls whether statistics forecasts are generated for a specific table. When set, this overrides the `sql.stats.forecasts.enabled` cluster setting. [#86986][#86986]
- Introduced a new `RESTORE` privilege that is grantable as a system or database level privilege. You can opt-in to the new privilege model by granting the appropriate privileges as per the following model:
    1. Cluster backups - user requires the system `RESTORE` privilege.
    1. Database backups - user requires the system `RESTORE` privilege.
    1. Table backups - user requires the database `RESTORE` privilege.
    In CockroachDB v22.2, the previous privilege model will continue to be respected, but will be completely replaced with the `RESTORE` privilege in CockroachDB v23.1. [#86918][#86918]
- The [`SHOW REGIONS`](../{{site.versions["dev"]}}/show-regions.html) statement now shows information about secondary regions. [#86924][#86924]
- The `SHOW SYSTEM GRANTS [FOR ROLE ...]` statement now allows you to see the grants done by `GRANT SYSTEM ...` [#86700][#86700]
- Added support for the [`SHOW GRANTS`](../{{site.versions["dev"]}}/show-grants.html) syntax: `SHOW GRANTS ON EXTERNAL CONNECTION "name" FOR [users...]`. [#86700][#86700]

<h3 id="v22-2-0-alpha-2-operational-changes">Operational changes</h3>

- Added logging on replicate queue processing in the presence of errors or when the duration exceeds 50% of the timeout. [#86007][#86007]
- [Full cluster restores](../{{site.versions["dev"]}}/restore.html#full-cluster) now fail if an upgrade may be in progress. [#86848][#86848]

<h3 id="v22-2-0-alpha-2-db-console-changes">DB Console changes</h3>

- Added the **Insights Overview** page for statements to show if there are index recommendations, high retry count, and unknown for scenarios that don't fall into those categories. [#86688][#86688]
- Added the **Schedules** page to the DB Console. [#86409][#86409]
- Added the **Statement Insight Details** page to DB Console. [#86779][#86779]
- Added transaction and statement fingerprint IDs to thier correlating tabs on the **SQL Activity** page in the DB Console. New columns are hidden by default. [#85464][#85464]
- Change column name from `User` to `User Name` on the **Table Details** and **Grants** pages in the DB Console. [#86990][#86990]
- Update "Sub-Optimal" label to "Suboptimal". [#87068][#87068]

<h3 id="v22-2-0-alpha-2-bug-fixes">Bug fixes</h3>

- The timescale object is now properly constructed from session storage, preventing bugs and crashes in pages that use the timescale object when reloading the page. [#86909][#86909]
- Previously, escaping a double quote (`"`) with `COPY` in `CSV` mode could ignore all subsequent lines in the same `COPY` if an `ESCAPE` clause were specified. This is now resolved. [#86929][#86929]
- Changefeeds emitting to [Kafka](../{{site.versions["dev"]}}/create-changefeed.html#create-a-changefeed-connected-to-kafka) upon receiving a "message too large" error will now halve the size of their batches until it either succeeds or a batch size of 1 fails. [#86138][#86138]
- Added a missing memory accounting call when appending a KV to the underlying `kvBuf`. [#86738][#86738]
- Fixed the latency that is reported for `COPY` commands in the CLI and statistics reporting. [#86991][#86991]

<h3 id="v22-2-0-alpha-2-contributors">Contributors</h3>

This release includes 69 merged PRs by 35 authors.

[#82435]: https://github.com/cockroachdb/cockroach/pull/82435
[#85464]: https://github.com/cockroachdb/cockroach/pull/85464
[#85704]: https://github.com/cockroachdb/cockroach/pull/85704
[#86007]: https://github.com/cockroachdb/cockroach/pull/86007
[#86138]: https://github.com/cockroachdb/cockroach/pull/86138
[#86255]: https://github.com/cockroachdb/cockroach/pull/86255
[#86409]: https://github.com/cockroachdb/cockroach/pull/86409
[#86495]: https://github.com/cockroachdb/cockroach/pull/86495
[#86688]: https://github.com/cockroachdb/cockroach/pull/86688
[#86700]: https://github.com/cockroachdb/cockroach/pull/86700
[#86738]: https://github.com/cockroachdb/cockroach/pull/86738
[#86779]: https://github.com/cockroachdb/cockroach/pull/86779
[#86819]: https://github.com/cockroachdb/cockroach/pull/86819
[#86829]: https://github.com/cockroachdb/cockroach/pull/86829
[#86834]: https://github.com/cockroachdb/cockroach/pull/86834
[#86841]: https://github.com/cockroachdb/cockroach/pull/86841
[#86848]: https://github.com/cockroachdb/cockroach/pull/86848
[#86906]: https://github.com/cockroachdb/cockroach/pull/86906
[#86909]: https://github.com/cockroachdb/cockroach/pull/86909
[#86918]: https://github.com/cockroachdb/cockroach/pull/86918
[#86924]: https://github.com/cockroachdb/cockroach/pull/86924
[#86929]: https://github.com/cockroachdb/cockroach/pull/86929
[#86932]: https://github.com/cockroachdb/cockroach/pull/86932
[#86957]: https://github.com/cockroachdb/cockroach/pull/86957
[#86986]: https://github.com/cockroachdb/cockroach/pull/86986
[#86990]: https://github.com/cockroachdb/cockroach/pull/86990
[#86991]: https://github.com/cockroachdb/cockroach/pull/86991
[#87068]: https://github.com/cockroachdb/cockroach/pull/87068
[1cc5b550c]: https://github.com/cockroachdb/cockroach/commit/1cc5b550c
[566bb1651]: https://github.com/cockroachdb/cockroach/commit/566bb1651
[6590b9f4f]: https://github.com/cockroachdb/cockroach/commit/6590b9f4f
[831bfe703]: https://github.com/cockroachdb/cockroach/commit/831bfe703
[9ec6d411f]: https://github.com/cockroachdb/cockroach/commit/9ec6d411f
[b7be578e9]: https://github.com/cockroachdb/cockroach/commit/b7be578e9
[f1f0697bf]: https://github.com/cockroachdb/cockroach/commit/f1f0697bf
[fb5ec492b]: https://github.com/cockroachdb/cockroach/commit/fb5ec492b
