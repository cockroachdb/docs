#!/bin/bash

function build {
	bundle exec jekyll build --trace --config _config_base.yml,$1
}

gem install bundler
bundle install
build _config_cockroachdb.yml

cp _site/docs/_redirects _site/_redirects
cp _site/docs/404.html _site/404.html

# Run Algolia if building master
if [[ "$CONTEXT" = "production" ]]; then
	echo "Building Algolia index..."
	ALGOLIA_API_KEY=$PROD_ALGOLIA_API_KEY bundle exec jekyll algolia --config _config_base.yml --builds-config _config_cockroachdb.yml
fi;

# Set up Vale, a text linter
wget -O- https://github.com/errata-ai/vale/releases/download/v1.2.7/vale_1.2.7_Linux_64-bit.tar.gz | tar -xz vale

# Set up htmltest
go get -u github.com/cockroachdb/htmltest
pushd $GOPATH/src/github.com/cockroachdb/htmltest && ./build.sh && popd

# Run Vale, but don't fail the build if it reports errors
./vale --no-wrap v20.2 || true

# Run htmltest, but skip checking external links to speed things up
# unless it's on a scheduled nightly run
if [[ "$INCOMING_HOOK_TITLE" = "nightly" ]]
then
	$GOPATH/src/github.com/cockroachdb/htmltest/bin/htmltest
else
	$GOPATH/src/github.com/cockroachdb/htmltest/bin/htmltest --skip-external
fi
