---
title: Export Logs From a CockroachDB Dedicated Cluster
summary: Export Logs From a CockroachDB Dedicated Cluster
toc: true
docs_area: manage
---

{{ site.data.products.dedicated }} users can use the [Cluster API](/docs/{{site.versions["stable"]}}/cluster-api.html) to configure log export to [AWS CloudWatch](https://aws.amazon.com/cloudwatch/). Once the export is configured, logs will flow from all nodes in all regions of your {{ site.data.products.dedicated }} cluster to your CloudWatch log sink.

{% include cockroachcloud/private-preview.md %}

Currently, the {{ site.data.products.dedicated }} log export feature is limited to AWS CloudWatch only, but additional cloud log sinks are planned for the near future.

## The `logexport` endpoint

To configure and manage log export for your {{ site.data.products.dedicated }} cluster, use the `logexport` endpoint:

{% include_cached copy-clipboard.html %}
~~~
https://cockroachlabs.cloud/api/v1/clusters/{cluster_id}/logexport
~~~

The following methods are available:

Method | Description
--- | ---
`GET` | Returns the current status of the log export configuration.
`POST` | Enables log export, or updates an existing log export configuration. Requires the [Amazon Resource Name (ARN)](https://docs.aws.amazon.com/general/latest/gr/aws-arns-and-namespaces.html) of an [IAM role](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles.html) with permission to write to CloudWatch.
`DELETE` | Disables log export, halting all log export to AWS CloudWatch.

You can find your {{ site.data.products.dedicated }} `{cluster_id}` in the URL of the [admin web interface](https://cockroachlabs.cloud/cluster/) for the specific cluster you wish to configure, resembling `f78b7feb-b6cf-4396-9d7f-494982d7d81e`.

## Enable log export

1. Determine the AWS account ID of your {{ site.data.products.dedicated }} cluster, by issuing the following Cluster API command:

    {% include_cached copy-clipboard.html %}
    ~~~shell
    curl -H GET https://cockroachlabs.cloud/api/v1/clusters/{cluster_id}/  \
      Authorization: Bearer {api_session_token}
    ~~~

    Where:
    - The `{cluster_id}` can be found in the URL of the [admin web interface](https://cockroachlabs.cloud/cluster/) for the specific cluster you wish to configure, resembling `f78b7feb-b6cf-4396-9d7f-494982d7d81e`.
    - The `{api_session_token}` can be generated by [authenticating to your cluster via the Cluster API](/docs/{{site.versions["stable"]}}/cluster-api.html#authentication).

    The command returns diagnostic and status information, including an `account_id` field, which contains the AWS Account ID for your {{ site.data.products.dedicated }} cluster. Note this account ID for later use in this procedure.

1. In the AWS console, visit the [IAM page](https://console.aws.amazon.com/iam/) and select **Roles** from the sidebar.

1. Create a new cross-account IAM role. These instructions will use the role name `CockroachCloudLogExportRole`.

1. Select the new role, and create a new policy for this role. These instructions will use the policy name `CockroachCloudLogExportPolicy`.

1. Select the new policy, and paste the following into the **Permissions** tab, with the **{} JSON** option selected, providing your own `{aws_acct_id}` as returned from step 1:

    {% include_cached copy-clipboard.html %}
    ~~~
    {
        "Version": "2012-10-17",
        "Statement": [
            {
                "Action": [
                    "logs:CreateLogGroup",
                    "logs:CreateLogStream",
                    "logs:DescribeLogGroups",
                    "logs:DescribeLogStreams",
                    "logs:PutRetentionPolicy",
                    "logs:PutLogEvents"
                ],
                "Effect": "Allow",
                "Resource": [
                    "arn:aws:logs:*:{aws_acct_id}:log-group:*:*"
                ]
            }
        ]
    }
    ~~~

    This defines the set of permissions that the {{ site.data.products.dedicated }} log export feature requires to be able to write logs to CloudWatch.

    The entry for `Resource` allows for more granular control of log export if desired. You can adjust this value in one or more of the following manners:

        1. To limit log export from {{ site.data.products.dedicated }} to a specific single AWS region, provide the name of the desired region as the fourth value to the `Resource` entry, for example:

            {% include_cached copy-clipboard.html %}
            ~~~
            "Resource": [
                "arn:aws:logs:us-east-1:{aws_acct_id}:log-group:*:*"
            ]
            ~~~

        1. To export {{ site.data.products.dedicated }} logs to a specific AWS CloudWatch [log group](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/iam-access-control-overview-cwl.html#CWL_ARN_Format), provide the name of the desired log group as the seventh value to the `Resource` entry, for example:

            {% include_cached copy-clipboard.html %}
            ~~~
            "Resource": [
                "arn:aws:logs:*:{aws_acct_id}:log-group:ccloggroup:*"
            ]
            ~~~

            If this log group does not exist, this configuration will create it in AWS CloudWatch. If this log group does exist,
            you may optionally remove the `"logs:CreateLogGroup"` entry from the policy permissions configuration to further restrict permissions given to the `CockroachCloudLogExportRole` role.

        1. To export {{ site.data.products.dedicated }} logs to a specific AWS CloudWatch [log stream](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/iam-access-control-overview-cwl.html#CWL_ARN_Format), provide the name of the desired log stream as the eighth value to the `Resource` entry, for example:

            {% include_cached copy-clipboard.html %}
            ~~~
            "Resource": [
                "arn:aws:logs:*:{aws_acct_id}:log-group:*:cclogstream"
            ]
            ~~~

            If this log stream does not exist, this configuration will create it in AWS CloudWatch. If this log stream does exist,
            you may optionally remove the `"logs:CreateLogStream"` entry from the policy permissions configuration to further restrict permissions given to the `CockroachCloudLogExportRole` role.

1. Return to the **Roles** page and select the `CockroachCloudLogExportRole` role. From this page, select the **Trust relationships** tab then click **Edit trust policy** and add the following trust policy, providing your own `{aws_acct_id}` as returned from step 1:

    {% include_cached copy-clipboard.html %}
    ~~~
    {
        "Version": "2012-10-17",
        "Statement": [
            {
                "Effect": "Allow",
                "Principal": {
                    "AWS": "arn:aws:iam::{aws_acct_id}:root"
                },
                "Action": "sts:AssumeRole"
            }
        ]
    }
    ~~~

1. Note the [Amazon Resource Name (ARN)](https://docs.aws.amazon.com/general/latest/gr/aws-arns-and-namespaces.html) of the `CockroachCloudLogExportRole` role found under **Summary**, which is needed for the next step.

1. Issue the following Cluster API command to enable log export for your {{ site.data.products.dedicated }} cluster:

    {% include_cached copy-clipboard.html %}
    ~~~shell
    curl -H POST https://cockroachlabs.cloud/api/v1/clusters/{cluster_id}/logexport \
      Authorization: Bearer {api_session_token} \
      {"type": "AWS_CLOUDWATCH", "log_name": "{aws_log_group}", "auth_principal": "{role_arn}"}
    ~~~

    Where:
    - The `{cluster_id}` can be found in the URL of your [admin web interface](https://cockroachlabs.cloud/cluster/) for the specific cluster you wish to configure, resembling `f78b7feb-b6cf-4396-9d7f-494982d7d81e`.
    - The `{api_session_token}` can be generated by [authenticating to your cluster via the Cluster API](/docs/{{site.versions["stable"]}}/cluster-api.html#authentication).
    - `{aws_log_group}` is the target AWS CloudWatch log group. If `*`, a log group will be created automatically on enablement.
    - `{role_arn}` is the ARN for the `CockroachCloudLogExportRole` role you copied in step 6.

1. Depending on the size of your cluster and how many regions it spans, the configuration may take a moment. You can monitor the ongoing status of the configuration using the following Cluster API command:

    {% include_cached copy-clipboard.html %}
    ~~~shell
    curl -H GET https://cockroachlabs.cloud/api/v1/clusters/{cluster_id}/logexport \
      Authorization: Bearer ${api_session_token}
    ~~~

    Once the command returns `ENABLED`, logs will begin appearing in CloudWatch under log group you configured in step 7. Since the configuration is applied to cluster nodes in a rolling fashion, you may see some logs appear even before the `GET` command returns an `ENABLED` status.

## Monitor the status of a log export configuration

To check the status of an existing {{ site.data.products.dedicated }} log export configuration, use the following Cluster API command:

{% include_cached copy-clipboard.html %}
~~~shell
curl -H GET https://cockroachlabs.cloud/api/v1/clusters/{cluster_id}/logexport \
  Authorization: Bearer {api_session_token}
~~~

Where:

- The `{cluster_id}` can be found in the URL of your [admin web interface](https://cockroachlabs.cloud/cluster/) for the specific cluster you wish to configure, resembling `f78b7feb-b6cf-4396-9d7f-494982d7d81e`.
- The `{api_session_token}` can be generated by [authenticating to your cluster via the Cluster API](/docs/{{site.versions["stable"]}}/cluster-api.html#authentication).

## Update an existing log export configuration

To update an existing {{ site.data.products.dedicated }} log export configuration, make any necessary changes to your AWS CloudWatch configuration, then issue the same `POST` Cluster API command as shown in step 8 of the [Enable log export](#enable-log-export) instructions with the desired updated configuration. Follow the [Monitor the status of a log export configuration](#monitor-the-status-of-a-log-export-configuration) instructions to ensure the update completes successfully.

## Disable log export

To disable an existing {{ site.data.products.dedicated }} log export configuration, and stop sending logs to your AWS CloudWatch log sink, use the following Cluster API command:

{% include_cached copy-clipboard.html %}
~~~shell
curl -H DELETE https://cockroachlabs.cloud/api/v1/clusters/{cluster_id}/logexport \
  Authorization: Bearer {api_session_token}
~~~

Where:

- The `{cluster_id}` can be found in the URL of your [admin web interface](https://cockroachlabs.cloud/cluster/) for the specific cluster you wish to configure, resembling `f78b7feb-b6cf-4396-9d7f-494982d7d81e`.
- The `{api_session_token}` can be generated by [authenticating to your cluster via the Cluster API](/docs/{{site.versions["stable"]}}/cluster-api.html#authentication).


## Limitations

- Logs exported in this fashion retain [`redactable`](/docs/{{site.versions["stable"]}}/configure-logs.html#redact-logs) markers, but are **not** themselves redacted. Do not use this feature with sensitive log messages that you do not wish to export.
- Only one log export configuration is possible per cluster.
- A cluster log configuration is shared by all nodes in all regions in the cluster. 
- Only the following CockroachDB [log channels](/docs/{{site.versions["stable"]}}/logging-overview.html#logging-channels) are supported for export in this manner: `SESSIONS`,`OPS`, `HEALTH`, `STORAGE`, `SQL_SCHEMA`, `USER_ADMIN`, `PRIVILEGES`, `SENSITIVE_ACCESS`, `SQL_EXEC`, and `SQL_PERF`. Other log channels are not exportable from {{ site.data.products.dedicated }}.

## Troubleshooting

Most log export errors stem from incorrect AWS IAM configuration. Ensure you have followed steps 1 through 6 of the [Enable log export](#enable-log-export) instructions closely, and that you have a cross-account IAM role which trusts your {{ site.data.products.dedicated }} AWS account ID (as determined in step 1) and has permission to write to your specified log group in CloudWatch.
